"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[454],{96454:(e,t,n)=>{n.r(t),n.d(t,{default:()=>p});var s=n(41766),a=n(5085);const i=[{label:"ImagingStudy-open",value:"ImagingStudy-open",eventObject:{timestamp:"2018-01-08T01:37:05.14",id:"q9v3jubddqt63n1",event:{"hub.topic":"fdb2f928-5546-4f52-87a0-0648e9ded065","hub.event":"imagingstudy-open",context:[{key:"patient",resource:{resourceType:"Patient",id:"ewUbXT9RWEbSj5wPEdgRaBw3",identifier:[{system:"urn:oid:1.2.840.114350",value:"185444"},{system:"urn:oid:1.2.840.114350.1.13.861.1.7.5.737384.27000",value:"2667"}]}},{key:"study",resource:{resourceType:"ImagingStudy",id:"8i7tbu6fby5ftfbku6fniuf",uid:"urn:oid:2.16.840.1.114362.1.11972228.22789312658.616067305.306.2",identifier:[{system:"7678",value:"185444"}],patient:{reference:"Patient/ewUbXT9RWEbSj5wPEdgRaBw3"}}}]}}},{label:"ImagingStudy-close",value:"ImagingStudy-close",eventObject:{timestamp:"2018-01-08T01:37:05.14",id:"q9v3jubddqt63n1",event:{"hub.topic":"fdb2f928-5546-4f52-87a0-0648e9ded065","hub.event":"imagingstudy-close",context:[{key:"patient",resource:{resourceType:"Patient",id:"ewUbXT9RWEbSj5wPEdgRaBw3",identifier:[{system:"urn:oid:1.2.840.114350",value:"185444"},{system:"urn:oid:1.2.840.114350.1.13.861.1.7.5.737384.27000",value:"2667"}]}},{key:"study",resource:{resourceType:"ImagingStudy",id:"8i7tbu6fby5ftfbku6fniuf",uid:"urn:oid:2.16.840.1.114362.1.11972228.22789312658.616067305.306.2",identifier:[{system:"7678",value:"185444"}],patient:{reference:"Patient/ewUbXT9RWEbSj5wPEdgRaBw3"}}}]}}},{label:"Patient-open",value:"Patient-open",eventObject:{timestamp:"",id:"",event:{"hub.topic":"b073c35e-d86e-4ae0-a8b7-e8804dc50fd1","hub.event":"patient-open",context:[{key:"patient",resource:{resourceType:"Patient",id:"645d87b8-4710-4837-97f4-aeecf3566ac8",identifier:[{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"MR",display:"Medical Record Number"}]},value:"M1"}]}}]}}},{label:"Patient-close",value:"Patient-close",eventObject:{timestamp:"",id:"",event:{"hub.topic":"b073c35e-d86e-4ae0-a8b7-e8804dc50fd1","hub.event":"patient-close",context:[{key:"patient",resource:{resourceType:"Patient",id:"645d87b8-4710-4837-97f4-aeecf3566ac8",identifier:[{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"MR",display:"Medical Record Number"}]}}]}}]}}},{label:"[RAD-148] DiagnoticReport-open",value:"[RAD-148] DiagnoticReport-open",eventObject:{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"diagnosticreport-open",context:[{key:"report",resource:{resourceType:"DiagnosticReport",id:"2402d3bd-e988-414b-b7f2-4322e86c9327",status:"unknown",basedOn:[{type:"ServiceRequest",identifier:{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"ACSN"}]},system:"urn:oid:2.16.840.1.113883.19.5",value:"GH339884",assigner:{reference:"Organization/a92ac1be-fb34-49c1-be58-10928bd271cc",display:"My Healthcare Provider"}}}],code:{coding:[{system:"http://loinc.org",code:"19005-8",display:"Radiology Imaging study [Impression] (narrative)"}]},subject:{reference:"Patient/503824b8-fe8c-4227-b061-7181ba6c3926"},study:[{reference:"ImagingStudy/e25c1d31-20a2-41f8-8d85-fe2fdeac74fd"}]}},{key:"study",resource:{resourceType:"ImagingStudy",id:"e25c1d31-20a2-41f8-8d85-fe2fdeac74fd",identifier:[{system:"urn:dicom:uid",value:"urn:oid:2.16.840.1.114362.1.11972228.22789312658.616067305.306.2"}],status:"unknown",subject:{reference:"Patient/503824b8-fe8c-4227-b061-7181ba6c3926"},basedOn:[{type:"ServiceRequest",identifier:{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"ACSN"}]},system:"urn:oid:2.16.840.1.113883.19.5",value:"GH339884",assigner:{reference:"Organization/a92ac1be-fb34-49c1-be58-10928bd271cc",display:"My Healthcare Provider"}}}]}},{key:"patient",resource:{resourceType:"Patient",id:"503824b8-fe8c-4227-b061-7181ba6c3926",identifier:[{use:"official",type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"MR"}]},system:"urn:oid:2.16.840.1.113883.19.5",value:"4438001",assigner:{reference:"Organization/a92ac1be-fb34-49c1-be58-10928bd271cc",display:"My Healthcare Provider"}}],name:[{use:"official",family:"Smith",given:["John"],prefix:["Dr."],suffix:["Jr.","M.D."]}],gender:"male",birthDate:"1978-11-03"}}]}}},{label:"[RAD-149] DiagnoticReport-close",value:"[RAD-149] DiagnoticReport-close",eventObject:{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"diagnosticreport-close",context:[{key:"report",resource:{resourceType:"DiagnosticReport",id:"2402d3bd-e988-414b-b7f2-4322e86c9327",identifier:[{use:"official",system:"http://myhealthcare.com/reporting-system",value:"GH339884.RPT.0001"}],status:"unknown",basedOn:[{type:"ServiceRequest",identifier:{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"ACSN"}]},system:"urn:oid:2.16.840.1.113883.19.5",value:"GH339884",assigner:{reference:"Organization/a92ac1be-fb34-49c1-be58-10928bd271cc",display:"My Healthcare Provider"}}}],code:{coding:[{system:"http://loinc.org",code:"19005-8",display:"Radiology Imaging study [Impression] (narrative)"}]},subject:{reference:"Patient/503824b8-fe8c-4227-b061-7181ba6c3926"},imagingStudy:[{reference:"ImagingStudy/e25c1d31-20a2-41f8-8d85-fe2fdeac74fd"}]}},{key:"study",resource:{resourceType:"ImagingStudy",id:"e25c1d31-20a2-41f8-8d85-fe2fdeac74fd",identifier:[{system:"urn:dicom:uid",value:"urn:oid:1.2.840.83474.8.231.875.3.15.661594731"}],status:"unknown",subject:{reference:"Patient/503824b8-fe8c-4227-b061-7181ba6c3926"},basedOn:[{type:"ServiceRequest",identifier:{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"ACSN"}]},system:"urn:oid:2.16.840.1.113883.19.5",value:"GH339884",assigner:{reference:"Organization/a92ac1be-fb34-49c1-be58-10928bd271cc",display:"My Healthcare Provider"}}}]}},{key:"patient",resource:{resourceType:"Patient",id:"503824b8-fe8c-4227-b061-7181ba6c3926",identifier:[{use:"official",type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"MR"}]},system:"urn:oid:2.16.840.1.113883.19.5",value:"4438001",assigner:{reference:"Organization/a92ac1be-fb34-49c1-be58-10928bd271cc",display:"My Healthcare Provider"}}]}}]}}},{label:"[RAD-150] DiagnoticReport-update",value:"[RAD-150] DiagnoticReport-update",eventObject:{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"DiagnosticReport-update","context.versionId":"",context:[{key:"report",resource:{resourceType:"DiagnosticReport",id:"2402d3bd-e988-414b-b7f2-4322e86c9327",status:"unknown",code:{coding:[{system:"http://loinc.org",code:"19005-8",display:"Radiology Imaging study [Impression] (narrative)"}]}}},{key:"updates",resource:{resourceType:"Bundle",type:"transaction",entry:[{request:{method:"PUT"},resource:{resourceType:"ImagingStudy",description:"CHEST XRAY",started:"2010-02-14T01:10:00.000Z",id:"7e9deb91-0017-4690-aebd-951cef34aba4",identifier:[{type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/v2-0203",code:"ACSN"}]},value:"3478116342"},{system:"urn:dicom:uid",value:"urn:oid:2.16.124.113543.6003.1154777499.30276.83661.3632298176"}]}},{request:{method:"PUT"},resource:{resourceType:"Observation",id:"40afe766-3628-4ded-b5bd-925727c013b3",partOf:{reference:"ImagingStudy/7e9deb91-0017-4690-aebd-951cef34aba4"},status:"preliminary",category:{system:"http://terminology.hl7.org/CodeSystem/observation-category",code:"imaging",display:"Imaging"},code:{coding:[{system:"http://www.radlex.org",code:"RID49690",display:"simple cyst"}]},issued:"2020-09-07T15:02:03.651Z"}}]}}]}}},{label:"[RAD-151] DiagnoticReport-select",value:"[RAD-151] DiagnoticReport-select",eventObject:{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"DiagnosticReport-select",context:[{key:"report",resource:{resourceType:"DiagnosticReport",id:"2402d3bd-e988-414b-b7f2-4322e86c9327",status:"unknown",code:{coding:[{system:"http://loinc.org",code:"19005-8",display:"Radiology Imaging study [Impression] (narrative)"}]}}},{key:"select",resources:[{resourceType:"Observation",id:"40afe766-3628-4ded-b5bd-925727c013b3"}]}]}}},{label:"[RAD-156] sync-error",value:"[RAD-156] sync-error",eventObject:{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"syncerror",context:[{key:"operationoutcome",resource:{resourceType:"OperationOutcome",issue:[{severity:"warning",code:"processing",diagnostics:"Acme Product failed to follow context",details:{coding:[{system:"https://fhircast.hl7.org/events/syncerror/eventid",code:"fdb2f928-5546-4f52-87a0-0648e9ded065"},{system:"https://fhircast.hl7.org/events/syncerror/eventname",code:"Patient-open"},{system:"https://fhircast.hl7.org/events/syncerror/subscriber",code:"Acme Product"},{system:"http://example.com/events/syncerror/your-error-code-system",code:"FHIRcast sync error"}]}}]}}]}}}];var r=n(15575);const c=function({servicesManager:e,commandsManager:t,extensionManager:n}){const{FhircastService:c}=e.services,[o,u]=(0,s.useState)(!1),[l,d]=(0,s.useState)(!1),[b,h]=(0,s.useState)("Session-DrXray"),[g,p]=(0,s.useState)({label:"ImagingStudy-open",value:"ImagingStudy-open"}),[m,y]=(0,s.useState)({value:"TEST",label:"TEST-FHIRcast Javascript Sandbox"}),[v,f]=(0,s.useState)(!0),[S,E]=(0,s.useState)(!0),[w,k]=(0,s.useState)(!0),[C]=(0,r.r)();let R={name:"",friendlyName:"",productName:"",enabled:!1,events:[],lease:999,hub_endpoint:"",authorization_endpoint:"",token_endpoint:"",token:"",subscribed:!1,subscriberName:""};(0,s.useEffect)((()=>{R=c.getHub(),R.subscribed&&u(!0),""!=R.token&&d(!0),y({label:R.name,value:R.friendlyName});const e=c.EVENTS.FHIRCAST_MESSAGE,t=c.EVENTS.HUB_SUBSCRIBED,n=c.EVENTS.HUB_UNSUBSCRIBED,s=c.EVENTS.WEBSOCKET_CLOSE,a=[];return[e,t,n,s].forEach((e=>{const{unsubscribe:t}=c.subscribe(e,(()=>{"tokenAcquired"===e&&(d(!0),console.debug("FhircastPanel: tokenAcquired event received.")),"hubSubscribed"===e&&(u(!0),console.debug("FhircastPanel: hubSubscribed event received.")),"hubUnsubscribed"===e&&(u(!1),console.debug("FhircastPanel: hubUnsubscribed event received.")),"websocketClose"===e&&(u(!1),console.debug("FhircastPanel: websocketClose event received.")),"fhircastMessage"===e&&console.debug("FhircastPanel: fhircastMessage event received.")}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const T=()=>{E(!S)};return s.createElement(s.Fragment,null,s.createElement("div",{className:"bg-secondary-main flex justify-between px-2 py-1"},s.createElement("span",{className:"text-base center font-bold uppercase tracking-widest text-white"},"FHIRcast")),s.createElement("div",{className:"ohif-scrollbar  overflow-y-auto overflow-x-hidden text-primary-light  text-base"},s.createElement("hr",null),s.createElement("label",{className:"leading-[1.2] text-[12px]"},"Hub status: "),o&&s.createElement("label",{className:" leading-[1.2] text-white"},"SUBSCRIBED"),!o&&s.createElement("label",{className:" leading-[1.2] text-white"},"NOT SUBSCRIBED"),s.createElement("br",null),s.createElement(a.l6,{id:"hub",options:(P=[],C.fhircast.hubs&&C.fhircast.hubs.forEach((e=>{e.enabled&&P.push({label:e.name+"-"+e.friendlyName,value:e.name})})),P),value:m,onChange:e=>{return y(t=e),u(!1),d(!1),void c.setHub(t.value);var t}}),s.createElement(a.$n,{type:a.Ny.NW.secondary,disabled:!1,onClick:async()=>{console.debug("FhircastPanel: Getting token from the  hub: "+c.getHub().name),await c.getToken()&&(d(!0),c.getHub.subscribed&&u(!0))},size:"small"},"Get token"),s.createElement("br",null),s.createElement("hr",null),s.createElement(a.JU,{className:" leading-[1.2] text-primary-light "},"Subscribe to a topic:",s.createElement(a.Sm,{label:"",id:"topic",disabled:o||!l,value:b,onChange:e=>{h(e),c.setTopic(e)}})),s.createElement("br",null),s.createElement(a.$n,{type:a.Ny.NW.secondary,disabled:o||!l,onClick:async()=>{console.debug("FhircastPanel: Subscribing to the hub."),void 0===c.getTopic()&&c.setTopic(b),202==await c.fhircastSubscribe()&&u(!0)},size:"small"},"Subscribe"),s.createElement(a.$n,{type:a.Ny.NW.secondary,disabled:!o||!l,onClick:async()=>{console.debug("FhircastPanel: Unsubscribing from the hub.");await c.fhircastUnsubscribe();u(!1)},size:"small"},"Unsubscribe"),s.createElement("br",null),s.createElement("hr",null),s.createElement(a.$n,{type:a.Ny.NW.secondary,disabled:!l,onClick:async()=>{console.debug("FhircastPanel: Fetching current context from the hub.");try{var e=await c.fhircastGetContext();console.debug("FhircastPanel: Get Context response: ",JSON.stringify(e)),alert(JSON.stringify(e))}catch(e){console.warn("FhircastPanel: Get Context error ",e.message)}},size:"small"},"Get context"),s.createElement("label",null,"Auto-load context:",s.createElement("input",{type:"checkbox",checked:!S,onChange:T})),s.createElement("br",null),s.createElement("hr",null),s.createElement("p",null,"Publish an event:"),s.createElement(a.l6,{id:"eventSelect",options:i,value:g,onChange:e=>{p({label:e.value})},defaultValue:{label:"ImagingStudy-open",value:"ImagingStudy-open"}}),s.createElement(a.$n,{type:a.Ny.NW.secondary,disabled:!l,onClick:async()=>{try{console.debug("FhircastPanel: calling publish");var t=i.filter((e=>e.label===g.label));if(v&&"imagingstudy-open"===t[0].eventObject.event["hub.event"].toLowerCase()){console.debug("FhircastPanel: Publishing ImagingStudy event from current active display port.");const{viewportGridService:n,displaySetService:s,cornerstoneViewportService:a}=e.services,i=s.getActiveDisplaySets()[0],r=i?.instances?.[0]||i?.instance;r&&(console.debug("FhircastPanel: Publishing ImagingStudy "+r.StudyInstanceUID),t[0].eventObject.event.context[1].resource.uid="urn:oid:"+r.StudyInstanceUID)}var n=await c.fhircastPublish(t[0].eventObject);console.debug("FhircastPanel: publish response: ",n.statusText)}catch(e){console.warn("FhircastPanel: publish error: ",e.message)}},size:"small"},"Publish"),s.createElement("label",null,"Overwrite test data:",s.createElement("input",{type:"checkbox",checked:v,onChange:()=>{f(!v)}})),s.createElement("br",null),s.createElement("hr",null),s.createElement("p",null,"Handle events from this hub:"),s.createElement("br",null),s.createElement("label",null,"Patient-open:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null),s.createElement("label",null,"Patient-close:",s.createElement("input",{type:"checkbox",checked:w,onChange:()=>{k(!w)}})),s.createElement("br",null),s.createElement("label",null,"ImagingStudy-open:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null),s.createElement("label",null,"ImagingStudy-close:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null),s.createElement("label",null,"DiagnosticReport-open:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null),s.createElement("label",null,"DiagnosticReport-close:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null),s.createElement("br",null),s.createElement("hr",null),s.createElement("p",null,"Send events to this hub:"),s.createElement("br",null),s.createElement("label",null,"ImagingStudy-open:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null),s.createElement("label",null,"ImagingStudy-close:",s.createElement("input",{type:"checkbox",checked:S,onChange:T})),s.createElement("br",null)));var P};const o=function(){const[e,t]=(0,s.useState)(""),[n,i]=(0,s.useState)(""),[c]=(0,r.r)();return s.createElement(s.Fragment,null,s.createElement("div",{className:"ohif-scrollbar  overflow-y-auto overflow-x-hidden text-primary-light  text-base"},s.createElement(a.$n,{type:a.Ny.NW.secondary,onClick:async()=>{console.debug("Powercast: Get topic and configuration.");try{var e=await async function(e){const t={method:"GET",headers:{"Content-Type":"application/json"}};try{const n=await fetch(e,t);if(200==n.status)return await n.json()}catch(e){console.debug("PowerCast: Error getting configuration.",e.message)}}(c.powercastConnector[0].connector_config_endpoint);console.debug("PowerCast: Get configuration response: ",JSON.stringify(e)),t(JSON.stringify(e))}catch(e){console.debug("PowerCast: Get configuration error: ",e.message),t(e.message)}},size:"small"},"Get configuration"),s.createElement("textarea",{className:"text-[10px] text-black",id:"configuration",readOnly:!0,value:e,rows:6,cols:40}),s.createElement("br",null),s.createElement("hr",null),s.createElement(a.$n,{type:a.Ny.NW.secondary,onClick:async()=>{console.debug("Powercast: Getting auth.");try{t('"authorization_endpoint": "https://nuance-auth0-server/oauth/authorize"')}catch(e){}},size:"small"},"Get Authorization"),s.createElement("textarea",{className:"text-[10px] text-black",id:"authorization",readOnly:!0,value:n,rows:6,cols:40})))};function u(){return console.debug("FHIRcast:  callback called"),'{hub.topic="Session-DrXray",hub.challenge="secret"}'}var l,d=n(55411);const b={FHIRCAST_MESSAGE:"fhircastMessage",HUB_SUBSCRIBED:"hubSubscribed",HUB_UNSUBSCRIBED:"hubUnsubscribed",WEBSOCKET_CLOSE:"websocketClose",TOKEN_ACQUIRED:"tokenAcquired",STUDY_CLOSE:"studyClose"};class h extends d.Rc{constructor(e,t,n){if(console.debug("FhircastService: creating service "),super(b),this._extensionManager=void 0,this._servicesManager=void 0,this._commandsManager=void 0,this.hub={name:"",friendlyName:"",productName:"",enabled:!1,events:[],lease:999,hub_endpoint:"",authorization_endpoint:"",token_endpoint:"",token:"",subscriberName:"",topic:"",lastPublishedMessageID:"",subscribed:!1,resubscribeRequested:!1,websocket:null},this.fhircastConfig=window.config.fhircast,this.checkWebsocket=async e=>{if(this.hub.resubscribeRequested&&this.hub.subscribed){console.debug("FhircastService: Try to resubscribe "),this.hub.resubscribeRequested=!1;var t=await this.fhircastSubscribe();this.hub.resubscribeRequested=202!=t}else!this.hub.subscribed&&this.hub.resubscribeRequested&&(this.hub.resubscribeRequested=!1)},this._extensionManager=e,this._commandsManager=t,this._servicesManager=n,this.fhircastConfig.defaultHub){this.setHub(this.fhircastConfig.defaultHub);this.fhircastConfig.autoStart&&this.getToken()}const s=setInterval((()=>{this.checkWebsocket(s)}),1e4)}createImagingStudyClose(e){return{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"imagingstudy-close",context:[]}}}createImagingStudyOpen(e){return{timestamp:"",id:"",event:{"hub.topic":"","hub.event":"imagingstudy-open",context:[{key:"patient",resource:{resourceType:"Patient",id:"ewUbXT9RWEbSj5wPEdgRaBw3",identifier:[{system:"urn:oid:1.2.840.114350",value:"185444"},{system:"urn:oid:1.2.840.114350.1.13.861.1.7.5.737384.27000",value:"2667"}]}},{key:"study",resource:{resourceType:"ImagingStudy",id:"8i7tbu6fby5ftfbku6fniuf",uid:"urn:oid:"+e,identifier:[{system:"7678",value:"185444"}],patient:{reference:"Patient/ewUbXT9RWEbSj5wPEdgRaBw3"}}}]}}}setHub(e){if(e===this.hub.name)return console.debug("FhircastService: setHub: hub already set to "+e),!0;console.debug("FhircastService: setting hub to "+e);try{if(!this.fhircastConfig.hubs)return console.debug("FhircastService: hub not found in configuration "+e),!1;this.fhircastConfig.hubs.forEach((t=>{if(t.enabled&&t.name===e)return this.hub=t,this.hub.subscribed=!1,!0}))}catch(t){return console.warn("FhircastService: Unable to set the hub to  "+e),!1}}getHub(){return console.debug("FhircastService: getHub: hub is "+this.hub.name),this.hub}getTopic(e){return console.debug("FhircastService: getTopic called."),this.hub.topic}setTopic(e){console.debug("FhircastService: setting topic to "+e),this.hub.topic=e,this.hub.subscriberName="OHIF-"+e+"-"+Math.random().toString(36).substring(2,16)}async getToken(){console.debug("FhircastService: Getting token.");const e=new URLSearchParams;e.append("grant_type","client_credentials"),e.append("client_id","97b949f6-21f8-4e98-80b4-08e139e381fa"),e.append("client_secret","7ee51e1e18f339c65afe831ee496bcc97853e8d09789af3d1bd672dfc412830c");const t={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e};try{const e=await fetch(this.hub.token_endpoint,t);if(200==e.status){const t=await e.json();return t.access_token&&(console.debug("FhircastService:  Token received: ",t.access_token),this.hub.token=t.access_token,this._broadcastEvent(h.EVENTS.TOKEN_ACQUIRED,{})),t.topic&&(console.debug("FhircastService:  Topic received: ",t.topic),this.setTopic(t.topic),this.fhircastConfig.autoStart&&this.fhircastSubscribe()),!0}return console.debug("FhircastService: Error getting token."),!1}catch(e){return console.warn("FhircastService: Error getting token:",e.message),!1}}async fhircastUnsubscribe(){this.hub.subscribed=!1,this.hub.resubscribeRequested=!1;const e=new URLSearchParams;e.append("hub.mode","unsubscribe"),e.append("hub.channel.type","websocket"),e.append("hub.callback",window.location.origin+"/fhircastCallback"),e.append("hub.events",this.hub.events.toString()),e.append("hub.topic",this.hub.topic),e.append("hub.lease",this.hub.lease.toString()),e.append("subscriber.name",this.hub.subscriberName);const t={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:"Bearer "+this.hub.token},body:e,signal:AbortSignal.timeout(5e3)};try{const e=await fetch(this.hub.hub_endpoint,t);if(202==e.status){await e.json();console.debug("FhircastService: Unsubscribe successfully. "),this._broadcastEvent(h.EVENTS.HUB_UNSUBSCRIBED,{})}else console.debug("FhircastService: Unsubscribe refused by the hub. ")}catch(e){console.warn("FhircastService: Error unsubscribing from the hub.",e.message)}this.hub.websocket.close()}processEvent(e){try{const s=JSON.parse(e);if(s["hub.mode"]&&console.debug("FhircastService: Subscription acknowledged on the websocket."),s.event)if("heartbeat"===s.event["hub.event"])console.debug("FhircastService: Received websocket heartbeat from hub.");else if(s.id===this.hub.lastPublishedMessageID)console.debug("FhircastService: Received echo of event "+s.event["hub.event"]+", id:"+s.id);else if(s.event){console.debug("FhircastService: websocket received data: ",e),this._broadcastEvent(h.EVENTS.FHIRCAST_MESSAGE,{});let a=window.location.search;if(console.debug("FhircastService: wcurrent location: ",a),"patient-open"===s.event["hub.event"].toLowerCase())if(s.event.context){var t=null;s.event.context.forEach((e=>{"patient"===e.key.toLowerCase()&&(t=e.resource.identifier[0].value)})),console.debug("FhircastPanel: patient-open for mrn:"+t),this._commandsManager.runCommand("navigateHistory",{to:"/?mrn="+t})}else console.warn("FhircastPanel: mrn not found in  patient-open message.");if(""!=a&&"patient-close"===s.event["hub.event"].toLowerCase()&&this._commandsManager.runCommand("navigateHistory",{to:"/"}),"imagingstudy-open"===s.event["hub.event"].toLowerCase()){var n=null;s.event.context.forEach((e=>{"study"===e.key.toLowerCase()&&(n=e.resource.uid.replaceAll("urn:oid:",""))})),null===n||a.includes(n)?null===n?console.debug("FhircastPanel:  imagingstudy-open, studyUID not found in message"):a.includes(n)&&console.debug("FhircastPanel:  imagingstudy-open, studyUID already open"):(console.debug("FhircastPanel:  imagingstudy-open, opening "+n),this._commandsManager.runCommand("navigateHistory",{to:"/viewer?StudyInstanceUIDs="+n}))}if(""!=a&&"imagingstudy-close"===s.event["hub.event"].toLowerCase()&&this._commandsManager.runCommand("navigateHistory",{to:"/"}),"diagnosticreport-open"===s.event["hub.event"].toLowerCase()){const e=s.event.context[1].identifier[0].value;console.debug("FhircastPanel:  Opening "+e),this._commandsManager.runCommand("navigateHistory",{to:"/viewer?StudyInstanceUIDs="+e})}""!=a&&"diagnosticreport-close"===s.event["hub.event"].toLowerCase()&&this._commandsManager.runCommand("navigateHistory",{to:"/"})}}catch(e){console.warn("FhircastService: websocket setup error: ",e)}}websocketClose(){console.debug("FhircastService: websocket is closed."),this.hub.resubscribeRequested=!0,this._broadcastEvent(h.EVENTS.WEBSOCKET_CLOSE,{})}async fhircastSubscribe(){if(void 0===this.hub.topic)return console.warn("FhircastService: Error. subscription not sent. No topic defined."),"error: topic not defined";const e=new URLSearchParams;e.append("hub.mode","subscribe"),e.append("hub.channel.type","websocket"),e.append("hub.callback",window.location.origin+"/fhircastCallback"),e.append("hub.events",this.hub.events.toString()),e.append("hub.topic",this.hub.topic),e.append("hub.lease",this.hub.lease.toString()),e.append("subscriber.name",this.hub.subscriberName);const t={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:"Bearer "+this.hub.token},body:e,signal:AbortSignal.timeout(5e3)};try{const e=await fetch(this.hub.hub_endpoint,t);if(202==e.status){this.hub.subscribed=!0,this.hub.resubscribeRequested=!1;const t=await e.json();console.debug("FhircastService: subscribe response: "+JSON.stringify(t));const n=t["hub.channel.endpoint"];this.hub.websocket=new WebSocket(n),this.hub.websocket.onopen=function(){console.debug("FhircastService: websocket is connected."),this.send('{"hub.channel.endpoint":"'+n+'"}')},this.hub.websocket.addEventListener("message",(e=>this.processEvent(e.data))),this.hub.websocket.addEventListener("close",(()=>this.websocketClose())),this.hub.websocket.onerror=function(){console.warn("FhircastService: Error reported on websocket:")},this._broadcastEvent(h.EVENTS.HUB_SUBSCRIBED,{})}else console.debug("FhircastService: Subscription rejected by hub:",e.status);return e.status}catch(e){console.warn("FhircastService: Error subscribing to the hub.",e.message)}}async fhircastPublish(e){const t=new Date;e.timestamp=t.toJSON(),e.id="OHIF-"+Math.random().toString(36).substring(2,16),this.hub.lastPublishedMessageID=e.id,e.event["hub.topic"]=this.hub.topic;const n=JSON.stringify(e),s={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.hub.token},body:n};try{console.debug("FhircastService: Publishing message to FHIRcast hub: "+n);var a=this.hub.hub_endpoint+"/"+this.hub.topic;"PHILIPS"===this.hub.productName&&(a=this.hub.hub_endpoint);return await fetch(a,s)}catch(e){return console.debug(e.message),null}}async fhircastGetContext(){console.debug("FhircastService: Retrieving context from FHIRcast hub.");try{const e={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.hub.token}},t=await fetch(this.hub.hub_endpoint+"/"+this.hub.topic,e);return await t.json()}catch(e){return console.warn("FhircastService: get context error: ",e.message),e.text}}}l=h,h.EVENTS=b,h.REGISTRATION={name:"fhircastService",altName:"FhircastService",create:({extensionManager:e,commandsManager:t,servicesManager:n})=>new l(e,t,n)};const g=h,p={id:"fhir",preRegistration:({servicesManager:e,commandsManager:t,extensionManager:n,configuration:s={}})=>{e.registerService(g.REGISTRATION)},getPanelModule:function({commandsManager:e,extensionManager:t,servicesManager:n}){return[{name:"PowercastPanel",iconName:"power-off",iconLabel:"power-off",label:"Powercast",secondaryLabel:"Measurements",component:()=>{const[{activeViewportId:i,viewports:r}]=(0,a.ih)();return s.createElement(o,{viewports:r,activeViewportId:i,onSaveComplete:()=>{},onRejectComplete:()=>{},commandsManager:e,servicesManager:n,extensionManager:t})}},{name:"FhircastPanel",iconName:"power-off",iconLabel:"power-off",label:"FHIRcast",secondaryLabel:"Measurements",component:()=>{const[{activeViewportId:i,viewports:r}]=(0,a.ih)();return s.createElement(c,{viewports:r,activeViewportId:i,onSaveComplete:()=>{},onRejectComplete:()=>{},commandsManager:e,servicesManager:n,extensionManager:t})}}]},getCustomizationModule:function({servicesManager:e,extensionManager:t}){return[{name:"fhircastCallback",value:{id:"customRoutes",routes:[{path:"/fhircastCallback",children:()=>s.createElement(u,null)}]}}]}}}}]);
//# sourceMappingURL=454.bundle.c1a1093c102977b6c35d.js.map