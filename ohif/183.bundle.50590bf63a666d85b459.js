"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[183],{1904:(e,t,n)=>{n.d(t,{A:()=>i});const i=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]]},40233:(e,t,n)=>{n.r(t),n.d(t,{hideElementCursor:()=>l,initElementCursor:()=>a,resetElementCursor:()=>s,setElementCursor:()=>r});var i=n(32916);const o=Symbol("ElementCursorsMap");function a(e,t){d(e)[0]=t,r(e,t)}function r(e,t){const n=d(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof i.MouseCursor?t:i.MouseCursor.getDefinedCursor("auto")).getStyleProperty()}function s(e){r(e,d(e)[1])}function l(e){r(e,i.MouseCursor.getDefinedCursor("none"))}function d(e){let t=d[o];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(d,o,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}},32916:(e,t,n)=>{n.r(t),n.d(t,{CursorNames:()=>x,CursorSVG:()=>E,ImageMouseCursor:()=>d,MouseCursor:()=>a,SVGMouseCursor:()=>b,elementCursor:()=>R,registerCursor:()=>w,setCursorForElement:()=>M});const i=Symbol("DefinedCursors"),o=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class a{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof a?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=r(a,i);let n=t.get(e);return n instanceof a?n:o.has(e)?(n=new a(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof a){return r(a,i).set(e,t),!0}return!1}}function r(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const s=o.values();var l=n(44656);class d extends a{constructor(e,t,n,i,o){super(i||d.getUniqueInstanceName("image-cursor"),o),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let i=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(i+=` ${t} ${n}`),this.addFallbackStyleProperty(i)}static getUniqueInstanceName(e){return`${e}-${l.utilities.getRuntimeId(d)}`}}var c=n(84901);const g={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},h={x:127,y:60},u='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',m='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',v='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',p='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',f='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',E={Angle:I(g,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:I(g,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:I(g,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:I(g,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:I(g,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:I(g,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:I(g,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:I(g,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:I(g,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:I(g,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:I(g,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:I(g,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:I(g,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:I(g,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:I(g,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:I(g,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:I(g,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:I(g,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:I(g,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:I(g,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:I(g,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:I(g,{iconContent:`${v} ${u}`,viewBox:h}),SegmentationFreeHandFillInside:I(g,{iconContent:`${v} ${m}`,viewBox:h}),SegmentationFreeHandEraseOutside:I(g,{iconContent:`${v} ${u}`,viewBox:h}),SegmentationFreeHandFillOutside:I(g,{iconContent:`${v} ${m}`,viewBox:h}),SegmentationRectangleEraseInside:I(g,{iconContent:`${p} ${u}`,viewBox:h}),RectangleScissor:I(g,{iconContent:`${p} ${m}`,viewBox:h}),"RectangleScissor.FILL_INSIDE":I(g,{iconContent:`${p} ${m}`,viewBox:h}),"RectangleScissor.FILL_OUTSIDE":I(g,{iconContent:`${p} ${m}`,viewBox:h}),"RectangleScissor.ERASE_OUTSIDE":I(g,{iconContent:`${p} ${u}`,viewBox:h}),"RectangleScissor.ERASE_INSIDE":I(g,{iconContent:`${p} ${u}`,viewBox:h}),CircleScissor:I(g,{iconContent:`${f} ${m}`,viewBox:h}),"CircleScissor.FILL_INSIDE":I(g,{iconContent:`${f} ${m}`,viewBox:h}),"CircleScissor.ERASE_OUTSIDE":I(g,{iconContent:`${f} ${u}`,viewBox:h}),"CircleScissor.FILL_OUTSIDE":I(g,{iconContent:`${f} ${m}`,viewBox:h})};function I(e,t){return Object.assign(Object.create(e),t)}function w(e,t,n){E[e]=I(g,{iconContent:t,viewBox:n})}const C=Object.keys(E);var T=n(28664);const S=c.AnnotationStyleStates.Highlighted,_=c.ToolModes.Active;class b extends d{constructor(e,t,n,i,o){super(e,t,n,i,o)}static getDefinedCursor(e,t=!1,n){n||(n=(0,T.h)("color",{},S,_));const i=function(e,t,n){const i=t?"pointer":"cursor";return`${i}:${e}/${n}`}(e,t,n);let o=super.getDefinedCursor(i);if(!o){const a=function(e){return E[e]}(e);a&&(o=function(e,t,n,i,o){const{x:a,y:r}=e.mousePoint;return new b(function(e,t,n){return URL.createObjectURL(function(e,t,n){const i=(t?y:A)(e,n);return new Blob([i],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:i}),a,r,t,o)}(a,i,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(i,o))}return o}}function D(e,t){const n=Object(t),i=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,((e,t)=>i(t)?n[t]+"":""))}function A(e,t){const{iconContent:n,iconSize:i,viewBox:o}=e;return D(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${i}" height="${i}" viewBox="0 0\n      ${o.x} ${o.y}">\n      ${n}\n    </svg>`,t)}function y(e,t){const{iconContent:n,iconSize:i,viewBox:o,mousePointerGroupString:a}=e,r=16+i;return D(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${r}" height="${r}" viewBox="0 0 ${r} ${r}">\n      <g>${a}</g>\n      <g transform="translate(16, 16) scale(${i/Math.max(o.x,o.y,1)})">${n}</g>\n    </svg>`,t)}var R=n(40233);const M=function(e,t){let n=b.getDefinedCursor(t,!0);n||(n=a.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=a.getDefinedCursor(t)),(0,R.setElementCursor)(e,n)},x=[...C,...s]},2746:(e,t,n)=>{n.r(t),n.d(t,{draw:()=>i.A,drawArrow:()=>T,drawCircle:()=>s,drawEllipse:()=>d,drawEllipseByCoordinates:()=>l,drawHandle:()=>c,drawHandles:()=>g,drawLine:()=>h,drawLinkedTextBox:()=>w,drawPath:()=>m,drawPolyline:()=>u,drawRect:()=>C,drawRedactionRect:()=>S,drawTextBox:()=>f,setAttributesIfNecessary:()=>a,setNewAttributesIfValid:()=>r});var i=n(79697);const o=function(e,t,n){return`${e}::${t}::${n}`};const a=function(e,t){Object.keys(e).forEach((n=>{const i=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):i!==o&&t.setAttribute(n,o)}))};const r=function(e,t){Object.keys(e).forEach((n=>{const i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)}))};const s=function(e,t,n,i,s,l={},d=""){const{color:c,fill:g,width:h,lineWidth:u,lineDash:m,fillOpacity:v,strokeOpacity:p}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},l),f=u||h,E=o(t,"circle",n),I=e.getSvgNode(E),w={cx:`${i[0]}`,cy:`${i[1]}`,r:`${s}`,stroke:c,fill:g,"stroke-width":f,"stroke-dasharray":m,"fill-opacity":v,"stroke-opacity":p};if(I)a(w,I),e.setNodeTouched(E);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==d&&t.setAttribute("data-id",d),r(w,t),e.appendNode(t,E)}};const l=function(e,t,n,i,s={},l=""){const{color:d,width:c,lineWidth:g,lineDash:h}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},s),u=g||c,m=o(t,"ellipse",n),v=e.getSvgNode(m),[p,f,E,I]=i,w=Math.hypot(E[0]-I[0],E[1]-I[1]),C=Math.hypot(f[0]-p[0],f[1]-p[1]),T=180*Math.atan2(E[1]-I[1],E[0]-I[0])/Math.PI,S=[(E[0]+I[0])/2,(f[1]+p[1])/2],_={cx:`${S[0]}`,cy:`${S[1]}`,rx:`${w/2}`,ry:`${C/2}`,stroke:d,fill:"transparent",transform:`rotate(${T} ${S[0]} ${S[1]})`,"stroke-width":u,"stroke-dasharray":h};if(v)a(_,v),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==l&&t.setAttribute("data-id",l),r(_,t),e.appendNode(t,m)}};const d=function(e,t,n,i,o,a={},r=""){const s=[(i[0]+o[0])/2,i[1]],d=[(i[0]+o[0])/2,o[1]],c=[i[0],(i[1]+o[1])/2],g=[o[0],(i[1]+o[1])/2];l(e,t,n,[d,s,c,g],{},"")};const c=function(e,t,n,i,s={},l){const{color:d,handleRadius:c,width:g,lineWidth:h,fill:u,type:m,opacity:v}=Object.assign({color:"rgb(0, 255, 0)",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},s),p=h||g,f=o(t,"handle",`hg-${n}-index-${l}`);let E;if("circle"===m)E={cx:`${i[0]}`,cy:`${i[1]}`,r:c,stroke:d,fill:u,"stroke-width":p,opacity:v};else{if("rect"!==m)throw new Error(`Unsupported handle type: ${m}`);{const e=1.5*parseFloat(c);E={x:`${i[0]-.5*e}`,y:`${i[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:d,fill:u,"stroke-width":p,rx:""+.1*e,opacity:v}}}const I=e.getSvgNode(f);if(I)a(E,I),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg",m);r(E,t),e.appendNode(t,f)}};const g=function(e,t,n,i,o={}){i.forEach(((i,a)=>{c(e,t,n,i,o,a)}))};function h(e,t,n,i,s,l={},d=""){if(isNaN(i[0])||isNaN(i[1])||isNaN(s[0])||isNaN(s[1]))return;const{color:c,width:g,lineWidth:h,lineDash:u,shadow:m}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},l),v=h||g,p=o(t,"line",n),f=e.getSvgNode(p),E=m?`filter:url(#shadow-${e.svgLayerElement.id});`:"",I={x1:`${i[0]}`,y1:`${i[1]}`,x2:`${s[0]}`,y2:`${s[1]}`,stroke:c,style:E,"stroke-width":v,"stroke-dasharray":u};if(f)a(I,f),e.setNodeTouched(p);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==d&&t.setAttribute("data-id",d),r(I,t),e.appendNode(t,p)}}function u(e,t,n,i,s){if(i.length<2)return;const{color:l="rgb(0, 255, 0)",width:d=10,fillColor:c="none",fillOpacity:g=0,lineWidth:h,lineDash:u,closePath:m=!1}=s,v=h||d,p=o(t,"polyline",n),f=e.getSvgNode(p);let E="";for(const e of i)E+=`${e[0].toFixed(1)}, ${e[1].toFixed(1)} `;if(m){const e=i[0];E+=`${e[0]}, ${e[1]}`}const I={points:E,stroke:l,fill:c,"fill-opacity":g,"stroke-width":v,"stroke-dasharray":u};if(f)a(I,f),e.setNodeTouched(p);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");r(I,t),e.appendNode(t,p)}}function m(e,t,n,i,s){const l=i.length&&i[0].length&&Array.isArray(i[0][0])?i:[i],{color:d="rgb(0, 255, 0)",width:c=10,fillColor:g="none",fillOpacity:h=0,lineWidth:u,lineDash:m,closePath:v=!1}=s,p=u||c,f=o(t,"path",n),E=e.getSvgNode(f);let I="";for(let e=0,t=l.length;e<t;e++){const t=l[e],n=t.length;if(!(n<2)){for(let e=0;e<n;e++){const n=t[e];I+=`${e?"L":"M"} ${n[0].toFixed(1)}, ${n[1].toFixed(1)} `}v&&(I+="Z ")}}if(!I)return;const w={d:I,stroke:d,fill:g,"fill-opacity":h,"stroke-width":p,"stroke-dasharray":m};if(E)a(w,E),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");r(w,t),e.appendNode(t,f)}}function v(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function p(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const i=e.getBBox(),o={x:`${i.x}`,y:`${i.y}`,width:`${i.width}`,height:`${i.height}`,fill:t};return a(o,n),i}const f=function(e,t,n,i,r,s={}){return function(e,t,n,i=[""],r,s){const{padding:l,color:d,fontFamily:c,fontSize:g,background:h}=s;let u;const[m,f]=[r[0]+l,r[1]+l],E="http://www.w3.org/2000/svg",I=o(t,"text",n),w=e.getSvgNode(I);if(w){const t=w.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],o=i[e]||"";t.textContent=o}if(i.length>n.length){for(let e=0;e<i.length-n.length;e++){const o=v(i[e+n.length]);t.appendChild(o)}w.appendChild(t),e.appendNode(w,I)}const o={transform:`translate(${m} ${f})`};a({fill:d,"font-size":g,"font-family":c},t),a(o,w),u=p(w,h),e.setNodeTouched(I)}else{const t=document.createElementNS(E,"g");t.setAttribute("transform",`translate(${m} ${f})`);const n=function(e,t){const{color:n,fontFamily:i,fontSize:o}=t,a="http://www.w3.org/2000/svg",r=document.createElementNS(a,"text"),s="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${s}${l}`;return r.setAttribute("x","0"),r.setAttribute("y","0"),r.setAttribute("fill",n),r.setAttribute("font-family",i),r.setAttribute("font-size",o),r.setAttribute("style",d),r}(e,s);for(let e=0;e<i.length;e++){const t=v(i[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,I),u=p(t,h)}return Object.assign({},u,{x:m,y:f,height:u.height+l,width:u.width+l})}(e,t,n,i,r,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},s))};var E=n(87658);const I=function(e,t,n,i,o,a,r={}){const s=i.length>0?(0,E.A)(i,o):o,l=function(e){const{x:t,y:n,height:i,width:o}=e,a=o/2,r=i/2;return[[t+a,n],[t,n+r],[t+a,n+i],[t+o,n+r]]}(a);h(e,t,`link-${n}`,s,(0,E.A)(l,s),Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},r))};const w=function(e,t,n,i,o,a,r,s={}){const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},s),d=f(e,t,n,i,o,l);return I(e,t,n,a,o,d,l),d};function C(e,t,n,i,s,l={},d=""){const{color:c,width:g,lineWidth:h,lineDash:u}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},l),m=h||g,v=o(t,"rect",n),p=e.getSvgNode(v),f=[Math.min(i[0],s[0]),Math.min(i[1],s[1])],E=Math.abs(i[0]-s[0]),I=Math.abs(i[1]-s[1]),w={x:`${f[0]}`,y:`${f[1]}`,width:`${E}`,height:`${I}`,stroke:c,fill:"transparent","stroke-width":m,"stroke-dasharray":u};if(p)a(w,p),e.setNodeTouched(v);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==d&&t.setAttribute("data-id",d),r(w,t),e.appendNode(t,v)}}function T(e,t,n,i,o,a={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:r,width:s,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a);h(e,t,n,i,o,{color:r,width:s,lineWidth:l,lineDash:d});const c=Math.atan2(o[1]-i[1],o[0]-i[0]),g={start:[o[0]-10*Math.cos(c-Math.PI/7),o[1]-10*Math.sin(c-Math.PI/7)],end:o},u={start:[o[0]-10*Math.cos(c+Math.PI/7),o[1]-10*Math.sin(c+Math.PI/7)],end:o};h(e,t,"2",g.start,g.end,{color:r,width:s,lineWidth:l}),h(e,t,"3",u.start,u.end,{color:r,width:s,lineWidth:l})}function S(e,t,n,i,s,l={}){const{color:d,width:c,lineWidth:g,lineDash:h}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},l),u=g||c,m=o(t,"rect",n),v=e.getSvgNode(m),p=[Math.min(i[0],s[0]),Math.min(i[1],s[1])],f=Math.abs(i[0]-s[0]),E=Math.abs(i[1]-s[1]),I={x:`${p[0]}`,y:`${p[1]}`,width:`${f}`,height:`${E}`,stroke:d,fill:"black","stroke-width":u,"stroke-dasharray":h};if(v)a(I,v),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");r(I,t),e.appendNode(t,m)}}},42111:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated"}(i||(i={}));const o=i},28117:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(i||(i={}));const o=i},83946:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.Labelmap="LABELMAP",e.Contour="CONTOUR",e.Surface="SURFACE"}(i||(i={}));const o=i},75117:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.ComputeInnerCircleRadius="computeInnerCircleRadius"}(i||(i={}));const o=i},79825:(e,t,n)=>{var i;n.d(t,{H:()=>i}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(i||(i={}))},84901:(e,t,n)=>{var i,o;n.r(t),n.d(t,{AnnotationStyleStates:()=>s,ChangeTypes:()=>u.A,Events:()=>d.A,KeyboardBindings:()=>o,MouseBindings:()=>i,SegmentationRepresentations:()=>c.A,StrategyCallbacks:()=>h.A,Swipe:()=>g.H,ToolModes:()=>r.A,WorkerTypes:()=>m}),function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button"}(i||(i={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(o||(o={}));var a,r=n(12468);!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(a||(a={}));const s=a;var l,d=n(28117),c=n(83946),g=n(79825),h=n(75117),u=n(42111);!function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="polySeg/convertContourToVolumeLabelmap",e.POLYSEG_SURFACE_TO_LABELMAP="polySeg/convertSurfacesToVolumeLabelmap",e.POLYSEG_CONTOUR_TO_SURFACE="polySeg/convertContourToSurface",e.POLYSEG_LABELMAP_TO_SURFACE="polySeg/convertLabelmapToSurface",e.SURFACE_CLIPPING="surfaceClipping"}(l||(l={}));const m=l},44926:(e,t,n)=>{n.d(t,{dj:()=>A,aB:()=>E,In:()=>r,z5:()=>S,V$:()=>g,n6:()=>d,$m:()=>b});var i=n(44656),o=n(6805);const a=function(e){(0,o.Ay)(e.detail.element)},r={enable:function(e){e.addEventListener(i.Enums.Events.IMAGE_RENDERED,a)},disable:function(e){e.removeEventListener(i.Enums.Events.IMAGE_RENDERED,a)}};var s=n(28117),l=n(39375);const d={enable:function(e){e.addEventListener(s.A.MOUSE_CLICK,l.q_),e.addEventListener(s.A.MOUSE_DOWN,l.cT),e.addEventListener(s.A.MOUSE_DOWN_ACTIVATE,l.Xd),e.addEventListener(s.A.MOUSE_DOUBLE_CLICK,l.LM),e.addEventListener(s.A.MOUSE_DRAG,l.al),e.addEventListener(s.A.MOUSE_MOVE,l.tG),e.addEventListener(s.A.MOUSE_UP,l.Je),e.addEventListener(s.A.MOUSE_WHEEL,l.rO)},disable:function(e){e.removeEventListener(s.A.MOUSE_CLICK,l.q_),e.removeEventListener(s.A.MOUSE_DOWN,l.cT),e.removeEventListener(s.A.MOUSE_DOWN_ACTIVATE,l.Xd),e.removeEventListener(s.A.MOUSE_DOUBLE_CLICK,l.LM),e.removeEventListener(s.A.MOUSE_DRAG,l.al),e.removeEventListener(s.A.MOUSE_MOVE,l.tG),e.removeEventListener(s.A.MOUSE_UP,l.Je),e.removeEventListener(s.A.MOUSE_WHEEL,l.rO)}};var c=n(93858);const g={enable:function(e){e.addEventListener(s.A.KEY_DOWN,c.u),e.addEventListener(s.A.KEY_UP,c.L)},disable:function(e){e.removeEventListener(s.A.KEY_DOWN,c.u),e.removeEventListener(s.A.KEY_UP,c.L)}};var h=n(84901),u=n(31437);const{Active:m,Passive:v,Enabled:p}=h.ToolModes,f=function(e){(0,u.A)(e,[m,v,p]).forEach((t=>{t.onCameraModified&&t.onCameraModified(e)}))},E={enable:function(e){e.addEventListener(i.Enums.Events.CAMERA_MODIFIED,f)},disable:function(e){e.removeEventListener(i.Enums.Events.CAMERA_MODIFIED,f)}},{Active:I,Passive:w,Enabled:C}=h.ToolModes,T=function(e){(0,u.A)(e,[I,w,C]).forEach((t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},S={enable:function(e){e.addEventListener(i.Enums.Events.IMAGE_SPACING_CALIBRATED,T)},disable:function(e){e.removeEventListener(i.Enums.Events.IMAGE_SPACING_CALIBRATED,T)}};var _=n(50734);const b={enable:function(e){e.addEventListener(s.A.TOUCH_START,_.gX),e.addEventListener(s.A.TOUCH_START_ACTIVATE,_.$F),e.addEventListener(s.A.TOUCH_DRAG,_.Oz),e.addEventListener(s.A.TOUCH_END,_.ls),e.addEventListener(s.A.TOUCH_TAP,_.lI),e.addEventListener(s.A.TOUCH_PRESS,_.x5)},disable:function(e){e.removeEventListener(s.A.TOUCH_START,_.gX),e.removeEventListener(s.A.TOUCH_START_ACTIVATE,_.$F),e.removeEventListener(s.A.TOUCH_DRAG,_.Oz),e.removeEventListener(s.A.TOUCH_END,_.ls),e.removeEventListener(s.A.TOUCH_PRESS,_.x5)}};var D=n(33836);const A={enable:function(){i.eventTarget.addEventListener(s.A.ANNOTATION_COMPLETED,D.A.handleAnnotationCompleted),i.eventTarget.addEventListener(s.A.ANNOTATION_MODIFIED,D.A.handleAnnotationUpdate),i.eventTarget.addEventListener(s.A.ANNOTATION_REMOVED,D.A.handleAnnotationDelete)},disable:function(){i.eventTarget.removeEventListener(s.A.ANNOTATION_COMPLETED,D.A.handleAnnotationCompleted),i.eventTarget.removeEventListener(s.A.ANNOTATION_MODIFIED,D.A.handleAnnotationUpdate),i.eventTarget.removeEventListener(s.A.ANNOTATION_REMOVED,D.A.handleAnnotationDelete)}}},90202:(e,t,n)=>{n.d(t,{A:()=>v,r:()=>E});var i=n(44656),o=n(65903),a=n(21013),r=n(90252),s=n(38296),l=n(75908),d=n(15916),c=n(61738),g=n(94152),h=n(96950),u=n(54177);const m="PlanarFreehandContourSegmentationTool";async function v(e){const t=e.detail.annotation;if(!d.isContourSegmentationAnnotation(t))return;const n=function(e){const t=(0,o.A)(e),n=t.find((e=>p(e,!0)));return n??t[0]}(t),v=function(e,t){const{annotationUID:n}=t;return(0,s.getAllAnnotations)().filter((i=>i.annotationUID&&i.annotationUID!==n&&d.isContourSegmentationAnnotation(i)&&d.areSameSegment(i,t)&&e.isReferenceViewable(i.metadata)))}(n,t);if(!v.length)return;const I=f(t.data.contour.polyline,n),w=function(e,t,n){const i=a.math.polyline.getAABB(t);for(let o=0;o<n.length;o++){const r=n[o],s=f(r.data.contour.polyline,e),l=a.math.polyline.getAABB(s),d=a.math.aabb.intersectAABB(i,l),c=d&&a.math.polyline.intersectPolyline(t,s),g=d&&!c&&a.math.polyline.containsPoints(s,t);if(c||g)return{targetAnnotation:r,targetPolyline:s,isContourHole:g}}}(n,I,v);if(!w)return;const{targetAnnotation:C,targetPolyline:T,isContourHole:S}=w;if(S){const{contourHoleProcessingEnabled:i=!1}=e.detail;if(!i)return;E(n,C,t)}else!function(e,t,n,o,v){if(!(0,c.J2)(g.PlanarFreehandContourSegmentationTool))return void console.warn(`${g.PlanarFreehandContourSegmentationTool.toolName} is not registered in cornerstone`);if(!p(e))return;const E=v[0],I=a.math.polyline.containsPoint(n,E),w=function(e,t){return(0,s.getChildAnnotations)(t).map((t=>({annotation:t,polyline:f(t.data.contour.polyline,e)})))}(e,t),C=new Set(w),T=new Map,S=(e,t)=>{let n=T.get(e);n||(n=[],T.set(e,n)),n.push(t),C.delete(t)},_=[];if(I){const e=a.math.polyline.mergePolylines(n,v);_.push(e),Array.from(C.keys()).forEach((t=>S(e,t)))}else{a.math.polyline.subtractPolylines(n,v).forEach((e=>{_.push(e),Array.from(C.keys()).forEach((t=>{a.math.polyline.containsPoints(e,t.polyline)&&(S(e,t),C.delete(t))}))}))}Array.from(T.values()).forEach((e=>e.forEach((e=>(0,s.clearParentAnnotation)(e.annotation)))));const{element:b}=e,D=(0,i.getEnabledElement)(b),{metadata:A,data:y}=t,{handles:R,segmentation:M}=y,{textBox:x}=R;(0,s.removeAnnotation)(o.annotationUID),(0,s.removeAnnotation)(t.annotationUID);for(let n=0;n<_.length;n++){const o=_[n],a=e.canvasToWorld(o[0]),r=e.canvasToWorld(o[o.length-1]),c={metadata:{...A,toolName:m,originalToolName:A.originalToolName||A.toolName},data:{cachedStats:{},handles:{points:[a,r],textBox:x?{...x}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...M}},annotationUID:i.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};l.updateContourPolyline(c,{points:o,closed:!0,targetWindingDirection:h.W.Clockwise},e),(0,s.addAnnotation)(c,b),d.addContourSegmentationAnnotation(c),(0,u.XF)(c,e.element),T.get(o)?.forEach((e=>(0,s.addChildAnnotation)(c,e.annotation)))}!function(e,t,n){const{viewport:i}=e,{element:o}=i,{renderingEngine:s}=e,l=new Set([m,t.metadata.toolName,n.metadata.toolName]);for(const e of l.values()){const t=(0,r.getViewportIdsWithToolToRender)(o,e);(0,a.triggerAnnotationRenderForViewportIds)(s,t)}new Promise((e=>window.requestAnimationFrame(e)))}(D,t,o)}(n,C,T,t,I)}function p(e,t=!1){const{toolName:n}=g.PlanarFreehandContourSegmentationTool,i=c.dU.getToolGroupForViewport(e.id,e.renderingEngineId);let o;return i.hasTool(n)?i.getToolOptions(n)||(o=`Tool ${n} must be in active/passive state`):o=`Tool ${n} not added to ${i.id} toolGroup`,o&&!t&&console.warn(o),!o}function f(e,t){const n=e.length,i=new Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);return i}function E(e,t,n){const{windingDirection:o}=t.data.contour,{windingDirection:l}=n.data.contour;o===l&&(n.data.contour.polyline.reverse(),n.data.contour.windingDirection=-1*o),(0,s.addChildAnnotation)(t,n),d.removeContourSegmentationAnnotation(n);const{element:c}=e,g=(0,i.getEnabledElement)(c),{renderingEngine:h}=g,u=new Set([m,t.metadata.toolName,n.metadata.toolName]);for(const e of u.values()){const t=(0,r.getViewportIdsWithToolToRender)(c,e);(0,a.triggerAnnotationRenderForViewportIds)(h,t)}}},60878:(e,t,n)=>{n.d(t,{tQ:()=>N,nm:()=>W,Gg:()=>B,ge:()=>k,_9:()=>O,kt:()=>v.A,bH:()=>s,qI:()=>S,sp:()=>D,Xm:()=>f,u1:()=>_,F_:()=>g,CG:()=>m});var i=n(81387),o=n(37054),a=n(65263);function r(e){e.removeEventListener("dblclick",i.A),e.removeEventListener("mousedown",o.Ay),e.removeEventListener("mousemove",a.A),e.removeEventListener("dblclick",o.DF,{capture:!0})}const s={enable:function(e){r(e),e.addEventListener("dblclick",i.A),e.addEventListener("mousedown",o.Ay),e.addEventListener("mousemove",a.A),e.addEventListener("dblclick",o.DF,{capture:!0})},disable:r};var l=n(38738),d=n(80285);function c(e){l.A.disable(e),e.removeEventListener("touchstart",d.A)}const g={enable:function(e){c(e),l.A.enable(e),e.addEventListener("touchstart",d.A,{passive:!1})},disable:c};var h=n(79445);function u(e){e.removeEventListener("wheel",h.A)}const m={enable:function(e){u(e),e.addEventListener("wheel",h.A,{passive:!1})},disable:u};var v=n(9147),p=n(49521);const f=function(e){const{toolGroupId:t}=e.detail;(0,p.Ay)(t)};var E=n(83946),I=n(30322),w=n(44656),C=n(52610);const T=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:i,type:o}=I.getSegmentation(t),a=I.getToolGroupIdsWithSegmentation(t),r=i[o];"volumeId"in r&&function({modifiedSlicesToUse:e,representationData:t,type:n}){const i=w.cache.getVolume(t[n].volumeId);if(!i)return void console.warn("segmentation not found in cache");const{imageData:o,vtkOpenGLTexture:a}=i;let r;if(e&&Array.isArray(e))r=e;else{const e=o.getDimensions()[2];r=[...Array(e).keys()]}r.forEach((e=>{a.setUpdatedFrame(e)})),o.modified()}({modifiedSlicesToUse:n,representationData:i,type:o}),"imageIdReferenceMap"in r&&function({toolGroupIds:e,segmentationId:t,representationData:n,type:i}){e.forEach((e=>{const o=I.getSegmentationRepresentations(e),a=(0,C.getToolGroup)(e).getViewportsInfo();o.forEach((e=>{e.segmentationId===t&&a.forEach((({viewportId:t,renderingEngineId:o})=>{const a=(0,w.getEnabledElementByIds)(t,o).viewport;if(a instanceof w.VolumeViewport)return;const r=a.getActor(e.segmentationRepresentationUID);if(!r)return;const s=a.getCurrentImageId(),l=r.actor.getMapper().getInputData(),{imageIdReferenceMap:d}=n[i],c=d.get(s),g=w.cache.getImage(c);l.modified(),w.utilities.updateVTKImageDataWithCornerstoneImage(l,g)}))}))}))}({toolGroupIds:a,segmentationId:t,representationData:i,type:o})},S=function(e){const{segmentationId:t}=e.detail,{type:n}=I.getSegmentation(t),i=I.getToolGroupIdsWithSegmentation(t);n===E.A.Labelmap&&T(e),i.forEach((e=>{(0,p.Ay)(e)}))},_=function(e){const{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;(0,p.Ay)(t)};var b=n(87682);const D=function(e){const{segmentationId:t}=e.detail;(0,I.getToolGroupIdsWithSegmentation)(t).forEach((e=>{(0,I.getSegmentationRepresentations)(e).forEach((n=>{n.segmentationId===t&&(0,b.triggerSegmentationRepresentationModified)(e,n.segmentationRepresentationUID)}))}))};var A=n(45128),y=n(51250),R=n(16124);const M=new Map;function x(e){const t=e.detail,{viewportId:n,renderingEngineId:i}=t,{viewport:o}=(0,w.getEnabledElementByIds)(n,i),a=(0,C.getToolGroupForViewport)(n,i);if(!a)return;let r=I.getSegmentationRepresentations(a.id)||[];if(r=r.filter((e=>e.type===E.A.Labelmap)),!r?.length)return;const s={};r.forEach((e=>{const t=I.getSegmentation(e.segmentationId);if(!t||!t.representationData?.LABELMAP)return;const n=t.representationData.LABELMAP;if((0,R.r)(n,o))return;const{imageIdReferenceMap:i}=n;s[e.segmentationRepresentationUID]={imageIdReferenceMap:i}}));const l=Object.keys(s),d=o.getCurrentImageId(),c=o.getActors();c.find((e=>!!l.includes(e.uid)))?c.forEach((t=>{if(!l.includes(t.uid))return;const n=t.actor,{imageIdReferenceMap:i}=s[t.uid],r=i.get(d),c=n.getMapper().getInputData();if(!r){if(c.setDerivedImage)return void c.setDerivedImage(null);const e=A.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:new Uint8Array(c.getNumberOfPoints())}),t=y.Ay.newInstance();return t.getPointData().setScalars(e),void n.getMapper().setInputData(t)}const g=w.cache.getImage(r),{dimensions:h,spacing:u,direction:m}=o.getImageDataMetadata(g),v=w.cache.getImage(d)||{imageId:d},{origin:f}=o.getImageDataMetadata(v),E=f;if(c.setOrigin(E),c.modified(),c.getDimensions()[0]!==h[0]||c.getDimensions()[1]!==h[1])return o.removeActors([t.uid]),o.addImages([{imageId:r,actorUID:t.uid,callback:({imageActor:e})=>{const t=A.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:[...g.getPixelData()]}),n=y.Ay.newInstance();n.setDimensions(h[0],h[1],1),n.setSpacing(u),n.setDirection(m),n.setOrigin(E),n.getPointData().setScalars(t),e.getMapper().setInputData(n)}}],!0,!1),void(0,p.Ay)(a.id);c.setDerivedImage?c.setDerivedImage(g):w.utilities.updateVTKImageDataWithCornerstoneImage(c,g),o.render(),e.type===w.Enums.Events.IMAGE_RENDERED&&o.element.removeEventListener(w.Enums.Events.IMAGE_RENDERED,x)})):M.has(a.id)||(M.set(a.id,!0),(0,p.Ay)(a.id))}const O={enable:function(e){const{viewport:t}=(0,w.getEnabledElement)(e);t instanceof w.BaseVolumeViewport||(e.addEventListener(w.Enums.Events.STACK_NEW_IMAGE,x),e.addEventListener(w.Enums.Events.IMAGE_RENDERED,x))},disable:function(e){e.removeEventListener(w.Enums.Events.STACK_NEW_IMAGE,x),e.removeEventListener(w.Enums.Events.IMAGE_RENDERED,x)}};var L=n(15916),P=n(90202);function N(e){const t=e.detail.annotation;L.isContourSegmentationAnnotation(t)&&(0,P.A)(e)}var U=n(21013);const k=function(e){if(!e.detail.removed.length)return;(0,w.getRenderingEngines)().forEach((e=>{const t=e.getViewports().map((e=>e.id));(0,U.triggerAnnotationRenderForViewportIds)(e,t)}))};var V=n(23072);const W=function(e){const{viewportId:t,renderingEngineId:n}=e.detail,i=(0,w.getRenderingEngine)(n);(0,V.A)(i,[t])};function B(e){const t=e.detail.annotation;L.isContourSegmentationAnnotation(t)&&function(e){const t=e.detail.annotation;(0,L.removeContourSegmentationAnnotation)(t)}(e)}},24542:(e,t,n)=>{n.r(t),n.d(t,{AdvancedMagnifyTool:()=>j.M$,AngleTool:()=>j.yT,AnnotationDisplayTool:()=>j.wh,AnnotationTool:()=>j.EC,ArrowAnnotateTool:()=>j.ao,BaseTool:()=>j.oS,BidirectionalTool:()=>j.Mu,BrushTool:()=>j.ls,CONSTANTS:()=>i,CircleROIStartEndThresholdTool:()=>j.pq,CircleROITool:()=>j.Vl,CircleScissorsTool:()=>j.G2,CobbAngleTool:()=>j.EV,CrosshairsTool:()=>j.ep,DragProbeTool:()=>j.j$,EllipticalROITool:()=>j.qD,Enums:()=>d,EraserTool:()=>j.dB,KeyImageTool:()=>j.Np,LengthTool:()=>j.LW,LivewireContourSegmentationTool:()=>j.Ix,LivewireContourTool:()=>j.Ys,MIPJumpToClickTool:()=>j.uJ,MagnifyTool:()=>j.eh,OrientationMarkerTool:()=>j.Xr,OverlayGridTool:()=>j.Nk,PaintFillTool:()=>j.Uj,PanTool:()=>j.CH,PlanarFreehandContourSegmentationTool:()=>j.PlanarFreehandContourSegmentationTool,PlanarFreehandROITool:()=>j.ex,PlanarRotateTool:()=>j.A5,ProbeTool:()=>j.N7,RectangleROIStartEndThresholdTool:()=>j.mX,RectangleROIThresholdTool:()=>j.TR,RectangleROITool:()=>j.E0,RectangleScissorsTool:()=>j.td,ReferenceCursors:()=>j.xI,ReferenceLines:()=>j.LL,ReferenceLinesTool:()=>j.X8,ScaleOverlayTool:()=>j.FE,SegmentSelectTool:()=>j.IX,SegmentationDisplayTool:()=>j.t0,SegmentationIntersectionTool:()=>j.cN,SphereScissorsTool:()=>j.zH,SplineContourSegmentationTool:()=>j.qT,SplineROITool:()=>j.J2,StackScrollMouseWheelTool:()=>j.uf,StackScrollTool:()=>j.ae,Synchronizer:()=>c.xW,SynchronizerManager:()=>c._K,ToolGroupManager:()=>c.dU,TrackballRotateTool:()=>j.So,Types:()=>a,UltrasoundDirectionalTool:()=>j.oi,VideoRedactionTool:()=>oe,VolumeRotateMouseWheelTool:()=>j.Y1,WindowLevelTool:()=>j.Du,ZoomTool:()=>j.OQ,addTool:()=>c.Gx,annotation:()=>z,cancelActiveManipulations:()=>c.BU,cursors:()=>$,destroy:()=>f,drawing:()=>q,init:()=>p,removeTool:()=>c.Bl,segmentation:()=>Z,state:()=>c.wk,synchronizers:()=>o,utilities:()=>P});var i={};n.r(i),n.d(i,{COLOR_LUT:()=>w.A});var o={};n.r(o),n.d(o,{createCameraPositionSynchronizer:()=>_,createImageSliceSynchronizer:()=>W,createPresentationViewSynchronizer:()=>A,createSlabThicknessSynchronizer:()=>F,createStackImageSynchronizer:()=>G,createVOISynchronizer:()=>R,createZoomPanSynchronizer:()=>O});var a={};n.r(a);var r=n(44656),s=n(38296),l=n(30322),d=n(84901),c=n(61738),g=n(55588),h=n(60878),u=n(44926),m=n(52610);let v=!1;function p(e={}){v||(!function(){E();const e=r.Enums.Events.ELEMENT_ENABLED,t=r.Enums.Events.ELEMENT_DISABLED;r.eventTarget.addEventListener(e,c.D0),r.eventTarget.addEventListener(t,c.kq),u.dj.enable()}(),I(),r.eventTarget.addEventListener(d.Events.ANNOTATION_COMPLETED,h.tQ),r.eventTarget.addEventListener(d.Events.ANNOTATION_MODIFIED,h.nm),r.eventTarget.addEventListener(d.Events.ANNOTATION_SELECTION_CHANGE,h.ge),r.eventTarget.addEventListener(d.Events.ANNOTATION_SELECTION_CHANGE,h.ge),r.eventTarget.addEventListener(d.Events.ANNOTATION_REMOVED,h.Gg),r.eventTarget.addEventListener(d.Events.SEGMENTATION_MODIFIED,h.sp),r.eventTarget.addEventListener(d.Events.SEGMENTATION_DATA_MODIFIED,h.qI),r.eventTarget.addEventListener(d.Events.SEGMENTATION_REPRESENTATION_MODIFIED,h.Xm),r.eventTarget.addEventListener(d.Events.SEGMENTATION_REPRESENTATION_REMOVED,h.u1),v=!0)}function f(){E(),I(),m.destroy(),(0,g.qh)();const e=(0,s.getAnnotationManager)(),t=(0,l.getDefaultSegmentationStateManager)();e.restoreAnnotations({}),t.resetState(),v=!1}function E(){const e=r.Enums.Events.ELEMENT_ENABLED,t=r.Enums.Events.ELEMENT_DISABLED;r.eventTarget.removeEventListener(e,c.D0),r.eventTarget.removeEventListener(t,c.kq),u.dj.disable()}function I(){r.eventTarget.removeEventListener(d.Events.ANNOTATION_COMPLETED,h.tQ),r.eventTarget.removeEventListener(d.Events.ANNOTATION_MODIFIED,h.nm),r.eventTarget.removeEventListener(d.Events.ANNOTATION_SELECTION_CHANGE,h.ge),r.eventTarget.removeEventListener(d.Events.ANNOTATION_SELECTION_CHANGE,h.ge),r.eventTarget.removeEventListener(d.Events.SEGMENTATION_MODIFIED,h.sp),r.eventTarget.removeEventListener(d.Events.SEGMENTATION_DATA_MODIFIED,h.qI),r.eventTarget.removeEventListener(d.Events.SEGMENTATION_REPRESENTATION_MODIFIED,h.Xm),r.eventTarget.removeEventListener(d.Events.SEGMENTATION_REPRESENTATION_REMOVED,h.u1)}var w=n(1904),C=n(45114);function T(e,t,n,i){const{camera:o}=i.detail,a=(0,r.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const s=a.getViewport(n.viewportId);s.setCamera(o),s.render()}const{CAMERA_MODIFIED:S}=r.Enums.Events;function _(e){return(0,C.createSynchronizer)(e,S,T)}function b(e,t,n,i,o){const a=(0,r.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const s=a.getViewport(n.viewportId),l=a.getViewport(t.viewportId).getViewPresentation(o);s.setView(null,l),s.render()}const{CAMERA_MODIFIED:D}=r.Enums.Events;function A(e,t){return(0,C.createSynchronizer)(e,D,b,t)}function y(e,t,n,i,o){const a=i.detail,{volumeId:s,range:l,invertStateChanged:d,invert:c,colormap:g}=a,h=(0,r.getRenderingEngine)(n.renderingEngineId);if(!h)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const u=h.getViewport(n.viewportId),m={voiRange:l};if(o?.syncInvertState&&d&&(m.invert=c),o?.syncColormap&&g&&(m.colormap=g),u instanceof r.BaseVolumeViewport){u._actors&&u._actors.size>1?u.setProperties(m,s):u.setProperties(m)}else{if(!(u instanceof r.StackViewport))throw new Error("Viewport type not supported.");u.setProperties(m)}u.render()}function R(e,t){t=Object.assign({syncInvertState:!0,syncColormap:!0},t);return(0,C.createSynchronizer)(e,r.Enums.Events.VOI_MODIFIED,y,{auxiliaryEventNames:[r.Enums.Events.COLORMAP_MODIFIED],...t})}function M(e,t,n){const i=(0,r.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=e.getOptions(n.viewportId),a=i.getViewport(n.viewportId),s=i.getViewport(t.viewportId);if(!1!==o?.syncZoom){const e=s.getZoom();a.setZoom(e)}if(!1!==o?.syncPan){const e=s.getPan();a.setPan(e)}a.render()}const{CAMERA_MODIFIED:x}=r.Enums.Events;function O(e){return(0,C.createSynchronizer)(e,x,M)}var L=n(44753),P=n(21013);const N=(e,t)=>r.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",e,t);async function U(e,t,n){const i=(0,r.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=i.getViewport(t.viewportId),a=e.getOptions(n.viewportId);if(a?.disabled)return;const s=i.getViewport(n.viewportId),l=o.getCurrentImageId(),d=r.metaData.get("imagePlaneModule",l).imagePositionPatient,c=s.getImageIds();if(!function(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:i}=t.getCamera(),o=L.eR.dot(n,i);return Math.abs(o)>.9}(o,s))return;let g=N(n.viewportId,t.viewportId);if(!g){if(o.getFrameOfReferenceUID()===s.getFrameOfReferenceUID()&&!1!==a?.useInitialPosition?g=L.pB.identity(L.pB.create()):(r.utilities.calculateViewportsSpatialRegistration(o,s),g=N(n.viewportId,t.viewportId)),!g)return}const h=L.eR.transformMat4(L.eR.create(),d,g),u=(m=h,c.reduce(((e,t,n)=>{const{imagePositionPatient:i}=r.metaData.get("imagePlaneModule",t),o=L.eR.distance(i,m);return o<e.distance?{distance:o,index:n}:e}),{distance:1/0,index:-1}));var m;let v=u.index;s instanceof r.VolumeViewport&&(v=c.length-u.index-1),-1!==u.index&&s.getCurrentImageIdIndex()!==u.index&&await(0,P.jumpToSlice)(s.element,{imageIndex:v})}const{STACK_NEW_IMAGE:k,VOLUME_NEW_IMAGE:V}=r.Enums.Events;function W(e){return(0,C.createSynchronizer)(e,k,U,{auxiliaryEventNames:[V]})}function B(e,t,n){const i=(0,r.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=i.getViewport(n.viewportId),a=i.getViewport(t.viewportId),s=a.getSlabThickness?.();s&&(o.setSlabThickness?.(s),o.render())}const{CAMERA_MODIFIED:H}=r.Enums.Events;function F(e){return(0,C.createSynchronizer)(e,H,B)}const G=W;var q=n(2746),$=n(32916),z=n(45200),Z=n(63421),j=n(94152),K=n(96214),Y=n(21090),X=n(95778),J=n(90252),Q=n(23345),ee=n(40233),te=n(23072),ne=n(31970);class ie extends K.EC{constructor(e={}){super(e,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,r.getEnabledElement)(i),{viewport:s,renderingEngine:l}=a;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,o,c,g),u={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:h,toolName:this.getToolName()},data:{invalidated:!0,handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},active:!0}};(0,X.lC)(u,i);const m=(0,J.getViewportIdsWithToolToRender)(i,this.getToolName(),!1);return this.editData={annotation:u,viewportUIDsToRender:m,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,ee.hideElementCursor)(i),e.preventDefault(),(0,te.A)(l,m),u},this.getHandleNearImagePoint=(e,t,n,i)=>{const o=(0,r.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:l}=s.handles;for(let e=0;e<l.length;e++){const t=l[e],o=a.worldToCanvas(t);if(!0===L.Zc.distance(n,o)<i)return s.handles.activeHandleIndex=e,t}s.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,i)=>{const o=(0,r.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:l}=s.handles,d=a.worldToCanvas(l[0]),c=a.worldToCanvas(l[3]),g=this._getRectangleImageCoordinates([d,c]),h=[n[0],n[1]],{left:u,top:m,width:v,height:p}=g;if(Q.distanceToPoint([u,m,v,p],h)<=i)return!0},this.toolSelectedCallback=(e,t,n="mouse")=>{const i=e.detail,{element:o}=i,{data:a}=t;a.active=!0;const s=(0,J.getViewportIdsWithToolToRender)(o,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:s},this._activateModify(o),(0,ee.hideElementCursor)(o);const l=(0,r.getEnabledElement)(o),{renderingEngine:d}=l;(0,te.A)(d,s),e.preventDefault()},this.handleSelectedCallback=(e,t,n,i="mouse")=>{const o=e.detail,{element:a}=o,{data:s}=t;s.active=!0;let l,d=!1;n.worldPosition?d=!0:l=s.handles.points.findIndex((e=>e===n));const c=(0,J.getViewportIdsWithToolToRender)(a,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:c,handleIndex:l},this._activateModify(a),(0,ee.hideElementCursor)(a);const g=(0,r.getEnabledElement)(a),{renderingEngine:h}=g;(0,te.A)(h,c),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:l}=i;if(a&&!s)return;l.active=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,ee.resetElementCursor)(n);const d=(0,r.getEnabledElement)(n),{renderingEngine:c}=d;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,X.O8)(i.annotationUID),(0,te.A)(c,o)},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:o,handleIndex:a}=this.editData,{data:s}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:i}=s.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),s.invalidated=!0}else{const{currentPoints:e}=t,i=(0,r.getEnabledElement)(n),{worldToCanvas:o,canvasToWorld:l}=i.viewport,d=e.world,{points:c}=s.handles;let g,h,u,m,v,p,f,E;switch(c[a]=[...d],a){case 0:case 3:g=o(c[0]),m=o(c[3]),h=[m[0],g[1]],u=[g[0],m[1]],p=l(h),f=l(u),c[1]=p,c[2]=f;break;case 1:case 2:h=o(c[1]),u=o(c[2]),g=[u[0],h[1]],m=[h[0],u[1]],v=l(g),E=l(m),c[0]=v,c[3]=E}s.invalidated=!0}this.editData.hasMoved=!0;const l=(0,r.getEnabledElement)(n),{renderingEngine:d}=l;(0,te.A)(d,o)},this._activateDraw=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(d.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(d.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(d.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(d.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(d.Events.TOUCH_END,this._mouseUpCallback),e.addEventListener(d.Events.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateDraw=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(d.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(d.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(d.Events.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(d.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(d.Events.TOUCH_END,this._mouseUpCallback),e.removeEventListener(d.Events.TOUCH_DRAG,this._mouseDragCallback)},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(d.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(d.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(d.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(d.Events.TOUCH_END,this._mouseUpCallback),e.addEventListener(d.Events.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(d.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(d.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(d.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(d.Events.TOUCH_END,this._mouseUpCallback),e.removeEventListener(d.Events.TOUCH_DRAG,this._mouseDragCallback)},this.renderAnnotation=(e,t)=>{const n=!1,{viewport:i}=e,{element:o}=i;let a=(0,X.Rh)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;this.getTargetId(i),i.getRenderingEngine();const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const n=a[e],{annotationUID:o}=n,s=(n.metadata,n.data),{points:l,activeHandleIndex:d}=s.handles,c=l.map((e=>i.worldToCanvas(e))),g=this.getStyle("lineWidth",r,n),h=this.getStyle("lineDash",r,n),u=this.getStyle("color",r,n);if(!i.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let m;if(this.editData||null===d||(m=[c[d]]),m){const e="0";(0,q.drawHandles)(t,o,e,m,{color:u})}const v="0";(0,q.drawRedactionRect)(t,o,v,c[0],c[3],{color:"black",lineDash:h,lineWidth:g})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{const{data:a}=e,{viewportUID:s,renderingEngineUID:l,sceneUID:c}=o,g=a.handles.points[0],h=a.handles.points[3],{cachedStats:u}=a,m=Object.keys(u);for(let e=0;e<m.length;e++){const o=m[e],{imageVolume:a}=this._getImageVolumeFromTargetUID(o,i),{dimensions:r,scalarData:s,vtkImageData:l,metadata:d}=a,c=L.eR.fromValues(0,0,0),v=L.eR.fromValues(0,0,0);if(l.worldToIndexVec3(g,c),c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]),l.worldToIndexVec3(h,v),v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),this._isInsideVolume(c,v,r)){this.isHandleOutsideImage=!1;const e=Math.min(c[0],v[0]),i=Math.max(c[0],v[0]),a=Math.min(c[1],v[1]),l=Math.max(c[1],v[1]),m=Math.min(c[2],v[2]),p=Math.max(c[2],v[2]),{worldWidth:f,worldHeight:E}=(0,ne.A)(t,n,g,h),I=f*E;let w=0,C=0,T=0;const S=r[0],_=r[0]*r[1];for(let t=m;t<=p;t++)for(let n=a;n<=l;n++)for(let o=e;o<=i;o++){w++,C+=s[t*_+n*S+o]}C/=w;for(let t=m;t<=p;t++)for(let n=a;n<=l;n++)for(let o=e;o<=i;o++){const e=s[t*_+n*S+o]-C;T+=e*e}T/=w,T=Math.sqrt(T),u[o]={Modality:d.Modality,area:I,mean:C,stdDev:T}}else this.isHandleOutsideImage=!0,u[o]={Modality:d.Modality}}a.invalidated=!1;const v=d.Events.ANNOTATION_MODIFIED,p={annotation:e,viewportUID:s,renderingEngineUID:l,sceneUID:c};return(0,r.triggerEvent)(r.eventTarget,v,p),u},this._isInsideVolume=(e,t,n)=>r.utilities.indexWithinDimensions(e,n)&&r.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=(0,Y.A)(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,ee.resetElementCursor)(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:i}=t;i.active=!1,i.handles.activeHandleIndex=null;const o=(0,r.getEnabledElement)(e),{renderingEngine:a}=o;return(0,te.A)(a,n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const i=e.indexOf(":"),o=e.substring(i+1);n=t.getViewport(o).getImageData()}else n=r.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}ie.toolName="VideoRedaction";const oe=ie},22581:(e,t,n)=>{n.d(t,{A:()=>c,H:()=>d});var i=n(48463),o=n.n(i),a=n(44656),r=n(48428),s=n(21009);class l{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,a.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,i=this.annotations[n];i&&Object.keys(i).forEach((e=>{i[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]?n[e][t]:[]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){const n=i[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(const e in n)i+=n[e].length;return i},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:i,toolName:o}=n;t=t||i;const a=this.annotations;let l=a[t];l||(a[t]={},l=a[t]);let d=l[o];d||(l[o]=[],d=l[o]),d.push(e),(0,r.checkAndDefineIsLockedProperty)(e),(0,s.checkAndDefineIsVisibleProperty)(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const i=t[n];for(const t in i){const n=i[t],o=n.findIndex((t=>t.annotationUID===e));-1!==o&&(n.splice(o,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const i=n[e];if(!i)return;const a=i[t];return o()(a)}if(e){const t=n[e];return o()(t)}return o()(n)},this.restoreAnnotations=(e,t,n)=>{const i=this.annotations;if(t&&n){let o=i[t];o||(i[t]={},o=i[t]),o[n]=e}else t?i[t]=e:this.annotations=o()(e)},this.getAllAnnotations=()=>Object.values(this.annotations).map((e=>Object.values(e))).flat(2),this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){e+=i[t].length}}return e},this.removeAllAnnotations=()=>{this.annotations={}},e||(e=a.utilities.uuidv4()),this.annotations={},this.uid=e,a.eventTarget.addEventListener(a.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}const d=new l("DEFAULT"),c=l},48428:(e,t,n)=>{n.r(t),n.d(t,{checkAndDefineIsLockedProperty:()=>g,getAnnotationsLocked:()=>l,getAnnotationsLockedCount:()=>c,isAnnotationLocked:()=>d,setAnnotationLocked:()=>r,unlockAllAnnotations:()=>s});var i=n(44656),o=n(84901);const a=new Set;function r(e,t=!0){const n=h();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,a,n):u(e,a,n)),m(n,a)}function s(){const e=h();!function(e,t){e.forEach((n=>{u(n,e,t)}))}(a,e),m(e,a)}function l(){return Array.from(a)}function d(e){return a.has(e)}function c(){return a.size}function g(e){if(e){const t=!!e.isLocked;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isLocked");if(t)return t.configurable&&(t.set!==v||t.get!==p);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:v,get:p}),r(e,t)}}function h(){return Object.freeze({added:[],removed:[],locked:[]})}function u(e,t,n){t.delete(e)&&n.removed.push(e)}function m(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_LOCK_CHANGE,e))}function v(e){r(this,e)}function p(){return d(this)}},42351:(e,t,n)=>{n.r(t),n.d(t,{deselectAnnotation:()=>l,getAnnotationsSelected:()=>d,getAnnotationsSelectedByToolName:()=>c,getAnnotationsSelectedCount:()=>h,isAnnotationSelected:()=>g,setAnnotationSelected:()=>s});var i=n(44656),o=n(84901),a=n(38296);const r=new Set;function s(e,t=!0,n=!1){t?function(e,t=!1){const n=u();t||m(r,n);e&&!r.has(e)&&(r.add(e),n.added.push(e));v(n,r)}(e,n):l(e)}function l(e){const t=u();e?r.delete(e)&&t.removed.push(e):m(r,t),v(t,r)}function d(){return Array.from(r)}function c(e){return d().filter((t=>{const n=(0,a.getAnnotation)(t);return n?.metadata?.toolName===e}))}function g(e){return r.has(e)}function h(){return r.size}function u(){return Object.freeze({added:[],removed:[],selection:[]})}function m(e,t){e.forEach((n=>{e.delete(n)&&t.removed.push(n)}))}function v(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_SELECTION_CHANGE,e))}},38296:(e,t,n)=>{n.r(t),n.d(t,{addAnnotation:()=>f,addChildAnnotation:()=>m,clearParentAnnotation:()=>u,getAllAnnotations:()=>h,getAnnotation:()=>w,getAnnotationManager:()=>l,getAnnotations:()=>g,getChildAnnotations:()=>p,getNumberOfAnnotations:()=>E,getParentAnnotation:()=>v,invalidateAnnotation:()=>T,removeAllAnnotations:()=>C,removeAnnotation:()=>I,resetAnnotationManager:()=>c,setAnnotationManager:()=>d});var i=n(44656),o=n(84901),a=n(22581),r=n(54177);let s=a.H;function l(){return s}function d(e){s=e}function c(){s=a.H}function g(e,t){const n=l(),i=n.getGroupKey(t);return n.getAnnotations(i,e)}function h(){return l().getAllAnnotations()}function u(e){const{annotationUID:t,parentAnnotationUID:n}=e;if(!n)return;const i=w(n),o=i.childAnnotationUIDs.indexOf(t);i.childAnnotationUIDs.splice(o,1),e.parentAnnotationUID=void 0}function m(e,t){const{annotationUID:n}=e,{annotationUID:i}=t;u(t),e.childAnnotationUIDs||(e.childAnnotationUIDs=[]),e.childAnnotationUIDs.includes(i)||(e.childAnnotationUIDs.push(i),t.parentAnnotationUID=n)}function v(e){return e.parentAnnotationUID?w(e.parentAnnotationUID):void 0}function p(e){return e.childAnnotationUIDs?.map((e=>w(e)))??[]}function f(e,t){e.annotationUID||(e.annotationUID=i.utilities.uuidv4());const n=l();if(t instanceof HTMLDivElement){const i=n.getGroupKey(t);n.addAnnotation(e,i),(0,r.$f)(e,t)}else n.addAnnotation(e),(0,r._3)(e);return e.annotationUID}function E(e,t){const n=l(),i=n.getGroupKey(t);return n.getNumberOfAnnotations(i,e)}function I(e){if(!e)return;const t=l(),n=t.getAnnotation(e);if(!n)return;n.childAnnotationUIDs?.forEach((e=>I(e))),t.removeAnnotation(e);const a=o.Events.ANNOTATION_REMOVED,r={annotation:n,annotationManagerUID:t.uid};(0,i.triggerEvent)(i.eventTarget,a,r)}function w(e){return l().getAnnotation(e)}function C(){l().removeAllAnnotations()}function T(e){let t=e;for(;t;)t.invalidated=!0,t=t.parentAnnotationUID?w(t.parentAnnotationUID):void 0}},21009:(e,t,n)=>{n.r(t),n.d(t,{checkAndDefineIsVisibleProperty:()=>g,isAnnotationVisible:()=>c,setAnnotationVisibility:()=>l,showAllAnnotations:()=>d});var i=n(44656),o=n(38296),a=n(84901),r=n(42351);const s=new Set;function l(e,t=!0){const n=h();e&&(t?u(e,s,n):function(e,t,n){t.has(e)||(t.add(e),(0,r.isAnnotationSelected)(e)&&(0,r.deselectAnnotation)(e),n.lastHidden.push(e))}(e,s,n)),m(n)}function d(){const e=h();s.forEach((t=>{u(t,s,e)})),m(e)}function c(e){if((0,o.getAnnotation)(e))return!s.has(e)}function g(e){if(e){const t=e.isVisible??!0;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isVisible");if(t)return t.configurable&&(t.set!==v||t.get!==p);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:v,get:p}),l(e.annotationUID,t)}}function h(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function u(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function m(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(s.forEach((t=>{e.hidden.push(t)})),(0,i.triggerEvent)(i.eventTarget,a.Events.ANNOTATION_VISIBILITY_CHANGE,e))}function v(e){l(this.annotationUID,e)}function p(){return c(this.annotationUID)}},31862:(e,t,n)=>{n.d(t,{A:()=>i});const i=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:i,toolGroupId:o,toolName:a}=t;return this._getToolStyle(e,n,i,o,a)}_getToolStyle(e,t,n,i,o){if(t){const n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(i){const t=this.getToolGroupToolStyles(i);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[o]&&void 0!==a[o][e]?a[o][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}}},28664:(e,t,n)=>{n.d(t,{h:()=>o});var i=n(31862);function o(e,t,n,o){const a=function(e,t,n){const i=[`${e}`];return t&&i.push(`${i[0]}${t}`),n&&i.push(`${i[i.length-1]}${n}`),i}(e,n,o);for(let e=a.length-1;e>=0;--e){const n=i.A.getStyleProperty(a[e],t);if(void 0!==n)return n}}},17264:(e,t,n)=>{n.r(t),n.d(t,{getFont:()=>l,getState:()=>r,style:()=>d.A});var i=n(48428),o=n(42351),a=n(84901);const r=function(e){if(e){if(e.data&&e.highlighted)return a.AnnotationStyleStates.Highlighted;if((0,o.isAnnotationSelected)(e.annotationUID))return a.AnnotationStyleStates.Selected;if((0,i.isAnnotationLocked)(e))return a.AnnotationStyleStates.Locked;if(e.data&&e.autoGenerated)return a.AnnotationStyleStates.AutoGenerated}return a.AnnotationStyleStates.Default};var s=n(28664);const l=function(e,t,n){return`${(0,s.h)("textBoxFontSize",e,t,n)}px ${(0,s.h)("textBoxFontFamily",e,t,n)}`};var d=n(31862)},54177:(e,t,n)=>{n.d(t,{$f:()=>r,PS:()=>c,XF:()=>l,_3:()=>s,dZ:()=>d});var i=n(44656),o=n(84901),a=n(52610);function r(e,t){const n=(0,i.getEnabledElement)(t),{renderingEngine:a,viewportId:r}=n,s=o.Events.ANNOTATION_ADDED,l={annotation:e,viewportId:r,renderingEngineId:a.id};(0,i.triggerEvent)(i.eventTarget,s,l)}function s(e){const{toolName:t}=e.metadata,n=(0,a.getToolGroupsWithToolName)(t);if(!n.length)return;const r=[];n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:o}=t,{FrameOfReferenceUID:a}=(0,i.getEnabledElementByIds)(o,n);e.metadata.FrameOfReferenceUID===a&&r.push(t)}))}));const s=o.Events.ANNOTATION_ADDED,l={annotation:e};r.length?r.forEach((({renderingEngineId:e,viewportId:t})=>{l.viewportId=t,l.renderingEngineId=e,(0,i.triggerEvent)(i.eventTarget,s,l)})):(0,i.triggerEvent)(i.eventTarget,s,l)}function l(e,t,n=o.ChangeTypes.HandlesUpdated){const a=(0,i.getEnabledElement)(t),{viewportId:r,renderingEngineId:s}=a,l=o.Events.ANNOTATION_MODIFIED,d={annotation:e,viewportId:r,renderingEngineId:s,changeType:n};(0,i.triggerEvent)(i.eventTarget,l,d)}function d(e){g({annotation:e})}function c(e,t=!1){g({annotation:e,contourHoleProcessingEnabled:t})}function g(e){const t=o.Events.ANNOTATION_COMPLETED;(0,i.triggerEvent)(i.eventTarget,t,e)}},45200:(e,t,n)=>{n.r(t),n.d(t,{AnnotationGroup:()=>g,FrameOfReferenceSpecificAnnotationManager:()=>l.A,config:()=>i,locking:()=>o,selection:()=>a,state:()=>r,visibility:()=>s});var i=n(17264),o=n(48428),a=n(42351),r=n(38296),s=n(21009),l=n(22581),d=n(44656),c=n(28117);class g{constructor(){this.annotationUIDs=new Set,this._isVisible=!0,this.visibleFilter=this.unboundVisibleFilter.bind(this)}unboundVisibleFilter(e){return!this._isVisible||!this.annotationUIDs.has(e)}has(e){return this.annotationUIDs.has(e)}setVisible(e=!0,t,n){this._isVisible!==e&&(this._isVisible=e,this.annotationUIDs.forEach((i=>{const o=(0,r.getAnnotation)(i);if(!o)return void this.annotationUIDs.delete(i);if(o.isVisible===e)return;if(!e&&!1===n?.(i))return;o.isVisible=e;const a={...t,annotation:o};(0,d.triggerEvent)(d.eventTarget,c.A.ANNOTATION_MODIFIED,a)})))}get isVisible(){return this._isVisible}findNearby(e,t){const n=[...this.annotationUIDs];if(0===n.length)return null;if(!e)return n[1===t?0:n.length-1];const i=n.indexOf(e);return-1===i||i+t<0||i+t>=n.length?null:n[i+t]}add(...e){e.forEach((e=>this.annotationUIDs.add(e)))}remove(...e){e.forEach((e=>this.annotationUIDs.delete(e)))}clear(){this.annotationUIDs.clear()}}},71065:(e,t,n)=>{n.r(t),n.d(t,{getActiveSegmentation:()=>r,getActiveSegmentationRepresentation:()=>a,setActiveSegmentationRepresentation:()=>s});var i=n(30322),o=n(87682);function a(e){const t=(0,i.getDefaultSegmentationStateManager)().getSegmentationRepresentations(e);if(!t)return;return t.find((e=>e.active))}function r(e){const t=a(e);if(!t)return;return(0,i.getSegmentation)(t.segmentationId)}function s(e,t){(0,i.getDefaultSegmentationStateManager)().setActiveSegmentationRepresentation(e,t),(0,o.triggerSegmentationRepresentationModified)(e,t)}},23308:(e,t,n)=>{n.r(t),n.d(t,{getSegmentVisibility:()=>c,getSegmentationVisibility:()=>s,setSegmentVisibility:()=>d,setSegmentationVisibility:()=>r,setSegmentsVisibility:()=>l});var i=n(30322),o=n(96638),a=n(87682);function r(e,t,n){const r=(0,i.getSegmentationRepresentations)(e);if(!r)return;const s=r.find((e=>e.segmentationRepresentationUID===t));if(!s)return;const{segmentsHidden:l,segmentationId:d}=s,c=(0,o.getUniqueSegmentIndices)(d);n?l.clear():c.forEach((e=>{l.add(e)})),(0,a.triggerSegmentationRepresentationModified)(e,s.segmentationRepresentationUID)}function s(e,t){const n=(0,i.getSegmentationRepresentations)(e).find((e=>e.segmentationRepresentationUID===t));if(!n)return;const{segmentsHidden:a,segmentationId:r}=n,s=(0,o.getUniqueSegmentIndices)(r),l=new Set(s);return a.forEach((e=>l.delete(e))),!!l.size}function l(e,t,n,o){const r=i.getSegmentationRepresentationByUID(e,t);r&&(n.forEach((e=>{o?r.segmentsHidden.delete(e):r.segmentsHidden.add(e)})),(0,a.triggerSegmentationRepresentationModified)(e,t))}function d(e,t,n,o){const r=i.getSegmentationRepresentationByUID(e,t);r&&(o?r.segmentsHidden.delete(n):r.segmentsHidden.add(n),(0,a.triggerSegmentationRepresentationModified)(e,t))}function c(e,t,n){const o=i.getSegmentationRepresentationByUID(e,t);return!!o&&!o.segmentsHidden.has(n)}},58555:(e,t,n)=>{n.d(t,{NL:()=>g,jU:()=>h});var i=n(44656),o=n(84901),a=n(21013),r=n(65807);const s=(0,i.getWebWorkerManager)(),l=new Map,d=new Map,c=(e,t)=>{(0,i.triggerEvent)(e,i.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:o.WorkerTypes.SURFACE_CLIPPING})};async function g(e,t,n){(0,r.b)();const o=t.getSlicesClippingPlanes?.();if(!o)return;const g=t.getSliceIndex();o.sort(((e,t)=>Math.abs(e.sliceIndex-g)-Math.abs(t.sliceIndex-g))),c(i.eventTarget,0),await async function(e){const t=e.filter((e=>!d.has(e.id)));if(!t.length)return;const n=await s.executeTask("polySeg","getSurfacesAABBs",{surfacesInfo:t},{callbacks:[({progress:e})=>{c(i.eventTarget,e)}]});n.forEach(((e,t)=>{d.set(t,e)}))}(e);const h=new Map;e.forEach((e=>{h.set(e.id,d.get(e.id))}));const u=t.getCamera();return await s.executeTask("polySeg","cutSurfacesIntoPlanes",{surfacesInfo:e,planesInfo:o,surfacesAABB:h},{callbacks:[({progress:e})=>{c(i.eventTarget,e)},({sliceIndex:e,polyDataResults:i})=>{i.forEach(((i,o)=>{const r=`${n}_${o}`,s=function(e,t,n){return`${e.id}-${(0,a.pointToString)(t)}-${n}`}(t,u.viewPlaneNormal,e);!function(e,t,n){const{points:i,lines:o,numberOfCells:a}=n;let r=l.get(e);r||(r=new Map,l.set(e,r));r.set(t,{points:i,lines:o,numberOfCells:a})}(r,s,i)}))}]}).catch((e=>{console.error(e)})),c(i.eventTarget,1),l}function h(e,t){return`${e}_${t}`}},63421:(e,t,n)=>{n.r(t),n.d(t,{activeSegmentation:()=>G,addRepresentationData:()=>U,addSegmentationRepresentations:()=>N,addSegmentations:()=>f,config:()=>a,convertStackToVolumeSegmentation:()=>B,convertVolumeToStackSegmentation:()=>F,polySeg:()=>r,removeSegmentationsFromToolGroup:()=>g,segmentIndex:()=>J,segmentLocking:()=>i,state:()=>c,triggerSegmentationEvents:()=>V});var i={};n.r(i),n.d(i,{getLockedSegments:()=>z,isSegmentIndexLocked:()=>q,setSegmentIndexLocked:()=>$});var o={};n.r(o),n.d(o,{addColorLUT:()=>Z,getColorForSegmentIndex:()=>K,setColorForSegmentIndex:()=>Y,setColorLUT:()=>j});var a={};n.r(a),n.d(a,{color:()=>o,getGlobalConfig:()=>w,getGlobalRepresentationConfig:()=>T,getSegmentSpecificConfig:()=>y,getSegmentationRepresentationSpecificConfig:()=>D,getToolGroupSpecificConfig:()=>_,setGlobalConfig:()=>C,setGlobalRepresentationConfig:()=>S,setSegmentSpecificConfig:()=>R,setSegmentationRepresentationSpecificConfig:()=>A,setToolGroupSpecificConfig:()=>b,visibility:()=>X});var r={};n.r(r),n.d(r,{canComputeRequestedRepresentation:()=>xe,computeAndAddContourRepresentation:()=>Re,computeAndAddLabelmapRepresentation:()=>Se,computeAndAddSurfaceRepresentation:()=>he});var s=n(83946),l=n(94318),d=n(2884),c=n(30322);const g=function(e,t,n){const i=(0,c.getSegmentationRepresentations)(e);if(!i||0===i.length)return;const o=i.map((e=>e.segmentationRepresentationUID));let a=t;if(a){const e=t.filter((e=>!o.includes(e)));if(e.length>0)throw new Error(`The following segmentationRepresentationUIDs are not part of the toolGroup: ${JSON.stringify(e)}`)}else a=o;a.forEach((t=>{!function(e,t,n){const i=(0,c.getSegmentationRepresentationByUID)(e,t),{type:o}=i;if(o===s.A.Labelmap)l.Zy.removeSegmentationRepresentation(e,t,n);else{if(o!==s.A.Contour)throw new Error(`The representation ${o} is not supported yet`);d.T.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))};var h=n(48463),u=n.n(h),m=n(84901),v=n(11654);const p=function(e){if(!e||0===e.length)throw new Error("The segmentationInputArray is undefined or an empty array");e.forEach((e=>{if(void 0===e.segmentationId)throw new Error("Undefined segmentationInput.segmentationId. Please provide a valid segmentationId");if(void 0===e.representation)throw new Error("Undefined segmentationInput.representation. Please provide a valid representation");e.representation.type===m.SegmentationRepresentations.Labelmap&&(0,v.y)(e)}))};const f=function(e){p(e),e.map((e=>{const t=u()(e);(0,c.addSegmentation)(t)}))};var E=n(52610),I=n(44656);function w(){return c.getGlobalConfig()}function C(e){c.setGlobalConfig(e)}function T(e){return w().representations[e]}function S(e,t){const n=w();C({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function _(e){return c.getToolGroupSpecificConfig(e)}function b(e,t){c.setToolGroupSpecificConfig(e,t)}function D(e,t){return c.getSegmentationRepresentationSpecificConfig(e,t)}function A(e,t,n){c.setSegmentationRepresentationSpecificConfig(e,t,n)}function y(e,t,n){return c.getSegmentSpecificRepresentationConfig(e,t,n)}function R(e,t,n){c.setSegmentSpecificRepresentationConfig(e,t,n)}var M=n(44956);function x(e){const{type:t}=e;return t===s.A.Labelmap?(0,M.iA)():{}}var O=n(1904),L=n(21013);async function P(e,t,n){const{segmentationId:i,options:o={}}=t,a=t.options?.segmentationRepresentationUID||I.utilities.uuidv4(),r=new Set,s=function(e={}){const t=e.colorLUTOrIndex;let n;if("number"==typeof t)n=t;else{const e=(0,c.getNextColorLUTIndex)(),i=Array.isArray(t)?t:O.A;(0,c.addColorLUT)(i,e),n=e}return n}(o),l={segmentationId:i,segmentationRepresentationUID:a,type:t.type,segmentsHidden:r,colorLUTIndex:s,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:x(t),polySeg:o.polySeg};if(n){const t=_(e),i=I.utilities.deepMerge(t,n);b(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return(0,c.addSegmentationRepresentation)(e,l),t.type===m.SegmentationRepresentations.Contour&&(0,E.getToolGroup)(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const n=(0,I.getRenderingEngine)(t);(0,L.triggerAnnotationRenderForViewportIds)(n,[e])})),a}const N=async function(e,t,n){if(!(0,E.getToolGroup)(e))throw new Error(`No tool group found for toolGroupId: ${e}`);const i=t.map((t=>P(e,t,n)));return await Promise.all(i)};const U=function({segmentationId:e,type:t,data:n}){const i=(0,c.getSegmentation)(e);switch(i.representationData[t]&&console.warn(`Representation data of type ${t} already exists for segmentation ${e}, overwriting it.`),t){case s.A.Labelmap:case s.A.Contour:case s.A.Surface:n&&(i.representationData[t]=n);break;default:throw new Error(`Invalid representation type ${t}`)}};var k=n(96638),V=n(87682);async function W({imageIdReferenceMap:e,options:t}){const n=Array.from(e.values()),i={imageIdReferenceMap:e},o=t?.volumeId??I.utilities.uuidv4();return await I.volumeLoader.createAndCacheVolumeFromImages(o,n,{additionalDetails:i}),{volumeId:o}}async function B({segmentationId:e,options:t}){const n=(0,c.getSegmentation)(e).representationData.LABELMAP,{volumeId:i}=await W({imageIdReferenceMap:n.imageIdReferenceMap,options:t});await async function({segmentationId:e,toolGroupId:t,volumeId:n,options:i}){const o=(0,c.getSegmentation)(e);if(i?.removeOriginal){const e=o.representationData.LABELMAP.imageIdReferenceMap;Array.from(e.values()).forEach((e=>{I.cache.removeImageLoadObject(e)})),o.representationData.LABELMAP={volumeId:n}}else o.representationData.LABELMAP={...o.representationData.LABELMAP,volumeId:n};await N(t,[{segmentationId:e,type:m.SegmentationRepresentations.Labelmap}]),(0,k.triggerSegmentationRender)(t),I.eventTarget.addEventListenerOnce(m.Events.SEGMENTATION_RENDERED,(()=>(0,V.triggerSegmentationDataModified)(e)))}({segmentationId:e,toolGroupId:t.toolGroupId,options:t,volumeId:i})}async function H({volumeId:e}){const t=I.cache.getVolume(e);let n=!1;t.imageCacheOffsetMap.size>0&&(n=t.imageIds.every((e=>I.cache.getImage(e))));const i=(0,I.getRenderingEngines)()[0].getVolumeViewports().find((t=>t.hasVolumeId(e)));t.decache(!i&&n);const o=function(e){if(e.additionalDetails?.imageIdReferenceMap)return e.additionalDetails.imageIdReferenceMap;if(e.referencedImageIds?.length&&!e.referencedImageIds[0].startsWith("derived")){const t=e.referencedImageIds,n=e.imageIds;return(0,k.createImageIdReferenceMap)(t,[...n].reverse())}{const t=e.referencedVolumeId,n=I.cache.getVolume(t);if(!n)throw new Error("Cannot convert volumetric segmentation without referenced volume to stack segmentation yet");if(!n?.imageIds?.length)throw new Error("Cannot convert volumetric segmentation without imageIds to stack segmentation yet");if(n.imageIds?.[0].startsWith("derived"))throw new Error("Cannot convert volume segmentation that is derived from another segmentation\n         to stack segmentation yet, include the additionalDetails.imageIdReferenceMap\n         in the volume segmentation in case you need it for the conversion");const i=n.imageIds;let o=e.imageIds;return o?.length||(o=e.convertToImageSlicesAndCache()),(0,k.createImageIdReferenceMap)(i,[...o].reverse())}}(t);return{imageIdReferenceMap:o}}async function F({segmentationId:e,options:t}){const n=(0,c.getSegmentation)(e).representationData.LABELMAP,{imageIdReferenceMap:i}=await H({volumeId:n.volumeId});await async function({segmentationId:e,toolGroupId:t,imageIdReferenceMap:n,options:i}){const o=(0,c.getSegmentation)(e);if(i?.removeOriginal){const e=o.representationData.LABELMAP;I.cache.getVolume(e.volumeId)&&I.cache.removeVolumeLoadObject(e.volumeId),o.representationData.LABELMAP={imageIdReferenceMap:n}}else o.representationData.LABELMAP={...o.representationData.LABELMAP,imageIdReferenceMap:n};await N(t,[{segmentationId:e,type:m.SegmentationRepresentations.Labelmap}]),(0,k.triggerSegmentationRender)(t),I.eventTarget.addEventListenerOnce(m.Events.SEGMENTATION_RENDERED,(()=>(0,V.triggerSegmentationDataModified)(e)))}({segmentationId:e,toolGroupId:t.toolGroupId,imageIdReferenceMap:i,options:t})}var G=n(71065);function q(e,t){const n=(0,c.getSegmentation)(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:i}=n;return i.has(t)}function $(e,t,n=!0){const i=(0,c.getSegmentation)(e);if(!i)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:o}=i;n?o.add(t):o.delete(t),(0,V.triggerSegmentationModified)(e)}function z(e){const t=(0,c.getSegmentation)(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:n}=t;return Array.from(n)}function Z(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");I.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),c.addColorLUT(e,t)}function j(e,t,n){const i=c.getSegmentationRepresentationByUID(e,t);if(!i)throw new Error(`setColorLUT: could not find segmentation representation with UID ${t}`);if(!c.getColorLUT(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);i.colorLUTIndex=n,(0,V.triggerSegmentationRepresentationModified)(e,t)}function K(e,t,n){const i=c.getSegmentationRepresentationByUID(e,t);if(!i)throw new Error(`segmentation representation with UID ${t} does not exist for tool group ${e}`);const{colorLUTIndex:o}=i,a=c.getColorLUT(o);let r=a[n];if(!r){if("number"!=typeof n)throw new Error(`Can't create colour for LUT index ${n}`);r=a[n]=[0,0,0,0]}return r}function Y(e,t,n,i){const o=K(e,t,n);for(let e=0;e<i.length;e++)o[e]=i[e];(0,V.triggerSegmentationRepresentationModified)(e,t)}var X=n(23308),J=n(96834),Q=n(65807);const ee=new Map;async function te(e,t,n,i){(0,Q.b)();const o=await n();U({segmentationId:e,type:t,data:o}),ee.has(e)||ee.set(e,[]);const a=ee.get(e);return a.includes(t)||a.push(t),function(e){const t=t=>{ne(t,e)};e._debouncedUpdateFunction=t,I.eventTarget.removeEventListener(m.Events.SEGMENTATION_DATA_MODIFIED,e._debouncedUpdateFunction),I.eventTarget.addEventListener(m.Events.SEGMENTATION_DATA_MODIFIED,e._debouncedUpdateFunction)}(i),(0,V.triggerSegmentationModified)(e),o}const ne=(0,L.debounce)(((e,t)=>{const n=e.detail.segmentationId,i=ee.get(n);i&&i.length&&(t(n),i.length&&(0,V.triggerSegmentationModified)(n))}),300);var ie=n(38296);const oe=(0,I.getWebWorkerManager)(),ae=(e,t)=>{(0,I.triggerEvent)(e,I.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_CONTOUR_TO_SURFACE})};async function re(e,t,n={}){let i,o;n.segmentationRepresentationUID&&({segmentationRepresentation:i,toolGroupId:o}=(0,c.findSegmentationRepresentationByUID)(n.segmentationRepresentationUID));const a=(0,c.getSegmentation)(e),r=new Map,s=Object.keys(t).map((async e=>{const n=t[e],s=n.segmentIndex,l=i;if(K(o,i.segmentationRepresentationUID,s).slice(0,3),!l)throw new Error("No color found for segment index, unable to create surface");const d={id:`segmentation_${a.segmentationId}_surface_${s}`,color:l,frameOfReferenceUID:"test-frameOfReferenceUID",data:{points:n.data.points,polys:n.data.polys}},c=d.id;return r.set(s,c),I.geometryLoader.createAndCacheGeometry(c,{type:I.Enums.GeometryType.SURFACE,geometryData:d})}));return await Promise.all(s),{geometryIds:r}}var se=n(16124);const le=(0,I.getWebWorkerManager)(),de=(e,t)=>{(0,I.triggerEvent)(e,I.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_LABELMAP_TO_SURFACE})};async function ce(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e);let i;const o=(0,c.getSegmentation)(e),a=o.representationData;try{a.CONTOUR?i=await async function(e,t={}){const n=(0,c.getSegmentation)(e),i=n.representationData.CONTOUR,o=t.segmentIndices||(0,k.getUniqueSegmentIndices)(e),a=o.map((async e=>{const t=await async function(e,t){const{annotationUIDsMap:n}=e,i=[],o=[],a=n.get(t);for(const e of a){const t=(0,ie.getAnnotation)(e),{polyline:n}=t.data.contour;o.push(n.length),n.forEach((e=>i.push(...e)))}ae(I.eventTarget,0);const r=await oe.executeTask("polySeg","convertContourToSurface",{polylines:i,numPointsArray:o},{callbacks:[e=>{ae(I.eventTarget,e)}]});return ae(I.eventTarget,1),r}(i,e);return{segmentIndex:e,data:t}}));return await Promise.all(a)}(e,{segmentIndices:n,...t}):a.LABELMAP&&(i=await ge(o.segmentationId,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!i)throw new Error("Not enough data to convert to surface, currently only support converting volume labelmap to surface if available");return await re(e,i,t)}async function ge(e,t={}){const n=(0,c.getSegmentation)(e);if(!n?.representationData?.LABELMAP)return void console.warn("Only support surface update from labelmaps");const i=(0,se.r)(n.representationData.LABELMAP),o=n.representationData.LABELMAP,a=t.segmentIndices||(0,k.getUniqueSegmentIndices)(e),r=a.map((e=>{const t=async function(e,t,n=!0){let i;if(n)i=e.volumeId;else{const{imageIdReferenceMap:t}=e;({volumeId:i}=await W({imageIdReferenceMap:t}))}const o=I.cache.getVolume(i),a=o.getScalarData(),{dimensions:r,spacing:s,origin:l,direction:d}=o;de(I.eventTarget,0);const c=await le.executeTask("polySeg","convertLabelmapToSurface",{scalarData:a,dimensions:r,spacing:s,origin:l,direction:d,segmentIndex:t},{callbacks:[e=>{de(I.eventTarget,e)}]});return de(I.eventTarget,1),c}(o,e,i);return t})),s=await Promise.allSettled(r),l=s.filter((e=>"rejected"===e.status));if(l.length>0)throw console.error(l),new Error("Failed to convert labelmap to surface");return s.map(((e,t)=>{if("fulfilled"===e.status)return{segmentIndex:a[t],data:e.value}})).filter(Boolean)}function he(e,t={}){return te(e,m.SegmentationRepresentations.Surface,(()=>ce(e,t)),(()=>async function(e){const t=await ge(e);if(!t)return;const n=(0,c.getSegmentation)(e),i=(0,k.getUniqueSegmentIndices)(e);if(!i.length)return n.representationData.SURFACE.geometryIds.forEach((e=>{const t=I.cache.getGeometry(e).data;t.setPoints([]),t.setPolys([])})),void(0,V.triggerSegmentationModified)(e);const o=t.map((({data:t,segmentIndex:o})=>{const a=`segmentation_${e}_surface_${o}`,r=I.cache.getGeometry(a);if(!r)return(0,c.getToolGroupIdsWithSegmentation)(e).map((i=>(0,c.getSegmentationRepresentations)(i).map((i=>{if(i.type===m.SegmentationRepresentations.Surface)return n.representationData.SURFACE.geometryIds.set(o,a),re(e,[{segmentIndex:o,data:t}],{segmentationRepresentationUID:i.segmentationRepresentationUID})}))));if(i.includes(o)){const e=r.data;e.setPoints(t.points),e.setPolys(t.polys)}else{const e=r.data;e.setPoints([]),e.setPolys([])}}));await Promise.all(o),(0,V.triggerSegmentationModified)(e)}(e)))}var ue=n(44753),me=n(95778);const ve=(0,I.getWebWorkerManager)(),pe=(e,t)=>{(0,I.triggerEvent)(e,I.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_CONTOUR_TO_LABELMAP})};async function fe(e,t={}){const{viewport:n}=t,i=I.utilities.getViewportImageIds(n);if(!i)throw new Error("No imageIds found, labelmap computation from contour requires viewports with imageIds");const o=I.utilities.uuidv4(),a=I.utilities.generateVolumePropsFromImageIds(i,o),{metadata:r,dimensions:s,origin:l,direction:d,spacing:c,scalarData:g}=a,h=await I.volumeLoader.createLocalSegmentationVolume({dimensions:s,origin:l,direction:d,spacing:c,metadata:r,imageIds:i.map((e=>`generated://${e}`)),referencedImageIds:i},o),{segmentIndices:u,annotationUIDsInSegmentMap:m}=Ie(e,t);pe(I.eventTarget,0);const v=await ve.executeTask("polySeg","convertContourToVolumeLabelmap",{segmentIndices:u,dimensions:s,scalarData:g,origin:l,direction:d,spacing:c,annotationUIDsInSegmentMap:m},{callbacks:[e=>{pe(I.eventTarget,e)}]});return pe(I.eventTarget,1),h.imageData.getPointData().getScalars().setData(v),h.imageData.modified(),h.modified(),{volumeId:h.volumeId}}async function Ee(e,t={}){if(!t.viewport)throw new Error("No viewport provided, labelmap computation from contour requires viewports");const n=t.viewport.getImageIds();if(!n)throw new Error("No imageIds found, labelmap computation from contour requires viewports with imageIds");n.forEach((e=>{if(!I.cache.getImageLoadObject(e))throw new Error("ImageIds must be cached before converting contour to labelmap")}));const{imageIds:i}=await I.imageLoader.createAndCacheDerivedSegmentationImages(n),{segmentIndices:o,annotationUIDsInSegmentMap:a}=Ie(e,t),r=new Map;i.forEach(((e,t)=>{const i=I.cache.getImage(e),o=I.metaData.get(I.Enums.MetadataModules.IMAGE_PLANE,e);let{columnCosines:a,rowCosines:s,rowPixelSpacing:l,columnPixelSpacing:d,imagePositionPatient:c}=o;a=a??[0,1,0],s=s??[1,0,0],l=l??1,d=d??1,c=c??[0,0,0];const g=ue.eR.fromValues(s[0],s[1],s[2]),h=ue.eR.fromValues(a[0],a[1],a[2]),u=ue.eR.create();ue.eR.cross(u,g,h);const m=[...g,...h,...u],v=[l,d,1],p=c;r.set(n[t],{direction:m,spacing:v,origin:p,scalarData:i.getPixelData(),imageId:e,dimensions:[i.width,i.height,1]})})),pe(I.eventTarget,0);const s=await ve.executeTask("polySeg","convertContourToStackLabelmap",{segmentationsInfo:r,annotationUIDsInSegmentMap:a,segmentIndices:o},{callbacks:[e=>{pe(I.eventTarget,e)}]});pe(I.eventTarget,1);const l=new Map;return s.forEach((({scalarData:e},t)=>{const n=r.get(t),{imageId:i}=n,o=I.cache.getImage(i);o.getPixelData().set(e),o.imageFrame?.pixelData?.set(e),l.set(t,i)})),{imageIdReferenceMap:l}}function Ie(e,t={}){const n=e.annotationUIDsMap,i=t.segmentIndices?.length?t.segmentIndices:Array.from(n.keys()),o=new Map;return i.forEach((e=>{const t=n.get(e);let i=Array.from(t);i=i.filter((e=>!(0,me.gw)(e).parentAnnotationUID));const a=i.map((e=>{const t=(0,me.gw)(e),n=t.childAnnotationUIDs?.length;return{polyline:t.data.contour.polyline,referencedImageId:t.metadata.referencedImageId,holesPolyline:n&&t.childAnnotationUIDs.map((e=>(0,me.gw)(e).data.contour.polyline))}}));o.set(e,a)})),{segmentIndices:i,annotationUIDsInSegmentMap:o}}const we=(0,I.getWebWorkerManager)(),Ce=(e,t)=>{(0,I.triggerEvent)(e,I.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_SURFACE_TO_LABELMAP})};async function Te(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e);let i;const o=(0,c.getSegmentation)(e),a=o.representationData;try{a.CONTOUR?i=await async function(e,t={}){const n=t.viewport instanceof I.VolumeViewport??!0;if(n&&!t.viewport)throw new Error("Cannot compute labelmap from contour segmentation without providing the viewport");const i=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e),o=(0,c.getSegmentation)(e),a=o.representationData.CONTOUR,r=n?fe:Ee,s=await r(a,{segmentIndices:i,segmentationRepresentationUID:t.segmentationRepresentationUID,viewport:t.viewport});return s}(e,{segmentIndices:n,...t}):a.SURFACE&&(i=await async function(e,t={}){const n=t.viewport instanceof I.VolumeViewport??!0,i=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e),o=(0,c.getSegmentation)(e),a=new Map,r=o.representationData.SURFACE;if(r.geometryIds.forEach(((e,t)=>{i.includes(t)&&a.set(t,e)})),n&&!t.viewport)throw new Error("Cannot compute labelmap from surface segmentation without providing the viewport");let s;if(n){const e=t.viewport.getDefaultActor(),{uid:n}=e;s=await I.volumeLoader.createAndCacheDerivedSegmentationVolume(n)}else{const e=t.viewport.getImageIds(),n="generatedSegmentationVolumeId",i=I.utilities.generateVolumePropsFromImageIds(e,n);delete i.imageIds,s=await I.volumeLoader.createLocalSegmentationVolume({...i,scalarData:i.scalarData,referencedImageIds:e},n)}const l=await async function(e,t){const{geometryIds:n}=e;if(!n?.size)throw new Error("No geometry IDs found for surface representation");const i=new Map;n.forEach(((e,t)=>{const n=I.cache.getGeometry(e).data,o=n.getPoints(),a=n.getPolys();i.set(t,{points:o,polys:a})}));const{dimensions:o,direction:a,origin:r,spacing:s}=t;Ce(I.eventTarget,0);const l=await we.executeTask("polySeg","convertSurfacesToVolumeLabelmap",{segmentsInfo:i,dimensions:o,spacing:s,direction:a,origin:r},{callbacks:[e=>{Ce(I.eventTarget,e)}]});return Ce(I.eventTarget,1),t.imageData.getPointData().getScalars().setData(l),t.imageData.modified(),t.modified(),{volumeId:t.volumeId}}({geometryIds:a},s);if(n)return l;return await H({volumeId:s.volumeId})}(o.segmentationId,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!i)throw new Error("Not enough data to convert to surface, currently only support converting volume labelmap to surface if available");return i}function Se(e,t={}){return te(e,m.SegmentationRepresentations.Labelmap,(()=>Te(e,t)),(()=>{}))}var _e=n(58555);function be(e,t){const n=new Map;for(const[i,o]of e){const e=i.split("_")[1];for(const[i,a]of o){if(!a)continue;const i=Number(e)||t?.get(e);i&&(n.has(i)||n.set(i,[]),n.get(i).push(a))}}return n}var De=n(94152);const Ae=e=>{const{numberOfCells:t,lines:n}=e,i=[],o=[];for(let e=0;e<n.length;){const a=n[e];if(o.push(a),i.push(n.slice(e+1,e+a+1)),e+=a+1,i.length===t)break}return{lineSegments:i,linesNumberOfPoints:o}};async function ye(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e);let i;const o=(0,c.getSegmentation)(e).representationData;try{o.SURFACE?i=await async function(e,t={}){if(!t.viewport)throw new Error("Viewport is required to compute contour from surface");const{viewport:n,segmentationRepresentationUID:i}=t,o=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e),a=new Map,r=new Map,s=(0,c.getSegmentation)(e),l=s.representationData.SURFACE,d=[];l.geometryIds.forEach(((e,t)=>{if(o.includes(t)){a.set(t,e);const n=I.cache.getGeometry(e)?.data;n&&d.push({id:e,points:n.getPoints(),polys:n.getPolys()})}})),a.forEach(((e,t)=>{r.set(e,t)}));const g=await(0,_e.NL)(d,n,i);return be(g,r)}(e,{segmentIndices:n,...t}):o.LABELMAP&&(i=await async function(e,t={}){if(!t.viewport)throw new Error("Viewport is required to compute contour from labelmap");const n=await ge(e,t);if(!n?.length)return void console.error("Failed to convert labelmap to surface or labelmap is empty");const{viewport:i,segmentationRepresentationUID:o}=t,a=n.map((e=>({id:e.segmentIndex.toString(),points:e.data.points,polys:e.data.polys,segmentIndex:e.segmentIndex}))),r=await(0,_e.NL)(a,i,o);return be(r)}(e,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!i)throw new Error("Not enough data to convert to contour, currently only support converting volume labelmap to contour if available");const{viewport:a,segmentationRepresentationUID:r}=t,s=function(e,t,n){const i=new Map;for(const[o,a]of e)for(const e of a){const{points:a}=e,{lineSegments:r,linesNumberOfPoints:s}=Ae(e);for(let e=0;e<r.length;e++){const l=r[e],d=[];for(let t=0;t<s[e];t++){const e=l[t];d.push([a[3*e],a[3*e+1],a[3*e+2]])}if(d.length<3)continue;const c={annotationUID:I.utilities.uuidv4(),data:{contour:{closed:!0,polyline:d},segmentation:{segmentationId:n,segmentIndex:o},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:De.PlanarFreehandContourSegmentationTool.toolName,...t.getViewReference()}};(0,ie.addAnnotation)(c,t.element);const g=i.get(o)||new Set;g.add(c.annotationUID),i.set(o,g)}}return i}(i,a,e),l=(0,E.getToolGroupForViewport)(a.id)?.id;return(0,c.setSegmentationRepresentationSpecificConfig)(l,r,{CONTOUR:{fillAlpha:0}}),{annotationUIDsMap:s}}function Re(e,t={}){return te(e,m.SegmentationRepresentations.Contour,(()=>ye(e,t)),(()=>{}))}const Me=new Map([[m.SegmentationRepresentations.Labelmap,new Set([m.SegmentationRepresentations.Surface,m.SegmentationRepresentations.Contour])],[m.SegmentationRepresentations.Contour,new Set([m.SegmentationRepresentations.Labelmap,m.SegmentationRepresentations.Surface])],[m.SegmentationRepresentations.Surface,new Set([m.SegmentationRepresentations.Labelmap])]]);function xe(e){const t=(0,c.findSegmentationRepresentationByUID)(e);if(!t?.segmentationRepresentation)return!1;const{segmentationRepresentation:n}=t,{type:i,polySeg:o}=n;if(!o||!o.enabled)return!1;const{representationData:a}=(0,c.getSegmentation)(n.segmentationId),r=function(e){const t=[];return Object.keys(e).forEach((n=>{const i=e[n];let o;if(n===m.SegmentationRepresentations.Labelmap)o=l.ji;if(o)try{o(i),t.push(n)}catch(e){console.warn(`Validation failed for labelmap of type ${n}`)}else t.push(n)})),t}(a);return r.some((e=>async function(e,t){return Me.get(e)?.has(t)||!1}(e,i)))}},65807:(e,t,n)=>{n.d(t,{b:()=>a});var i=n(44656);let o=!1;function a(){if(o)return;o=!0;(0,i.getWebWorkerManager)().registerWorker("polySeg",(()=>new Worker(new URL(n.p+n.u(572),n.b),{name:"polySeg"})),{maxWorkerInstances:1,autoTerminateOnIdle:{enabled:!0,idleTimeThreshold:2e3}})}},96834:(e,t,n)=>{n.r(t),n.d(t,{getActiveSegmentIndex:()=>s,setActiveSegmentIndex:()=>r});var i=n(96638),o=n(30322),a=n(87682);function r(e,t){const n=(0,o.getSegmentation)(e);"string"==typeof t&&(console.warn("segmentIndex is a string, converting to number"),t=Number(t)),n?.activeSegmentIndex!==t&&(n.activeSegmentIndex=t,(0,a.triggerSegmentationModified)(e));(0,o.getToolGroupIdsWithSegmentation)(e).forEach((e=>{(0,i.invalidateBrushCursor)(e)}))}function s(e){const t=(0,o.getSegmentation)(e);if(t)return t.activeSegmentIndex}},30322:(e,t,n)=>{n.r(t),n.d(t,{addColorLUT:()=>G,addSegmentation:()=>w,addSegmentationRepresentation:()=>L,findSegmentationRepresentationByUID:()=>_,getAllSegmentationRepresentations:()=>T,getColorLUT:()=>H,getDefaultSegmentationStateManager:()=>f,getGlobalConfig:()=>P,getNextColorLUTIndex:()=>F,getSegmentSpecificRepresentationConfig:()=>M,getSegmentation:()=>E,getSegmentationIdRepresentations:()=>S,getSegmentationRepresentationByUID:()=>U,getSegmentationRepresentationSpecificConfig:()=>R,getSegmentationRepresentations:()=>C,getSegmentations:()=>I,getToolGroupIdFromSegmentationRepresentationUID:()=>O,getToolGroupIdsWithSegmentation:()=>b,getToolGroupSpecificConfig:()=>D,removeColorLUT:()=>B,removeSegmentation:()=>k,removeSegmentationRepresentation:()=>V,removeSegmentationRepresentations:()=>W,setGlobalConfig:()=>N,setSegmentSpecificRepresentationConfig:()=>x,setSegmentationRepresentationSpecificConfig:()=>y,setToolGroupSpecificConfig:()=>A});var i=n(48463),o=n.n(i),a=n(44656),r=n(84901),s=n(20652),l=n(44350),d=n(68492);const c=(0,l.A)(),g=(0,s.A)(),h=(0,d.A)(),u={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:{[r.SegmentationRepresentations.Labelmap]:c,[r.SegmentationRepresentations.Contour]:g,[r.SegmentationRepresentations.Surface]:h}},toolGroups:{}};const m=new class{constructor(e){e||(e=a.utilities.uuidv4()),this.state=o()(u),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this.state=o()(u)}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}addSegmentation(e){if(this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.state.segmentations.push(e)}getSegmentationRepresentations(e){const t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}getAllSegmentationRepresentations(){const e={};return Object.entries(this.state.toolGroups).forEach((([t,n])=>{e[t]=n.segmentationRepresentations})),e}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){const n=this.getSegmentationRepresentations(e),i=n?.find((e=>e.segmentationRepresentationUID===t));return i}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter((t=>t.segmentationId!==e))}removeSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No viewport specific segmentation state found for viewport ${e}`);const i=n.findIndex((e=>e.segmentationRepresentationUID===t));-1===i&&console.warn(`No viewport specific segmentation state data found for viewport ${e} and segmentation data UID ${t}`);const o=n[i];n.splice(i,1),this._handleActiveSegmentation(e,o)}setActiveSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No segmentation data found for toolGroupId: ${e}`);const i=n.find((e=>e.segmentationRepresentationUID===t));if(!i)throw new Error(`No segmentation data found for segmentation data UID ${t}`);i.active=!0,this._handleActiveSegmentation(e,i)}getToolGroupSpecificConfig(e){const t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){const n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);if(i)return i.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n,i){const o=this.getSegmentationRepresentationByUID(e,t);o&&(o.segmentSpecificConfig&&!i?.clear||(o.segmentSpecificConfig={}),Object.keys(n).forEach((e=>{o.segmentSpecificConfig[e]=n[e]})))}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=o()(e)}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){const n=this.getSegmentationRepresentations(e);if(0===n.length)return;if(1===n.length)return void(n[0].active=!0);0!==n.filter((e=>e.active)).length?t.active&&n.forEach((e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0}}("DEFAULT");var v=n(87682);const p=function(e){const{segmentationId:t,representation:n}=e,i=n.type===r.SegmentationRepresentations.Contour;let o=n.data?{...n.data}:null;if(o=!o&&i?{}:o,!o)throw new Error("Segmentation representation data may not be undefined");if(i){const e=o;e.geometryIds=e.geometryIds??[],e.annotationUIDsMap=e.annotationUIDsMap??new Map}return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...o}}}};function f(){return m}function E(e){return f().getSegmentation(e)}function I(){return f().getState().segmentations}function w(e,t){const n=f(),i=p(e);n.addSegmentation(i),t||(0,v.triggerSegmentationModified)(i.segmentationId)}function C(e){return f().getSegmentationRepresentations(e)}function T(){return f().getAllSegmentationRepresentations()}function S(e){const t=T()||{},n=[];for(const i in t){const o=t[i].find((t=>t.segmentationId===e));o&&n.push(o)}return n}function _(e){const t=T()||[],n=Object.keys(t);for(const t of n){const n=T()[t].find((t=>t.segmentationRepresentationUID===e));if(n)return{segmentationRepresentation:n,toolGroupId:t}}}function b(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");const t=f(),n=t.getState(),i=Object.keys(n.toolGroups),o=[];return i.forEach((n=>{t.getSegmentationRepresentations(n).forEach((t=>{t.segmentationId===e&&o.push(n)}))})),o}function D(e){return f().getToolGroupSpecificConfig(e)}function A(e,t,n){f().setSegmentationRepresentationConfig(e,t),n||(0,v.triggerSegmentationRepresentationModified)(e)}function y(e,t,n,i=!1){f().setSegmentationRepresentationSpecificConfig(e,t,n),i||(0,v.triggerSegmentationRepresentationModified)(e,t)}function R(e,t){return f().getSegmentationRepresentationSpecificConfig(e,t)}function M(e,t,n){return f().getSegmentSpecificConfig(e,t,n)}function x(e,t,n,i=!1){f().setSegmentSpecificConfig(e,t,n),i||(0,v.triggerSegmentationRepresentationModified)(e,t)}function O(e){const t=T()||[],n=Object.keys(t);for(const t of n){if(T()[t].find((t=>t.segmentationRepresentationUID===e)))return t}}function L(e,t,n){f().addSegmentationRepresentation(e,t),n||(0,v.triggerSegmentationRepresentationModified)(e,t.segmentationRepresentationUID)}function P(){return f().getGlobalConfig()}function N(e,t){f().setGlobalConfig(e),t||(0,v.triggerSegmentationModified)()}function U(e,t){return f().getSegmentationRepresentationByUID(e,t)}function k(e){f().removeSegmentation(e),(0,v.triggerSegmentationRemoved)(e)}function V(e,t){f().removeSegmentationRepresentation(e,t),(0,v.triggerSegmentationRepresentationRemoved)(e,t)}function W(e){(C(e)||[]).forEach((t=>{V(e,t.segmentationRepresentationUID)}))}function B(e){f().removeColorLUT(e)}function H(e){return f().getColorLUT(e)}function F(){return f().getNextColorLUTIndex()}function G(e,t){f().addColorLUT(e,t)}},87682:(e,t,n)=>{n.r(t),n.d(t,{triggerSegmentationDataModified:()=>g,triggerSegmentationModified:()=>c,triggerSegmentationRemoved:()=>s,triggerSegmentationRepresentationModified:()=>d,triggerSegmentationRepresentationRemoved:()=>l});var i=n(44656),o=n(84901),a=n(30322),r=n(94510);function s(e){const t={segmentationId:e};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REMOVED,t)}function l(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REPRESENTATION_REMOVED,n)}function d(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};if(t)return void(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REPRESENTATION_MODIFIED,n);((0,a.getSegmentationRepresentations)(e)||[]).forEach((t=>{const{segmentationRepresentationUID:n}=t,a={toolGroupId:e,segmentationRepresentationUID:n};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REPRESENTATION_MODIFIED,a)}))}function c(e){let t;t=e?[e]:(0,a.getSegmentations)().map((({segmentationId:e})=>e)),t.forEach((e=>{const t={segmentationId:e};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_MODIFIED,t)}))}function g(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,r.HM)(e),(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_DATA_MODIFIED,n)}},30765:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(44656);function o(e,t){return e.findIndex((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))}function a(e,t){return e.some((e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId))}const r=class{constructor(e,t,n,o){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t=(0,i.getEnabledElement)(e.currentTarget);if(!t)return;const{renderingEngineId:n,viewportId:o}=t;this._sourceViewports.find((e=>e.viewportId===o))&&this.fireEvent({renderingEngineId:n,viewportId:o},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=o||{},this._auxiliaryEventNames=this._options.auxiliaryEventNames||[],this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e,t={}){this._viewportOptions[e]=t}setEnabled(e){this._enabled=e}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(a(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,o=(0,i.getRenderingEngine)(t).getViewport(n);if(!o)return void console.warn(`Synchronizer.addSource: No viewport for ${t} ${n}`);const r=o.element;r.addEventListener(this._eventName,this._onEvent.bind(this)),this._auxiliaryEventNames.length&&this._auxiliaryEventNames.forEach((e=>{r.addEventListener(e,this._onEvent.bind(this))})),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){a(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach((e=>this.removeSource(e))),this._targetViewports.forEach((e=>this.removeTarget(e)))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=o(this._sourceViewports,e);if(-1===t)return;const n=function(e){const t=(0,i.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error(`No RenderingEngine for Id: ${e.renderingEngineId}`);return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._auxiliaryEventNames&&this._auxiliaryEventNames.forEach((e=>{n.removeEventListener(e,this._eventHandler)})),this._updateDisableHandlers()}removeTarget(e){const t=o(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return a(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return a(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const n=[];try{for(let i=0;i<this._targetViewports.length;i++){const o=this._targetViewports[i];if(e.viewportId===o.viewportId)continue;const a=this._eventHandler(this,e,o,t,this._options);a instanceof Promise&&n.push(a)}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{n.length?Promise.allSettled(n).then((()=>{this._ignoreFiredEvents=!1})):this._ignoreFiredEvents=!1}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],i=e.concat(t);for(let e=0;e<i.length;e++){const t=i[e];n.some((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach((function(e){const t=(0,i.getRenderingEngine)(e.renderingEngineId);if(!t)return;const o=t.getViewport(e.viewportId),{element:a}=o;a.removeEventListener(i.Enums.Events.ELEMENT_DISABLED,n),a.addEventListener(i.Enums.Events.ELEMENT_DISABLED,n)}))}}},74267:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(61738);const o=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let o=0;o<i.wk.synchronizers.length;o++){const a=i.wk.synchronizers[o],r=!a.isDisabled(),s=a.hasSourceViewport(t,e),l=a.hasTargetViewport(t,e);r&&(s||l)&&n.push(a)}return n}},45114:(e,t,n)=>{n.r(t),n.d(t,{createSynchronizer:()=>a,destroy:()=>r,destroySynchronizer:()=>c,getAllSynchronizers:()=>d,getSynchronizer:()=>l,getSynchronizersForViewport:()=>s.A});var i=n(61738),o=n(30765);const a=function(e,t,n,a){if(i.wk.synchronizers.some((t=>t.id===e)))throw new Error(`Synchronizer with id '${e}' already exists.`);const r=new o.A(e,t,n,a);return i.wk.synchronizers.push(r),r};const r=function(){for(;i.wk.synchronizers.length>0;){i.wk.synchronizers.pop().destroy()}};var s=n(74267);const l=function(e){return i.wk.synchronizers.find((t=>t.id===e))};const d=function(){return i.wk.synchronizers};const c=function(e){const t=i.wk.synchronizers.findIndex((t=>t.id===e));if(t>-1){i.wk.synchronizers[t].destroy(),i.wk.synchronizers.splice(t,1)}}},63776:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(44656),o=n(61738);const a=function(e,t){t||(t=(0,i.getRenderingEngines)().find((t=>t.getViewports().find((t=>t.id===e))))?.id);const n=o.wk.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}}},52610:(e,t,n)=>{n.r(t),n.d(t,{createToolGroup:()=>i.A,destroy:()=>a.A,destroyToolGroup:()=>o.A,getAllToolGroups:()=>l.A,getToolGroup:()=>r.A,getToolGroupForViewport:()=>s.A,getToolGroupsWithToolName:()=>d.A});var i=n(27630),o=n(59755),a=n(648),r=n(29697),s=n(63776),l=n(3193),d=n(64109)},61738:(e,t,n)=>{n.d(t,{xW:()=>S.A,_K:()=>b,dU:()=>_,D0:()=>c,Gx:()=>o,BU:()=>T,J2:()=>a,kq:()=>C,Bl:()=>r,wk:()=>i.Ay});var i=n(55588);function o(e){const t=e.toolName,n=void 0!==i.wk.tools[t];if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);if(n)throw new Error(`${t} has already been added globally`);i.wk.tools[t]={toolClass:e}}function a(e){const t=e.toolName;return!(!t||!i.wk.tools[t])}function r(e){const t=e.toolName;if(!t)throw new Error(`No tool found for: ${e.name}`);if(void 0===!i.wk.tools[t])throw new Error(`${t} cannot be removed because it has not been added`);delete i.wk.tools[t]}var s=n(60878),l=n(44926),d=n(6805);function c(e){const{element:t,viewportId:n}=e.detail,o=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),i=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",i),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),r=document.createElementNS(t,"feOffset"),s=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${i}`),a.setAttribute("filterUnits","userSpaceOnUse"),r.setAttribute("result","offOut"),r.setAttribute("in","SourceGraphic"),r.setAttribute("dx","0.5"),r.setAttribute("dy","0.5"),s.setAttribute("result","matrixOut"),s.setAttribute("in","offOut"),s.setAttribute("in2","matrix"),s.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(r),a.appendChild(s),a.appendChild(l),o.appendChild(a),n.appendChild(o),n}(n);var a;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;i.wk.svgNodeCache[o]={}}(t),a=o,t.querySelector("div.viewport-element").appendChild(a),d.ou.addViewportElement(n,t),s.bH.enable(t),s.CG.enable(t),s.F_.enable(t),s.kt.enable(t),s._9.enable(t),l.In.enable(t),l.aB.enable(t),l.z5.enable(t),l.n6.enable(t),l.V$.enable(t),l.$m.enable(t),i.wk.enabledElements.push(t)}var g=n(44656),h=n(9933),u=n(42360),m=n(84901),v=(n(95778),n(74267)),p=n(63776);const f="viewport-element";const E=e=>{const t=(0,g.getEnabledElement)(e);(0,v.A)(t.viewportId,t.renderingEngineId).forEach((e=>{e.remove(t)}))},I=e=>{const{renderingEngineId:t,viewportId:n}=(0,g.getEnabledElement)(e),i=(0,p.A)(n,t);i&&i.removeViewports(t,n)};const w=function(e){const t=i.wk.enabledElements.findIndex((t=>t===e));t>-1&&i.wk.enabledElements.splice(t,1)},C=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;delete i.wk.svgNodeCache[o]}(t),function(e){const t=e.querySelector(`div.${f}`),n=t.querySelector("svg");n&&t.removeChild(n)}(t),d.ou.removeViewportElement(n,t),s.bH.disable(t),s.CG.disable(t),s.F_.disable(t),s.kt.disable(t),s._9.disable(t),l.In.disable(t),l.aB.disable(t),l.z5.disable(t),l.n6.disable(t),l.V$.disable(t),l.$m.disable(t),E(t),I(t),w(t)};function T(e){const t=(0,u.A)(e,[m.ToolModes.Active,m.ToolModes.Passive]),n=(0,h.A)(e,t);for(const{tool:t}of n){const n=t.cancel(e);if(n)return n}}var S=n(30765),_=(n(34913),n(52610)),b=n(45114)},55588:(e,t,n)=>{n.d(t,{Ay:()=>s,qh:()=>l,wk:()=>s});var i=n(34913),o=n(48463),a=n.n(o);const r={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:i.A,enabledElements:[],handleRadius:6};let s={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:i.A,enabledElements:[],handleRadius:6};function l(){(0,i.e)(),s={...a()({...r,svgNodeCache:{}}),svgNodeCache:{...r.svgNodeCache}}}},34913:(e,t,n)=>{n.d(t,{A:()=>a,e:()=>o});let i={};function o(){i={}}const a=i},50720:(e,t,n)=>{n.d(t,{A:()=>_});var i=n(44753),o=n(44656),a=n(24592),r=n(21013),s=n(96214),l=n(21090),d=n(38296),c=n(48428),g=n(21009),h=n(54177),u=n(2746),m=n(61738),v=n(84901),p=n(90252),f=n(21954),E=n(10910),I=n(40233),w=n(23072);const{transformWorldToIndex:C}=o.utilities;class T extends s.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:S}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,{points:l}=s.handles;let d=r.worldToCanvas(l[0]),c=r.worldToCanvas(l[1]),g={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},h=f.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]]);return h<=i||(d=r.worldToCanvas(l[2]),c=r.worldToCanvas(l[3]),g={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},h=f.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]]),h<=i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,w.A)(s,a),(0,I.hideElementCursor)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,r=t.data;t.highlighted=!0;let s,l=!1;n.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===n));const d=(0,p.getViewportIdsWithToolToRender)(a,this.getToolName());(0,I.hideElementCursor)(a),this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,w.A)(g,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:r,newAnnotation:s,hasMoved:l}=this.editData,{data:c}=a;if(s&&!l)return;c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,I.resetElementCursor)(n);const{renderingEngine:g}=(0,o.getEnabledElement)(n);if(void 0!==this.editData.handleIndex){const{points:e}=c.handles,t=i.eR.distance(e[0],e[1]);if(i.eR.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],o=[...e[1]],a=i.Zc.create();i.Zc.set(a,t[1][0]-t[0][0],t[1][1]-t[1][0]);const r=i.Zc.create();i.Zc.set(r,-a[1],a[0]);const s=i.Zc.create();let l;i.Zc.set(s,o[0]-n[0],o[1]-n[0]),l=i.Zc.dot(s,r)>0?[n,o]:[o,n],c.handles.points=[t[0],t[1],l[0],l[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,d.removeAnnotation)(a.annotationUID),(0,w.A)(g,r),s&&(0,h.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:a}=t,r=(0,o.getEnabledElement)(a),{renderingEngine:s,viewport:l}=r,{worldToCanvas:d}=l,{annotation:c,viewportIdsToRender:g,handleIndex:h}=this.editData,{data:u}=c,m=n.world;u.handles.points[h]=[...m];const v=u.handles.points.map(d),p={start:{x:v[0][0],y:v[0][1]},end:{x:v[1][0],y:v[1][1]}},f=(v[2][0],v[2][1],v[3][0],v[3][1],i.Zc.distance(v[0],v[1])/3),E=p.start.x-p.end.x,I=p.start.y-p.end.y,C=Math.sqrt(E*E+I*I),T=E/C,S=I/C,_=(p.start.x+p.end.x)/2,b=(p.start.y+p.end.y)/2,D=_+f*S,A=b-f*T,y=_-f*S,R=b+f*T;u.handles.points[2]=l.canvasToWorld([D,A]),u.handles.points[3]=l.canvasToWorld([y,R]),c.invalidated=!0,(0,w.A)(s,g),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{renderingEngine:a}=i,{annotation:r,viewportIdsToRender:s,handleIndex:l,movingTextBox:d}=this.editData,{data:c}=r;if(d){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===l){const{deltaPoints:e}=t,n=e.world;c.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),r.invalidated=!0}else this._dragModifyHandle(e),r.invalidated=!0;(0,w.A)(a,s)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:a}=t,r=(0,o.getEnabledElement)(a),{viewport:s}=r,{annotation:l,handleIndex:d}=this.editData,{data:c}=l,g=n.world,h=[s.worldToCanvas(c.handles.points[0]),s.worldToCanvas(c.handles.points[1]),s.worldToCanvas(c.handles.points[2]),s.worldToCanvas(c.handles.points[3])],u={start:{x:h[0][0],y:h[0][1]},end:{x:h[1][0],y:h[1][1]}},m={start:{x:h[2][0],y:h[2][1]},end:{x:h[3][0],y:h[3][1]}},v=[...g],p=s.worldToCanvas(v);if(0===d||1===d){const e=h[0===d?1:0],t=i.Zc.set(i.Zc.create(),p[0]-e[0],p[1]-e[1]),n=i.Zc.set(i.Zc.create(),h[d][0]-e[0],h[d][1]-e[1]);i.Zc.normalize(t,t),i.Zc.normalize(n,n);const o={start:{x:e[0],y:e[1]},end:{x:p[0],y:p[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(o,m))return;const a=e,r=this._getSignedAngle(n,t);let l=h[2][0],g=h[2][1],u=h[3][0],f=h[3][1];l-=a[0],g-=a[1],u-=a[0],f-=a[1];const E=l*Math.cos(r)-g*Math.sin(r),I=l*Math.sin(r)+g*Math.cos(r),w=u*Math.cos(r)-f*Math.sin(r),C=u*Math.sin(r)+f*Math.cos(r);l=E+a[0],g=I+a[1],u=w+a[0],f=C+a[1];const T=s.canvasToWorld([l,g]),S=s.canvasToWorld([u,f]);c.handles.points[d]=v,c.handles.points[2]=T,c.handles.points[3]=S}else{const e=2===d?3:2,t={longLineSegment:{start:u.start,end:u.end},shortLineSegment:{start:m.start,end:m.end}},n=i.Zc.subtract(i.Zc.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),o=i.Zc.normalize(i.Zc.create(),n),a=i.Zc.subtract(i.Zc.create(),[p[0],p[1]],[h[d][0],h[d][1]]),r=i.Zc.length(a),l=this._getSignedAngle(o,a),g=Math.cos(l)*r,E=i.Zc.scaleAndAdd(i.Zc.create(),[h[e][0],h[e][1]],o,g);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:p[0],y:p[1]},end:{x:E[0],y:E[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!f.intersectLine([p[0],p[1]],[E[0],E[1]],[u.start.x,u.start.y],[u.end.x,u.end.y]))return;c.handles.points[e]=s.canvasToWorld(E),c.handles.points[d]=v}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,I.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:r}=(0,o.getEnabledElement)(e);return(0,w.A)(r,n),i&&(0,h.dZ)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(v.Events.MOUSE_UP,this._endCallback),e.addEventListener(v.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(v.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(v.Events.TOUCH_TAP,this._endCallback),e.addEventListener(v.Events.TOUCH_END,this._endCallback),e.addEventListener(v.Events.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(v.Events.MOUSE_UP,this._endCallback),e.removeEventListener(v.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(v.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(v.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(v.Events.TOUCH_END,this._endCallback),e.removeEventListener(v.Events.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(v.Events.MOUSE_UP,this._endCallback),e.addEventListener(v.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(v.Events.TOUCH_END,this._endCallback),e.addEventListener(v.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(v.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(v.Events.MOUSE_UP,this._endCallback),e.removeEventListener(v.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(v.Events.TOUCH_END,this._endCallback),e.removeEventListener(v.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(v.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:i}=e,{element:o}=i;let a=(0,d.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r=this.getTargetId(i),s=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:h,data:m}=d,{points:v,activeHandleIndex:p}=m.handles,f=v.map((e=>i.worldToCanvas(e)));l.annotationUID=h;const{color:I,lineWidth:w,lineDash:C,shadow:T}=this.getAnnotationStyle({annotation:d,styleSpecifier:l});if(m.cachedStats[r]&&null!=m.cachedStats[r].unit?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(m.cachedStats[r]={length:null,width:null,unit:null},this._calculateCachedStats(d,s,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let S;if(!(0,g.isAnnotationVisible)(h))continue;if((0,c.isAnnotationLocked)(d)||this.editData||null===p||(S=[f[p]]),S){const e="0";(0,u.drawHandles)(t,h,e,S,{color:I})}const _=`${h}-line-1`,b=`${h}-line-2`,D="0";(0,u.drawLine)(t,h,D,f[0],f[1],{color:I,lineDash:C,lineWidth:w,shadow:T},_);const A="1";(0,u.drawLine)(t,h,A,f[2],f[3],{color:I,lineDash:C,lineWidth:w,shadow:T},b),n=!0;const y=this.getLinkedTextBoxStyle(l,d);if(!y.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const R=this.configuration.getTextLines(m,r);if(!R||0===R.length)continue;let M;m.handles.textBox.hasMoved||(M=(0,E.getTextBoxCoordsCanvas)(f),m.handles.textBox.worldPosition=i.canvasToWorld(M));const x=i.worldToCanvas(m.handles.textBox.worldPosition),O="1",L=(0,u.drawLinkedTextBox)(t,h,O,R,x,f,{},y),{x:P,y:N,width:U,height:k}=L;m.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,N]),topRight:i.canvasToWorld([P+U,N]),bottomLeft:i.canvasToWorld([P,N+k]),bottomRight:i.canvasToWorld([P+U,N+k])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=i.Zc.create();i.Zc.set(n,t.end.x-t.start.x,t.end.y-t.start.y),i.Zc.normalize(n,n);const o={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!f.intersectLine([o.start.x,o.start.y],[o.end.x,o.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:i}=e,{element:o}=n.viewport,r=i.handles.points[0],s=i.handles.points[1],l=i.handles.points[2],d=i.handles.points[3],{cachedStats:c}=i,g=Object.keys(c);for(let e=0;e<g.length;e++){const n=g[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:h}=i,u=(0,a.yH)(i),m=this._calculateLength(r,s)/u,v=this._calculateLength(l,d)/u,p=m>v?m:v,f=m>v?v:m,E=C(o,r),I=C(o,s),w=C(o,l),T=C(o,d);this._isInsideVolume(E,I,w,T,h)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:p,width:f,unit:(0,a.Nx)(null,i)}}return e.invalidated=!1,(0,h.XF)(e,o),c},this._isInsideVolume=(e,t,n,i,a)=>o.utilities.indexWithinDimensions(e,a)&&o.utilities.indexWithinDimensions(t,a)&&o.utilities.indexWithinDimensions(n,a)&&o.utilities.indexWithinDimensions(i,a),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=(0,l.A)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const c=s.getCamera(),{viewPlaneNormal:g,viewUp:h}=c,u=this.getReferencedImageId(s,a,g,h),m=s.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...g],viewUp:[...h],FrameOfReferenceUID:m,referencedImageId:u},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,d.addAnnotation)(v,i);const f=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,I.hideElementCursor)(i),e.preventDefault(),(0,w.A)(l,f),v}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}}function S(e,t){const{cachedStats:n,label:i}=e,{length:o,width:a,unit:s}=n[t],l=[];return i&&l.push(i),void 0===o||l.push(`L: ${(0,r.roundNumber)(o)} ${s}`,`W: ${(0,r.roundNumber)(a)} ${s}`),l}T.toolName="Bidirectional";const _=T},20070:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(44656),o=n(87682),a=n(78279);class r extends a.A{constructor(e){super(i.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e))}isContourSegmentationTool(){return!0}renderAnnotationInstance(e){const t=e.annotation,{invalidated:n}=t,i=super.renderAnnotationInstance(e);if(n){const{segmentationId:e}=t.data.segmentation;(0,o.triggerSegmentationDataModified)(e)}return i}}r.toolName="PlanarFreehandContourSegmentationTool";const s=r},28062:(e,t,n)=>{n.d(t,{A:()=>g});var i=n(44656),o=n(22338),a=n(38296),r=n(6805),s=n(65826),l=n(28664),d=n(17264);class c extends o.A{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,imageId:n}=e.detail,o=i.utilities.imageIdToURI(n),s=(0,a.getAnnotationManager)();s.getFramesOfReference().forEach((e=>{const n=s.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach((e=>{if(!e.metadata?.referencedImageId)return;i.utilities.imageIdToURI(e.metadata.referencedImageId)===o&&(e.invalidated=!0,e.data.cachedStats={})})),(0,r.Ay)(t))}))}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,i.getEnabledElement)(e),{viewport:o}=n;return(0,s.A)(o,t)}getReferencedImageId(e,t,n,o){const a=this.getTargetId(e);let r;if(e instanceof i.StackViewport)r=a.split("imageId:")[1];else if(e instanceof i.VideoViewport)r=a.split("videoId:")[1];else{const e=i.utilities.getVolumeId(a),o=i.cache.getVolume(e);r=i.utilities.getClosestImageId(o,t,n)}return r}getStyle(e,t,n){return(0,l.h)(e,t,(0,d.getState)(n),this.mode)}}c.toolName="AnnotationDisplayTool";const g=c},52454:(e,t,n)=>{n.d(t,{A:()=>g});var i=n(44656),o=n(44753),a=n(28062),r=n(48428),s=n(21009),l=n(38296),d=n(54177);class c extends a.A{constructor(e,t){super(e,t),this.mouseMoveCallback=(e,t)=>{if(!t)return!1;const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(const e of t){if((0,r.isAnnotationLocked)(e)||!(0,s.isAnnotationVisible)(e.annotationUID))continue;const{data:t}=e,i=t.handles?t.handles.activeHandleIndex:void 0,l=this._imagePointNearToolOrHandle(n,e,o,6),d=l&&!e.highlighted,c=!l&&e.highlighted;d||c?(e.highlighted=!e.highlighted,a=!0):t.handles&&t.handles.activeHandleIndex!==i&&(a=!0)}return a},e.configuration?.getTextLines&&(this.configuration.getTextLines=e.configuration.getTextLines),e.configuration?.statsCalculator&&(this.configuration.statsCalculator=e.configuration.statsCalculator)}static createAnnotation(...e){let t={annotationUID:null,highlighted:!0,invalidated:!0,metadata:{toolName:this.toolName},data:{text:"",handles:{points:new Array,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};for(const n of e)t=i.utilities.deepMerge(t,n);return t}static createAnnotationForViewport(e,...t){return this.createAnnotation({metadata:e.getViewReference()},...t)}static createAndAddAnnotation(e,...t){const n=this.createAnnotationForViewport(e,...t);(0,l.addAnnotation)(n,e.element),(0,d.XF)(n,e.element)}getHandleNearImagePoint(e,t,n,a){const r=(0,i.getEnabledElement)(e),{viewport:s}=r,{data:l}=t,{isCanvasAnnotation:d}=l,{points:c,textBox:g}=l.handles;if(g){const{worldBoundingBox:e}=g;if(e){const t={topLeft:s.worldToCanvas(e.topLeft),topRight:s.worldToCanvas(e.topRight),bottomLeft:s.worldToCanvas(e.bottomLeft),bottomRight:s.worldToCanvas(e.bottomRight)};if(n[0]>=t.topLeft[0]&&n[0]<=t.bottomRight[0]&&n[1]>=t.topLeft[1]&&n[1]<=t.bottomRight[1])return l.handles.activeHandleIndex=null,g}}for(let e=0;e<c?.length;e++){const t=c[e],i=d?t.slice(0,2):s.worldToCanvas(t);if(!0===o.Zc.distance(n,i)<a)return l.handles.activeHandleIndex=e,t}l.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{visibility:this.getStyle("textBoxVisibility",e,t),fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}isSuvScaled(e,t,n){if(e instanceof i.BaseVolumeViewport){const e=i.utilities.getVolumeId(t),n=i.cache.getVolume(e);return void 0!==n.scaling?.PT}const o=n&&i.metaData.get("scalingModule",n);return"number"==typeof o?.suvbw}getAnnotationStyle(e){const{annotation:t,styleSpecifier:n}=e,i=e=>this.getStyle(e,n,t),{annotationUID:o}=t,a=(0,s.isAnnotationVisible)(o),l=(0,r.isAnnotationLocked)(t),d=i("lineWidth"),c=i("lineDash"),g=i("color");return{visibility:a,locked:l,color:g,lineWidth:d,lineDash:c,lineOpacity:1,fillColor:g,fillOpacity:0,shadow:i("shadow"),textbox:this.getLinkedTextBoxStyle(n,t)}}_imagePointNearToolOrHandle(e,t,n,i){if(this.getHandleNearImagePoint(e,t,n,i))return!0;return!!this.isPointNearTool(e,t,n,i,"mouse")||void 0}}c.toolName="AnnotationTool";const g=c},22338:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(44656),o=n(12468);class a{constructor(e,t){const n=i.utilities.deepMerge(t,e),{configuration:a={},supportedInteractionTypes:r,toolGroupId:s}=n;a.strategies||(a.strategies={},a.defaultStrategy=void 0,a.activeStrategy=void 0,a.strategyOptions={}),this.toolGroupId=s,this.supportedInteractionTypes=r||[],this.configuration=Object.assign({},a),this.mode=o.A.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:i}=this.configuration;return n[i]?.call(this,e,t)}applyActiveStrategyCallback(e,t,n){const{strategies:i,activeStrategy:o}=this.configuration;if(!i[o])throw new Error(`applyActiveStrategyCallback: active strategy ${o} not found, check tool configuration or spellings`);return i[o][n]?.call(this,e,t)}setConfiguration(e){this.configuration=i.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){if(this.configuration.volumeId)return this.configuration.volumeId;const t=e.getActors();return t?t.find((e=>"vtkVolume"===e.actor.getClassName()))?.uid:void 0}getTargetIdImage(e,t){if(e.startsWith("imageId:")){const n=e.split("imageId:")[1],o=i.utilities.imageIdToURI(n);let a=i.utilities.getViewportsWithImageURI(o,t.id);if(!a||!a.length)return;if(a=a.filter((e=>e.getCurrentImageId()===n)),!a||!a.length)return;return a[0].getImageData()}if(e.startsWith("volumeId:")){const n=i.utilities.getVolumeId(e),o=i.utilities.getViewportsWithVolumeId(n,t.id);if(!o||!o.length)return;return o[0].getImageData()}if(e.startsWith("videoId:")){const n=i.utilities.imageIdToURI(e),o=i.utilities.getViewportsWithImageURI(n,t.id);if(!o||!o.length)return;return o[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){const t=e.getReferenceId?.();if(t)return t;if(e instanceof i.BaseVolumeViewport)return`volumeId:${this.getTargetVolumeId(e)}`;throw new Error("getTargetId: viewport must have a getTargetId method")}}a.toolName="BaseTool";const r=a},96214:(e,t,n)=>{n.d(t,{EC:()=>o.A,oS:()=>i.A,wh:()=>a.A});var i=n(22338),o=n(52454),a=n(28062)},2884:(e,t,n)=>{n.d(t,{T:()=>i.A});var i=n(69714)},94318:(e,t,n)=>{n.d(t,{Zy:()=>i.Ay,ji:()=>o.t});var i=n(44956),o=(n(44350),n(11654))},44350:(e,t,n)=>{n.d(t,{A:()=>a,J:()=>o});const i={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,activeSegmentOutlineWidthDelta:0,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85};function o(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"number"==typeof e.activeSegmentOutlineWidthDelta&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}const a=function(){return i}},44956:(e,t,n)=>{n.d(t,{Ay:()=>w,iA:()=>v});var i=n(29853),o=n(37452),a=n(44656),r=n(83946),s=n(30322),l=n(52610),d=n(3006),c=n(29306),g=n(16124),h=n(63421);const u=255,m=new Map;function v(){const e=o.Ay.newInstance(),t=i.Ay.newInstance();return t.addPoint(0,0),{ofun:t,cfun:e}}let p=!1;function f(e,t,n,i){const o={...e,...t,...i||{}};return{fillAlpha:n?o.fillAlpha:o.fillAlphaInactive,outlineWidth:n?o.outlineWidthActive:o.outlineWidthInactive,renderFill:n?o.renderFill:o.renderFillInactive,renderOutline:o.renderOutline,outlineOpacity:n?o.outlineOpacity:o.outlineOpacityInactive}}function E(e,t,n,{fillAlpha:i,renderFill:o,renderOutline:a,segmentColor:r,outlineWidth:s,segmentsHidden:l}){const d=`${e}-${t}-${n}`,c=m.get(d);if(!c)return m.set(d,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:s,segmentColor:r.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:g,renderFill:h,renderOutline:u,outlineWidth:v,segmentColor:p,segmentsHidden:f}=c,E=p[0]!==r[0]||p[1]!==r[1]||p[2]!==r[2],I=p[3]!==r[3]||g!==i||h!==o||u!==a||v!==s||f.has(n)!==l.has(n);return m.set(d,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:s,segmentColor:r.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:I,forceColorUpdate:E}}async function I(e,t,n){await(0,d.A)(e.element,t,n)}const w={getRepresentationRenderingConfig:v,render:async function(e,t,n){const{colorLUTIndex:i,active:o,segmentationId:l,segmentationRepresentationUID:d,segmentsHidden:c,config:m}=t,v=s.getSegmentation(l);if(!v)return void console.warn("No segmentation found for segmentationId: ",l);let w=v.representationData[r.A.Labelmap],C=e.getActor(d);if(!w&&h.polySeg.canComputeRequestedRepresentation(d)&&!p){if(p=!0,w=await h.polySeg.computeAndAddLabelmapRepresentation(l,{segmentationRepresentationUID:d,viewport:e}),!w)throw new Error(`No labelmap data found for segmentationId ${l}.`);p=!1}if(!w)return;if((0,g.r)(w,e)){if(e instanceof a.StackViewport)return;const{volumeId:t}=w;if(!a.cache.getVolume(t))throw new Error(`No Labelmap found for volumeId: ${t}`);if(!function(e,t){if(!t)return!0;const n=e.getDefaultActor();if(!n)return!1;const{uid:i}=n,o=a.cache.getVolume(i);if(o){const e=a.cache.getVolume(t);if(e&&o.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,w?.referencedVolumeId))return;C||await I(e,w,d),C=e.getActor(d)}else{if(e instanceof a.VolumeViewport)return;const t=e.getCurrentImageId(),{imageIdReferenceMap:n}=w;if(!n.has(t))return;C||await I(e,w,d),C=e.getActor(d)}if(!C)return;const{cfun:T,ofun:S}=m,_=n.renderInactiveSegmentations;!function(e,t,n,i,o,a,l,d,c,g){const{segmentSpecificConfig:h,segmentationRepresentationSpecificConfig:m}=l,v=m[r.A.Labelmap],p=s.getColorLUT(o),I=Math.min(256,p.length),{uid:w}=t,{outlineWidth:C,renderOutline:T,outlineOpacity:S}=f(a,v,d);for(let t=0;t<I;t++){const o=t,s=p[o],l=h[o]?.[r.A.Labelmap],{fillAlpha:c,outlineWidth:m,renderFill:I,renderOutline:C}=f(a,v,d,l),{forceOpacityUpdate:T,forceColorUpdate:S}=E(e,w,o,{fillAlpha:c,renderFill:I,renderOutline:C,segmentColor:s,outlineWidth:m,segmentsHidden:g});if(S&&n.addRGBPoint(o,s[0]/u,s[1]/u,s[2]/u),T)if(I){const e=g.has(o)?0:s[3]/255*c;i.removePoint(o),i.addPointLong(o,e,.5,1)}else i.addPointLong(o,.01,.5,1)}const _=t.actor;_.getProperty().setRGBTransferFunction(0,n),i.setClamping(!1),_.getProperty().setScalarOpacity(0,i),_.getProperty().setInterpolationTypeToNearest(),_.getProperty().setUseLabelOutline(T),_.getProperty().setLabelOutlineOpacity(S);const{activeSegmentIndex:b}=s.getSegmentation(l.segmentationId),D=new Array(I-1);for(let e=1;e<I;e++){g.has(e)?D[e-1]=0:D[e-1]=e===b?C+a.activeSegmentOutlineWidthDelta:C}_.getProperty().setLabelOutlineThickness(D);const A=d||c;_.setVisibility(A)}(e.id,C,T,S,i,n.representations[r.A.Labelmap],t,o,_,c)},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=(0,l.getToolGroup)(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,a.getEnabledElementByIds)(n,i);(0,c.A)(o.viewport.element,t)}}(e,t),s.removeSegmentationRepresentation(e,t),n){(0,l.getToolGroup)(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,a.getEnabledElementByIds)(e,t).viewport.render()}))}}}},94152:(e,t,n)=>{n.d(t,{M$:()=>se,yT:()=>kt,wh:()=>i.wh,EC:()=>i.EC,ao:()=>Pt,oS:()=>i.oS,Mu:()=>De.A,ls:()=>_n.A,pq:()=>Sn,Vl:()=>rt,G2:()=>gn,EV:()=>Ht,ep:()=>J,j$:()=>Fe,qD:()=>nt,dB:()=>Jt,Np:()=>Kt,LW:()=>Le,Ix:()=>Mt,Ys:()=>yt,uJ:()=>x,eh:()=>te,Xr:()=>Bn,Nk:()=>me,Uj:()=>Mn,CH:()=>r,PlanarFreehandContourSegmentationTool:()=>St.A,ex:()=>Tt.A,A5:()=>E,N7:()=>We,mX:()=>wn,TR:()=>fn,E0:()=>Ye,td:()=>sn,xI:()=>Te,LL:()=>ge,X8:()=>ge,FE:()=>be,IX:()=>zn,t0:()=>Qt.A,cN:()=>we,zH:()=>vn,qT:()=>Ct,J2:()=>It,uf:()=>C,ae:()=>v,So:()=>c,oi:()=>$t,Y1:()=>D,Du:()=>h,OQ:()=>S});var i=n(96214),o=n(44656);class a extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),a=n.world,r=i.viewport.getCamera(),{focalPoint:s,position:l}=r,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[s[0]-a[0],s[1]-a[1],s[2]-a[2]];i.viewport.setCamera({focalPoint:c,position:d}),i.viewport.render()}}a.toolName="Pan";const r=a;var s=n(61199),l=n(44753);class d extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{viewport:a}=i,r=a.getDefaultActor().actor.getMapper(),s=r.getSampleDistance();return r.setSampleDistance(2*s),null!==this.cleanUp&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{r.setSampleDistance(s),a.render()},document.addEventListener("mouseup",this.cleanUp,{once:!0}),!0},this.rotateCamera=(e,t,n,i)=>{const o=e.getVtkActiveCamera(),a=o.getViewUp(),r=o.getFocalPoint(),s=o.getPosition(),d=[0,0,0],c=[0,0,0],g=[0,0,0],h=l.pB.identity(new Float32Array(16));l.pB.translate(h,h,t),l.pB.rotate(h,h,i,n),l.pB.translate(h,h,[-t[0],-t[1],-t[2]]),l.eR.transformMat4(d,s,h),l.eR.transformMat4(c,r,h),l.pB.identity(h),l.pB.rotate(h,h,i,n),l.eR.transformMat4(g,a,h),e.setCamera({position:d,viewUp:g,focalPoint:c})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:i}=e.detail,a=n.canvas,r=i.canvas,{rotateIncrementDegrees:l}=this.configuration,d=(0,o.getEnabledElement)(t),{viewport:c}=d,g=c.getCamera(),h=t.clientWidth,u=t.clientHeight,m=[a[0]/h,a[1]/u],v=[r[0]/h,r[1]/u],p=[.5*h,.5*u],f=c.canvasToWorld(p),E=(1+Math.abs(.5))**2,I=[v[0],0,0],w=[m[0],0,0],C=I[0]**2,T=w[0]**2,S=C>E?0:Math.sqrt(E-C),_=T>E?0:Math.sqrt(E-T),b=[I[0],0,S];s.Ay.normalize(b);const D=[w[0],0,_];s.Ay.normalize(D);const A=s.Ay.dot(b,D);if(Math.abs(A)>1e-4){const e=-2*Math.acos(s.Ay.clampValue(A,-1,1))*Math.sign(m[0]-v[0])*l,t=g.viewUp,n=g.viewPlaneNormal,i=[0,0,0],o=[0,0,0];s.Ay.cross(t,n,i),s.Ay.normalize(i),s.Ay.cross(n,i,o),s.Ay.normalize(o),s.Ay.normalize(t),this.rotateCamera(c,f,o,e);const a=(v[1]-m[1])*l;this.rotateCamera(c,f,i,a),c.render()}}}d.toolName="TrackballRotate";const c=d;class g extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),i=t[0]*t[1];let o,a;e instanceof Float32Array?(o=4,a=Float32Array):e instanceof Uint8Array?(o=1,a=Uint8Array):e instanceof Uint16Array?(o=2,a=Uint16Array):e instanceof Int16Array&&(o=2,a=Int16Array);const r=new a(e.buffer,n*i*o,i),{max:s,min:l}=this._getMinMax(r,i);return s-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),{renderingEngine:a,viewport:r}=i;let s,l,d,c,g,h,u=!1;const m=r.getProperties();if(r instanceof o.VolumeViewport){const e=this.getTargetId(r);s=o.utilities.getVolumeId(e),h=o.utilities.getViewportsWithVolumeId(s,a.id),({lower:l,upper:d}=m.voiRange);const t=o.cache.getVolume(s);if(!t)throw new Error("Volume not found "+s);c=t.metadata.Modality,u=t.scaling&&Object.keys(t.scaling).length>0}else{if(!m.voiRange)throw new Error("Viewport is not a valid type");{c=r.modality,({lower:l,upper:d}=m.voiRange);const{preScale:e={scaled:!1}}=r.getImageData?.()||{};u=e.scaled&&void 0!==e.scalingParameters?.suvbw}}g="PT"===c&&u?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:l,upper:d,clientHeight:t.clientHeight,isPreScaled:u,viewport:r,volumeId:s}):this.getNewRange({viewport:r,deltaPointsCanvas:n.canvas,volumeId:s,lower:l,upper:d}),g.lower>=g.upper||(r.setProperties({voiRange:g}),r.render(),r instanceof o.VolumeViewport&&h.forEach((e=>{r!==e&&e.render()})))}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:i,viewport:o,volumeId:a,isPreScaled:r}){let s=4;s=r?5/i:this._getMultiplierFromDynamicRange(o,a)||4;return n-=e[1]*s,{lower:t,upper:n=r?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:i,upper:a}){const r=this._getMultiplierFromDynamicRange(e,n)||4,s=t[0]*r,l=t[1]*r;let{windowWidth:d,windowCenter:c}=o.utilities.windowLevel.toWindowLevel(i,a);return d+=s,c+=l,d=Math.max(d,1),o.utilities.windowLevel.toLowHighRange(d,c)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const e=o.cache.getVolume(t),{dimensions:i}=e,a=e.getScalarData(),r=this._getImageDynamicRangeFromMiddleSlice(a,i),s=e?.metadata?.BitsStored,l=s?2**s:1/0;n=Math.min(r,l)}else n=this._getImageDynamicRangeFromViewport(e);const i=n/1024;return i>1?Math.round(i):i}_getImageDynamicRangeFromViewport(e){const{imageData:t}=e.getImageData(),n=t.getDimensions();if(t.getRange){const e=t.getRange();return e[1]-e[0]}let i,o;if(i=t.getScalarData?t.getScalarData():t.getPointData().getScalars(),1!==n[2])return this._getImageDynamicRangeFromMiddleSlice(i,n);if(i.getRange)o=i.getRange();else{const{min:e,max:t}=this._getMinMax(i,i.length);o=[e,t]}return o[1]-o[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let o=0;o<t;o++){const t=e[o];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}g.toolName="WindowLevel";const h=g;var u=n(21013);class m extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{deltaPoints:t,viewportId:n,renderingEngineId:i}=e.detail,{viewport:a}=(0,o.getEnabledElementByIds)(n,i),r=this.getTargetId(a),{debounceIfNotLoaded:s,invert:l,loop:d}=this.configuration,c=t.canvas[1];let g;a instanceof o.VolumeViewport&&(g=r.split(/volumeId:|\?/)[1]);const h=this._getPixelPerImage(a),m=c+this.deltaY;if(h)if(Math.abs(m)>=h){const e=Math.round(m/h);(0,u.scroll)(a,{delta:l?-e:e,volumeId:g,debounceLoading:s,loop:d}),this.deltaY=m%h}else this.deltaY=m}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}m.toolName="StackScroll";const v=m;var p=n(52475);class f extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:i}=e.detail,a=n.world,r=i.world,s=(0,o.getEnabledElement)(t),{viewport:d}=s,c=d.getCamera(),g=[.5*t.clientWidth,.5*t.clientHeight],h=d.canvasToWorld(g);let u=(0,p.A)([r,h],[h,a]);const{viewPlaneNormal:m,viewUp:v}=c,f=l.eR.sub(l.eR.create(),h,r),E=l.eR.sub(l.eR.create(),h,a),I=l.eR.cross(l.eR.create(),f,E);if(l.eR.dot(m,I)>0&&(u=-u),!Number.isNaN(u)){if(d instanceof o.BaseVolumeViewport){const e=u*Math.PI/180,t=l.pB.identity(new Float32Array(16));l.pB.rotate(t,t,e,m);const n=l.eR.transformMat4(l.eR.create(),v,t);d.setCamera({viewUp:n})}else{const{rotation:e}=d.getProperties();d.setProperties({rotation:e+u})}d.render()}}}f.toolName="PlanarRotate";const E=f;var I=n(21783);class w extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1,scrollSlabs:!1}}){super(e,t)}mouseWheelCallback(e){const{wheel:t,element:n}=e.detail,{direction:i}=t,{invert:a}=this.configuration,{viewport:r}=(0,o.getEnabledElement)(n),s=i*(a?-1:1),l=this.getTargetId(r),d=o.utilities.getVolumeId(l);(0,I.A)(r,{delta:s,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:d,scrollSlabs:this.configuration.scrollSlabs})}}w.toolName="StackScrollMouseWheel";const C=w;class T extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,a=i.world,r=(0,o.getEnabledElement)(n).viewport.getCamera(),{focalPoint:s}=r;this.initialMousePosWorld=a;let d=l.eR.fromValues(s[0]-a[0],s[1]-a[1],s[2]-a[2]);return d=l.eR.normalize(l.eR.create(),d),this.dirVec=d,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,i=!1)=>{const{element:o,deltaPoints:a}=e.detail,r=i?e.detail.deltaDistance.canvas:a.canvas[1],s=[o.clientWidth,o.clientHeight],{parallelScale:d,focalPoint:c,position:g}=n,h=r*(5/s[1])*(this.configuration.invert?-1:1),u=(1-h)*d;let m=c,v=g;if(!this.configuration.zoomToCenter){const e=l.eR.distance(c,this.initialMousePosWorld);v=l.eR.scaleAndAdd(l.eR.create(),g,this.dirVec,-e*h),m=l.eR.scaleAndAdd(l.eR.create(),c,this.dirVec,-e*h)}const p=t.getImageData();let f=[1,1,1];p&&(f=p.spacing);const{minZoomScale:E,maxZoomScale:I}=this.configuration,w=o.clientHeight*f[1]*.5,C=w/u;let T=u,S=!1;p&&(C<E?(T=w/E,S=!0):C>=I&&(T=w/I,S=!0)),t.setCamera({parallelScale:T,focalPoint:S?c:m,position:S?g:v})},this._dragPerspectiveProjection=(e,t,n,i=!1)=>{const{element:o,deltaPoints:a}=e.detail,r=i?e.detail.deltaDistance.canvas:a.canvas[1],l=[o.clientWidth,o.clientHeight],{position:d,focalPoint:c,viewPlaneNormal:g}=n,h=s.Ay.distance2BetweenPoints(d,c),u=Math.sqrt(h)/l[1],m=[-g[0],-g[1],-g[2]],v=this.configuration.invert?r/u:r*u;let p=v*m[0];d[0]+=p,c[0]+=p,p=v*m[1],d[1]+=p,c[1]+=p,p=v*m[2],d[2]+=p,c[2]+=p,t.setCamera({position:d,focalPoint:c})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),{viewport:a}=i,r=a.getCamera(),s=n.world,{focalPoint:d}=r;this.initialMousePosWorld=s;let c=l.eR.fromValues(d[0]-s[0],d[1]-s[1],d[2]-s[2]);c=l.eR.normalize(l.eR.create(),c),this.dirVec=c,r.parallelProjection?this._dragParallelProjection(e,a,r,!0):this._dragPerspectiveProjection(e,a,r,!0),a.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,o.getEnabledElement)(t),{viewport:i}=n,a=i.getCamera();a.parallelProjection?this._dragParallelProjection(e,i,a):this._dragPerspectiveProjection(e,i,a),i.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),a=n.world,r=i.viewport.getCamera(),{focalPoint:s,position:l}=r,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[s[0]-a[0],s[1]-a[1],s[2]-a[2]];i.viewport.setCamera({focalPoint:c,position:d}),i.viewport.render()}}T.toolName="Zoom";const S=T,_=[0,0,1];class b extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:_,rotateIncrementDegrees:30}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,i=(0,o.getEnabledElement)(t),{viewport:a}=i,{direction:r,rotateIncrementDegrees:s}=this.configuration,d=a.getCamera(),{viewUp:c,position:g,focalPoint:h}=d,{direction:u}=n,[m,v,p]=h,[f,E,I]=r,w=u*(s*Math.PI)/180,C=[0,0,0],T=[0,0,0],S=[0,0,0],_=l.pB.identity(new Float32Array(16));l.pB.translate(_,_,[m,v,p]),l.pB.rotate(_,_,w,[f,E,I]),l.pB.translate(_,_,[-m,-v,-p]),l.eR.transformMat4(C,g,_),l.eR.transformMat4(T,h,_),l.pB.identity(_),l.pB.rotate(_,_,w,[f,E,I]),l.eR.transformMat4(S,c,_),a.setCamera({position:C,viewUp:S,focalPoint:T}),a.render()}}b.toolName="VolumeRotateMouseWheel";const D=b;var A=n(84797),y=n(88240),R=n(52610);class M extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),{viewport:a,renderingEngine:r}=i,s=this.getTargetId(a);if(!s.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");const l=o.utilities.getVolumeId(s);let d=-1/0;const c=(0,A.getPointInLineOfSightWithCriteria)(a,n.world,l,((e,t)=>{if(e>d)return d=e,t}));if(!c||!c.length)return;const{targetViewportIds:g,toolGroupId:h}=this.configuration;r.getViewports().filter((e=>{if(g?.indexOf(e.id)>=0)return!0;const t=(0,R.getToolGroupForViewport)(e.id,r.id);return!(!h||h!==t?.id)})).forEach((e=>{e instanceof o.VolumeViewport?(0,y.A)(e,c):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}M.toolName="MIPJumpToClickTool";const x=M;var O=n(52961),L=n(38296),P=n(2746),N=n(61738),U=n(84901),k=n(90252),V=n(40233),W=n(86981),B=n(21954),H=n(48428),F=n(23072);const{RENDERING_DEFAULTS:G}=o.CONSTANTS;function q(){return"rgb(0, 200, 0)"}function $(){return!0}function z(){return!0}function Z(){return!0}const j=1,K=2,Y=3;class X extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:o.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,o.getEnabledElementByIds)(t,e),{FrameOfReferenceUID:i,viewport:a}=n,{element:r}=a,{position:s,focalPoint:l,viewPlaneNormal:d}=a.getCamera();let c=this._getAnnotations(n);c=this.filterInteractableAnnotationsForElement(r,c),c.length&&(0,L.removeAnnotation)(c[0].annotationUID);const g={highlighted:!1,metadata:{cameraPosition:[...s],cameraFocalPoint:[...l],FrameOfReferenceUID:i,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}};return(0,L.addAnnotation)(g,r),{normal:d,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}},this._getViewportsInfo=()=>(0,R.getToolGroup)(this.toolGroupId).viewportsInfo,this.resetCrosshairs=()=>{const e=this._getViewportsInfo();e.forEach((({viewportId:e,renderingEngineId:t})=>{const n=(0,o.getEnabledElementByIds)(e,t),{viewport:i}=n,{element:a}=i;let r=this._getAnnotations(n);r=this.filterInteractableAnnotationsForElement(a,r),r.length&&(0,L.removeAnnotation)(r[0].annotationUID)})),this.computeToolCenter(e)},this.computeToolCenter=e=>{if(!e.length||1===e.length)return void console.warn("For crosshairs to operate, at least two viewports must be given.");const[t,n,i]=e,{normal:a,point:r}=this.initializeViewport(t),{normal:s,point:d}=this.initializeViewport(n);let c=[0,0,0],g=l.eR.create();i?({normal:c,point:g}=this.initializeViewport(i)):(l.eR.add(g,r,d),l.eR.scale(g,g,.5),l.eR.cross(c,a,s));const h=o.utilities.planar.planeEquation(a,r),u=o.utilities.planar.planeEquation(s,d),m=o.utilities.planar.planeEquation(c,g);this.toolCenter=o.utilities.planar.threePlaneIntersection(h,u,m);const{renderingEngine:v}=(0,o.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId);(0,F.A)(v,e.map((({viewportId:e})=>e)))},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.world,r=(0,o.getEnabledElement)(n),{viewport:s}=r;this._jump(r,a);const l=this._getAnnotations(r),d=this.filterInteractableAnnotationsForElement(s.element,l),{data:c}=d[0],{rotationPoints:g}=c.handles,h=[];for(let e=0;e<g.length-1;++e){const t=g[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(h.push(t.id),e++)}return c.activeViewportIds=[...h],c.handles.activeOperation=j,e.preventDefault(),(0,V.hideElementCursor)(n),this._activateModify(n),d[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),(0,V.hideElementCursor)(i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i;t.highlighted=!0,this._activateModify(o),(0,V.hideElementCursor)(o),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{renderingEngine:a}=i,r=i.viewport,l=this._getAnnotations(i),d=this.filterInteractableAnnotationsForElement(n,l)[0];if(!d)return;const c=r.getCamera(),g=d.metadata.cameraPosition,h=[0,0,0];s.Ay.subtract(c.position,g,h);const u=d.metadata.cameraFocalPoint,m=[0,0,0];s.Ay.subtract(c.focalPoint,u,m),d.metadata.cameraPosition=[...c.position],d.metadata.cameraFocalPoint=[...c.focalPoint];const v=this._getReferenceLineControllable(r.id),p=this._getReferenceLineDraggableRotatable(r.id);if(!o.utilities.isEqual(c.position,g,.001)&&v&&p){let e=!1;o.utilities.isEqual(h,m,.001)||(e=!0);const t=Math.abs(s.Ay.dot(h,c.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=h[0],this.toolCenter[1]+=h[1],this.toolCenter[2]+=h[2])}if(this.configuration.autoPan?.enabled){(0,R.getToolGroupForViewport)(r.id,a.id).getViewportIds().filter((e=>e!==r.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,a)}))}const f=(0,k.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,F.A)(a,f)},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(let e=0;e<t.length;e++){const i=t[e];if((0,H.isAnnotationLocked)(i))continue;const{data:r,highlighted:s}=i;if(!r.handles)continue;const l=r.handles.activeOperation,d=r.activeViewportIds&&r.activeViewportIds.length>0?[...r.activeViewportIds]:[];r.activeViewportIds=[],r.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,i,o,6)||this._pointNearTool(n,i,o,6);c&&!s||!c&&s?(i.highlighted=!s,a=!0):r.handles.activeOperation===l&&this._areViewportIdArraysEqual(r.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,o.getEnabledElement)(e),{viewportId:i}=n;return t.filter((e=>e.data.viewportId===i))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,renderingEngine:o}=e,{element:a}=i,r=this._getAnnotations(e),d=i.getCamera(),c=this.filterInteractableAnnotationsForElement(a,r)[0];if(!r?.length||!c?.data)return n;const g=c.annotationUID,{clientWidth:h,clientHeight:u}=i.canvas,m=Math.sqrt(h*h+u*u),v=Math.min(h,u),p=c.data,f=i.worldToCanvas(this.toolCenter),E=this._filterAnnotationsByUniqueViewportOrientations(e,r),I=[],w=[0,0,h,u];E.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=o.getViewport(t.viewportId),a=n.getCamera(),r=this._getReferenceLineControllable(n.id),c=this._getReferenceLineDraggableRotatable(n.id),g=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:h,clientHeight:u}=n.canvas,p=Math.sqrt(h*h+u*u),C=[.5*h,.5*u],T=n.canvasToWorld(C),S=[0,0,0];s.Ay.cross(d.viewPlaneNormal,a.viewPlaneNormal,S),s.Ay.normalize(S),s.Ay.multiplyScalar(S,p);const _=[0,0,0];s.Ay.add(T,S,_);const b=[0,0,0];s.Ay.subtract(T,S,b);const D=i.worldToCanvas(_),A=i.worldToCanvas(T),y=l.Zc.create();l.Zc.subtract(y,D,A),l.Zc.normalize(y,y);const R=l.Zc.create();l.Zc.scale(R,y,100*m);const M=l.Zc.create();l.Zc.scale(M,y,.4*v);const x=l.Zc.create();l.Zc.scale(x,y,.2*v);const L=l.Zc.create(),P=this.configuration.referenceLinesCenterGapRadius;l.Zc.scale(L,y,2===E.length?P:0);const N=l.Zc.create(),U=l.Zc.create(),k=l.Zc.create(),V=l.Zc.create();let B=l.Zc.clone(f);c&&r||(B=l.Zc.clone(A)),l.Zc.add(N,B,L),l.Zc.add(U,B,R),l.Zc.subtract(k,B,L),l.Zc.subtract(V,B,R),(0,W.A)(N,U,w),(0,W.A)(k,V,w);const H=l.Zc.create();l.Zc.subtract(H,f,M);const F=l.Zc.create();l.Zc.add(F,f,M);let G=l.Zc.clone(f);!c&&g&&(G=l.Zc.clone(A));let q=[...this.toolCenter];!c&&g&&(q=[...T]);const $=[0,0,0];s.Ay.subtract(_,b,$),s.Ay.normalize($);const{viewPlaneNormal:z}=d,{matrix:Z}=O.A.buildFromDegree().rotate(90,z),j=[0,0,0];l.eR.transformMat4(j,$,Z);const K=n.getSlabThickness(),Y=[...j];s.Ay.multiplyScalar(Y,K);const X=[0,0,0];s.Ay.add(q,Y,X);const J=i.worldToCanvas(X),Q=l.Zc.create();l.Zc.subtract(Q,G,J);const ee=l.Zc.create();l.Zc.subtract(ee,G,R),l.Zc.add(ee,ee,Q);const te=l.Zc.create();l.Zc.add(te,G,R),l.Zc.add(te,te,Q),(0,W.A)(ee,te,w);const ne=l.Zc.create();l.Zc.add(ne,G,R),l.Zc.subtract(ne,ne,Q);const ie=l.Zc.create();l.Zc.subtract(ie,G,R),l.Zc.subtract(ie,ie,Q),(0,W.A)(ne,ie,w);const oe=l.Zc.create(),ae=l.Zc.create(),re=l.Zc.create(),se=l.Zc.create();l.Zc.subtract(oe,G,x),l.Zc.add(oe,oe,Q),l.Zc.add(ae,G,x),l.Zc.add(ae,ae,Q),l.Zc.subtract(re,G,x),l.Zc.subtract(re,re,Q),l.Zc.add(se,G,x),l.Zc.subtract(se,se,Q),I.push([n,N,U,k,V,ee,te,ne,ie,H,F,oe,ae,re,se])}));const C=[],T=[],S=this._getReferenceLineColor(i.id),_=void 0!==S?S:"rgb(200, 200, 200)";if(I.forEach(((e,n)=>{const o=e[0],a=this._getReferenceLineColor(o.id),r=this._getReferenceLineControllable(o.id),s=this._getReferenceLineDraggableRotatable(o.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(o.id)||this.configuration.mobile?.enabled,d=p.activeViewportIds.find((e=>e===o.id));let c=void 0!==a?a:"rgb(200, 200, 200)",h=1;const u=null!==p.handles.activeOperation&&p.handles.activeOperation===j&&d;u&&(h=2.5);let m=`${n}`;if(r&&s?(m=`${n}One`,(0,P.drawLine)(t,g,m,e[1],e[2],{color:c,lineWidth:h}),m=`${n}Two`,(0,P.drawLine)(t,g,m,e[3],e[4],{color:c,lineWidth:h})):(0,P.drawLine)(t,g,m,e[2],e[4],{color:c,lineWidth:h}),r){c=void 0!==a?a:"rgb(200, 200, 200)";const r=p.handles.activeOperation===K,h=[e[9],e[10]],v=[i.canvasToWorld(e[9]),o,e[1],e[2]],f=[i.canvasToWorld(e[10]),o,e[3],e[4]];C.push(v,f);const E=p.handles.activeOperation===Y,I=[e[11],e[12],e[13],e[14]],w=[i.canvasToWorld(e[11]),o,e[5],e[6]],S=[i.canvasToWorld(e[12]),o,e[5],e[6]],_=[i.canvasToWorld(e[13]),o,e[7],e[8]],b=[i.canvasToWorld(e[14]),o,e[7],e[8]];if(T.push(w,S,_,b),(u||this.configuration.mobile?.enabled)&&!r&&!E&&s&&l){let e=`${n}One`;(0,P.drawHandles)(t,g,e,h,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),e=`${n}Two`,(0,P.drawHandles)(t,g,e,I,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(u&&!r&&!E&&s){const e=`${n}`;(0,P.drawHandles)(t,g,e,h,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(d&&!r&&!E&&l){const e=`${n}`;(0,P.drawHandles)(t,g,e,I,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(r&&s){const e=`${n}`;(0,P.drawHandles)(t,g,e,h,{color:c,handleRadius:2,fill:c,type:"circle"})}else E&&d&&l&&(0,P.drawHandles)(t,g,m,I,{color:c,handleRadius:2,fill:c,type:"rect"});o.getSlabThickness()>.5&&l&&(m=`${n}STOne`,(0,P.drawLine)(t,g,m,e[5],e[6],{color:c,width:1,lineDash:[2,3]}),m=`${n}STTwo`,(0,P.drawLine)(t,g,m,e[7],e[8],{color:c,width:e,lineDash:[2,3]}))}})),n=!0,p.handles.rotationPoints=C,p.handles.slabThicknessPoints=T,this.configuration.viewportIndicators){const e=[.95*h,.05*u],n=.01*m,i="0";(0,P.drawCircle)(t,g,i,e,n,{color:_,fill:_})}return n},this._getAnnotations=e=>{const{viewport:t}=e,n=(0,L.getAnnotations)(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map((({viewportId:e})=>e));return n.filter((e=>{const{data:t}=e;return i.includes(t.viewportId)}))},this._onNewVolume=e=>{const t=this._getViewportsInfo();this.computeToolCenter(t)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1})),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:i,viewport:a}=e,r=t.filter((e=>e.data.viewportId!==n));if(!r||!r.length)return[];const s=a.getCamera(),{viewPlaneNormal:l,position:d}=s,c=r.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera();return!(o.utilities.isEqual(n.viewPlaneNormal,l,.01)&&o.utilities.isEqual(n.position,d,1))}));return c},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:i}=e,{data:a}=t,r=i.getViewport(a.viewportId),l=n.filter((e=>{const{data:t}=e,n=i.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!l||!l.length)return[];const d=r.getCamera(),c=d.viewPlaneNormal;s.Ay.normalize(c);return l.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera(),a=n.viewPlaneNormal;return s.Ay.normalize(a),o.utilities.isEqual(c,a,.01)&&o.utilities.isEqual(d.viewUp,n.viewUp,.01)}))},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:i}=e,a=i.getCamera().viewPlaneNormal;s.Ay.normalize(a);const r=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0===a})),l=[];for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,d=n.getViewport(i).getCamera(),c=d.viewPlaneNormal;if(s.Ay.normalize(c),o.utilities.isEqual(a,c,.01)||o.utilities.isOpposite(a,c,.01))continue;let g=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera();o.utilities.isEqual(a.viewPlaneNormal,d.viewPlaneNormal,.01)&&o.utilities.isEqual(a.position,d.position,1)&&(g=!0)}g||l.push(t)}const d=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0!==a}));for(let e=0;e<d.length;++e){const t=d[e],{viewportId:i}=t.data,r=n.getViewport(i).getCamera(),c=r.viewPlaneNormal;if(s.Ay.normalize(c),o.utilities.isEqual(a,c,.01)||o.utilities.isOpposite(a,c,.01))continue;let g=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera();o.utilities.isEqual(a.viewPlaneNormal,r.viewPlaneNormal,.01)&&o.utilities.isEqual(a.position,r.position,1)&&(g=!0)}g||l.push(t)}const c=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<c.length;++e){const t=c[e];if(l.some((e=>e===t)))continue;const{viewportId:i}=t.data,r=n.getViewport(i).getCamera(),d=r.viewPlaneNormal;if(s.Ay.normalize(d),o.utilities.isEqual(a,d,.01)||o.utilities.isOpposite(a,d,.01))continue;let g=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera();o.utilities.isEqual(a.viewPlaneNormal,r.viewPlaneNormal,.01)&&o.utilities.isEqual(a.position,r.position,1)&&(g=!0)}g||l.push(t)}return l},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getActors(),i=t.getActors();let o=!0;return n.forEach((e=>{n.length===i.length&&void 0!==i.find((({uid:t})=>t===e.uid))||(o=!1)})),o},this._jump=(e,t)=>{N.wk.isInteractingWithTool=!0;const{viewport:n,renderingEngine:i}=e,o=this._getAnnotations(e),a=[0,0,0];s.Ay.subtract(t,this.toolCenter,a);const r=this._getAnnotationsForViewportsWithDifferentCameras(e,o).filter((e=>{const{data:t}=e,o=i.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,o);return this._getReferenceLineControllable(o.id)&&this._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===r.length?(N.wk.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,r,a),N.wk.isInteractingWithTool=!1,!0)},this._activateModify=e=>{N.wk.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),(0,V.resetElementCursor)(n),this.editData=null;const i=(0,o.getEnabledElement)(n),{renderingEngine:a}=i,r=(0,k.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,F.A)(a,r)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:i}=t,a=(0,o.getEnabledElement)(i),{renderingEngine:r,viewport:d}=a,c=this._getAnnotations(a),g=this.filterInteractableAnnotationsForElement(i,c)[0];if(!g)return;const{handles:h}=g.data,{currentPoints:u}=e.detail,m=u.canvas;if(h.activeOperation===j){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,c).filter((e=>{const{data:t}=e,n=r.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o&&g.data.activeViewportIds.find((e=>e===n.id))}));this._applyDeltaShiftToSelectedViewportCameras(r,e,n)}else if(h.activeOperation===K){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,c).filter((e=>{const{data:t}=e,n=r.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o})),n=l.Zc.create(),i=l.Zc.create(),o=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],s=d.worldToCanvas(o),g=t.currentPoints.canvas,h=l.Zc.create();l.Zc.sub(h,g,t.deltaPoints.canvas),l.Zc.sub(n,h,s),l.Zc.sub(i,g,s);let u=l.Zc.angle(n,i);this._isClockWise(s,h,g)&&(u*=-1),u=Math.round(100*u)/100;const m=d.getCamera().viewPlaneNormal,{matrix:v}=O.A.buildFromRadian().translate(o[0],o[1],o[2]).rotate(u,m).translate(-o[0],-o[1],-o[2]),p=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=o;const n=r.getViewport(t.viewportId),i=n.getCamera(),{viewUp:a,position:s,focalPoint:d}=i;a[0]+=s[0],a[1]+=s[1],a[2]+=s[2],l.eR.transformMat4(d,d,v),l.eR.transformMat4(s,s,v),l.eR.transformMat4(a,a,v),a[0]-=s[0],a[1]-=s[1],a[2]-=s[2],n.setCamera({position:s,viewUp:a,focalPoint:d}),p.push(n.id)})),r.renderViewports(p)}else if(h.activeOperation===Y){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,c).filter((e=>{const{data:t}=e,n=r.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===o&&g.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const i=this._filterViewportWithSameOrientation(a,e[0],c),h=[];h.push(d.id),i.forEach((e=>{const{data:i}=e,a=r.getViewport(i.viewportId),c=a.getCamera().viewPlaneNormal,u=s.Ay.dot(n,c),v=[...c];if(s.Ay.multiplyScalar(v,u),Math.abs(v[0])>.001||Math.abs(v[1])>.001||Math.abs(v[2])>.001){const e=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),n=t.lastPoints.world,i=[0,0,0],u=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(a.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===a.id));if(2===t.length){const e=d.canvasToWorld(t[0][3]),n=d.canvasToWorld(t[1][3]);s.Ay.add(e,n,u),s.Ay.multiplyScalar(u,.5)}}s.Ay.subtract(n,u,i);const p=s.Ay.dot(i,c),f=[...c];s.Ay.multiplyScalar(f,p);const E=[f[0],f[1],f[2]];l.eR.normalize(E,E);const I=[v[0],v[1],v[2]];l.eR.normalize(I,I);let w=a.getSlabThickness();o.utilities.isOpposite(E,I,.001)?w-=e:w+=e,w=Math.abs(w),w=Math.max(G.MINIMUM_SLAB_THICKNESS,w);this._pointNearReferenceLine(g,m,6,a)&&(w=G.MINIMUM_SLAB_THICKNESS);(0,R.getToolGroupForViewport)(a.id,r.id).getToolInstance(this.getToolName()).setSlabThickness(a,w),h.push(a.id)}})),r.renderViewports(h)}},this._pointNearReferenceLine=(e,t,n,i)=>{const{data:o}=e,{rotationPoints:a}=o.handles;for(let e=0;e<a.length-1;++e){const o=a[e][1];if(o.id!==i.id)continue;if(!this._getReferenceLineControllable(o.id))continue;const r={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},s=B.distanceToPoint([r.start.x,r.start.y],[r.end.x,r.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=B.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(s<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||q,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||$,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||z,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||Z}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((({renderingEngineId:e,viewportId:t})=>{const n=(0,o.getEnabledElementByIds)(t,e);if(!n)return;const i=this._getAnnotations(n);i?.length&&i.forEach((e=>{(0,L.removeAnnotation)(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,i){const a=(0,o.getEnabledElement)(e),{viewport:r}=a;let s=this._getRotationHandleNearImagePoint(r,t,n,i);return null!==s?s:(s=this._getSlabThicknessHandleNearImagePoint(r,t,n,i),null!==s?s:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,o.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(o.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,o.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(o.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:i,clientHeight:o}=n.canvas,a=n.worldToCanvas(this.toolCenter),r=this.configuration.autoPan.panSize,s=[a[0],a[1]];if(a[0]<0?s[0]=r:a[0]>i&&(s[0]=i-r),a[1]<0?s[1]=r:a[1]>o&&(s[1]=o-r),s[0]===a[0]&&s[1]===a[1])return;const l=n.canvasToWorld(s),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:g,position:h}=c,u=[h[0]-d[0],h[1]-d[1],h[2]-d[2]],m=[g[0]-d[0],g[1]-d[1],g[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:i}=this.configuration;i&&i.length>0&&(n=i);let a=this.configuration.slabThicknessBlendMode;t===G.MINIMUM_SLAB_THICKNESS&&(a=o.Enums.BlendModes.COMPOSITE);e.setBlendMode(a,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,o=e.getViewport(i.viewportId),a=o.getCamera(),r=a.viewPlaneNormal,l=s.Ay.dot(n,r),d=[...r];if(s.Ay.multiplyScalar(d,l),Math.abs(d[0])>.001||Math.abs(d[1])>.001||Math.abs(d[2])>.001){const e=[0,0,0],t=[0,0,0];s.Ay.add(a.focalPoint,d,e),s.Ay.add(a.position,d,t),o.setCamera({focalPoint:e,position:t}),o.render()}}_getRotationHandleNearImagePoint(e,t,n,i){const{data:o}=t,{rotationPoints:a}=o.handles;for(let r=0;r<a.length;r++){const s=a[r][0],d=a[r][1];if(!this._getReferenceLineControllable(d.id))continue;if(!this._getReferenceLineDraggableRotatable(d.id))continue;const c=e.worldToCanvas(s);if(l.Zc.distance(n,c)<i)return o.handles.activeOperation=K,this.editData={annotation:t},s}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){const{data:o}=t,{slabThicknessPoints:a}=o.handles;for(let r=0;r<a.length;r++){const s=a[r][0],d=a[r][1];if(!this._getReferenceLineControllable(d.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(d.id))continue;const c=e.worldToCanvas(s);if(l.Zc.distance(n,c)<i)return o.handles.activeOperation=Y,o.activeViewportIds=[d.id],this.editData={annotation:t},s}return null}_pointNearTool(e,t,n,i){const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{clientWidth:s,clientHeight:d}=r.canvas,c=Math.sqrt(s*s+d*d),{data:g}=t,{rotationPoints:h}=g.handles,{slabThicknessPoints:u}=g.handles,m=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!o||!a)continue;const r={start:{x:h[e][2][0],y:h[e][2][1]},end:{x:h[e][3][0],y:h[e][3][1]}},s=B.distanceToPoint([r.start.x,r.start.y],[r.end.x,r.end.y],[n[0],n[1]]),l={start:{x:h[e+1][2][0],y:h[e+1][2][1]},end:{x:h[e+1][3][0],y:h[e+1][3][1]}},d=B.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(s<=i||d<=i)&&(m.push(t.id),g.handles.activeOperation=j),e++}for(let e=0;e<u.length-1;++e){const t=u[e][1];if(m.find((e=>e===t.id)))continue;const o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!o||!a)continue;const r=u[e][2],s=u[e][3],d=l.Zc.create();l.Zc.add(d,r,s),l.Zc.scale(d,d,.5);const h=l.Zc.create();l.Zc.subtract(h,r,d),l.Zc.normalize(h,h);const v=l.Zc.create();l.Zc.scale(v,h,.05*c);const p=l.Zc.create(),f=l.Zc.create();l.Zc.add(p,d,v),l.Zc.subtract(f,d,v);const E={start:{x:p[0],y:p[1]},end:{x:r[0],y:r[1]}},I=B.distanceToPoint([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]),w={start:{x:f[0],y:f[1]},end:{x:s[0],y:s[1]}},C=B.distanceToPoint([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]);(I<=i||C<=i)&&(m.push(t.id),g.handles.activeOperation=null),e++}return g.activeViewportIds=[...m],this.editData={annotation:t},g.handles.activeOperation===j}}X.toolName="Crosshairs";const J=X,Q="magnify-viewport";class ee extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this._hasBeenRemoved=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,a=(0,o.getEnabledElement)(n),{viewport:r,renderingEngine:s}=a;if(!(r instanceof o.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const l=this._getReferencedImageId(r);if(!l)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const d=(0,k.getViewportIdsWithToolToRender)(n,this.getToolName());return this.editData={referencedImageId:l,viewportIdsToRender:d,enabledElement:a,renderingEngine:s,currentPoints:i},this._createMagnificationViewport(),this._activateDraw(n),(0,V.hideElementCursor)(n),e.preventDefault(),(0,F.A)(s,d),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:i,currentPoints:a}=this.editData,{viewport:r}=e,{element:s}=r,l=r.getProperties(),{canvas:d,world:c}=a;let g;if(g=s.querySelector(".magnifyTool"),null===g){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",g=e;s.querySelector(".viewport-element").appendChild(e);const t={viewportId:Q,type:o.Enums.ViewportType.STACK,element:g};i.enableElement(t)}g.style.top=d[1]-this.configuration.magnifyHeight/2+"px",g.style.left=d[0]-this.configuration.magnifyWidth/2+"px";const h=i.getViewport(Q);h.setStack([t]).then((()=>{if(this._hasBeenRemoved)return;h.setProperties(l);const{parallelScale:e}=r.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=h.getCamera(),o=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),a=[c[0],c[1],c[2]],s=[a[0]+o*i[0],a[1]+o*i[1],a[2]+o*i[2]];h.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:a,position:s}),h.render()})),g.style.display="block",(0,F.A)(i,n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:i,currentPoints:a}=t,r=n.world,s=a.canvas,l=(0,o.getEnabledElement)(i),{renderingEngine:d}=l,c=d.getViewport(Q),g=i.querySelector(".magnifyTool");if(!g)return;g.style.top=s[1]-this.configuration.magnifyHeight/2+"px",g.style.left=s[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:h,position:u}=c.getCamera(),m=[u[0]+r[0],u[1]+r[1],u[2]+r[2]],v=[h[0]+r[0],h[1]+r[1],h[2]+r[2]];c.setCamera({focalPoint:v,position:m}),c.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,o.getEnabledElement)(t),{renderingEngine:i}=n;i.disableElement(Q);const a=t.querySelector(".viewport-element"),r=a.querySelector(".magnifyTool");a.removeChild(r),this._deactivateDraw(t),(0,V.resetElementCursor)(t),this._hasBeenRemoved=!0},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,this._hasBeenRemoved=!1,e.addEventListener(U.Events.MOUSE_UP,this._dragEndCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(U.Events.TOUCH_END,this._dragEndCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._dragEndCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(U.Events.TOUCH_END,this._dragEndCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof o.StackViewport&&(n=t.split("imageId:")[1]),n}}ee.toolName="Magnify";const te=ee;var ne,ie=n(21009),oe=n(54177),ae=n(75162),re=n(69847);!function(e){e.ShowZoomFactorsList="showZoomFactorsList"}(ne||(ne={}));class se extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:3,zoomFactorList:[1.5,2,2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:U.MouseBindings.Secondary,modifierKey:U.KeyboardBindings.Shift}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=(0,o.getEnabledElement)(i),{viewport:r,renderingEngine:s}=a,l=n.world,d=n.canvas,{magnifyingGlass:c}=this.configuration,{radius:g,zoomFactor:h,autoPan:u}=c,m=this._getCanvasHandlePoints(d,g),v=r.getCamera(),{viewPlaneNormal:p,viewUp:f}=v,E=this.getReferencedImageId(r,l,p,f),I=o.utilities.uuidv4(),w=o.utilities.uuidv4(),C=r.getFrameOfReferenceUID(),T={annotationUID:I,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...p],viewUp:[...f],FrameOfReferenceUID:C,referencedImageId:E},data:{sourceViewportId:r.id,magnifyViewportId:w,zoomFactor:h,isCanvasAnnotation:!0,handles:{points:m,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(T,{magnifyViewportId:w,sourceEnabledElement:a,position:d,radius:g,zoomFactor:h,autoPan:{enabled:u.enabled,padding:u.padding,callback:e=>{const t=T.data.handles.points,{canvas:n}=e.delta;for(let e=0,i=t.length;e<i;e++){const i=t[e];i[0]+=n[0],i[1]+=n[1],T.invalidated=!0}}}}),(0,L.addAnnotation)(T,i);const S=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return e.preventDefault(),(0,F.A)(s,S),T},this.onSetToolDisabled=()=>{this.magnifyViewportManager.dispose();(0,L.getAllAnnotations)().forEach((e=>{e.metadata.toolName===this.getToolName()&&(0,L.removeAnnotation)(e.annotationUID)}))},this.isPointNearTool=(e,t,n,i)=>{const{data:o}=t,{points:a}=o.handles,r=a,s=r[0],l=r[2],d=r[3],c=.5*Math.abs(l[1]-s[1]),g=[d[0]+c,s[1]+c],h=(0,ae.r)([g,n]);return Math.abs(h-c)<2*i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},(0,V.hideElementCursor)(i),this._activateModify(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;const{points:s}=r.handles,l=s.findIndex((e=>e===n)),d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:l},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r}=this.editData,{data:s}=i;s.handles.activeHandleIndex=null,this._deactivateModify(n),(0,V.resetElementCursor)(n);const l=(0,o.getEnabledElement)(n),{renderingEngine:d}=l;this.editData=null,this.isDrawing=!1,(0,F.A)(d,a),r&&(0,oe.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n,deltaPoints:i}=t,a=i?.canvas??[0,0,0],r=(0,o.getEnabledElement)(n),{renderingEngine:s}=r,{annotation:l,viewportIdsToRender:d}=this.editData,{points:c}=l.data.handles;c.forEach((e=>{e[0]+=a[0],e[1]+=a[1]})),l.invalidated=!0,this.editData.hasMoved=!0,(0,F.A)(s,d)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r}=this.editData,{data:s}=i;if(void 0===r){const{deltaPoints:e}=t,n=e.canvas;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const l=(0,o.getEnabledElement)(n),{renderingEngine:d}=l;(0,F.A)(d,a)},this._dragHandle=e=>{const t=e.detail,{annotation:n}=this.editData,{data:i}=n,{points:o}=i.handles,a=o,r=a[0],s=a[2],l=a[3],d=.5*Math.abs(s[1]-r[1]),c=[l[0]+d,r[1]+d],{currentPoints:g}=t,h=g.canvas,u=(0,ae.r)([c,h]),m=this._getCanvasHandlePoints(c,u);o[0]=m[0],o[1]=m[1],o[2]=m[2],o[3]=m[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const r=(0,o.getEnabledElement)(e),{renderingEngine:s}=r;return(0,F.A)(s,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;a=a?.filter((e=>e.data.sourceViewportId===i.id));const r=this.filterInteractableAnnotationsForElement(o,a);if(!r?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const o=r[e],{annotationUID:a,data:l}=o,{magnifyViewportId:d,zoomFactor:c,handles:g}=l,{points:h,activeHandleIndex:u}=g;s.annotationUID=a;this.getStyle("lineWidth",s,o),this.getStyle("lineDash",s,o);const m=this.getStyle("color",s,o),v=h,p=v[0],f=v[2],E=v[3],I=.5*Math.abs(f[1]-p[1]),w=[E[0]+I,p[1]+I];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let C;if(!(0,ie.isAnnotationVisible)(a))continue;if((0,H.isAnnotationLocked)(o)||this.editData||null===u||(C=[v[u]]),C){const e="0";(0,P.drawHandles)(t,a,e,C,{color:m})}const T=`${a}-advancedMagnify`,S="0";(0,P.drawCircle)(t,a,S,w,I,{color:m,lineWidth:5},T);const _=this.magnifyViewportManager.getViewport(d);_.position=w,_.radius=I,_.zoomFactor=c,_.update(),n=!0}return n},this._getCanvasHandlePoints=(e,t)=>[[e[0],e[1]-t,0],[e[0]+t,e[1],0],[e[0],e[1]+t,0],[e[0]-t,e[1],0]],this.magnifyViewportManager=re.A.getInstance()}static{this.Actions=ne}showZoomFactorsList(e,t){const{element:n,currentPoints:i}=e.detail,a=(0,o.getEnabledElement)(n),{viewport:r}=a,{canvas:s}=i,l=n.querySelector(":scope .viewport-element"),d=t.data.zoomFactor,c=this._getZoomFactorsListDropdown(d,(e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),c.parentElement.removeChild(c),r.render()}));Object.assign(c.style,{left:`${s[0]}px`,top:`${s[1]}px`}),l.appendChild(c),c.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,i=document.createElement("select");return i.size=5,Object.assign(i.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((e=>{i.addEventListener(e,(e=>e.stopPropagation()))})),i.addEventListener("change",(e=>{e.stopPropagation(),t(i.value)})),i.addEventListener("keydown",(e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())})),n.forEach((t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,i.add(n)})),i}}se.toolName="AdvancedMagnify";var le=n(28062);const{EPSILON:de}=o.CONSTANTS;class ce extends le.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",showFullDimension:!1}}){super(e,t),this.editData={},this._init=()=>{const e=(0,o.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,k.filterViewportsWithToolEnabled)(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n?.getImageData())return;const{element:i}=n,{viewUp:a,viewPlaneNormal:r}=n.getCamera(),s=o.utilities.getViewportImageCornersInWorld(n);let l=this.editData.annotation;const d=n.getFrameOfReferenceUID();if(l)this.editData.annotation.data.handles.points=s;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...a],FrameOfReferenceUID:d,referencedImageId:null},data:{handles:{points:s}}};(0,L.addAnnotation)(e,i),l=e}this.editData={sourceViewportId:n.id,renderingEngine:e,annotation:l},(0,F.A)(e,t.filter((e=>e.id!==n.id)).map((e=>e.id)))},this.onSetToolEnabled=()=>{this._init()},this.onSetToolConfiguration=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{annotation:i,sourceViewportId:a}=this.editData;let r=!1;const{viewport:s}=(0,o.getEnabledElementByViewportId)(a)||{};if(!s)return r;if(s.id===n.id)return r;if(!i||!i?.data?.handles?.points)return r;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},c=i.data.handles.points[0],g=i.data.handles.points[1],h=i.data.handles.points[2],u=i.data.handles.points[3],{focalPoint:m,viewPlaneNormal:v,viewUp:p}=n.getCamera(),{viewPlaneNormal:f}=s.getCamera();if(this.isParallel(v,f))return r;const E=o.utilities.planar.planeEquation(v,m),I=[c,h,g,u],w=[c,g,h,u];let C=I,T=l.eR.subtract(l.eR.create(),I[0],I[1]);T=l.eR.normalize(l.eR.create(),T);let S=l.eR.subtract(l.eR.create(),I[2],I[0]);S=l.eR.normalize(l.eR.create(),S);const _=l.eR.cross(l.eR.create(),T,S);if(this.isParallel(_,v))return r;this.isPerpendicular(T,v)&&(C=w);const b=o.utilities.planar.linePlaneIntersection(C[0],C[1],E),D=o.utilities.planar.linePlaneIntersection(C[2],C[3],E),{annotationUID:A}=i;d.annotationUID=A;const y=this.getStyle("lineWidth",d,i),R=this.getStyle("lineDash",d,i),M=this.getStyle("color",d,i),x=this.getStyle("shadow",d,i);let O=[b,D].map((e=>n.worldToCanvas(e)));if(this.configuration.showFullDimension&&(O=this.handleFullDimension(n,b,v,p,D,O)),O.length<2)return r;const L=`${A}-line`;return(0,P.drawLine)(t,A,"1",O[0],O[1],{color:M,width:y,lineDash:R,shadow:x},L),r=!0,r},this.isPerpendicular=(e,t)=>{const n=l.eR.dot(e,t);return Math.abs(n)<de}}handleFullDimension(e,t,n,i,a,r){const s=e.getRenderingEngine(),l=this.getTargetId(e),d=this.getTargetIdImage(l,s),c=this.getReferencedImageId(e,t,n,i);if(c&&d)try{const{imageData:n,dimensions:i}=d,[s,l,g,h]=[n.indexToWorld([0,0,0]),n.indexToWorld([i[0]-1,0,0]),n.indexToWorld([i[0]-1,i[1]-1,0]),n.indexToWorld([0,i[1]-1,0])].map((e=>o.utilities.worldToImageCoords(c,e))),[u,m]=[t,a].map((e=>o.utilities.worldToImageCoords(c,e)));r=[[s,l],[l,g],[h,g],[s,h]].map((([e,t])=>this.intersectInfiniteLines(e,t,u,m))).filter((e=>e&&this.isInBound(e,i))).map((t=>{const n=o.utilities.imageToWorldCoords(c,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return r}intersectInfiniteLines(e,t,n,i){const[o,a]=e,[r,s]=t,[l,d]=n,[c,g]=i,h=s-a,u=o-r,m=r*a-o*s,v=g-d,p=l-c,f=c*d-l*g;if(Math.abs(h*p-v*u)<de)return;return[(u*f-p*m)/(h*p-v*u),(v*m-h*f)/(h*p-v*u)]}isParallel(e,t){return Math.abs(l.eR.dot(e,t))>1-de}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}ce.toolName="ReferenceLines";const ge=ce,{EPSILON:he}=o.CONSTANTS;class ue extends le.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(e,t),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=o.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,i=(0,R.getToolGroup)(this.toolGroupId).viewportsInfo;if(!i?.length)return void console.warn("OverlayGridTool: No viewports found");const a=(0,L.getAnnotations)(this.getToolName(),n);if(!a?.length){const t=e.map((e=>this.calculateImageIdPointSets(e))),i={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}};(0,L.addAnnotation)(i,n)}(0,F.A)((0,o.getRenderingEngine)(i[0].renderingEngineId),i.map((({viewportId:e})=>e)))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:i,rowCosines:a,columnCosines:r,rowPixelSpacing:s,columnPixelSpacing:d}=o.metaData.get("imagePlaneModule",e),c=[...t],g=[...t],h=[...t],u=[...t];l.eR.scaleAndAdd(g,t,r,i*d),l.eR.scaleAndAdd(h,t,a,n*s),l.eR.scaleAndAdd(u,h,r,i*d);return{pointSet1:[c,h,g,u],pointSet2:[c,g,h,u]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let i=!1;if(!n?.length)return i;const{viewport:a,FrameOfReferenceUID:r}=e;if(a.getImageIds().length<2)return i;const s=(0,L.getAnnotations)(this.getToolName(),r);if(!s?.length)return i;const d=s[0],{annotationUID:c}=d,{focalPoint:g,viewPlaneNormal:h}=a.getCamera(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},m=this.getImageIdNormal(n[0]);if(this.isParallel(h,m))return i;const v=o.utilities.planar.planeEquation(h,g),p=d.data.pointSets,f=d.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:i}=p[e],r=f.get(a.id)||this.initializeViewportData(f,a.id);if(!r.pointSetsToUse[e]){let t=n,a=l.eR.subtract(l.eR.create(),n[0],n[1]);a=l.eR.normalize(l.eR.create(),a),this.isPerpendicular(a,h)&&(t=i),r.pointSetsToUse[e]=t,r.lineStartsWorld[e]=o.utilities.planar.linePlaneIntersection(t[0],t[1],v),r.lineEndsWorld[e]=o.utilities.planar.linePlaneIntersection(t[2],t[3],v)}const s=r.lineStartsWorld[e],g=r.lineEndsWorld[e];u.annotationUID=c;const m=this.getStyle("lineWidth",u,d),E=this.getStyle("lineDash",u,d),I=this.getStyle("color",u,d),w=this.getStyle("shadow",u,d),C=[s,g].map((e=>a.worldToCanvas(e))),T=`${c}-line`,S=`${e}`;(0,P.drawLine)(t,c,S,C[0],C[1],{color:I,width:m,lineDash:E,shadow:w},T)}return i=!0,i},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=l.eR.dot(e,t);return Math.abs(n)<he}}isParallel(e,t){return Math.abs(l.eR.dot(e,t))>1-he}getImageIdNormal(e){const{imageOrientationPatient:t}=o.metaData.get("imagePlaneModule",e),n=l.eR.fromValues(t[0],t[1],t[2]),i=l.eR.fromValues(t[3],t[4],t[5]);return l.eR.cross(l.eR.create(),n,i)}}ue.toolName="OverlayGrid";const me=ue;var ve=n(14846),pe=n(60438);class fe extends le.A{constructor(e={},t={configuration:{opacity:.5}}){super(e,t),this._init=()=>{const e=(0,R.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,o.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),i=(0,L.getAnnotations)(this.getToolName(),n);if(!i?.length){const t=new Map;!function(e,t){t.forEach((({viewportId:t,renderingEngineId:n})=>{const i=(0,o.getRenderingEngine)(n)?.getViewport(t);Ee(e,i)}))}(t,e);const i={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}};(0,L.addAnnotation)(i,n)}(0,F.A)((0,o.getRenderingEngine)(e[0].renderingEngineId),e.map((({viewportId:e})=>e)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:i}=e;let o=!1;const a=(0,L.getAnnotations)(this.getToolName(),i);if(!a?.length)return o;const r=a[0],{annotationUID:s}=r,l=r.data.actorsWorldPointsMap;Ee(l,n);const d=n.getActors(),c=Ie(n);return d.forEach((e=>{if(!e?.clippingFilter)return;const i=l.get(e.uid);if(!i)return;if(!i.get(c))return;let o=1;const{worldPointsSet:a,color:r}=i.get(c);for(let i=0;i<a.length;i++){const l=a[i].map((e=>n.worldToCanvas(e))),d={color:r,fillColor:r,fillOpacity:this.configuration.opacity,closePath:!0,lineWidth:2},c=e.uid+"#"+o;(0,P.drawPath)(t,s,c,l,d),o++}})),o=!0,o}}}function Ee(e,t){const n=t.getActors(),i=Ie(t);n.forEach((t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(i)){const e=t.clippingFilter.getOutputData(),o=u.polyDataUtils.getPolyDataPoints(e);if(!o)return;const a=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(i,{worldPointsSet:o,color:a})}}))}function Ie(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${(0,pe.l)(t)}-${n}`}fe.toolName="SegmentationIntersection";const we=fe;class Ce extends le.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;const o=this.getActiveAnnotation(n);return null===o?(this.createInitialAnnotation(i.world,n),!1):(this.updateAnnotationPosition(n,o),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,o.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:i,renderingEngine:a}=n;this.isDrawing=!0;const r=i.getCamera(),{viewPlaneNormal:s,viewUp:l}=r;if(!s||!l)throw new Error("Camera not found");const d=this.getReferencedImageId(i,e,s,l),c=i.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...s],viewUp:[...l],FrameOfReferenceUID:c,referencedImageId:d},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if((0,L.getAnnotations)(this.getToolName(),t).length>0)return null;if(null===(0,L.addAnnotation)(g,t))return;const h=(0,k.getViewportIdsWithToolToRender)(t,this.getToolName(),!1);(0,F.A)(a,h)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:i,camera:a}=t,r=(0,o.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const l=i.focalPoint,d=a.viewPlaneNormal,c=a.focalPoint,g=[0,0,0];if(s.Ay.subtract(c,l,g),0===g.reduce(((e,t)=>e+t),0))return;const h=s.Ay.dot(g,d);if(Math.abs(h)<.01)return;if(!this._currentCanvasPosition)return;const u=r.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=u,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,FrameOfReferenceUID:o}=e,a=this._elementWithCursor===i.element;this.configuration.positionSync&&!a&&this.updateViewportImage(i);const{element:r}=i;let s=(0,L.getAnnotations)(this.getToolName(),r);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(r,s),!s?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const o=s[e],{annotationUID:r,data:d}=o,{handles:c}=d,{points:g}=c;if(!r)return n;l.annotationUID=r;const h=parseFloat(this.getStyle("lineWidth",l,o)),u=h,m=this.getStyle("lineDash",l,o),v=this.getStyle("color",l,o);if(g[0].some((e=>isNaN(e))))return n;const p=g.map((e=>i.worldToCanvas(e)));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ie.isAnnotationVisible)(r))continue;const f={upper:"upper",right:"right",lower:"lower",left:"left"},[E,I]=p[0],w=a?20:7,C=a?5:7;(0,P.drawLine)(t,r,f.upper,[E,I-(w/2+C)],[E,I-w/2],{color:v,lineDash:m,lineWidth:u}),(0,P.drawLine)(t,r,f.lower,[E,I+(w/2+C)],[E,I+w/2],{color:v,lineDash:m,lineWidth:u}),(0,P.drawLine)(t,r,f.right,[E+(w/2+C),I],[E+w/2,I],{color:v,lineDash:m,lineWidth:u}),(0,P.drawLine)(t,r,f.left,[E-(w/2+C),I],[E-w/2,I],{color:v,lineDash:m,lineWidth:u}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=(0,R.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,o.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&(0,V.hideElementCursor)(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=(0,R.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,o.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&(0,V.resetElementCursor)(e.viewport.element)}))}getActiveAnnotation(e){const t=(0,L.getAnnotations)(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const i=(0,k.getViewportIdsWithToolToRender)(e,this.getToolName(),!1),a=(0,o.getEnabledElement)(e);if(!a)return;const{renderingEngine:r}=a;(0,F.A)(r,i)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],i=(0,o.getEnabledElement)(e)?.viewport;if(!i)return[];const a=i.getCamera(),{viewPlaneNormal:r,focalPoint:s}=a;if(!r||!s)return[];const l=n.data?.handles?.points;if(!(l instanceof Array)||1!==l.length)return[];const d=l[0],c=o.utilities.planar.planeEquation(r,s);return o.utilities.planar.planeDistanceToPoint(c,d)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof o.StackViewport){const n=o.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof o.VolumeViewport){const{focalPoint:n,viewPlaneNormal:i}=e.getCamera();if(!n||!i)return;const a=o.utilities.planar.planeEquation(i,n),r=o.utilities.planar.planeDistanceToPoint(a,t,!0);if(Math.abs(r)<.5)return;const s=l.eR.normalize(l.eR.create(),l.eR.fromValues(...i)),d=l.eR.scale(l.eR.create(),s,r),c=l.eR.add(l.eR.create(),l.eR.fromValues(...n),d);if(!0){e.setCamera({focalPoint:c});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}Ce.toolName="ReferenceCursors";const Te=Ce,Se=[];class _e extends le.A{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData={},this._init=()=>{const e=(0,o.getRenderingEngines)()[0];if(!e)return;const t=(0,R.getToolGroup)(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,o.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:i}=n[0];const{FrameOfReferenceUID:a}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(i=e.viewport)})),!i)return;const{viewUp:r,viewPlaneNormal:s}=i.getCamera(),l=o.utilities.getViewportImageCornersInWorld(i);let d=this.editData.annotation;const c=(0,L.getAnnotations)(this.getToolName(),i.element);if(c.length&&(d=c.filter((e=>e.data.viewportId==i.id))[0]),Se.includes(i.id))this.editData.annotation&&this.editData.annotation.data.viewportId==i.id&&(this.editData.annotation.data.handles.points=l,this.editData.annotation.data.viewportId=i.id);else{const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...s],viewUp:[...r],FrameOfReferenceUID:a,referencedImageId:null},data:{handles:{points:l},viewportId:i.id}};Se.push(i.id),(0,L.addAnnotation)(e,i.element),d=e}this.editData={viewport:i,renderingEngine:e,annotation:d}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let o;return o="top"==n||"bottom"==n?i.filter((t=>t<.6*e&&t>.2*e)):i.filter((e=>e<.6*t&&e>.2*t)),o[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,i,o)=>{let a;"bottom"==t||"top"==t?a=o[0][0]-i[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-i[0][1]);const r=[],s=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const o={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};r.push(`${n}-tick${e}`),s.push(`tick${e}`),(e+1)%5==0?l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][0][0],i[1][1]+o[t][0][1]]]):l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][1][0],i[1][1]+o[t][1][1]]])}return{tickIds:r,tickUIDs:s,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let i,o=l.eR.subtract(l.eR.create(),n[0],n[1]);o=l.eR.normalize(l.eR.create(),o);let a=l.eR.subtract(l.eR.create(),n[2],n[0]);a=l.eR.normalize(l.eR.create(),a);const r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},s=l.eR.add(l.eR.create(),r[t][0],r[t][0]).map((e=>e/2)),d=e/2/Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2)+Math.pow(o[2],2));return"top"==t||"bottom"==t?i=[l.eR.subtract(l.eR.create(),s,a.map((e=>e*d))),l.eR.add(l.eR.create(),s,a.map((e=>e*d)))]:"left"!=t&&"right"!=t||(i=[l.eR.add(l.eR.create(),s,o.map((e=>e*d))),l.eR.subtract(l.eR.create(),s,o.map((e=>e*d)))]),i},this.computeCanvasScaleCoordinates=(e,t,n,i,o)=>{let a;if("top"==o||"bottom"==o){const i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){const n=t[0][1]-t[1][1];a=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,i)=>{const o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),r={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},s={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:s[i][0]+r[i][0],width:s[i][1]+r[i][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:i}=e,o=(0,L.getAnnotations)(this.getToolName(),i.element).filter((e=>e.data.viewportId==i.id))[0],a=e.viewport.canvas,r=!1;if(!i)return r;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d={width:a.width,height:a.height},c=o.data.handles.points[0],g=o.data.handles.points[1],h=o.data.handles.points[2],u=o.data.handles.points[3],m=[c,h,g,u],v=l.eR.distance(h,u),p=l.eR.distance(c,h),f=this.computeScaleBounds(d,.05,.05,n),E=this.computeScaleBounds(d,.05,.05,n),I=this.computeScaleSize(v,p,n),w=this.computeWorldScaleCoordinates(I,n,m).map((e=>i.worldToCanvas(e))),C=this.computeCanvasScaleCoordinates(d,w,E,f,n),T=this.computeEndScaleTicks(C,n),{annotationUID:S}=o;s.annotationUID=S;const _=this.getStyle("lineWidth",s,o),b=this.getStyle("lineDash",s,o),D=this.getStyle("color",s,o),A=this.getStyle("shadow",s,o),y=`${S}-scaleline`;(0,P.drawLine)(t,S,"1",C[0],C[1],{color:D,width:_,lineDash:b,shadow:A},y);const R=`${S}-left`;(0,P.drawLine)(t,S,"2",T.endTick1[0],T.endTick1[1],{color:D,width:_,lineDash:b,shadow:A},R);const M=`${S}-right`;(0,P.drawLine)(t,S,"3",T.endTick2[0],T.endTick2[1],{color:D,width:_,lineDash:b,shadow:A},M);const x={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},O=[C[0][0]+x[n][0],C[0][1]+x[n][1]],N=this._getTextLines(I),{tickIds:U,tickUIDs:k,tickCoordinates:V}=this.computeInnerScaleTicks(I,n,S,T.endTick1,T.endTick2);for(let e=0;e<k.length;e++)(0,P.drawLine)(t,S,k[e],V[e][0],V[e][1],{color:D,width:_,lineDash:b,shadow:A},U[e]);return(0,P.drawTextBox)(t,S,"text0",N,[O[0],O[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:D}),r}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}_e.toolName="ScaleOverlay";const be=_e;var De=n(50720),Ae=n(24592),ye=n(21090),Re=n(10910);const{transformWorldToIndex:Me}=o.utilities;class xe extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Oe}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;(0,V.hideElementCursor)(i),this.isDrawing=!0;const{viewPlaneNormal:d,viewUp:c,position:g}=s.getCamera(),h=this.getReferencedImageId(s,a,d,c),u={highlighted:!0,invalidated:!0,metadata:{...s.getViewReference({points:[a]}),toolName:this.getToolName(),referencedImageId:h,viewUp:c,cameraPosition:g},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,L.addAnnotation)(u,i);const m=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,F.A)(l,m),u},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,[l,d]=s.handles.points,c=r.worldToCanvas(l),g=r.worldToCanvas(d),h={start:{x:c[0],y:c[1]},end:{x:g[0],y:g[1]}};return B.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,V.hideElementCursor)(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(c,a),r&&(0,oe.dZ)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[r]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const r=(0,o.getEnabledElement)(e),{renderingEngine:s}=r;return(0,F.A)(s,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r=this.getTargetId(i),s=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:g}=d,{points:h,activeHandleIndex:u}=g.handles;l.annotationUID=c;const{color:m,lineWidth:v,lineDash:p,shadow:f}=this.getAnnotationStyle({annotation:d,styleSpecifier:l}),E=h.map((e=>i.worldToCanvas(e)));let I;if(g.cachedStats[r]&&null!=g.cachedStats[r].unit?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(g.cachedStats[r]={length:null,unit:null},this._calculateCachedStats(d,s,e)),!(0,ie.isAnnotationVisible)(c))continue;if((0,H.isAnnotationLocked)(d)||this.editData||null===u||(I=[E[u]]),I){const e="0";(0,P.drawHandles)(t,c,e,E,{color:m,lineDash:p,lineWidth:v})}const w=`${c}-line`,C="1";if((0,P.drawLine)(t,c,C,E[0],E[1],{color:m,width:v,lineDash:p,shadow:f},w),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const T=this.getLinkedTextBoxStyle(l,d);if(!T.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(g,r);if(!g.handles.textBox.hasMoved){const e=(0,Re.getTextBoxCoordsCanvas)(E);g.handles.textBox.worldPosition=i.canvasToWorld(e)}const _=i.worldToCanvas(g.handles.textBox.worldPosition),b="1",D=(0,P.drawLinkedTextBox)(t,c,b,S,_,E,{},T),{x:A,y,width:R,height:M}=D;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([A,y]),topRight:i.canvasToWorld([A+R,y]),bottomLeft:i.canvasToWorld([A,y+M]),bottomRight:i.canvasToWorld([A+R,y+M])}}return n},this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;n.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===n));const d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,d),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport,a=i.handles.points[0],r=i.handles.points[1],{cachedStats:s}=i,l=Object.keys(s);for(let e=0;e<l.length;e++){const n=l[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:d}=i,c=Me(o,a),g=Me(o,r),h=[c,g],{scale:u,units:m}=(0,Ae.Op)(i,h),v=this._calculateLength(a,r)/u;this._isInsideVolume(c,g,d)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,s[n]={length:v,unit:m}}return e.invalidated=!1,(0,oe.XF)(e,o),s}_isInsideVolume(e,t,n){return o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n)}}function Oe(e,t){const n=e.cachedStats[t],{length:i,unit:o}=n;if(null==i||isNaN(i))return;return[`${(0,u.roundNumber)(i)} ${o}`]}xe.toolName="Length";const Le=xe;var Pe=n(73801),Ne=n(97022);const{transformWorldToIndex:Ue}=o.utilities;class ke extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ve}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}};(0,L.addAnnotation)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,newAnnotation:!0,viewportIdsToRender:v},this._activateModify(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,v),m},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r}=this.editData,{viewportId:s,renderingEngine:l}=(0,o.getEnabledElement)(n);this.eventDispatchDetail={viewportId:s,renderingEngineId:l.id},this._deactivateModify(n),(0,V.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(l,a),r&&(0,oe.dZ)(i)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,{annotation:r,viewportIdsToRender:s}=this.editData,{data:l}=r;l.handles.points[0]=[...a],r.invalidated=!0;const d=(0,o.getEnabledElement)(i),{renderingEngine:c}=d;(0,F.A)(c,s)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:r}=(0,o.getEnabledElement)(e);return(0,F.A)(r,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let r=(0,L.getAnnotations)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<r.length;a++){const c=r[a],g=c.annotationUID,h=c.data,u=h.handles.points[0],m=i.worldToCanvas(u);d.annotationUID=g;const{color:v}=this.getAnnotationStyle({annotation:c,styleSpecifier:d});if(h.cachedStats||(h.cachedStats={}),h.cachedStats[s]&&null!=h.cachedStats[s].value){if(c.invalidated&&(this._calculateCachedStats(c,l,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=c.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){l.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,index:null,value:null},this._calculateCachedStats(c,l,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const p="0";(0,P.drawHandles)(t,g,p,[m],{color:v}),n=!0;const f=this.getLinkedTextBoxStyle(d,c);if(!f.visibility)continue;const E=this.configuration.getTextLines(h,s);if(E){const e=[m[0]+6,m[1]-6],n="0";(0,P.drawTextBox)(t,g,n,E,[e[0],e[1]],f)}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,i){const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,d=s.handles.points[0],c=r.worldToCanvas(d);if(!0===l.Zc.distance(n,c)<i)return d}handleSelectedCallback(e,t){const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(i),(0,V.hideElementCursor)(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{renderingEngineId:a,viewport:r}=n,{element:s}=r,l=i.handles.points[0],{cachedStats:d}=i,c=Object.keys(d);for(let n=0;n<c.length;n++){const i=c[n],g={isPreScaled:(0,Ne.u)(r,i),isSuvScaled:this.isSuvScaled(r,i,e.metadata.referencedImageId)},h=this.getTargetIdImage(i,t);if(!h)continue;const{dimensions:u,imageData:m,metadata:v}=h,p="getScalarData"in h?h.getScalarData():h.scalarData,f=v.Modality,E=Ue(m,l);E[0]=Math.round(E[0]),E[1]=Math.round(E[1]),E[2]=Math.round(E[2]);const I=p.length/u[2]/u[1]/u[0];if(o.utilities.indexWithinDimensions(E,u)){this.isHandleOutsideImage=!1;const t=u[0]*I,n=u[0]*u[1]*I,r=E[2]*n+E[1]*t+E[0]*I;let s,l=I>2?[p[r],p[r+1],p[r+2]]:p[r];if(i.startsWith("imageId:")){const e=i.split("imageId:")[1],t=o.utilities.imageIdToURI(e),n=o.utilities.getViewportsWithImageURI(t,a)[0];E[2]=n.getCurrentImageIdIndex()}if("US"===f){const e=(0,Ae.Xw)(h,[E]),t=e.values.every((e=>null!==e));l=t?e.values:l,s=t?e.units:"raw"}else s=(0,Pe.c)(f,e.metadata.referencedImageId,g);d[i]={index:E,value:l,Modality:f,modalityUnit:s}}else this.isHandleOutsideImage=!0,d[i]={index:E,Modality:f};e.invalidated=!1,(0,oe.XF)(e,s)}return d}}function Ve(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const r=[];if(r.push(`(${i[0]}, ${i[1]}, ${i[2]})`),o instanceof Array&&a instanceof Array)for(let e=0;e<o.length;e++)r.push(`${(0,u.roundNumber)(o[e])} ${a[e]}`);else r.push(`${(0,u.roundNumber)(o)} ${a}`);return r}ke.toolName="Probe";const We=ke;class Be extends We{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:He}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:h},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}},m=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:u,newAnnotation:!0,viewportIdsToRender:m},this._activateModify(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,m),u},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;if(!this.editData)return n;const o=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(!o?.length)return n;const a=this.getTargetId(i),r=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,g=c.handles.points[0],h=i.worldToCanvas(g);s.annotationUID=d;const{color:u}=this.getAnnotationStyle({annotation:l,styleSpecifier:s});(0,Ne.u)(i,a),this.isSuvScaled(i,a,l.metadata.referencedImageId);if(c.cachedStats[a]&&null!=c.cachedStats[a].value?l.invalidated&&this._calculateCachedStats(l,r,e):(c.cachedStats[a]={Modality:null,index:null,value:null},this._calculateCachedStats(l,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;(0,P.drawHandles)(t,d,"0",[h],{color:u}),n=!0;const m=this.configuration.getTextLines(c,a);if(m){const e=[h[0]+6,h[1]-6],n="0";(0,P.drawTextBox)(t,d,n,m,[e[0],e[1]],this.getLinkedTextBoxStyle(s,l))}return n}}}function He(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const r=[];return r.push(`(${i[0]}, ${i[1]}, ${i[2]})`),r.push(`${o.toFixed(2)} ${a}`),r}Be.toolName="DragProbe";const Fe=Be;var Ge=n(95778),qe=n(23345),$e=n(78609),ze=n(83112);const{transformWorldToIndex:Ze}=o.utilities;class je extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ke,statsCalculator:ze.BasicStatsCalculator}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};(0,Ge.lC)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,{points:l}=s.handles,d=r.worldToCanvas(l[0]),c=r.worldToCanvas(l[3]),g=this._getRectangleImageCoordinates([d,c]),h=[n[0],n[1]],{left:u,top:m,width:v,height:p}=g;return qe.distanceToPoint([u,m,v,p],h)<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,V.hideElementCursor)(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;n.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===n));const d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const{renderingEngine:d}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,Ge.O8)(i.annotationUID),(0,F.A)(d,a),r&&(0,oe.dZ)(i)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world,{points:o}=l.handles;o.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,a=(0,o.getEnabledElement)(n),{worldToCanvas:s,canvasToWorld:d}=a.viewport,c=e.world,{points:g}=l.handles;let h,u,m,v,p,f,E,I;switch(g[r]=[...c],r){case 0:case 3:h=s(g[0]),v=s(g[3]),u=[v[0],h[1]],m=[h[0],v[1]],f=d(u),E=d(m),g[1]=f,g[2]=E;break;case 1:case 2:u=s(g[1]),m=s(g[2]),h=[m[0],u[1]],v=[u[0],m[1]],p=d(h),I=d(v),g[0]=p,g[3]=I}i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:r}=(0,o.getEnabledElement)(e);return(0,F.A)(r,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let r=(0,Ge.Rh)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<r.length;a++){const c=r[a],{annotationUID:g,data:h}=c,{points:u,activeHandleIndex:m}=h.handles,v=u.map((e=>i.worldToCanvas(e)));d.annotationUID=g;const{color:p,lineWidth:f,lineDash:E}=this.getAnnotationStyle({annotation:c,styleSpecifier:d}),{viewPlaneNormal:I,viewUp:w}=i.getCamera();if(h.cachedStats[s]&&null!=h.cachedStats[s].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,I,w,l,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=c.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){l.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(c,I,w,l,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let C;if(!(0,ie.isAnnotationVisible)(g))continue;if((0,H.isAnnotationLocked)(c)||this.editData||null===m||(C=[v[m]]),C){const e="0";(0,P.drawHandles)(t,g,e,C,{color:p})}const T=`${g}-rect`,S="0";(0,P.drawRect)(t,g,S,v[0],v[3],{color:p,lineDash:E,lineWidth:f},T),n=!0;const _=this.getLinkedTextBoxStyle(d,c);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const b=this.configuration.getTextLines(h,s);if(!b||0===b.length)continue;if(!h.handles.textBox.hasMoved){const e=(0,Re.getTextBoxCoordsCanvas)(v);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const D=i.worldToCanvas(h.handles.textBox.worldPosition),A="1",y=(0,P.drawLinkedTextBox)(t,g,A,b,D,v,{},_),{x:R,y:M,width:x,height:O}=y;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([R,M]),topRight:i.canvasToWorld([R+x,M]),bottomLeft:i.canvasToWorld([R,M+O]),bottomRight:i.canvasToWorld([R+x,M+O])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{const{data:a}=e,{viewport:r}=o,{element:s}=r,l=a.handles.points[0],d=a.handles.points[3],{cachedStats:c}=a,g=Object.keys(c);for(let o=0;o<g.length;o++){const a=g[o],s=this.getTargetIdImage(a,i);if(!s)continue;const{dimensions:h,imageData:m,metadata:v}=s,p=("getScalarData"in s?s.getScalarData():s.scalarData,Ze(m,l));p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]);const f=Ze(m,d);if(f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),this._isInsideVolume(p,f,h)){this.isHandleOutsideImage=!1;const i=[[Math.min(p[0],f[0]),Math.max(p[0],f[0])],[Math.min(p[1],f[1]),Math.max(p[1],f[1])],[Math.min(p[2],f[2]),Math.max(p[2],f[2])]],{worldWidth:o,worldHeight:g}=(0,$e.A)(t,n,l,d),h=(0,Ae.yH)(s),E=Math.abs(o*g)/(h*h),I={isPreScaled:(0,Ne.u)(r,a),isSuvScaled:this.isSuvScaled(r,a,e.metadata.referencedImageId)},w=(0,Pe.c)(v.Modality,e.metadata.referencedImageId,I),C=(0,u.pointInShapeCallback)(m,(()=>!0),this.configuration.statsCalculator.statsCallback,i),T=this.configuration.statsCalculator.getStatistics();c[a]={Modality:v.Modality,area:E,mean:T.mean?.value,stdDev:T.stdDev?.value,max:T.max?.value,statsArray:T.array,pointsInShape:C,areaUnit:(0,Ae.Ss)(null,s),modalityUnit:w}}else this.isHandleOutsideImage=!0,c[a]={Modality:v.Modality}}return e.invalidated=!1,(0,oe.XF)(e,s),c},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,100,{trailing:!0})}}function Ke(e,t){const n=e.cachedStats[t],{area:i,mean:o,max:a,stdDev:r,areaUnit:s,modalityUnit:l}=n;if(void 0===o)return;const d=[];return d.push(`Area: ${(0,u.roundNumber)(i)} ${s}`),d.push(`Mean: ${(0,u.roundNumber)(o)} ${l}`),d.push(`Max: ${(0,u.roundNumber)(a)} ${l}`),d.push(`Std Dev: ${(0,u.roundNumber)(r)} ${l}`),d}je.toolName="RectangleROI";const Ye=je;var Xe=n(31970),Je=n(2264);const{transformWorldToIndex:Qe}=o.utilities;class et extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:tt,statsCalculator:ze.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(n.canvas,(0,o.getEnabledElement)(i)),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},initialRotation:s.getRotation()}};(0,L.addAnnotation)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,centerWorld:a,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,{points:l}=s.handles,d=l.map((e=>r.worldToCanvas(e))),c=(0,Je.getCanvasEllipseCorners)(d),[g,h]=c,u={left:Math.min(g[0],h[0])+i/2,top:Math.min(g[1],h[1])+i/2,width:Math.abs(g[0]-h[0])-i,height:Math.abs(g[1]-h[1])-i},m={left:Math.min(g[0],h[0])-i/2,top:Math.min(g[1],h[1])-i/2,width:Math.abs(g[0]-h[0])+i,height:Math.abs(g[1]-h[1])+i},v=this._pointInEllipseCanvas(u,n);return!(!this._pointInEllipseCanvas(m,n)||v)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,V.hideElementCursor)(i),this._activateModify(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l,d,c,g,h,u=!1;if(n.worldPosition)u=!0;else{const{points:e}=r.handles,{viewport:t}=(0,o.getEnabledElement)(a),{worldToCanvas:i,canvasToWorld:u}=t;s=e.findIndex((e=>e===n));const m=e.map(i);h=m[s],c=Math.abs(m[2][0]-m[3][0]),g=Math.abs(m[0][1]-m[1][1]),l=[(m[2][0]+m[3][0])/2,(m[0][1]+m[1][1])/2],d=u(l)}const m=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:m,handleIndex:s,canvasWidth:c,canvasHeight:g,centerWorld:d,originalHandleCanvas:h,movingTextBox:u},this._activateModify(a),(0,V.hideElementCursor)(a);const v=(0,o.getEnabledElement)(a),{renderingEngine:p}=v;(0,F.A)(p,m),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const{renderingEngine:d}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(d,a),r&&(0,oe.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,r=(0,o.getEnabledElement)(n),{renderingEngine:s,viewport:l}=r,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:g,centerWorld:h}=this.editData,u=l.worldToCanvas(h),{data:m}=c,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),f=[u[0],u[1]-p],E=[u[0],u[1]+p],I=[u[0]-v,u[1]],w=[u[0]+v,u[1]];m.handles.points=[d(f),d(E),d(I),d(w)],c.invalidated=!0,this.editData.hasMoved=!0,(0,F.A)(s,g)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:i}=(0,o.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:r}=i,{annotation:s,canvasWidth:l,canvasHeight:d,handleIndex:c,centerWorld:g,originalHandleCanvas:h}=this.editData,u=i.worldToCanvas(g),{data:m}=s,{points:v}=m.handles,{currentPoints:p}=t,f=p.canvas;if(0===c||1===c){const e=Math.abs(f[1]-u[1]),t=[u[0],u[1]-e],n=[u[0],u[1]+e];v[0]=a(t),v[1]=a(n);const i=l/2+(f[0]-h[0]),o=[u[0]-i,u[1]],r=[u[0]+i,u[1]];v[2]=a(o),v[3]=a(r)}else{const e=Math.abs(f[0]-u[0]),t=[u[0]-e,u[1]],n=[u[0]+e,u[1]];v[2]=a(t),v[3]=a(n);const i=d/2+(f[1]-h[1]),o=[u[0],u[1]-i],r=[u[0],u[1]+i];v[0]=a(o),v[1]=a(r)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:r}=(0,o.getEnabledElement)(e);return(0,F.A)(r,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let r=(0,L.getAnnotations)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<r.length;a++){const c=r[a],{annotationUID:g,data:h}=c,{handles:u}=h,{points:m,activeHandleIndex:v}=u;d.annotationUID=g;const{color:p,lineWidth:f,lineDash:E}=this.getAnnotationStyle({annotation:c,styleSpecifier:d}),I=m.map((e=>i.worldToCanvas(e))),w=(Math.abs(i.getRotation()-(h.initialRotation||0)),(0,Je.getCanvasEllipseCorners)(I)),{centerPointRadius:C}=this.configuration;if(h.cachedStats[s]&&null!=h.cachedStats[s].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,i,l,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=c.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){l.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(c,i,l,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!(0,ie.isAnnotationVisible)(g))continue;if((0,H.isAnnotationLocked)(c)||this.editData||null===v||(T=[I[v]]),T){const e="0";(0,P.drawHandles)(t,g,e,T,{color:p})}const S=`${g}-ellipse`,_="0";if((0,P.drawEllipseByCoordinates)(t,g,_,I,{color:p,lineDash:E,lineWidth:f},S),C>0){if(Math.min(Math.abs(w[0][0]-w[1][0])/2,Math.abs(w[0][1]-w[1][1])/2)>3*C){const e=this._getCanvasEllipseCenter(I);(0,P.drawCircle)(t,g,`${_}-center`,e,C,{color:p,lineDash:E,lineWidth:f})}}n=!0;const b=this.getLinkedTextBoxStyle(d,c);if(!b.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const D=this.configuration.getTextLines(h,s);if(!D||0===D.length)continue;let A;h.handles.textBox.hasMoved||(A=(0,Re.getTextBoxCoordsCanvas)(w),h.handles.textBox.worldPosition=i.canvasToWorld(A));const y=i.worldToCanvas(h.handles.textBox.worldPosition),R="1",M=(0,P.drawLinkedTextBox)(t,g,R,D,y,I,{},b),{x,y:O,width:L,height:N}=M;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([x,O]),topRight:i.canvasToWorld([x+L,O]),bottomLeft:i.canvasToWorld([x,O+N]),bottomRight:i.canvasToWorld([x+L,O+N])}}return n},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{element:a}=t,{points:r}=o.handles,s=r.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:l,viewUp:d}=t.getCamera(),[c,g]=(0,Je.getCanvasEllipseCorners)(s),h=t.canvasToWorld(c),m=t.canvasToWorld(g),{cachedStats:v}=o,p=Object.keys(v),f=h,E=m;for(let i=0;i<p.length;i++){const o=p[i],a=this.getTargetIdImage(o,n);if(!a)continue;const{dimensions:r,imageData:s,metadata:c,hasPixelSpacing:g}=a,I=Qe(s,f);I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]);const w=Qe(s,E);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(I,w,r)){this.isHandleOutsideImage=!1;const n=[[Math.min(I[0],w[0]),Math.max(I[0],w[0])],[Math.min(I[1],w[1]),Math.max(I[1],w[1])],[Math.min(I[2],w[2]),Math.max(I[2],w[2])]],i={center:[(h[0]+m[0])/2,(h[1]+m[1])/2,(h[2]+m[2])/2],xRadius:Math.abs(h[0]-m[0])/2,yRadius:Math.abs(h[1]-m[1])/2,zRadius:Math.abs(h[2]-m[2])/2},{worldWidth:r,worldHeight:g}=(0,Xe.A)(l,d,f,E),p=0===r&&0===g,C=(0,Ae.yH)(a),T=Math.abs(Math.PI*(r/2)*(g/2))/C/C,S={isPreScaled:(0,Ne.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},_=(0,Pe.c)(c.Modality,e.metadata.referencedImageId,S),b=(0,u.pointInShapeCallback)(s,(e=>(0,Je.pointInEllipse)(i,e,{fast:!0})),this.configuration.statsCalculator.statsCallback,n),D=this.configuration.statsCalculator.getStatistics();v[o]={Modality:c.Modality,area:T,mean:D.mean?.value,max:D.max?.value,stdDev:D.stdDev?.value,statsArray:D.array,pointsInShape:b,isEmptyArea:p,areaUnit:(0,Ae.Ss)(null,a),modalityUnit:_}}else this.isHandleOutsideImage=!0,v[o]={Modality:c.Modality}}return e.invalidated=!1,(0,oe.XF)(e,a),v},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,i=e.height/2;if(n<=0||i<=0)return!1;const o=[e.left+n,e.top+i],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(i*i)<=1}_getCanvasEllipseCenter(e){const[t,n,i,o]=e,a=[i[0],n[1]],r=[o[0],t[1]];return[(a[0]+r[0])/2,(a[1]+r[1])/2]}}function tt(e,t){const n=e.cachedStats[t],{area:i,mean:o,stdDev:a,max:r,isEmptyArea:s,areaUnit:l,modalityUnit:d}=n,c=[];if(i){const e=s?"Area: Oblique not supported":`Area: ${(0,u.roundNumber)(i)} ${l}`;c.push(e)}return o&&c.push(`Mean: ${(0,u.roundNumber)(o)} ${d}`),r&&c.push(`Max: ${(0,u.roundNumber)(r)} ${d}`),a&&c.push(`Std Dev: ${(0,u.roundNumber)(a)} ${d}`),c}et.toolName="EllipticalROI";const nt=et,{transformWorldToIndex:it}=o.utilities;class ot extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:at,statsCalculator:ze.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a]],activeHandleIndex:null},cachedStats:{}}};(0,L.addAnnotation)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,{points:l}=s.handles,d=l.map((e=>r.worldToCanvas(e))),c=(0,ae.r)(d),g=(0,ae.r)([d[0],n]);return Math.abs(g-c)<i/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,V.hideElementCursor)(i),this._activateModify(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=r.handles;s=e.findIndex((e=>e===n))}const d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const{renderingEngine:d}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(d,a),r&&(0,oe.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,r=(0,o.getEnabledElement)(n),{renderingEngine:s,viewport:l}=r,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:g}=this.editData,{data:h}=c;h.handles.points=[h.handles.points[0],d(a)],c.invalidated=!0,this.editData.hasMoved=!0,(0,F.A)(s,g)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:r}=i.viewport,{annotation:s,handleIndex:l}=this.editData,{data:d}=s,{points:c}=d.handles,g=c.map((e=>r(e))),{currentPoints:h}=t,u=h.canvas;if(0===l){const e=u[0]-g[0][0],t=u[1]-g[0][1],n=u,i=[g[1][0]+e,g[1][1]+t];c[0]=a(n),c[1]=a(i)}else c[1]=a(u)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:r}=(0,o.getEnabledElement)(e);return(0,F.A)(r,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let r=(0,L.getAnnotations)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<r.length;a++){const c=r[a],{annotationUID:g,data:h}=c,{handles:u}=h,{points:m,activeHandleIndex:v}=u;d.annotationUID=g;const{color:p,lineWidth:f,lineDash:E}=this.getAnnotationStyle({annotation:c,styleSpecifier:d}),I=m.map((e=>i.worldToCanvas(e))),w=I[0],C=(0,ae.r)(I),T=(0,ae.H)(I),{centerPointRadius:S}=this.configuration;if(h.cachedStats[s]&&null!=h.cachedStats[s].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,i,l,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=c.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){l.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(c,i,l,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let _;if(!(0,ie.isAnnotationVisible)(g))continue;if((0,H.isAnnotationLocked)(c)||this.editData||null===v||(_=[I[v]]),_){const e="0";(0,P.drawHandles)(t,g,e,_,{color:p})}const b=`${g}-circle`,D="0";(0,P.drawCircle)(t,g,D,w,C,{color:p,lineDash:E,lineWidth:f},b),S>0&&C>3*S&&(0,P.drawCircle)(t,g,`${D}-center`,w,S,{color:p,lineDash:E,lineWidth:f}),n=!0;const A=this.getLinkedTextBoxStyle(d,c);if(!A.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const y=this.configuration.getTextLines(h,s);if(!y||0===y.length)continue;let R;h.handles.textBox.hasMoved||(R=(0,Re.getTextBoxCoordsCanvas)(T),h.handles.textBox.worldPosition=i.canvasToWorld(R));const M=i.worldToCanvas(h.handles.textBox.worldPosition),x="1",O=(0,P.drawLinkedTextBox)(t,g,x,y,M,I,{},A),{x:L,y:N,width:U,height:k}=O;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([L,N]),topRight:i.canvasToWorld([L+U,N]),bottomLeft:i.canvasToWorld([L,N+k]),bottomRight:i.canvasToWorld([L+U,N+k])}}return n},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{element:a}=t,{points:r}=o.handles,s=r.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:l,viewUp:d}=t.getCamera(),[c,g]=(0,ae.H)(s),h=t.canvasToWorld(c),m=t.canvasToWorld(g),{cachedStats:v}=o,p=Object.keys(v),f=h,E=m;for(let i=0;i<p.length;i++){const o=p[i],a=this.getTargetIdImage(o,n);if(!a)continue;const{dimensions:r,imageData:s,metadata:c,hasPixelSpacing:g}=a,I=it(s,f);I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]);const w=it(s,E);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(I,w,r)){const n=[[Math.min(I[0],w[0]),Math.max(I[0],w[0])],[Math.min(I[1],w[1]),Math.max(I[1],w[1])],[Math.min(I[2],w[2]),Math.max(I[2],w[2])]],i={center:[(h[0]+m[0])/2,(h[1]+m[1])/2,(h[2]+m[2])/2],xRadius:Math.abs(h[0]-m[0])/2,yRadius:Math.abs(h[1]-m[1])/2,zRadius:Math.abs(h[2]-m[2])/2},{worldWidth:r,worldHeight:g}=(0,Xe.A)(l,d,f,E),p=0===r&&0===g,C=(0,Ae.yH)(a),T=(0,Ae.CQ)(a),S=Math.abs(Math.PI*(r/C/2)*(g/T/C/2)),_={isPreScaled:(0,Ne.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},b=(0,Pe.c)(c.Modality,e.metadata.referencedImageId,_),D=(0,u.pointInShapeCallback)(s,(e=>(0,Je.pointInEllipse)(i,e,{fast:!0})),this.configuration.statsCalculator.statsCallback,n),A=this.configuration.statsCalculator.getStatistics();v[o]={Modality:c.Modality,area:S,mean:A.mean?.value,max:A.max?.value,stdDev:A.stdDev?.value,statsArray:A.array,pointsInShape:D,isEmptyArea:p,areaUnit:(0,Ae.Ss)(null,a),radius:r/2/C,radiusUnit:(0,Ae.Nx)(null,a),perimeter:2*Math.PI*(r/2)/C,modalityUnit:b}}else this.isHandleOutsideImage=!0,v[o]={Modality:c.Modality}}return e.invalidated=!1,(0,oe.XF)(e,a),v},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,100,{trailing:!0})}}function at(e,t){const n=e.cachedStats[t],{radius:i,radiusUnit:o,area:a,mean:r,stdDev:s,max:l,isEmptyArea:d,areaUnit:c,modalityUnit:g}=n,h=[];if(i){const e=d?"Radius: Oblique not supported":`Radius: ${(0,u.roundNumber)(i)} ${o}`;h.push(e)}if(a){const e=d?"Area: Oblique not supported":`Area: ${(0,u.roundNumber)(a)} ${c}`;h.push(e)}return r&&h.push(`Mean: ${(0,u.roundNumber)(r)} ${g}`),l&&h.push(`Max: ${(0,u.roundNumber)(l)} ${g}`),s&&h.push(`Std Dev: ${(0,u.roundNumber)(s)} ${g}`),h}ot.toolName="CircleROI";const rt=ot;var st=n(94750),lt=n(96950),dt=n(91975),ct=n(95562),gt=n(55067),ht=n(75251),ut=n(76840);const mt={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var vt,pt;!function(e){e.Cardinal="CARDINAL",e.Linear="LINEAR",e.CatmullRom="CATMULLROM",e.BSpline="BSPLINE"}(vt||(vt={})),function(e){e.AddControlPoint="addControlPoint",e.DeleteControlPoint="deleteControlPoint"}(pt||(pt={}));class ft extends ut.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:Et,contourHoleAdditionModifierKey:U.KeyboardBindings.Shift,decimate:{enabled:!1,epsilon:.1},spline:{configuration:{[vt.Cardinal]:{Class:dt.A,scale:.5},[vt.CatmullRom]:{Class:gt.e},[vt.Linear]:{Class:ct.F},[vt.BSpline]:{Class:ht.k,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:vt.CatmullRom,drawPreviewEnabled:!0,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[pt.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:U.MouseBindings.Primary,modifierKey:U.KeyboardBindings.Shift}]},[pt.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:U.MouseBindings.Primary,modifierKey:U.KeyboardBindings.Ctrl}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.fireChangeOnUpdate=null,this.isPointNearTool=(e,t,n,i)=>{const{instance:o}=t.data.spline;return o.isPointNearCurve(n,i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1};const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;this._activateModify(i),(0,u.triggerAnnotationRenderForViewportIds)(s,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=r.handles;s=e.findIndex((e=>e===n))}const d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,u.triggerAnnotationRenderForViewportIds)(g,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,contourHoleProcessingEnabled:s}=this.editData,{data:l}=i;i.autoGenerated=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d,g=this.getTargetIdImage(this.getTargetId(d.viewport),d.renderingEngine),{imageData:h,dimensions:m}=g;this.isHandleOutsideImage=l.handles.points.map((e=>o.utilities.transformWorldToIndex(h,e))).some((e=>!o.utilities.indexWithinDimensions(e,m))),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID);const v=r?U.ChangeTypes.Completed:U.ChangeTypes.HandlesUpdated;this.fireChangeOnUpdate?(this.fireChangeOnUpdate.annotationUID=i.annotationUID,this.fireChangeOnUpdate.changeType=v):this.fireChangeOnUpdate={annotationUID:i.annotationUID,changeType:v,contourHoleProcessingEnabled:s},(0,u.triggerAnnotationRenderForViewportIds)(c,a),this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const t=e.detail,{element:n}=t,i=t.key??"",{lastControlPointDeletionKeys:o}=this.configuration.spline;if(!o.includes(i))return;const{annotation:a}=this.editData,{data:r}=a;if(3!==r.handles.points.length){{const e=r.handles.points.length-1;this._deleteControlPointByIndex(n,a,e)}e.preventDefault()}else this.cancel(n)},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:t}=this.configuration.spline;if(!t)return;const{element:n}=e.detail,{renderingEngine:i}=(0,o.getEnabledElement)(n),a=(0,k.getViewportIdsWithToolToRender)(n,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,(0,u.triggerAnnotationRenderForViewportIds)(i,a),e.preventDefault()},this._mouseDownCallback=e=>{const t=e.type===U.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i}=this.editData,{data:a}=n;if(a.contour.closed)return;const r=e.detail,{element:s}=r,{currentPoints:l}=r,{canvas:d,world:c}=l,g=(0,o.getEnabledElement)(s),{renderingEngine:h}=g;let m=a.handles.points.length>=2&&t,v=!0;if(a.handles.points.length>=3){const{instance:e}=a.spline,t=e.getClosestControlPointWithinDistance(d,10);0===t?.index&&(v=!1,m=!0)}v&&a.handles.points.push(c),a.contour.closed=a.contour.closed||m,n.invalidated=!0,(0,u.triggerAnnotationRenderForViewportIds)(h,i),a.contour.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;this.moveAnnotation(i,n)}else{const{currentPoints:e}=t,n=e.world;l.handles.points[r]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,u.triggerAnnotationRenderForViewportIds)(c,a)},this.triggerAnnotationCompleted=(e,t)=>{const n=U.Events.ANNOTATION_COMPLETED,i={annotation:e,changeType:U.ChangeTypes.Completed,contourHoleProcessingEnabled:t};(0,o.triggerEvent)(o.eventTarget,n,i)},this.triggerAnnotationModified=(e,t,n=U.ChangeTypes.StatsUpdated)=>{const{viewportId:i,renderingEngineId:a}=t,r=U.Events.ANNOTATION_MODIFIED,s={annotation:e,viewportId:i,renderingEngineId:a,changeType:n};(0,o.triggerEvent)(o.eventTarget,r,s)},this.triggerChangeEvent=(e,t,n=U.ChangeTypes.StatsUpdated,i)=>{n===U.ChangeTypes.Completed?this.triggerAnnotationCompleted(e,i):this.triggerAnnotationModified(e,t,n)},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.KEY_DOWN,this._keyDownCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(U.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(U.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(U.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.KEY_DOWN,this._keyDownCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(U.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(U.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._mouseDownCallback)},this._renderStats=(e,t,n,i)=>{const o=e.data,a=this.getTargetId(t);if(!o.spline.instance.closed||!i.visibility)return;const r=this.configuration.getTextLines(o,a);if(!r||0===r.length)return;const s=o.handles.points.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=(0,Re.getTextBoxCoordsCanvas)(s);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const l=t.worldToCanvas(o.handles.textBox.worldPosition),d=(0,P.drawLinkedTextBox)(n,e.annotationUID??"","textBox",r,l,s,{},i),{x:c,y:g,width:h,height:u}=d;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([c,g]),topRight:t.canvasToWorld([c+h,g]),bottomLeft:t.canvasToWorld([c,g+u]),bottomRight:t.canvasToWorld([c+h,g+u])}},this.addControlPointCallback=(e,t)=>{const{data:n}=t,i=n.spline.type,a=this._getSplineConfig(i),r=a.controlPointAdditionDistance;if(!1===a.controlPointAdditionEnabled)return;const s=e.detail,{element:l}=s,d=(0,o.getEnabledElement)(l),{renderingEngine:c,viewport:g}=d,{canvasToWorld:h}=g,{instance:m}=n.spline,v=e.detail.currentPoints.canvas,p=m.getClosestPoint(v);if(p.distance>r)return;const{index:f,point:E}=m.addControlPointAtU(p.uValue);n.handles.points.splice(f,0,h(E)),t.invalidated=!0;const I=(0,k.getViewportIdsWithToolToRender)(l,this.getToolName());(0,u.triggerAnnotationRenderForViewportIds)(c,I)},this.deleteControlPointCallback=(e,t)=>{const n=t.data.spline.type,i=this._getSplineConfig(n),o=i.controlPointDeletionDistance;if(!1===i.controlPointDeletionEnabled)return;const a=e.detail,{element:r,currentPoints:s}=a,{canvas:l}=s,{instance:d}=t.data.spline,c=d.getClosestControlPointWithinDistance(l,o);c&&this._deleteControlPointByIndex(r,t,c.index)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const i=(0,o.getEnabledElement)(t),{viewport:a,renderingEngine:r}=i,{cachedStats:s}=n,{polyline:d}=n.contour,c=Object.keys(s);for(let e=0;e<c.length;e++){const t=c[e],n=this.getTargetIdImage(t,r);if(!n)continue;const{metadata:i}=n,o=d.map((e=>a.worldToCanvas(e))),g=o[0],h=a.canvasToWorld(g),m=a.canvasToWorld([g[0]+1,g[1]]),v=a.canvasToWorld([g[0],g[1]+1]),p=l.eR.distance(h,m),f=l.eR.distance(h,v),E=(0,u.getCalibratedScale)(n);let I=u.math.polyline.getArea(o)/E/E;I*=p*f,s[t]={Modality:i.Modality,area:I,areaUnit:(0,u.getCalibratedAreaUnits)(null,n)}}return this.triggerAnnotationModified(e,i,U.ChangeTypes.StatsUpdated),s},this._throttledCalculateCachedStats=(0,u.throttle)(this._calculateCachedStats,100,{trailing:!0})}static{this.SplineTypes=vt}static{this.Actions=pt}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{canvas:a}=n,r=(0,st.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey,s=(0,o.getEnabledElement)(i),{renderingEngine:l}=s,d=this.createAnnotation(e);this.isDrawing=!0,this.addAnnotation(d,i);const c=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:c,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,contourHoleProcessingEnabled:r},this._activateDraw(i),e.preventDefault(),(0,u.triggerAnnotationRenderForViewportIds)(l,c),d}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&(0,L.removeAnnotation)(t.annotationUID),super.cancelAnnotation(t);const a=(0,o.getEnabledElement)(e),{renderingEngine:r}=a;return(0,u.triggerAnnotationRenderForViewportIds)(r,n),this.editData=null,t.annotationUID}isContourSegmentationTool(){return!1}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:i,annotationStyle:o}=e,{viewport:a}=t,{worldToCanvas:r}=a,{element:s}=a,l=e.annotation,{annotationUID:d,data:c,highlighted:g}=l,{handles:h}=c,{points:u,activeHandleIndex:m}=h,v=this.editData?.newAnnotation,{lineWidth:p,lineDash:f,color:E,locked:I}=o,w=u.map((e=>r(e))),{drawPreviewEnabled:C}=this.configuration.spline,T=l.data.spline.type,S=this._getSplineConfig(T),_=l.data.spline.instance,b=(0,L.getChildAnnotations)(l);if(-1!==b.findIndex((e=>!e)))throw new Error(`Can't find annotation for child ${l.childAnnotationUIDs.join()}`);let D;if([l,...b].filter((e=>this._isSplineROIAnnotation(e))).forEach((e=>{const t=this._updateSplineInstance(s,e).getPolylinePoints();this.updateContourPolyline(e,{points:t,closed:c.contour.closed,targetWindingDirection:lt.W.Clockwise},a)})),super.renderAnnotationInstance(e),c.cachedStats[n]&&null!=c.cachedStats[n].areaUnit?l.invalidated&&this._throttledCalculateCachedStats(l,s):(c.cachedStats[n]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(l,s)),I||this.editData||null===m||(D=[w[m]]),D||v||g){const e="0";(0,P.drawHandles)(i,d,e,w,{color:E,lineWidth:Math.max(1,p),handleRadius:"3"})}if(C&&_.numControlPoints>1&&this.editData?.lastCanvasPoint&&!_.closed){const{lastCanvasPoint:e}=this.editData,t=_.getPreviewPolylinePoints(e,10);(0,P.drawPolyline)(i,d,"previewSplineChange",t,{color:"#9EA0CA",lineDash:f,lineWidth:1})}if(S.showControlPointsConnectors){const e=[...w];_.closed&&e.push(w[0]),(0,P.drawPolyline)(i,d,"controlPointsConnectors",e,{color:"rgba(255, 255, 255, 0.5)",lineWidth:1})}return this._renderStats(l,a,i,o.textbox),this.fireChangeOnUpdate?.annotationUID===d&&(this.triggerChangeEvent(l,t,this.fireChangeOnUpdate.changeType,this.fireChangeOnUpdate.contourHoleProcessingEnabled),this.fireChangeOnUpdate=null),l.invalidated=!1,!0}createInterpolatedSplineControl(e){if(e.data.handles.points?.length)return;const{polyline:t}=e.data.contour;if(!t||!t.length)return;e.data.handles.points=[];const{points:n}=e.data.handles,i=Math.max(10,Math.floor(t.length/20));for(let e=0;e<t.length-i;e+=i)n.push(t[e]);n.push(t[t.length-1])}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints,{type:i}=this.configuration.spline,a=this._getSplineConfig(i),r=new a.Class,s=()=>({type:a.type,instance:r,resolution:a.resolution});let l;return this.configuration.interpolation?.enabled&&(l=e=>{e.data.spline||=s(),this.createInterpolatedSplineControl(e)}),o.utilities.deepMerge(t,{data:{handles:{points:[[...n]]},spline:s(),cachedStats:{}},onInterpolationComplete:l})}_deleteControlPointByIndex(e,t,n){const i=(0,o.getEnabledElement)(e),{points:a}=t.data.handles;3===a.length?(0,L.removeAnnotation)(t.annotationUID):a.splice(n,1);const{renderingEngine:r}=i,s=(0,k.getViewportIdsWithToolToRender)(e,this.getToolName());t.invalidated=!0,(0,u.triggerAnnotationRenderForViewportIds)(r,s)}_isSplineROIAnnotation(e){return!!e.data?.spline}_getSplineConfig(e){const{configuration:t}=this,n=t.spline.configuration;return Object.assign({type:e},mt,n[e])}_updateSplineInstance(e,t){const n=(0,o.getEnabledElement)(e),{viewport:i}=n,{worldToCanvas:a}=i,{data:r}=t,{type:s,instance:l}=t.data.spline,d=this._getSplineConfig(s),c=r.handles.points.map(a),g=void 0!==d.resolution?parseInt(d.resolution):void 0,h=void 0!==d.scale?parseFloat(d.scale):void 0;return l.setControlPoints(c),l.closed=!!r.contour.closed,l.fixedResolution||void 0===g||l.resolution===g||(l.resolution=g,t.invalidated=!0),l instanceof dt.A&&!l.fixedScale&&void 0!==h&&l.scale!==h&&(l.scale=h,t.invalidated=!0),l}}function Et(e,t){const n=e.cachedStats[t],{area:i,isEmptyArea:o,areaUnit:a}=n,r=[];if(i){const e=o?"Area: Oblique not supported":`Area: ${(0,u.roundNumber)(i)} ${a}`;r.push(e)}return r}ft.toolName="SplineROI";const It=ft;class wt extends It{constructor(e){super(o.utilities.deepMerge({configuration:{calculateStats:!1}},e))}isContourSegmentationTool(){return!0}}wt.toolName="SplineContourSegmentationTool";const Ct=wt;var Tt=n(78279),St=n(20070),_t=n(84045),bt=n(9587),Dt=n(1320);class At extends ut.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:U.KeyboardBindings.Shift,snapHandleNearby:2,interpolation:{enabled:!1,nearestEdge:2,showInterpolationPolyline:!1},decimate:{enabled:!1,epsilon:.1},actions:{undo:{method:"undo",bindings:[{key:"Escape"}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,s=i*i,l=t.data.contour.polyline.map((e=>r.worldToCanvas(e)));let d=l[l.length-1];for(let e=0;e<l.length;e++){const t=l[e];if(u.math.lineSegment.distanceToPointSquared(d,t,n)<=s)return!0;d=t}return!1},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a};const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;this._activateModify(i),(0,u.triggerAnnotationRenderForViewportIds)(s,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;const{points:s}=r.handles,l=s.findIndex((e=>e===n)),d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:l},this._activateModify(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,u.triggerAnnotationRenderForViewportIds)(g,d),e.preventDefault()},this._endCallback=(e,t=!1)=>{const n=e.detail,{element:i}=n,{annotation:a,viewportIdsToRender:r,newAnnotation:s,contourHoleProcessingEnabled:l}=this.editData,{data:d}=a;d.handles.activeHandleIndex=null,this._deactivateModify(i),this._deactivateDraw(i),(0,V.resetElementCursor)(i);const c=(0,o.getEnabledElement)(i),{renderingEngine:g}=c;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage||t)return(0,L.removeAnnotation)(a.annotationUID),this.clearEditData(),void(0,u.triggerAnnotationRenderForViewportIds)(g,r);(0,u.triggerAnnotationRenderForViewportIds)(g,r);const h=s?U.ChangeTypes.Completed:U.ChangeTypes.HandlesUpdated;this.triggerChangeEvent(a,c,h,l),this.clearEditData()},this.triggerChangeEvent=(e,t,n=U.ChangeTypes.StatsUpdated,i=!1)=>{n===U.ChangeTypes.Completed?(0,oe.PS)(e,i):(0,oe.XF)(e,t.viewport.element,n)},this._mouseDownCallback=e=>{const t=e.type===U.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i,worldToSlice:a,sliceToWorld:r}=this.editData;if(this.editData.closed)return;const s=e.detail,{element:l}=s,{currentPoints:d}=s,{canvas:c,world:g}=d;let h=g;const m=(0,o.getEnabledElement)(l),{viewport:v,renderingEngine:p}=m,f=this.editData.currentPath.getControlPoints();let E=f.length>=2&&t;if(f.length>=2){const e={index:-1,distSquared:1/0};for(let t=0,n=f.length;t<n;t++){const n=r(f[t]),i=v.worldToCanvas(n),o=u.math.point.distanceToPointSquared(c,i);o<=100&&o<e.distSquared&&(e.distSquared=o,e.index=t)}0===e.index&&(E=!0)}const{snapHandleNearby:I}=this.configuration;if(I&&!this.editData.closed){const e=new Dt.j,t=this.scissors.findMinNearby(a(g),1),n=this.scissors.findPathToPoint(t);e.addPoints(n),e.prependPath(this.editData.confirmedPath),h=r(t),this.editData.currentPath=e}this.editData.closed=this.editData.closed||E,this.editData.confirmedPath=this.editData.currentPath;const w=this.editData.currentPath.getLastPoint();this.editData.confirmedPath.addControlPoint(w),n.data.handles.points.push(r(w)),this.scissors.startSearch(a(h)),n.invalidated=!0,(0,u.triggerAnnotationRenderForViewportIds)(p,i),this.editData.closed&&(this.updateAnnotation(this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:t,currentPoints:n}=e.detail,{world:i,canvas:a}=n,{renderingEngine:r}=(0,o.getEnabledElement)(t),s=(0,k.getViewportIdsWithToolToRender)(t,this.getToolName());this.editData.lastCanvasPoint=a;const{width:l,height:d}=this.scissors,{worldToSlice:c}=this.editData,g=c(i);if(g[0]<0||g[1]<0||g[0]>=l||g[1]>=d)return;const h=this.scissors.findPathToPoint(g),m=new Dt.j;m.addPoints(h),m.prependPath(this.editData.confirmedPath),this.editData.currentPath=m,(0,u.triggerAnnotationRenderForViewportIds)(r,s),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r}=this.editData;if(void 0===r)console.warn("No drag implemented for livewire");else{const{currentPoints:e}=t,o=e.world;this.editHandle(o,n,i,r)}const s=(0,o.getEnabledElement)(n),{renderingEngine:l}=s;(0,u.triggerAnnotationRenderForViewportIds)(l,a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&(0,L.removeAnnotation)(t.annotationUID);const a=(0,o.getEnabledElement)(e),{renderingEngine:r}=a;return(0,u.triggerAnnotationRenderForViewportIds)(r,n),this.editData=null,this.scissors=null,t.annotationUID},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(U.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(U.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(U.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(U.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(U.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._mouseDownCallback)}}setupBaseEditData(e,t,n,i,a){const r=(0,o.getEnabledElement)(t),{viewport:s}=r;this.isDrawing=!0;const d=s.getImageData(),{imageData:c}=d;let g,h,u,m,{scalarData:v}=d;if(s instanceof o.VolumeViewport||!v){if(!(s instanceof o.VolumeViewport))throw new Error("Viewport not supported");{const e=o.utilities.getCurrentVolumeViewportSlice(s),{sliceToIndexMatrix:t,indexToSliceMatrix:n}=e;g=e=>{const t=o.utilities.transformWorldToIndex(c,e),i=l.eR.transformMat4([0,0,0],t,n);return[i[0],i[1]]},h=e=>{const n=l.eR.transformMat4([0,0,0],[e[0],e[1],0],t);return o.utilities.transformIndexToWorld(c,n)},v=e.scalarData,u=e.width,m=e.height}}else u=d.dimensions[0],m=d.dimensions[1],g=e=>{const t=o.utilities.transformWorldToIndex(c,e);return[t[0],t[1]]},h=e=>o.utilities.transformIndexToWorld(c,[e[0],e[1],0]);v=o.utilities.convertToGrayscale(v,u,m);const{voiRange:p}=s.getProperties(),f=g(e);this.scissors=bt.f.createInstanceFromRawPixelData(v,u,m,p),i&&(this.scissorsRight=bt.f.createInstanceFromRawPixelData(v,u,m,p),this.scissorsRight.startSearch(g(i))),this.scissors.startSearch(f);const E=!i,I=new Dt.j,w=new Dt.j,C=E?void 0:new Dt.j;I.addPoint(f),I.addControlPoint(f);const T=(0,k.getViewportIdsWithToolToRender)(t,this.getToolName()),S=s.worldToCanvas(e);this.editData={annotation:n,viewportIdsToRender:T,newAnnotation:E,hasMoved:!1,lastCanvasPoint:S,confirmedPath:I,currentPath:w,confirmedPathRight:C,closed:!1,handleIndex:this.editData?.handleIndex??n.handles?.activeHandleIndex,worldToSlice:g,sliceToWorld:h,contourHoleProcessingEnabled:a}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{world:a}=n,{renderingEngine:r}=(0,o.getEnabledElement)(i),s=this.createAnnotation(e),l=(0,st.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey;return this.setupBaseEditData(a,i,s,void 0,l),this.addAnnotation(s,i),this._activateDraw(i),e.preventDefault(),(0,u.triggerAnnotationRenderForViewportIds)(r,this.editData.viewportIdsToRender),s}clearEditData(){this.editData=null,this.scissors=null,this.scissorsRight=null,this.isDrawing=!1}editHandle(e,t,n,i){const{data:o}=n,{points:a}=o.handles,{length:r}=a,s=a[(i-1+r)%r],l=a[(i+1)%r];if(!this.editData?.confirmedPathRight){this.setupBaseEditData(s,t,n,l);const{polyline:e}=o.contour,a=new Dt.j,r=new Dt.j,{worldToSlice:d}=this.editData,c=(0,_t.A)(n,i-1),g=(0,_t.A)(n,i+1);if(-1===g||-1===c)throw new Error(`Can't find handle index ${-1===g&&l} ${-1===c&&s}`);if(0===i)r.addPoints(e.slice(g+1,c).map(d));else{if(g<c)throw new Error(`Expected right index after left index, but were: ${c} ${g}`);a.addPoints(e.slice(0,c+1).map(d)),r.addPoints(e.slice(g,e.length).map(d))}this.editData.confirmedPath=a,this.editData.confirmedPathRight=r}const{editData:d,scissors:c}=this,{worldToSlice:g,sliceToWorld:h}=d,{activeHandleIndex:u}=o.handles;if(null==u)o.handles.activeHandleIndex=i;else if(u!==i)throw new Error(`Trying to edit a different handle than the one currently being edited ${i}!==${o.handles.activeHandleIndex}`);const m=g(e);if(m[0]<0||m[0]>=c.width||m[1]<0||m[1]>=c.height)return;a[i]=h(m);const v=c.findPathToPoint(m),p=this.scissorsRight.findPathToPoint(m),f=new Dt.j;f.prependPath(d.confirmedPath),0!==i&&f.addPoints(v),f.addPoints(p.reverse()),f.appendPath(d.confirmedPathRight),0===i&&f.addPoints(v),d.currentPath=f,n.invalidated=!0,d.hasMoved=!0}renderAnnotation(e,t){return this.updateAnnotation(this.editData?.currentPath),super.renderAnnotation(e,t)}isContourSegmentationTool(){return!1}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints;return o.utilities.deepMerge(t,{data:{handles:{points:[[...n]]}}})}undo(e,t,n){this.editData&&this._endCallback(n,!0)}renderAnnotationInstance(e){const{annotation:t,enabledElement:n,svgDrawingHelper:i,annotationStyle:o}=e,{viewport:a}=n,{worldToCanvas:r}=a,{annotationUID:s,data:l,highlighted:d}=t,{handles:c}=l,g=this.editData?.newAnnotation,{lineWidth:h,lineDash:u,color:m}=o;if(d||g&&t.annotationUID===this.editData?.annotation?.annotationUID){const e="0",t=c.points.map(r);(0,P.drawHandles)(i,s,e,t,{color:m,lineDash:u,lineWidth:h})}return super.renderAnnotationInstance(e),!0}updateAnnotation(e){if(!this.editData||!e)return;const{annotation:t,sliceToWorld:n}=this.editData;let{pointArray:i}=e;i.length>1&&(i=[...i,i[0]]),this.updateContourPolyline(t,{points:i,closed:t.data.contour.closed,targetWindingDirection:lt.W.Clockwise},{canvasToWorld:n})}}At.toolName="LivewireContour";const yt=At;class Rt extends yt{updateInterpolatedAnnotation(e,t){!this.editData&&e.invalidated&&e.data.handles.interpolationSources&&(e.data.contour.originalPolyline=e.data.contour.polyline,queueMicrotask((()=>{if(!e.data.handles.interpolationSources)return;const{points:n}=e.data.handles,{element:i}=t.viewport;this.setupBaseEditData(n[0],i,e);const{length:a}=n,{scissors:r}=this,{nearestEdge:s,repeatInterpolation:l}=this.configuration.interpolation;e.data.handles.originalPoints=n;const{worldToSlice:d,sliceToWorld:c}=this.editData,g=[];if(s){let e=d(n[n.length-1]);n.forEach(((t,i)=>{const a=d(t);e=a,g.push(a),r.startSearch(e),r.findPathToPoint(a),r.findPathToPoint(d(n[(i+3)%n.length]));const l=r.findMinNearby(a,s);o.utilities.isEqual(a,l)||(g[i]=l,e=l,n[i]=c(l))}))}const h=new Dt.j;for(let e=0;e<a;e++){r.startSearch(d(n[e]));const t=r.findPathToPoint(d(n[(e+1)%a]));h.addPoints(t)}this.updateAnnotation(h),this.scissors=null,this.scissorsRight=null,this.editData=null,e.data.handles.interpolationSources=null,l&&(0,oe.XF)(e,t.viewport.element,U.ChangeTypes.InterpolationUpdated)})))}renderAnnotationInstance(e){const{enabledElement:t,svgDrawingHelper:n}=e,i=e.annotation,{annotationUID:o}=i,{viewport:a}=t,{worldToCanvas:r}=a,{showInterpolationPolyline:s}=this.configuration.interpolation||{};this.updateInterpolatedAnnotation?.(i,t);const{originalPolyline:l}=i.data.contour,d=super.renderAnnotationInstance(e);if(s&&l&&i.autoGenerated){const e=l.map(r);e.push(e[0]),(0,P.drawPolyline)(n,o,"interpolationContour-0",e,{color:"#70ffff",lineWidth:1,fillOpacity:0})}return d}isContourSegmentationTool(){return!0}}Rt.toolName="LivewireContourSegmentationTool";const Mt=Rt;class xt extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:Ot,changeTextCallback:Lt,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;(0,V.hideElementCursor)(i),this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),{arrowFirst:u}=this.configuration,m=s.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:h},data:{text:"",handles:{points:[[...a],[...a]],activeHandleIndex:null,arrowFirst:u,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};(0,L.addAnnotation)(v,i);const p=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,F.A)(l,p),v},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,[l,d]=s.handles.points,c=r.worldToCanvas(l),g=r.worldToCanvas(d),h={start:{x:c[0],y:c[1]},end:{x:g[0],y:g[1]}};return B.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,V.hideElementCursor)(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const{renderingEngine:d}=(0,o.getEnabledElement)(n);this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),r?this.configuration.getTextCallback((e=>{if(!e)return(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(d,a),this.editData=null,void(this.isDrawing=!1);i.data.text=e,(0,oe.dZ)(i),(0,F.A)(d,a)})):(0,oe.XF)(i,n),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[r]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,L.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const o=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!o)return;const a=o;this.configuration.changeTextCallback(o,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:r}=(0,o.getEnabledElement)(e);return(0,F.A)(r,n),i&&(0,oe.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:s,data:l}=o,{handles:d,text:c}=l,{points:g,activeHandleIndex:h}=d;r.annotationUID=s;const{color:u,lineWidth:m,lineDash:v}=this.getAnnotationStyle({annotation:o,styleSpecifier:r}),p=g.map((e=>i.worldToCanvas(e)));let f;if((0,H.isAnnotationLocked)(o)||this.editData||null===h||(f=[p[h]]),f){const e="0";(0,P.drawHandles)(t,s,e,p,{color:u,lineWidth:m})}const E="1";if(this.configuration.arrowFirst?(0,P.drawArrow)(t,s,E,p[1],p[0],{color:u,width:m,lineDash:v}):(0,P.drawArrow)(t,s,E,p[0],p[1],{color:u,width:m,lineDash:v}),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!c)continue;const I=this.getLinkedTextBoxStyle(r,o);if(!I.visibility){l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!l.handles.textBox.hasMoved){const e=p[1];l.handles.textBox.worldPosition=i.canvasToWorld(e)}const w=i.worldToCanvas(l.handles.textBox.worldPosition),C="1",T=(0,P.drawLinkedTextBox)(t,s,C,[c],w,p,{},I),{x:S,y:_,width:b,height:D}=T;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([S,_]),topRight:i.canvasToWorld([S+b,_]),bottomLeft:i.canvasToWorld([S,_+D]),bottomRight:i.canvasToWorld([S+b,_+D])}}return n}}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;n.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===n));const d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,d),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;const i=(0,o.getEnabledElement)(e),{renderingEngine:a}=i,r=(0,k.getViewportIdsWithToolToRender)(e,this.getToolName());(0,F.A)(a,r),(0,oe.XF)(t,e)}_isInsideVolume(e,t,n){return o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n)}}function Ot(e){return e(prompt("Enter your annotation:"))}function Lt(e,t,n){return n(prompt("Enter your annotation:"))}xt.toolName="ArrowAnnotate";const Pt=xt;class Nt extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ut}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;(0,V.hideElementCursor)(i),this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,L.addAnnotation)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,F.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,[l,d,c]=s.handles.points,g=r.worldToCanvas(l),h=r.worldToCanvas(d),u={start:{x:g[0],y:g[1]},end:{x:h[0],y:h[1]}};if(B.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=i)return!0;if(!c)return!1;const m=r.worldToCanvas(c),v={start:{x:h[0],y:h[1]},end:{x:m[0],y:m[1]}};return B.distanceToPoint([v.start.x,v.start.y],[v.end.x,v.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,V.hideElementCursor)(i);const r=(0,o.getEnabledElement)(i),{renderingEngine:s}=r;(0,F.A)(s,a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;if(this.angleStartedNotYetCompleted&&2===l.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(c,a),r&&(0,oe.dZ)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[r]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const r=(0,o.getEnabledElement)(e),{renderingEngine:s}=r;return(0,F.A)(s,n),i&&(0,oe.dZ)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r=this.getTargetId(i),s=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:g}=d,{points:h,activeHandleIndex:u}=g.handles;l.annotationUID=c;const{color:m,lineWidth:v,lineDash:p}=this.getAnnotationStyle({annotation:d,styleSpecifier:l}),f=h.map((e=>i.worldToCanvas(e)));let E;if(g.cachedStats[r]&&null!=g.cachedStats[r].angle?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(g.cachedStats[r]={angle:null},this._calculateCachedStats(d,s,e)),(0,H.isAnnotationLocked)(d)||this.editData||null===u||(E=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){const e="0";(0,P.drawHandles)(t,c,e,f,{color:m,lineDash:p,lineWidth:v})}let I="1";if((0,P.drawLine)(t,c,I,f[0],f[1],{color:m,width:v,lineDash:p}),n=!0,3!==f.length)return n;if(I="2",(0,P.drawLine)(t,c,I,f[1],f[2],{color:m,width:v,lineDash:p}),!g.cachedStats[r]?.angle)continue;const w=this.getLinkedTextBoxStyle(l,d);if(!w.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const C=this.configuration.getTextLines(g,r);if(!g.handles.textBox.hasMoved){const e=f[1];g.handles.textBox.worldPosition=i.canvasToWorld(e)}const T=i.worldToCanvas(g.handles.textBox.worldPosition),S="1",_=(0,P.drawLinkedTextBox)(t,c,S,C,T,f,{},w),{x:b,y:D,width:A,height:y}=_;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([b,D]),topRight:i.canvasToWorld([b+A,D]),bottomLeft:i.canvasToWorld([b,D+y]),bottomRight:i.canvasToWorld([b+A,D+y])}}return n},this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;n.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===n));const d=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,d),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport;if(3!==i.handles.points.length)return;const r=i.handles.points[0],s=i.handles.points[1],l=i.handles.points[2],{cachedStats:d}=i,c=Object.keys(d);for(let e=0;e<c.length;e++){const n=c[e],i=(0,p.A)([r,s],[s,l]),{dimensions:a,imageData:g}=this.getTargetIdImage(n,t);this.isHandleOutsideImage=[r,s,l].map((e=>o.utilities.transformWorldToIndex(g,e))).some((e=>!o.utilities.indexWithinDimensions(e,a))),d[n]={angle:isNaN(i)?"Incomplete Angle":i}}return e.invalidated=!1,(0,oe.XF)(e,a),d}}function Ut(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;if(isNaN(i))return[`${i}`];return[`${(0,u.roundNumber)(i)} ${String.fromCharCode(176)}`]}Nt.toolName="Angle";const kt=Nt;var Vt=n(76727);class Wt extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Bt,showArcLines:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;(0,V.hideElementCursor)(i),this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,L.addAnnotation)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,F.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,{distanceToPoint:l,distanceToPoint2:d}=this.distanceToLines({viewport:r,points:s.handles.points,canvasCoords:n,proximity:i});return l<=i||d<=i},this.toolSelectedCallback=(e,t,n,i,a=6)=>{const r=e.detail,{element:s}=r;t.highlighted=!0;const l=(0,k.getViewportIdsWithToolToRender)(s,this.getToolName()),d=(0,o.getEnabledElement)(s),{renderingEngine:c,viewport:g}=d,{isNearFirstLine:h,isNearSecondLine:u}=this.distanceToLines({viewport:g,points:t.data.handles.points,canvasCoords:i,proximity:a});this.editData={annotation:t,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:h,isNearSecondLine:u},this._activateModify(s),(0,V.hideElementCursor)(s),(0,F.A)(c,l),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;if(this.angleStartedNotYetCompleted&&l.handles.points.length<4)return(0,V.resetElementCursor)(n),void(this.editData.handleIndex=l.handles.points.length);this.angleStartedNotYetCompleted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(c,a),r&&(0,oe.dZ)(i),this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:o,currentPoints:a}=i,r=a.world,{data:s}=t;return 1===n?(s.handles.points[1]=r,void(this.editData.hasMoved=s.handles.points[1][0]!==s.handles.points[0][0]||s.handles.points[1][1]!==s.handles.points[0][0])):3===n?(s.handles.points[3]=r,this.editData.hasMoved=s.handles.points[3][0]!==s.handles.points[2][0]||s.handles.points[3][1]!==s.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,(0,V.hideElementCursor)(o),s.handles.points[2]=s.handles.points[3]=r,void(this.editData.handleIndex=s.handles.points.length-1))},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s,isNearFirstLine:l,isNearSecondLine:d}=this.editData,{data:c}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r&&(l||d)){const{deltaPoints:e}=t,n=e.world,o=c.handles.points;if(l){[o[0],o[1]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}else if(d){[o[2],o[3]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;c.handles.points[r]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const g=(0,o.getEnabledElement)(n),{renderingEngine:h}=g;(0,F.A)(h,a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;a.handles.points.length<4&&(0,L.removeAnnotation)(t.annotationUID),t.highlighted=!1,a.handles.activeHandleIndex=null;const r=(0,o.getEnabledElement)(e),{renderingEngine:s}=r;return(0,F.A)(s,n),i&&(0,oe.dZ)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(U.Events.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(U.Events.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r=this.getTargetId(i),s=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:g}=d,{points:h,activeHandleIndex:u}=g.handles;l.annotationUID=c;const{color:m,lineWidth:v,lineDash:p}=this.getAnnotationStyle({annotation:d,styleSpecifier:l}),f=h.map((e=>i.worldToCanvas(e)));let E;if(g.cachedStats[r]&&null!=g.cachedStats[r].angle?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(g.cachedStats[r]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(d,s,e)),(0,H.isAnnotationLocked)(d)||this.editData||null===u||(E=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){const e="0";(0,P.drawHandles)(t,c,e,f,{color:m,lineDash:p,lineWidth:v})}const I=[f[0],f[1]],w=[f[2],f[3]];let C="line1";if((0,P.drawLine)(t,c,C,I[0],I[1],{color:m,width:v,lineDash:p}),n=!0,f.length<4)return n;C="line2",(0,P.drawLine)(t,c,C,w[0],w[1],{color:m,width:v,lineDash:p}),C="linkLine";const T=(0,Vt.f)(I[0],I[1]),S=(0,Vt.f)(w[0],w[1]);(0,P.drawLine)(t,c,C,T,S,{color:m,lineWidth:"1",lineDash:"1,4"});const{arc1Start:_,arc1End:b,arc2End:D,arc2Start:A}=g.cachedStats[r].points.canvas,{arc1Angle:y,arc2Angle:R}=g.cachedStats[r];if(this.configuration.showArcLines&&(C="arc1",(0,P.drawLine)(t,c,C,_,b,{color:m,lineWidth:"1"}),C="arc2",(0,P.drawLine)(t,c,C,A,D,{color:m,lineWidth:"1"})),!g.cachedStats[r]?.angle)continue;const M=this.getLinkedTextBoxStyle(l,d);if(!M.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(g,r);if(!g.handles.textBox.hasMoved){const e=(0,Re.getTextBoxCoordsCanvas)(f);g.handles.textBox.worldPosition=i.canvasToWorld(e)}const O=i.worldToCanvas(g.handles.textBox.worldPosition),L="cobbAngleText",N=(0,P.drawLinkedTextBox)(t,c,L,x,O,f,{},M),{x:U,y:k,width:V,height:W}=N;if(g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([U,k]),topRight:i.canvasToWorld([U+V,k]),bottomLeft:i.canvasToWorld([U,k+W]),bottomRight:i.canvasToWorld([U+V,k+W])},this.configuration.showArcLines){const e="arcAngle1",n=[`${y.toFixed(2)} ${String.fromCharCode(176)}`],i=(0,Vt.f)(_,b);(0,P.drawTextBox)(t,c,e,n,i,{...M,padding:3});const o="arcAngle2",a=[`${R.toFixed(2)} ${String.fromCharCode(176)}`],r=(0,Vt.f)(A,D);(0,P.drawTextBox)(t,c,o,a,r,{...M,padding:3})}}return n},this.distanceToLines=({viewport:e,points:t,canvasCoords:n,proximity:i})=>{const[o,a,r,s]=t,l=e.worldToCanvas(o),d=e.worldToCanvas(a),c=e.worldToCanvas(r),g=e.worldToCanvas(s),h={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},u={start:{x:c[0],y:c[1]},end:{x:g[0],y:g[1]}},m=B.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]),v=B.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]);let p=!1,f=!1;return m<=i?p=!0:v<=i&&(f=!0),{distanceToPoint:m,distanceToPoint2:v,isNearFirstLine:p,isNearSecondLine:f}},this.getArcsStartEndPoints=({firstLine:e,secondLine:t,mid1:n,mid2:i})=>{const o=[n,i],a=(0,p.A)(e,o),r=(0,p.A)(t,o),s=a>90?1:0,l=r>90?0:1,d=(0,Vt.f)(o[0],o[1]),c=Math.sqrt((o[1][0]-o[0][0])**2+(o[1][1]-o[0][1])**2),g=.1,h=(0,Vt.f)(e[0],e[1]),u=(0,Vt.f)(t[0],t[1]),m=[e[s][0]-h[0],e[s][1]-h[1]],v=Math.sqrt(m[0]**2+m[1]**2),f=[m[0]/v,m[1]/v],E=[h[0]+f[0]*c*g,h[1]+f[1]*c*g],I=[d[0]-n[0],d[1]-n[1]],w=Math.sqrt(I[0]**2+I[1]**2),C=[I[0]/w,I[1]/w],T=[n[0]+C[0]*c*g,n[1]+C[1]*c*g],S=[t[l][0]-u[0],t[l][1]-u[1]],_=Math.sqrt(S[0]**2+S[1]**2),b=[S[0]/_,S[1]/_],D=[u[0]+b[0]*c*g,u[1]+b[1]*c*g],A=[d[0]-i[0],d[1]-i[1]],y=Math.sqrt(A[0]**2+A[1]**2),R=[A[0]/y,A[1]/y];return{arc1Start:E,arc1End:T,arc2Start:D,arc2End:[i[0]+R[0]*c*g,i[1]+R[1]*c*g],arc1Angle:a>90?180-a:a,arc2Angle:r>90?180-r:r}},this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n,i="mouse"){const a=e.detail,{element:r}=a,{data:s}=t;t.highlighted=!0;let l,d=!1;n.worldPosition?d=!0:l=s.handles.points.findIndex((e=>e===n));const c=(0,k.getViewportIdsWithToolToRender)(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:c,handleIndex:l,movingTextBox:d},this._activateModify(r),(0,V.hideElementCursor)(r);const g=(0,o.getEnabledElement)(r),{renderingEngine:h}=g;(0,F.A)(h,c),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data;if(4!==i.handles.points.length)return;const o=[null,null],a=[null,null];let r=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=l.eR.distance(i.handles.points[e],i.handles.points[t]);n<r&&(r=n,o[1]=i.handles.points[e],o[0]=i.handles.points[(e+1)%2],a[0]=i.handles.points[t],a[1]=i.handles.points[2+(t-1)%2])}const{viewport:s}=n,{element:d}=s,c=i.handles.points.map((e=>s.worldToCanvas(e))),g=[c[0],c[1]],h=[c[2],c[3]],u=(0,Vt.f)(g[0],g[1]),m=(0,Vt.f)(h[0],h[1]),{arc1Start:v,arc1End:f,arc2End:E,arc2Start:I,arc1Angle:w,arc2Angle:C}=this.getArcsStartEndPoints({firstLine:g,secondLine:h,mid1:u,mid2:m}),{cachedStats:T}=i,S=Object.keys(T);for(let e=0;e<S.length;e++){T[S[e]]={angle:(0,p.A)(o,a),arc1Angle:w,arc2Angle:C,points:{canvas:{arc1Start:v,arc1End:f,arc2End:E,arc2Start:I},world:{arc1Start:s.canvasToWorld(v),arc1End:s.canvasToWorld(f),arc2End:s.canvasToWorld(E),arc2Start:s.canvasToWorld(I)}}}}return e.invalidated=!1,(0,oe.XF)(e,d),T}}function Bt(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;return[`${i.toFixed(2)} ${String.fromCharCode(176)}`]}Wt.toolName="CobbAngle";const Ht=Wt,{transformWorldToIndex:Ft}=o.utilities;class Gt extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:qt,displayBothAxesDistances:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;if(!(s instanceof o.StackViewport))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");(0,V.hideElementCursor)(i),this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:u,referencedImageId:h},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,L.addAnnotation)(m,i);const v=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,F.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>!1,this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;if(this.startedDrawing&&1===l.handles.points.length)return void(this.editData.handleIndex=1);this.startedDrawing=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID),(0,F.A)(c,a),r&&(0,oe.dZ)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r,movingTextBox:s}=this.editData,{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[r]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,F.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,V.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const r=(0,o.getEnabledElement)(e),{renderingEngine:s}=r;return(0,F.A)(s,n),i&&(0,oe.dZ)(t),this.editData=null,this.startedDrawing=!1,t.annotationUID}},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r=this.getTargetId(i),s=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:g}=d,{points:h}=g.handles;l.annotationUID=c;const u=this.getStyle("color",l,d),m=h.map((e=>i.worldToCanvas(e)));if(g.cachedStats[r]&&null!=g.cachedStats[r].xValues?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(g.cachedStats[r]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(d,s,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let v="0";if((0,P.drawHandle)(t,c,v,m[0],{color:u},0),n=!0,2!==m.length)return n;v="1",(0,P.drawHandle)(t,c,v,m[1],{color:u},1);if(g.cachedStats[r].isUnitless){const e=`${c}-line-1`,n="1";(0,P.drawLine)(t,c,n,m[0],m[1],{color:u,width:1,shadow:this.configuration.shadow},e)}else{const e=m[0],n=m[1],i=n[1]-e[1],o=n[0]-e[0];let a=[0,0];a=g.cachedStats[r].isHorizontal?[e[0]+o,e[1]]:[e[0],e[1]+i];let s=`${c}-line-1`,l="1";(0,P.drawLine)(t,c,l,m[0],a,{color:u,width:1,shadow:this.configuration.shadow},s),s=`${c}-line-2`,l="2",(0,P.drawLine)(t,c,l,m[1],a,{color:u,width:1,lineDash:[1,1],shadow:this.configuration.shadow},s)}const p=this.getLinkedTextBoxStyle(l,d);if(!p.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const f=this.configuration.getTextLines(g,r,this.configuration);if(!g.handles.textBox.hasMoved){const e=m[1];g.handles.textBox.worldPosition=i.canvasToWorld(e)}const E=i.worldToCanvas(g.handles.textBox.worldPosition),I="1",w=(0,P.drawLinkedTextBox)(t,c,I,f,E,m,{},p),{x:C,y:T,width:S,height:_}=w;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([C,T]),topRight:i.canvasToWorld([C+S,T]),bottomLeft:i.canvasToWorld([C,T+_]),bottomRight:i.canvasToWorld([C+S,T+_])}}return n},this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(e,t,n,i){}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;const s=(0,k.getViewportIdsWithToolToRender)(a,this.getToolName());let l,d=!1;n.worldPosition?d=!0:l=r.handles.points.findIndex((e=>e===n)),this.editData={handleIndex:l,annotation:t,viewportIdsToRender:s},this._activateModify(a),(0,V.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,F.A)(g,s),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport;if(2!==i.handles.points.length)return;const{cachedStats:a}=i,r=Object.keys(a);for(let e=0;e<r.length;e++){const o=r[e],s=this.getTargetIdImage(o,t);if(!s)continue;const{imageData:l}=s,d=i.handles.points[0],c=i.handles.points[1],g=Ft(l,d),h=Ft(l,c),{values:u,units:m}=(0,Ae.Xw)(s,[g]),{values:v,units:p}=(0,Ae.Xw)(s,[h]);let f,E,I,w,C=!1;if(m[0]!==p[0]||m[1]!==p[1]||"raw"===m[0]&&"raw"===p[0]){const e=(0,ve.distanceToPoint)(d,c);f=[e,0],E=[e,0],I=["px"],C=!0}else{const e=n.viewport.worldToCanvas(d),t=n.viewport.worldToCanvas(c),i=t[1]-e[1],o=t[0]-e[0];w=Math.abs(o)>Math.abs(i),f=[u[0],v[0]],E=[u[1],v[1]],I=[m[0],m[1]]}a[o]={xValues:f,yValues:E,isHorizontal:w,units:I,isUnitless:C}}return e.invalidated=!1,(0,oe.XF)(e,o),a}}function qt(e,t,n){const i=e.cachedStats[t],{xValues:o,yValues:a,units:r,isUnitless:s,isHorizontal:l}=i;if(s)return[`${(0,u.roundNumber)(o[0])} px`];if(n.displayBothAxesDistances){const e=Math.abs(o[1]-o[0]),t=Math.abs(a[1]-a[0]);return[`${(0,u.roundNumber)(e)} ${r[0]}`,`${(0,u.roundNumber)(t)} ${r[1]}`]}if(l){const e=Math.abs(o[1]-o[0]);return[`${(0,u.roundNumber)(e)} ${r[0]}`]}{const e=Math.abs(a[1]-a[0]);return[`${(0,u.roundNumber)(e)} ${r[1]}`]}}Gt.toolName="UltrasoundDirectionalTool";const $t=Gt;class zt extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:Zt,changeTextCallback:jt,canvasPosition:[10,10],canvasSize:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r,d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getReferencedImageId(s,a,c,g),u=zt.createAnnotation({metadata:{...s.getViewReference(),referencedImageId:h}});(0,L.addAnnotation)(u,i);const m=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return e.preventDefault(),(0,F.A)(l,m),this.configuration.getTextCallback((e=>{if(!e)return(0,L.removeAnnotation)(u.annotationUID),(0,F.A)(l,m),void(this.isDrawing=!1);u.data.text=e,(0,oe.dZ)(u),(0,F.A)(l,m)})),u},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:r}=a,{data:s}=t,{canvasPosition:l,canvasSize:d}=this.configuration;return!!l?.length&&(Math.abs(n[0]-l[0]+d/2)<=d/2&&Math.abs(n[1]-l[1]+d/2)<=d/2)},this.toolSelectedCallback=(e,t)=>{t.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t;this._deactivateModify(n),(0,V.resetElementCursor)(n)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,L.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const o=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!o)return;const a=o;this.configuration.changeTextCallback(o,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this._activateModify=e=>{N.wk.isInteractingWithTool=!0,e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback)},this._deactivateModify=e=>{N.wk.isInteractingWithTool=!1,e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,L.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:s}=o;r.annotationUID=s;const{color:l}=this.getAnnotationStyle({annotation:o,styleSpecifier:r}),{canvasPosition:d,canvasSize:c}=this.configuration;if(d?.length){const e="1";(0,P.drawArrow)(t,s,e,d.map((e=>e+c)),d,{color:l,width:1})}if(n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n}return n}}cancel(){}handleSelectedCallback(e,t,n){}_doneChangingTextCallback(e,t,n){t.data.text=n;const i=(0,o.getEnabledElement)(e),{renderingEngine:a}=i,r=(0,k.getViewportIdsWithToolToRender)(e,this.getToolName());(0,F.A)(a,r),(0,oe.XF)(t,e)}_isInsideVolume(e,t,n){return o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n)}}function Zt(e){return e(prompt("Enter your annotation:"))}function jt(e,t,n){return n(prompt("Enter your annotation:"))}zt.toolName="KeyImage";const Kt=zt;var Yt=n(42351);class Xt extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>this._deleteNearbyAnnotations(e,"mouse"),this.preTouchStartCallback=e=>this._deleteNearbyAnnotations(e,"touch")}_deleteNearbyAnnotations(e,t){const{renderingEngineId:n,viewportId:i,element:o,currentPoints:a}=e.detail,r=N.dU.getToolGroupForViewport(i,n);if(!r)return!1;const s=r._toolInstances,l=[];for(const e in s){const n=s[e];if("function"!=typeof n.isPointNearTool||"function"!=typeof n.filterInteractableAnnotationsForElement)continue;const i=(0,L.getAnnotations)(e,o);if(!i)continue;const r=n.filterInteractableAnnotationsForElement(o,i);for(const e of r)n.isPointNearTool(o,e,a.canvas,10,t)&&l.push(e.annotationUID)}for(const e of l)(0,Yt.setAnnotationSelected)(e),(0,L.removeAnnotation)(e);return e.preventDefault(),!0}}Xt.toolName="Eraser";const Jt=Xt;var Qt=n(33944),en=n(21080),tn=n(66211),nn=n(63421),on=n(30322),an=n(16124);class rn extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:en.p,ERASE_INSIDE:tn.M},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.toolGroupId,u=nn.activeSegmentation.getActiveSegmentationRepresentation(h);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:v,type:p}=u,f=nn.segmentIndex.getActiveSegmentIndex(v),E=nn.segmentLocking.getLockedSegments(v),I=nn.config.color.getColorForSegmentIndex(h,m,f),{representationData:w}=(0,on.getSegmentation)(v),C=w[U.SegmentationRepresentations.Labelmap],T={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:I},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null}}},S=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());if(this.editData={annotation:T,segmentIndex:f,segmentationId:v,segmentsLocked:E,segmentColor:I,viewportIdsToRender:S,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,segmentationRepresentationUID:m},(0,an.r)(C,s)){const{volumeId:e}=C,t=o.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=C;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,S),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:r}=this.editData,{data:s}=i,{currentPoints:l}=t,d=(0,o.getEnabledElement)(n),{worldToCanvas:c,canvasToWorld:g}=d.viewport,h=l.world,{points:u}=s.handles;let m,v,p,f,E,I,w,C;switch(u[r]=[...h],r){case 0:case 3:m=c(u[0]),f=c(u[3]),v=[f[0],m[1]],p=[m[0],f[1]],I=g(v),w=g(p),u[1]=I,u[2]=w;break;case 1:case 2:v=c(u[1]),p=c(u[2]),m=[p[0],v[1]],f=[v[0],p[1]],E=g(m),C=g(f),u[0]=E,u[3]=C}i.invalidated=!0,this.editData.hasMoved=!0;const{renderingEngine:T}=d;(0,F.A)(T,a)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,V.resetElementCursor)(n);const l=(0,o.getEnabledElement)(n),d={...this.editData,points:s.handles.points};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(l,d)},this._activateDraw=e=>{e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{annotation:o}=this.editData,a=o.metadata,r=o.annotationUID,s=o.data,{points:l}=s.handles,d=l.map((e=>i.worldToCanvas(e))),c=`rgb(${a.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,P.drawRect)(t,r,"0",d[0],d[3],{color:c}),n=!0,n}}}rn.toolName="RectangleScissor";const sn=rn;var ln=n(4069),dn=n(11852);class cn extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:ln.kr,ERASE_INSIDE:dn.r},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=n.canvas,s=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=s;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:g,viewUp:h}=c,u=this.toolGroupId,m=nn.activeSegmentation.getActiveSegmentationRepresentation(u);if(!m)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:v,segmentationId:p,type:f}=m,E=nn.segmentIndex.getActiveSegmentIndex(p),I=nn.segmentLocking.getLockedSegments(p),w=nn.config.color.getColorForSegmentIndex(u,v,E),{representationData:C}=(0,on.getSegmentation)(p),T=C[f];if(!T)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const S={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...g],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},_=[l.id];if(this.editData={annotation:S,centerCanvas:r,segmentIndex:E,segmentationId:p,segmentsLocked:I,segmentColor:w,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,segmentationRepresentationUID:v},(0,an.r)(T,l)){const{volumeId:e}=T,t=o.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=T;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(d,_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,r=(0,o.getEnabledElement)(n),{renderingEngine:s,viewport:l}=r,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:g,centerCanvas:h}=this.editData,{data:u}=c,m=Math.abs(a[0]-h[0]),v=Math.abs(a[1]-h[1]),p=Math.sqrt(m*m+v*v),f=[h[0],h[1]+p],E=[h[0],h[1]-p],I=[h[0]-p,h[1]],w=[h[0]+p,h[1]];u.handles.points=[d(f),d(E),d(I),d(w)],c.invalidated=!0,this.editData.hasMoved=!0,(0,F.A)(s,g)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=i,{viewPlaneNormal:l,viewUp:d}=i.metadata;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,V.resetElementCursor)(n);const c=(0,o.getEnabledElement)(n),g={...this.editData,points:s.handles.points,viewPlaneNormal:l,viewUp:d,strategySpecificConfiguration:{}};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(c,g)},this._activateDraw=e=>{e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),g=c[0],h=c[1],u=[Math.floor((g[0]+h[0])/2),Math.floor((g[1]+h[1])/2)],m=Math.abs(g[1]-Math.floor((g[1]+h[1])/2)),v=`rgb(${r.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,P.drawCircle)(t,s,"0",u,m,{color:v}),n=!0,n}}}cn.toolName="CircleScissor";const gn=cn;var hn=n(61604),un=n(4373);class mn extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:hn.Jq,ERASE_INSIDE:un._},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=n.canvas,s=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=s;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:g,viewUp:h}=c,u=this.toolGroupId,m=nn.activeSegmentation.getActiveSegmentationRepresentation(u);if(!m)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:v,segmentationId:p}=m,f=nn.segmentIndex.getActiveSegmentIndex(p),E=nn.segmentLocking.getLockedSegments(p),I=nn.config.color.getColorForSegmentIndex(u,v,f);this.isDrawing=!0;const w={metadata:{viewPlaneNormal:[...g],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:I},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},C=[l.id];this.editData={annotation:w,centerCanvas:r,segmentationRepresentationUID:v,segmentIndex:f,segmentationId:p,segmentsLocked:E,segmentColor:I,toolGroupId:u,viewportIdsToRender:C,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1};const{representationData:T}=(0,on.getSegmentation)(p),S=T[U.SegmentationRepresentations.Labelmap];if((0,an.r)(S,l)){const{volumeId:e}=S,t=o.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=S;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(d,C),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,r=(0,o.getEnabledElement)(n),{renderingEngine:s,viewport:l}=r,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:g,centerCanvas:h}=this.editData,{data:u}=c,m=Math.abs(a[0]-h[0]),v=Math.abs(a[1]-h[1]),p=Math.sqrt(m*m+v*v),f=[h[0],h[1]+p],E=[h[0],h[1]-p],I=[h[0]-p,h[1]],w=[h[0]+p,h[1]];u.handles.points=[d(f),d(E),d(I),d(w)],c.invalidated=!0,this.editData.hasMoved=!0,(0,F.A)(s,g)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:r,segmentIndex:s,segmentationRepresentationUID:l,segmentsLocked:d}=this.editData,{data:c}=i,{viewPlaneNormal:g,viewUp:h}=i.metadata;if(a&&!r)return;i.highlighted=!1,c.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,V.resetElementCursor)(n);const u=(0,o.getEnabledElement)(n),m={...this.editData,points:c.handles.points,segmentIndex:s,segmentationRepresentationUID:l,segmentsLocked:d,viewPlaneNormal:g,viewUp:h};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(u,m)},this._activateDraw=e=>{e.addEventListener(U.Events.MOUSE_UP,this._endCallback),e.addEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(U.Events.TOUCH_END,this._endCallback),e.addEventListener(U.Events.TOUCH_TAP,this._endCallback),e.addEventListener(U.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(U.Events.MOUSE_UP,this._endCallback),e.removeEventListener(U.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(U.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(U.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(U.Events.TOUCH_END,this._endCallback),e.removeEventListener(U.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(U.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),g=c[0],h=c[1],u=[Math.floor((g[0]+h[0])/2),Math.floor((g[1]+h[1])/2)],m=Math.abs(g[1]-Math.floor((g[1]+h[1])/2)),v=`rgb(${r.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,P.drawCircle)(t,s,"0",u,m,{color:v}),n=!0,n}}}mn.toolName="SphereScissor";const vn=mn;class pn extends Ye{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d,h=this.getTargetId(s);let u,m;if(s instanceof o.StackViewport)u=h.split("imageId:")[1];else{m=o.utilities.getVolumeId(h);const e=o.cache.getVolume(m);u=o.utilities.getClosestImageId(e,a,c)}const v=s.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],enabledElement:r,viewUp:[...g],FrameOfReferenceUID:v,referencedImageId:u,toolName:this.getToolName(),volumeId:m},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},segmentationId:null}};(0,Ge.lC)(p,i);const f=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,f),p},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,Ge.Rh)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const s=a[e],{annotationUID:l,data:d}=s,{points:c,activeHandleIndex:g}=d.handles,h=c.map((e=>i.worldToCanvas(e)));r.annotationUID=l;const u=this.getStyle("lineWidth",r,s),m=this.getStyle("lineDash",r,s),v=this.getStyle("color",r,s);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let p;if((0,oe.XF)(s,o),!(0,ie.isAnnotationVisible)(l))continue;if((0,H.isAnnotationLocked)(s)||this.editData||null===g||(p=[h[g]]),p){const e="0";(0,P.drawHandles)(t,l,e,p,{color:v})}const f="0";(0,P.drawRect)(t,l,f,h[0],h[3],{color:v,lineDash:m,lineWidth:u}),n=!0}return n}}}pn.toolName="RectangleROIThreshold";const fn=pn,{transformWorldToIndex:En}=o.utilities;class In extends Ye{constructor(e={},t={configuration:{numSlicesToPropagate:10,computePointsInsideVolume:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d;let h,u,m;if(s instanceof o.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(s);m=o.utilities.getVolumeId(e),u=o.cache.getVolume(m),h=o.utilities.getClosestImageId(u,a,c)}if(!h)throw new Error("This tool does not work on non-acquisition planes");const v=s.getCurrentImageIdIndex(),p=o.utilities.getSpacingInNormalDirection(u,c),f=this._getEndSliceIndex(u,a,p,c),E=s.getFrameOfReferenceUID(),I={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],enabledElement:r,viewUp:[...g],FrameOfReferenceUID:E,referencedImageId:h,toolName:this.getToolName(),volumeId:m,spacingInNormal:p},data:{label:"",startSlice:v,endSlice:f,cachedStats:{pointsInVolume:[],projectionPoints:[],projectionPointsImageIds:[h]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(I,u),(0,Ge.lC)(I,i);const w=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:I,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,w),I},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,Ge.O8)(i.annotationUID);const c=this.getTargetId(d.viewport),g=o.cache.getVolume(c.split(/volumeId:|\?/)[1]);this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(i,g,d),(0,F.A)(d.renderingEngine,a),r&&(0,oe.dZ)(i)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,o=(0,Ge.Rh)(this.getToolName(),i.element);if(!o?.length)return n;const a=i.getCurrentImageIdIndex(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<o.length;s++){const l=o[s],{annotationUID:d,data:c}=l,{startSlice:g,endSlice:h}=c,{points:u,activeHandleIndex:m}=c.handles,v=u.map((e=>i.worldToCanvas(e)));r.annotationUID=d;const p=this.getStyle("lineWidth",r,l),f=this.getStyle("lineDash",r,l),E=this.getStyle("color",r,l);if(a<Math.min(g,h)||a>Math.max(g,h))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let I,w=!1;if(a!==g&&a!==h||(w=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ie.isAnnotationVisible)(d))continue;if((0,H.isAnnotationLocked)(l)||this.editData||null===m||!w||(I=[v[m]]),I){const e="0";(0,P.drawHandles)(t,d,e,I,{color:E})}let C=f;w||(C=2);const T="0";(0,P.drawRect)(t,d,T,v[0],v[3],{color:E,lineDash:C,lineWidth:p}),n=!0}return n},this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:a,spacingInNormal:r}=i,{imageData:s}=t,{startSlice:d,endSlice:c}=n,{points:g}=n.handles,h=En(s,g[0]);if(h[2]!==d)throw new Error("Start slice does not match");const u=l.eR.fromValues(h[0],h[1],c),m=l.eR.create();s.indexToWorldVec3(h,m);const v=l.eR.create();s.indexToWorldVec3(u,v);const p=l.eR.distance(m,v),f=[];for(let e=0;e<p;e+=r)f.push(g.map((t=>{const n=l.eR.create();return l.eR.scaleAndAdd(n,t,a,e),Array.from(n)})));n.cachedStats.projectionPoints=f;const E=[];for(const e of f){const n=o.utilities.getClosestImageId(t,e[0],a);E.push(n)}n.cachedStats.projectionPointsImageIds=E}_computePointsInsideVolume(e,t,n){const{data:i}=e,o=i.cachedStats.projectionPoints,a=[[]];for(let e=0;e<o.length;e++){if(!t)continue;const n=o[e][0],r=i.handles.points[0],s=i.handles.points[3],{dimensions:l,imageData:d}=t,c=En(d,r),g=En(d,n);c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(g[2]);const h=En(d,s);if(h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(g[2]),this._isInsideVolume(c,h,l)){this.isHandleOutsideImage=!1;const e=[[Math.min(c[0],h[0]),Math.max(c[0],h[0])],[Math.min(c[1],h[1]),Math.max(c[1],h[1])],[Math.min(c[2],h[2]),Math.max(c[2],h[2])]],t=(0,u.pointInShapeCallback)(d,(()=>!0),null,e);a.push(t)}}i.cachedStats.pointsInVolume=a}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:i}=t,{cachedStats:a}=n,r=this.getTargetId(i),s=o.cache.getVolume(r.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,s),e.invalidated=!1,(0,oe.XF)(e,i.element),a}_getEndSliceIndex(e,t,n,i){const a=this.configuration.numSlicesToPropagate,r=l.eR.create();l.eR.scaleAndAdd(r,t,i,a*n);const s=n/2,{imageIds:d}=e;let c;for(let e=0;e<d.length;e++){const t=d[e],{imagePositionPatient:n}=o.metaData.get("imagePlaneModule",t),a=l.eR.create();l.eR.sub(a,r,n);const g=l.eR.dot(a,i);Math.abs(g)<s&&(c=e)}return c}}In.toolName="RectangleROIStartEndThreshold";const wn=In,{transformWorldToIndex:Cn}=o.utilities;class Tn extends rt{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{numSlicesToPropagate:10,calculatePointsInsideVolume:!1}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:g}=d;let h,u,m;if(s instanceof o.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(s);m=o.utilities.getVolumeId(e),u=o.cache.getVolume(m),h=o.utilities.getClosestImageId(u,a,c)}const v=o.utilities.getSpacingInNormalDirection(u,c),p=this._getStartSliceIndex(u,a,v,c),f=this._getEndSliceIndex(u,a,v,c),E=s.getFrameOfReferenceUID(),I={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:E,referencedImageId:h,volumeId:m,spacingInNormal:v,enabledElement:r},data:{label:"",startSlice:p,endSlice:f,handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...a],[...a]],activeHandleIndex:null},cachedStats:{pointsInVolume:[],projectionPoints:[]},labelmapUID:null}};(0,L.addAnnotation)(I,i);const w=(0,k.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:I,viewportIdsToRender:w,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,V.hideElementCursor)(i),e.preventDefault(),(0,F.A)(l,w),I},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:s}=this.editData,{data:l}=i;if(r&&!s)return;i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,V.resetElementCursor)(n);const d=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,L.removeAnnotation)(i.annotationUID);const c=this.getTargetId(d.viewport),g=o.cache.getVolume(c.split(/volumeId:|\?/)[1]);this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(i,g,d),(0,F.A)(d.renderingEngine,a),r&&(0,oe.dZ)(i)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,o=(0,L.getAnnotations)(this.getToolName(),i.element);if(!o?.length)return n;const a=i.getCurrentImageIdIndex(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<o.length;s++){const l=o[s],{annotationUID:d,data:c}=l,{startSlice:g,endSlice:h}=c,{points:u,activeHandleIndex:m}=c.handles;r.annotationUID=d;const v=this.getStyle("lineWidth",r,l),p=this.getStyle("lineDash",r,l),f=this.getStyle("color",r,l),E=u.map((e=>i.worldToCanvas(e))),I=E[0],w=(0,ae.r)(E),{centerPointRadius:C}=this.configuration;if(a<Math.min(g,h)||a>Math.max(g,h))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let T,S=!1;if(a===Math.round((g+h)/2)&&(S=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ie.isAnnotationVisible)(d))continue;if((0,H.isAnnotationLocked)(l)||this.editData||null===m||!S||(T=[E[m]]),T){const e="0";(0,P.drawHandles)(t,d,e,T,{color:f})}let _=v;S&&(_=3);const b="0";(0,P.drawCircle)(t,d,b,I,w,{color:f,lineDash:p,lineWidth:_}),C>0&&w>3*C&&(0,P.drawCircle)(t,d,`${b}-center`,I,C,{color:f,lineDash:p,lineWidth:v}),n=!0}return n},this._throttledCalculateCachedStats=(0,ye.A)(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:o,spacingInNormal:a}=i,{imageData:r}=t,{startSlice:s,endSlice:d}=n,{points:c}=n.handles,g=Cn(r,c[0]);if(g[2]=s,g[2]!==s)throw new Error("Start slice does not match");const h=l.eR.fromValues(g[0],g[1],d),u=l.eR.create();r.indexToWorldVec3(g,u);const m=l.eR.create();r.indexToWorldVec3(h,m);const v=l.eR.distance(u,m),p=[];for(let e=0;e<v;e+=a)p.push(c.map((t=>{const n=l.eR.create();return l.eR.scaleAndAdd(n,t,o,e),Array.from(n)})));n.cachedStats.projectionPoints=p}_computePointsInsideVolume(e,t,n){const{data:i}=e,{viewport:o}=n,a=i.cachedStats.projectionPoints,r=[[]];for(let e=0;e<a.length;e++){if(!t)continue;const n=a[e][0],i=a[e].map((e=>o.worldToCanvas(e))),[s,l]=(0,ae.H)(i),d=o.canvasToWorld(s),c=o.canvasToWorld(l),g=d,h=c,{dimensions:m,imageData:v}=t,p=Cn(v,g),f=Cn(v,n);p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(f[2]);const E=Cn(v,h);if(E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]),E[2]=Math.floor(f[2]),this._isInsideVolume(p,E,m)){const e=[[Math.min(p[0],E[0]),Math.max(p[0],E[0])],[Math.min(p[1],E[1]),Math.max(p[1],E[1])],[Math.min(p[2],E[2]),Math.max(p[2],E[2])]],t={center:n,xRadius:Math.abs(d[0]-c[0])/2,yRadius:Math.abs(d[1]-c[1])/2,zRadius:Math.abs(d[2]-c[2])/2},i=(0,u.pointInShapeCallback)(v,(e=>(0,Je.pointInEllipse)(t,e)),null,e);r.push(i)}}i.cachedStats.pointsInVolume=r}_calculateCachedStatsTool(e,t){const n=e.data,{viewportId:i,renderingEngineId:a,viewport:r}=t,{cachedStats:s}=n,l=this.getTargetId(r),d=o.cache.getVolume(l.split(/volumeId:|\?/)[1]);this._computeProjectionPoints(e,d),e.invalidated=!1;const c=U.Events.ANNOTATION_MODIFIED,g={annotation:e,viewportId:i,renderingEngineId:a};return(0,o.triggerEvent)(o.eventTarget,c,g),s}_getStartSliceIndex(e,t,n,i){const o=this.configuration.numSlicesToPropagate,a=Math.round(o/2),r=l.eR.create();l.eR.scaleAndAdd(r,t,i,a*-n);return this._getImageIdIndex(e,r,n,i)}_getEndSliceIndex(e,t,n,i){const o=this.configuration.numSlicesToPropagate,a=Math.round(o/2),r=l.eR.create();l.eR.scaleAndAdd(r,t,i,a*n);return this._getImageIdIndex(e,r,n,i)}_getImageIdIndex(e,t,n,i){const a=n/2,{imageIds:r}=e;let s;for(let e=0;e<r.length;e++){const n=r[e],{imagePositionPatient:d}=o.metaData.get("imagePlaneModule",n),c=l.eR.create();l.eR.sub(c,t,d);const g=l.eR.dot(c,i);Math.abs(g)<a&&(s=e)}return s}}Tn.toolName="CircleROIStartEndThreshold";const Sn=Tn;var _n=n(53712),bn=n(87682),Dn=n(27650);const{transformWorldToIndex:An,isEqual:yn}=o.utilities;class Rn extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:s}=r,l=s.getCamera(),{viewPlaneNormal:d}=l,c=this.toolGroupId,g=nn.activeSegmentation.getActiveSegmentationRepresentation(c);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:h,type:u}=g,m=nn.segmentIndex.getActiveSegmentIndex(h),v=nn.segmentLocking.getLockedSegments(h),{representationData:p}=(0,on.getSegmentation)(h),f=p[U.SegmentationRepresentations.Labelmap];let E,I,w,C;if((0,an.r)(f,s)){const{volumeId:e}=p[u],t=o.cache.getVolume(e);({dimensions:E,direction:I}=t),w=t.getScalarData(),C=An(t.imageData,a)}else{const{imageIdReferenceMap:e}=f,t=r.viewport.getCurrentImageId(),n=e.get(t);if(!n)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const i=o.cache.getImage(n);w=i.getPixelData();const{imageData:l}=s.getImageData();E=l.getDimensions(),I=l.getDirection(),C=An(l,a)}const T=this.getFixedDimension(d,I);if(void 0===T)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:S,getLabelValue:_,getScalarDataPositionFromPlane:b,inPlaneSeedPoint:D,fixedDimensionValue:A}=this.generateHelpers(w,E,C,T);if(C[0]<0||C[0]>=E[0]||C[1]<0||C[1]>=E[1]||C[2]<0||C[2]>=E[2])return;const y=_(C[0],C[1],C[2]);if(v.includes(y))return;const R=(0,Dn.A)(S,D),{flooded:M}=R;M.forEach((e=>{const t=b(e[0],e[1]);w[t]=m}));const x=this.getFramesModified(T,A,R);return(0,bn.triggerSegmentationDataModified)(h,x),!0},this.getFramesModified=(e,t,n)=>{const{boundaries:i}=n;if(2===e)return[t];let o=1/0,a=-1/0;for(let e=0;e<i.length;e++){const t=i[e][1];t<o&&(o=t),t>a&&(a=t)}const r=[];for(let e=o;e<=a;e++)r.push(e);return r},this.generateHelpers=(e,t,n,i=2)=>{let o,a;switch(i){case 0:o=n[0],a=[n[1],n[2]];break;case 1:o=n[1],a=[n[0],n[2]];break;case 2:o=n[2],a=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${i}`)}const r=(e,n,i)=>i*t[1]*t[0]+n*t[0]+e,s=(t,n,i)=>e[r(t,n,i)],l=this.generateFloodFillGetter(t,i,o,s);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane(r,i,o),getLabelValue:s,floodFillGetter:l,inPlaneSeedPoint:a,fixedDimensionValue:o}},this.generateFloodFillGetter=(e,t,n,i)=>{let o;switch(t){case 0:o=(t,o)=>{if(!(t>=e[1]||t<0||o>=e[2]||o<0))return i(n,t,o)};break;case 1:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[2]||o<0))return i(t,n,o)};break;case 2:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[1]||o<0))return i(t,o,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i}}getFixedDimension(e,t){const n=t.slice(0,3),i=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(yn(a,r))return 0;const s=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if(yn(a,s))return 1;const l=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return yn(a,l)?2:void 0}}Rn.toolName="PaintFill";const Mn=Rn;var xn=n(7914),On=n(50638),Ln=n(65373),Pn=n(48987),Nn=n(22745),Un=n(88099),kn=n(27398);const Vn={ANNOTATED_CUBE:1,AXES:2,CUSTOM:3};class Wn extends i.oS{constructor(e={},t={configuration:{orientationWidget:{enabled:!0,viewportCorner:xn.Ay.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:Wn.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[Wn.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"R",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"L",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[Wn.OVERLAY_MARKER_TYPES.AXES]:{},[Wn.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(e,t),this._resizeObservers=new Map,this.configuration_invalidated=!0,this.onSetToolEnabled=()=>{this.initViewports(),this.configuration_invalidated=!0,this._subscribeToViewportEvents()},this.onSetToolActive=()=>{this.initViewports(),this.configuration_invalidated=!0,this._subscribeToViewportEvents()},this.onSetToolDisabled=()=>{this.cleanUpData(),this._unsubscribeToViewportNewVolumeSet()},this.reset=()=>{this.configuration_invalidated=!0,this.initViewports()},this._getViewportsInfo=()=>(0,R.getToolGroup)(this.toolGroupId).viewportsInfo,this.resize=e=>{const t=this.orientationMarkers[e];if(!t)return;const{orientationWidget:n}=t;n.updateViewport()},this.orientationMarkers={},this.configuration_invalidated=!0}static{this.CUBE=1}static{this.AXIS=2}static{this.VTPFILE=3}static{this.OVERLAY_MARKER_TYPES=Vn}_unsubscribeToViewportNewVolumeSet(){this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,o.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(o.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.reset);this._resizeObservers.get(e).unobserve(i)}))}_subscribeToViewportEvents(){this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,o.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(o.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.reset);const a=new ResizeObserver((()=>{setTimeout((()=>{this.reset()}),100)}));a.observe(i),this._resizeObservers.set(e,a)}))}cleanUpData(){(0,o.getRenderingEngines)()[0].getViewports().forEach((e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:i}=t;i?.setEnabled(!1),i?.delete(),n?.delete();e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]}))}initViewports(){const e=(0,o.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,k.filterViewportsWithToolEnabled)(t,this.getToolName()),t.forEach((e=>{e.getWidget(this.getToolName())||this.addAxisActorInViewport(e)}))}async addAxisActorInViewport(e){const t=e.id,n=this.configuration.overlayMarkerType,i=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:i}=this.orientationMarkers[t];e.getRenderer().removeActor(n),i.setEnabled(!1)}let o;1===n?o=this.createAnnotationCube(i):2===n?o=Ln.Ay.newInstance():3===n&&(o=await this.createCustomActor());const a=e.getRenderer(),r=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:s,viewportCorner:l,viewportSize:d,minPixelSize:c,maxPixelSize:g}=this.configuration.orientationWidget,h=xn.Ay.newInstance({actor:o,interactor:r.getInteractor(),parentRenderer:a});h.setEnabled(s),h.setViewportCorner(l),h.setViewportSize(d),h.setMinPixelSize(c),h.setMaxPixelSize(g),h.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:h,actor:o},e.addWidget(this.getToolName(),h),r.render(),e.getRenderingEngine().render(),this.configuration_invalidated=!1}async createCustomActor(){const e=this.configuration.overlayConfiguration[Vn.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=Un.Ay.newInstance();i.parseAsArrayBuffer(n),i.update();const o=kn.Ay.newInstance();o.shallowCopy(i.getOutputData()),o.getPointData().setActiveScalars("Color");const a=Nn.Ay.newInstance();a.setInputData(o),a.setColorModeToDirectScalars();const r=Pn.Ay.newInstance();return r.setMapper(a),r.rotateZ(180),r}createAnnotationCube(e){const t=On.Ay.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=On.Ay.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach((n=>{const i=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[i](t[n])})),e}}Wn.toolName="OrientationMarker";const Bn=Wn;var Hn=n(71065),Fn=n(83946),Gn=n(96834),qn=n(96638);class $n extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,mode:$n.SelectMode.Border,searchRadius:6}}){super(e,t),this.mouseMoveCallback=e=>(this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout((()=>{this._setActiveSegment(e),this.hoverTimer=null}),this.configuration.hoverTimeout),!0),this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.hoverTimer=null}static{this.SelectMode={Inside:"Inside",Border:"Border"}}_setActiveSegment(e={}){if(N.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,i=n.world,a=(0,o.getEnabledElement)(t);if(!a)return;const{viewport:r}=a,s=(0,Hn.getActiveSegmentationRepresentation)(this.toolGroupId);if(!s)return;[Fn.A.Labelmap,Fn.A.Contour].includes(s.type)?this._setActiveSegmentForType(s,i,r):console.warn("SegmentSelectTool does not support the current segmentation type.")}_setActiveSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:i,type:o}=e;let a;if(this.configuration.mode===$n.SelectMode.Inside)a=(0,qn.getSegmentAtWorldPoint)(i,t,{viewport:n});else switch(o){case Fn.A.Labelmap:a=(0,qn.getSegmentAtLabelmapBorder)(i,t,{viewport:n,searchRadius:this.configuration.searchRadius});break;case Fn.A.Contour:a=(0,qn.getHoveredContourSegmentationAnnotation)(i)}if(!a||0===a)return;(0,Gn.setActiveSegmentIndex)(i,a);const r=n.getRenderingEngine(),s=r.getViewports().map((e=>e.id));(0,bn.triggerSegmentationModified)(i),(0,F.A)(r,s)}}$n.toolName="SegmentSelectTool";const zn=$n},53712:(e,t,n)=>{n.d(t,{A:()=>f});var i=n(44656),o=n(44753),a=n(96214),r=n(61604),s=n(4373),l=n(4069),d=n(11852),c=n(84901),g=n(2746),h=n(40233),u=n(23072),m=n(63421),v=n(16124);class p extends a.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:l.kr,ERASE_INSIDE_CIRCLE:d.r,FILL_INSIDE_SPHERE:r.Jq,ERASE_INSIDE_SPHERE:s._,THRESHOLD_INSIDE_CIRCLE:l.q,THRESHOLD_INSIDE_SPHERE:r.rd},strategySpecificConfiguration:{THRESHOLD:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",thresholdVolumeId:null,brushSize:25,preview:{enabled:!1,previewColors:{},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[c.StrategyCallbacks.AcceptPreview]:{method:c.StrategyCallbacks.AcceptPreview,bindings:[{key:"Enter"}]},[c.StrategyCallbacks.RejectPreview]:{method:c.StrategyCallbacks.RejectPreview,bindings:[{key:"Escape"}]}}}}){super(e,t),this._previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1},this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{renderingEngine:a}=o;this._editData=this.createEditData(n),this._activateDraw(n),(0,h.hideElementCursor)(n),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();const r=this._hoverData||this.createHoverData(n);return(0,u.A)(a,r.viewportIdsToRender),this.applyActiveStrategyCallback(o,this.getOperationData(n),c.StrategyCallbacks.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===c.ToolModes.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:i}=this.configuration.preview,{currentPoints:a,element:r}=e.detail,{canvas:s}=a,{preview:l,startPoint:d,timer:c,timerStart:g,isDrag:h}=this._previewData,u=o.Zc.distance(s,d),m=Date.now()-g;if((u>n||m>t&&u>i)&&(c&&(window.clearTimeout(c),this._previewData.timer=null),l&&!h&&this.rejectPreview(r)),!this._previewData.timer){const e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:s,element:r})}}},this.previewCallback=()=>{this._previewData.preview||(this._previewData.timer=null,this._previewData.preview=this.applyActiveStrategyCallback((0,i.getEnabledElement)(this._previewData.element),this.getOperationData(this._previewData.element),c.StrategyCallbacks.Preview))},this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:a}=t,r=(0,i.getEnabledElement)(n),{renderingEngine:s}=r;this.updateCursor(e);const{viewportIdsToRender:l}=this._hoverData;(0,u.A)(s,l);const d=o.Zc.distance(a.canvas,this._previewData.startPoint),{dragTimeMs:c,dragMoveDistance:g}=this.configuration.preview;!this._previewData.isDrag&&this._previewData.preview&&Date.now()-this._previewData.timerStart<c&&d<g||(this._previewData.preview=this.applyActiveStrategy(r,this.getOperationData(n)),this._previewData.element=n,this._previewData.timerStart=Date.now()+c,this._previewData.isDrag=!0,this._previewData.startPoint=a.canvas)},this._endCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),a=this.getOperationData(n);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(o,a),this._deactivateDraw(n),(0,h.resetElementCursor)(n),this.updateCursor(e),this._editData=null,this.applyActiveStrategyCallback(o,a,c.StrategyCallbacks.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(n)},this._activateDraw=e=>{e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}createEditData(e){const t=(0,i.getEnabledElement)(e),{viewport:n}=t,o=this.toolGroupId,a=m.activeSegmentation.getActiveSegmentationRepresentation(o);if(!a)throw new Error("No active segmentation detected, create a segmentation representation before using the brush tool");const{segmentationId:r,type:s,segmentationRepresentationUID:l}=a;if(s===c.SegmentationRepresentations.Contour)throw new Error("Not implemented yet");const d=m.segmentLocking.getLockedSegments(r),{representationData:g}=m.state.getSegmentation(r),h=g[c.SegmentationRepresentations.Labelmap];if((0,v.r)(h,n)){const{volumeId:e}=g[s],t=n.getActors();if(n instanceof i.StackViewport){const e=new CustomEvent(i.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"Cannot perform brush operation on the selected viewport"},cancelable:!0});return i.eventTarget.dispatchEvent(e),null}const o=t.map((e=>i.cache.getVolume(e.referenceId))),a=i.cache.getVolume(e),r=o.find((e=>i.utilities.isEqual(e.dimensions,a.dimensions)))?.volumeId||o[0]?.volumeId;return{volumeId:e,referencedVolumeId:this.configuration.thresholdVolumeId??r,segmentsLocked:d,segmentationRepresentationUID:l}}{const{imageIdReferenceMap:e}=h,t=n.getCurrentImageId();if(!e.get(t))return;if(this.configuration.activeStrategy.includes("SPHERE"))throw new Error("Sphere manipulation is not supported for stacks of image segmentations yet");return{imageIdReferenceMap:e,segmentsLocked:d,segmentationRepresentationUID:l}}}createHoverData(e,t){const n=(0,i.getEnabledElement)(e),{viewport:o}=n,a=o.getCamera(),{viewPlaneNormal:r,viewUp:s}=a,l=[o.id],{segmentIndex:d,segmentationId:c,segmentationRepresentationUID:g,segmentColor:h}=this.getActiveSegmentationData()||{};return{brushCursor:{metadata:{viewPlaneNormal:[...r],viewUp:[...s],FrameOfReferenceUID:o.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:h},data:{}},centerCanvas:t,segmentIndex:d,segmentationId:c,segmentationRepresentationUID:g,segmentColor:h,viewportIdsToRender:l}}getActiveSegmentationData(){const e=this.toolGroupId,t=m.activeSegmentation.getActiveSegmentationRepresentation(e);if(!t)return void console.warn("No active segmentation detected, create one before using the brush tool");const{segmentationRepresentationUID:n,segmentationId:i}=t,o=m.segmentIndex.getActiveSegmentIndex(i);return{segmentIndex:o,segmentationId:i,segmentationRepresentationUID:n,segmentColor:m.config.color.getColorForSegmentIndex(e,n,o)}}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas;this._hoverData=this.createHoverData(n,a),this._calculateCursor(n,a),this._hoverData&&(0,u.A)((0,i.getEnabledElement)(n).renderingEngine,this._hoverData.viewportIdsToRender)}getOperationData(e){const t=this._editData||this.createEditData(e),{segmentIndex:n,segmentationId:i,segmentationRepresentationUID:o,brushCursor:a}=this._hoverData||this.createHoverData(e),{data:r,metadata:s={}}=a||{},{viewPlaneNormal:l,viewUp:d}=s;return{...t,points:r?.handles?.points,segmentIndex:n,previewColors:this.configuration.preview.enabled?this.configuration.preview.previewColors:null,viewPlaneNormal:l,toolGroupId:this.toolGroupId,segmentationId:i,segmentationRepresentationUID:o,viewUp:d,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration,preview:this._previewData?.preview}}_calculateCursor(e,t){const n=(0,i.getEnabledElement)(e),{viewport:a}=n,{canvasToWorld:r}=a,s=a.getCamera(),{brushSize:l}=this.configuration,d=o.eR.fromValues(s.viewUp[0],s.viewUp[1],s.viewUp[2]),c=o.eR.fromValues(s.viewPlaneNormal[0],s.viewPlaneNormal[1],s.viewPlaneNormal[2]),g=o.eR.create();o.eR.cross(g,d,c);const h=r([t[0],t[1]]),u=o.eR.create(),m=o.eR.create(),v=o.eR.create(),p=o.eR.create();for(let e=0;e<=2;e++)u[e]=h[e]-d[e]*l,m[e]=h[e]+d[e]*l,v[e]=h[e]-g[e]*l,p[e]=h[e]+g[e]*l;if(!this._hoverData)return;const{brushCursor:f}=this._hoverData,{data:E}=f;void 0===E.handles&&(E.handles={}),E.handles.points=[u,m,v,p];const I=this.configuration.activeStrategy,w=this.configuration.strategies[I];"function"==typeof w.computeInnerCircleRadius&&w.computeInnerCircleRadius({configuration:this.configuration,viewport:a}),E.invalidated=!1}rejectPreview(e=this._previewData.element){if(!e||!this._previewData.preview)return;const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),c.StrategyCallbacks.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(e=this._previewData.element){if(!e)return;const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),c.StrategyCallbacks.AcceptPreview),this._previewData.isDrag=!1,this._previewData.preview=null}invalidateBrushCursor(){if(void 0===this._hoverData)return;const{data:e}=this._hoverData.brushCursor;e.invalidated=!0;const{segmentColor:t}=this.getActiveSegmentationData()||{};this._hoverData.brushCursor.metadata.segmentColor=t}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const i=this._hoverData.brushCursor;if(!0===i.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const o=i.metadata;if(!o)return;const a=o.brushCursorUID,r=i.data,{points:s}=r.handles,l=s.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],h=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],u=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),m=`rgb(${o.segmentColor?.slice(0,3)||[0,0,0]})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");(0,g.drawCircle)(t,a,"0",h,u,{color:m});const v=this.configuration.activeStrategy,{dynamicRadiusInCanvas:p}=this.configuration.strategySpecificConfiguration[v]||{dynamicRadiusInCanvas:0};if(p){const e="1";(0,g.drawCircle)(t,a,e,h,p,{color:m})}}}p.toolName="Brush";const f=p},16124:(e,t,n)=>{n.d(t,{r:()=>o});var i=n(44656);function o(e,t){const{imageIdReferenceMap:n}=e,{volumeId:o}=e;if(o&&!n)return!0;if(n&&!o)return!1;if(o&&n&&!t)throw new Error("isVolumeSegmentation: viewport is required when both volumeId and imageIdReferenceMap are provided");return t instanceof i.VolumeViewport}},96950:(e,t,n)=>{var i;n.d(t,{W:()=>i}),function(e){e[e.CounterClockwise=-1]="CounterClockwise",e[e.Unknown=0]="Unknown",e[e.Clockwise=1]="Clockwise"}(i||(i={}))},42290:(e,t,n)=>{n.d(t,{A:()=>i});const i=function(e,t){const n=e.findIndex((([e,t])=>e===t));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e}},14471:(e,t,n)=>{n.d(t,{C:()=>s,g:()=>r});var i=n(44656);const{EPSILON:o}=i.CONSTANTS;function a(e,t,n=!1){let i=1/0,a=n?-1/0:0,r=1/0,s=n?-1/0:0,l=1/0,d=n?-1/0:0;const c=3===e[0]?.length;for(let t=0;t<e.length;t++){const n=e[t];i=Math.min(n[0],i),a=Math.max(n[0],a),r=Math.min(n[1],r),s=Math.max(n[1],s),c&&(l=Math.min(n[2]??l,l),d=Math.max(n[2]??d,d))}return t?(i=Math.max(n?t[0]+o:0,i),a=Math.min(n?t[0]-o:t[0]-1,a),r=Math.max(n?t[1]+o:0,r),s=Math.min(n?t[1]-o:t[1]-1,s),c&&3===t.length&&(l=Math.max(n?t[2]+o:0,l),d=Math.min(n?t[2]-o:t[2]-1,d))):n||(i=Math.max(0,i),a=Math.min(1/0,a),r=Math.max(0,r),s=Math.min(1/0,s),c&&(l=Math.max(0,l),d=Math.min(1/0,d))),c?[[i,a],[r,s],[l,d]]:[[i,a],[r,s],null]}function r(e,t){return a(e,t,!1)}function s(e,t){return a(e,t,!0)}},15306:(e,t,n)=>{n.r(t),n.d(t,{extend2DBoundingBoxInViewAxis:()=>i.A,getBoundingBoxAroundShape:()=>o.g,getBoundingBoxAroundShapeIJK:()=>o.g,getBoundingBoxAroundShapeWorld:()=>o.C});var i=n(42290),o=n(14471)},88484:(e,t,n)=>{function i(e,t,n){return Math.min(Math.max(t,e),n)}n.d(t,{Ay:()=>o});const o=i},32415:(e,t,n)=>{n.d(t,{V:()=>o});var i=n(30322);function o(e){if(e.parentAnnotationUID)return;if(!e.data.segmentation)throw new Error("addContourSegmentationAnnotation: annotation does not have a segmentation data");const{segmentationId:t,segmentIndex:n}=e.data.segmentation,o=(0,i.getSegmentation)(t);o.representationData.CONTOUR||(o.representationData.CONTOUR={annotationUIDsMap:new Map});const{annotationUIDsMap:a}=o.representationData.CONTOUR;let r=a.get(n);r||(r=new Set,a.set(n,r)),a.set(n,r.add(e.annotationUID))}},15916:(e,t,n)=>{function i(e,t){const{segmentation:n}=e.data,{segmentation:i}=t.data;return n.segmentationId===i.segmentationId&&n.segmentIndex===i.segmentIndex}function o(e){return!!e.data?.segmentation}n.r(t),n.d(t,{addContourSegmentationAnnotation:()=>a.V,areSameSegment:()=>i,isContourSegmentationAnnotation:()=>o,removeContourSegmentationAnnotation:()=>s});var a=n(32415),r=n(63421);function s(e){if(!e.data.segmentation)throw new Error("removeContourSegmentationAnnotation: annotation does not have a segmentation data");const{segmentationId:t,segmentIndex:n}=e.data.segmentation,i=r.state.getSegmentation(t),{annotationUIDsMap:o}=i?.representationData.CONTOUR||{},a=o?.get(n);a&&(a.delete(e.annotationUID),a.size||o.delete(n))}},53891:(e,t,n)=>{n.d(t,{A:()=>i});const i=function(e,t){let n=0;for(let t=0;t<e.length-1;t++){const i=e[t],o=e[t+1];n+=Math.sqrt(Math.pow(o[0]-i[0],2)+Math.pow(o[1]-i[1],2))}if(t){const t=e[0],i=e[e.length-1];n+=Math.sqrt(Math.pow(i[0]-t[0],2)+Math.pow(i[1]-t[1],2))}return n}},84045:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(44656),o=n(44753);const{isEqual:a}=i.utilities;function r(e,t){const{polyline:n}=e.data.contour,{points:i}=e.data.handles,{length:r}=i;if(t===r)return n.length;if(t<0&&(t=(t+r)%r),0===t)return 0;const s=i[t],l=n.findIndex((e=>a(s,e)));if(-1!==l)return l;let d=1/0;return n.reduce(((e,t,n)=>{const i=o.eR.squaredDistance(t,s);return i<d?(d=i,n):e}),-1)}},75908:(e,t,n)=>{n.r(t),n.d(t,{AnnotationToPointData:()=>T,acceptAutogeneratedInterpolations:()=>y,areCoplanarContours:()=>o,calculatePerimeter:()=>x.A,contourFinder:()=>l,detectContourHoles:()=>g,findHandlePolylineIndex:()=>M.A,generateContourSetsFromLabelmap:()=>E,getContourHolesDataCanvas:()=>b,getContourHolesDataWorld:()=>_,getDeduplicatedVTKPolyDataPoints:()=>d,interpolation:()=>R,updateContourPolyline:()=>D.A});var i=n(44753);function o(e,t){const{viewPlaneNormal:n}=e.metadata,{viewPlaneNormal:o}=t.metadata,a=i.eR.dot(n,o);if(!i.Fd.equals(1,Math.abs(a)))return!1;const{polyline:r}=e.data.contour,{polyline:s}=t.data.contour,l=i.eR.dot(n,r[0]),d=i.eR.dot(n,s[0]);return i.Fd.equals(l,d)}function a(e,t,n){let i=-1;if(t.forEach(((t,n)=>{i>=0||t.a==e.b&&(i=n)})),i>=0){const e=t[i];return t.splice(i,1),n.push(e.b),n[0]==e.b?{remainingLines:t,contourPoints:n,type:"CLOSED_PLANAR"}:a(e,t,n)}return{remainingLines:t,contourPoints:n,type:"OPEN_PLANAR"}}function r(e){if(0==e.length)return[];const t=[],n=e.shift();t.push(n.a),t.push(n.b);const i=a(n,e,t);if(0==i.remainingLines.length)return[{type:i.type,contourPoints:i.contourPoints}];{const e=r(i.remainingLines);return e.push({type:i.type,contourPoints:i.contourPoints}),e}}function s(e){return r(e)}const l={findContours:r,findContoursFromReducedSet:s};function d(e,t=!1){const n=e.getPoints(),i=e.getLines(),o=new Array(n.getNumberOfPoints()).fill(0).map(((e,t)=>n.getPoint(t).slice())),a=new Array(i.getNumberOfCells()).fill(0).map(((e,t)=>{const n=i.getCell(3*t).slice();return{a:n[0],b:n[1]}}));if(t)return{points:o,lines:a};const r=[];for(const[e,t]of o.entries()){const n=r.findIndex((e=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]));if(n>=0)a.map((t=>(t.a===e&&(t.a=n),t.b===e&&(t.b=n),t)));else{const n=r.length;r.push(t),a.map((t=>(t.a===e&&(t.a=n),t.b===e&&(t.b=n),t)))}}return{points:r,lines:a.filter((e=>e.a!==e.b))}}const c=(e,t)=>{const n=e[0],i=e[1];let o=!1;for(let e=0,a=t.length-1;e<t.length;a=e++){const r=t[e][0],s=t[e][1],l=t[a][0],d=t[a][1];s>i!=d>i&&n<(l-r)*(i-s)/(d-s)+r&&(o=!o)}return o};const g={processContourHoles:function(e,t,n=!0){const i=e.filter((e=>"CLOSED_PLANAR"!==e.type)),o=e.filter((e=>"CLOSED_PLANAR"===e.type)),a=[];let r=[];return o.forEach(((e,n)=>{const i=[];o.forEach(((o,a)=>{n!=a&&function(e,t,n){const i=[];e.contourPoints.forEach((e=>{i.push([n[e][0],n[e][1]])}));let o=0;return t.contourPoints.forEach((e=>{c([n[e][0],n[e][1]],i)||o++})),0===o}(e,o,t)&&i.push(a)})),i.length>0?a.push({contour:e,holes:i}):r.push(n)})),n&&(a.forEach((e=>{e.contour.type="CLOSEDPLANAR_XOR",i.push(e.contour),e.holes.forEach((e=>{o[e].type="CLOSEDPLANAR_XOR",i.push(o[e]),r=r.filter((t=>t!==e))}))})),r.forEach((e=>{i.push(o[e])}))),i}};var h=n(44656),u=n(52754),m=n(45128),v=n(51250),p=n(83946);const{Labelmap:f}=p.A;function E({segmentations:e}){const{representationData:t,segments:n=[0,1]}=e,{volumeId:i}=t[f],o=h.cache.getVolume(i);if(!o)return void console.warn(`No volume found for ${i}`);const a=o.dimensions[2],r=o.imageData.getPointData().getScalars().getData(),l=o.dimensions[0]*o.dimensions[1];for(let e=0;e<a;e++)for(let t=0;t<o.dimensions[1];t++){const n=t*o.dimensions[0]+e*l;r[n]=0,r[n+o.dimensions[0]-1]=0}const c=[],{FrameOfReferenceUID:g}=o.metadata,p=n.length;for(let e=0;e<p;e++){const t=n[e];if(!t)continue;const i=[],h=m.Ay.newInstance({name:"Scalars",numberOfComponents:1,size:l*a,dataType:"Uint8Array"}),{containedSegmentIndices:p}=t;for(let t=0;t<a;t++){if(I(t,r,l,e))continue;const n=t*l;try{for(let t=0;t<l;t++){const i=r[t+n];i===e||p?.has(i)?h.setValue(t+n,1):h.setValue(t,0)}const a=u.Ay.newInstance({slice:t}),c=v.Ay.newInstance();c.shallowCopy(o.imageData),c.getPointData().setScalars(h),a.setInputData(c);const m=[1];a.setContourValues(m),a.setMergePoints(!1);const f=d(a.getOutputData());if(f.points?.length){const e=s(f.lines);i.push({contours:e,polyData:f,FrameNumber:t+1,sliceIndex:t,FrameOfReferenceUID:g})}}catch(e){console.warn(t),console.warn(e)}}const f={FrameOfReferenceUID:g},E={label:t.label,color:t.color,metadata:f,sliceContours:i};c.push(E)}return c}function I(e,t,n,i){const o=e*n,a=o+n;for(let e=o;e<a;e++)if(t[e]===i)return!1;return!0}var w=n(69405);class C{constructor(){}static{this.TOOL_NAMES={}}static convert(e,t,n){!function(e){if(!e?.data)throw new Error("Tool data is empty");if(!e.metadata||e.metadata.referenceImageId)throw new Error("Tool data is not associated with any imageId")}(e);const{toolName:i}=e.metadata,o=C.TOOL_NAMES[i];if(!o)throw new Error(`Unknown tool type: ${i}, cannot convert to RTSSReport`);const a=o.getContourSequence(e,n);return{ReferencedROINumber:t+1,ROIDisplayColor:[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random())],ContourSequence:a}}static register(e){C.TOOL_NAMES[e.toolName]=e}}C.register(w.A);const T=C;var S=n(95778);function _(e){return(e.childAnnotationUIDs??[]).map((e=>(0,S.gw)(e).data.contour.polyline))}function b(e,t){const n=_(e),i=[];return n.forEach((e=>{const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);i.push(o)})),i}var D=n(89111),A=n(33836);function y(e,t){A.A.acceptAutoGenerated(e,t)}var R=n(69115),M=n(84045),x=n(53891)},69115:(e,t,n)=>{n.r(t),n.d(t,{InterpolationManager:()=>i.A});var i=n(33836)},89111:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(44656),o=n(39956),a=n(95778);function r(e,t,n,r){const{canvasToWorld:s}=n,{data:l}=e,{targetWindingDirection:d}=t;let{points:c}=t;r?.decimate?.enabled&&(c=o.polyline.decimate(t.points,r?.decimate?.epsilon));let{closed:g}=t;const h=c.length,u=new Array(h),m=o.polyline.getWindingDirection(c),v=(0,a.Ay)(e);if(void 0===g){let e=!1;if(c.length>3){const t=o.point.distanceToPointSquared(c[0],c[h-1]);e=i.utilities.isEqual(0,t)}g=e}let p=v?-1*v.data.contour.windingDirection:d;void 0===p?p=m:p!==m&&c.reverse();for(let e=0;e<h;e++)u[e]=s(c[e]);l.contour.polyline=u,l.contour.closed=g,l.contour.windingDirection=p,(0,a.zH)(e)}},64857:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(11857);const o=function(e,t,n){let o,a,r,s,l,d,c=0,g=!1,h=!1,u=!0;const m=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function v(t){const n=o,i=a;return o=a=void 0,c=t,s=e.apply(i,n),s}function p(e,t){return m?window.requestAnimationFrame(e):setTimeout(e,t)}function f(e){const n=e-d;return void 0===d||n>=t||n<0||h&&e-c>=r}function E(){const e=Date.now();if(f(e))return I(e);l=p(E,function(e){const n=e-c,i=t-(e-d);return h?Math.min(i,r-n):i}(e))}function I(e){return l=void 0,u&&o?v(e):(o=a=void 0,s)}function w(...e){const n=Date.now(),i=f(n);if(o=e,a=this,d=n,i){if(void 0===l)return function(e){return c=e,l=p(E,t),g?v(e):s}(d);if(h)return l=p(E,t),v(d)}return void 0===l&&(l=p(E,t)),s}return t=Number(t)||0,(0,i.A)(n)&&(g=Boolean(n.leading),h="maxWait"in n,r=h?Math.max(Number(n.maxWait)||0,t):r,u="trailing"in n?Boolean(n.trailing):u),w.cancel=function(){void 0!==l&&function(e){if(m)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),c=0,o=d=a=l=void 0},w.flush=function(){return void 0===l?s:I(Date.now())},w.pending=function(){return void 0!==l},w}},10910:(e,t,n)=>{function i(e){const t=function(e){const t=[e[0],e[1]].sort(r),n=[e[0],e[1]].sort(s),i=t[t.length-1],o=n[0],a=n[n.length-1];return{top:o,bottom:a,right:i};function r(e,t){return e[0]<t[0]?-1:1}function s(e,t){return e[1]<t[1]?-1:1}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}n.r(t),n.d(t,{getTextBoxCoordsCanvas:()=>i})},24592:(e,t,n)=>{n.d(t,{CQ:()=>p,Nx:()=>c,Op:()=>m,Ss:()=>h,Xw:()=>v,yH:()=>u});var i=n(44656);const{CalibrationTypes:o}=i.Enums,a="px",r=[1],s=["3,3"],l=["4,3"],d={3:"cm",4:"seconds"},c=(e,t)=>{const{calibration:n,hasPixelSpacing:i}=t,r=i?"mm":a;return n&&(n.type||n.sequenceOfUltrasoundRegions)?n.type===o.UNCALIBRATED?a:n.sequenceOfUltrasoundRegions?"US Region":`${r} ${n.type}`:r},g="²",h=(e,t)=>{const{calibration:n,hasPixelSpacing:i}=t,o=(i?"mm":a)+g;return n&&n.type?n.sequenceOfUltrasoundRegions?"US Region":`${o} ${n.type}`:o},u=(e,t=[])=>{if(!e.calibration?.sequenceOfUltrasoundRegions)return e.calibration?.scale?e.calibration.scale:1},m=(e,t)=>{const[n,l]=t,{calibration:d,hasPixelSpacing:c}=e;let h=c?"mm":a;const u=h+g;let m=1,v="";if(!d||!d.type&&!d.sequenceOfUltrasoundRegions)return{units:h,areaUnits:u,scale:m};if(d.type===o.UNCALIBRATED)return{units:a,areaUnits:a+g,scale:m};if(d.sequenceOfUltrasoundRegions){let e=d.sequenceOfUltrasoundRegions.filter((e=>n[0]>=e.regionLocationMinX0&&n[0]<=e.regionLocationMaxX1&&n[1]>=e.regionLocationMinY0&&n[1]<=e.regionLocationMaxY1&&l[0]>=e.regionLocationMinX0&&l[0]<=e.regionLocationMaxX1&&l[1]>=e.regionLocationMinY0&&l[1]<=e.regionLocationMaxY1));if(!e?.length)return{units:h,areaUnits:u,scale:m};if(e=e.filter((e=>r.includes(e.regionDataType)&&s.includes(`${e.physicalUnitsXDirection},${e.physicalUnitsYDirection}`))),!e.length)return{units:a,areaUnits:a+g,scale:m};const t=e[0],o=Math.abs(t.physicalDeltaX),c=Math.abs(t.physicalDeltaY);if(!i.utilities.isEqual(o,c,.001))return{units:a,areaUnits:a+g,scale:m};m=1/(o*c*100),v="US Region",h="mm"}else d.scale&&(m=d.scale);return[o.ERMF,o.USER,o.ERROR,o.PROJECTION].includes(d?.type)&&(v=d.type),{units:h+(v?` ${v}`:""),areaUnits:u+(v?` ${v}`:""),scale:m}},v=(e,t)=>{const[n]=t,{calibration:i}=e;let o=["raw"],a=[null],s="";if(!i||!i.type&&!i.sequenceOfUltrasoundRegions)return{units:o,values:a};if(i.sequenceOfUltrasoundRegions){const e=i.sequenceOfUltrasoundRegions.filter((e=>r.includes(e.regionDataType)&&l.includes(`${e.physicalUnitsXDirection},${e.physicalUnitsYDirection}`)));if(!e?.length)return{units:o,values:a};const t=e.find((e=>n[0]>=e.regionLocationMinX0&&n[0]<=e.regionLocationMaxX1&&n[1]>=e.regionLocationMinY0&&n[1]<=e.regionLocationMaxY1));if(!t)return{units:o,values:a};const{referencePixelX0:c=0,referencePixelY0:g=0}=t,{physicalDeltaX:h,physicalDeltaY:u}=t,m=(n[1]-t.regionLocationMinY0-g)*u;s="US Region",a=[(n[0]-t.regionLocationMinX0-c)*h,m],o=[d[t.physicalUnitsXDirection],d[t.physicalUnitsYDirection]]}return{units:o,values:a,calibrationType:s}},p=e=>e.calibration?.aspect||1},96760:(e,t,n)=>{n.d(t,{R:()=>s});var i=n(44656),o=n(44753),a=n(15306);const{transformWorldToIndex:r}=i.utilities;function s(e,t,n){const[i,s]=e,l=o.eR.fromValues((i[0]+s[0])/2,(i[1]+s[1])/2,(i[2]+s[2])/2),d=o.eR.distance(i,s)/2;if(!n)throw new Error("viewport is required in order to calculate the sphere bounds");const{boundsIJK:c,topLeftWorld:g,bottomRightWorld:h}=function(e,t,n,i,s){const[l,d]=n,c=e.getDimensions(),g=t.getCamera(),h=o.eR.fromValues(g.viewUp[0],g.viewUp[1],g.viewUp[2]),u=o.eR.fromValues(g.viewPlaneNormal[0],g.viewPlaneNormal[1],g.viewPlaneNormal[2]),m=o.eR.create();o.eR.cross(m,h,u);const v=o.eR.create(),p=o.eR.create();o.eR.scaleAndAdd(v,d,u,s),o.eR.scaleAndAdd(p,l,u,-s),o.eR.scaleAndAdd(v,v,m,-s),o.eR.scaleAndAdd(p,p,m,s);const f=r(e,v),E=r(e,p),I=n.map((t=>r(e,t))),w=(0,a.getBoundingBoxAroundShapeIJK)([f,E,...I],c);return{boundsIJK:w,topLeftWorld:v,bottomRightWorld:p}}(t,n,e,0,d);return{boundsIJK:c,centerWorld:l,radiusWorld:d,topLeftWorld:g,bottomRightWorld:h}}},39490:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(65903);function o(e){const t=(0,i.A)(e);return t.length?t[0]:void 0}},65903:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(44656);const{isEqual:o}=i.utilities;function a(e){const{metadata:t}=e;return(0,i.getEnabledElements)().filter((e=>{if(e.FrameOfReferenceUID===t.FrameOfReferenceUID){const n=e.viewport,{viewPlaneNormal:i,viewUp:a}=n.getCamera();return o(i,t.viewPlaneNormal)&&(!t.viewUp||o(a,t.viewUp))}})).map((e=>e.viewport))}},21013:(e,t,n)=>{n.r(t),n.d(t,{annotationFrameRange:()=>L,boundingBox:()=>U,calibrateImageSpacing:()=>T,cine:()=>o,clip:()=>w.Ay,contourSegmentation:()=>je,contours:()=>H,debounce:()=>f.A,drawing:()=>G,dynamicVolume:()=>s,getAnnotationNearPoint:()=>m,getAnnotationNearPointOnEnabledElement:()=>v,getCalibratedAreaUnits:()=>S.Ss,getCalibratedLengthUnits:()=>S.Nx,getCalibratedScale:()=>S.yH,getSphereBoundsInfo:()=>R.R,getViewportForAnnotation:()=>B.A,isObject:()=>I.A,jumpToSlice:()=>A.A,math:()=>q,orientation:()=>i,planar:()=>$,planarFreehandROITool:()=>a,pointInShapeCallback:()=>y.A,pointInSurroundingSphereCallback:()=>V,pointToString:()=>x.l,polyDataUtils:()=>l,rectangleROITool:()=>r,roundNumber:()=>Ke,scroll:()=>M.A,segmentation:()=>F,stackContextPrefetch:()=>De,stackPrefetch:()=>Ie,throttle:()=>E.A,touch:()=>ye,triggerAnnotationRender:()=>b.Ay,triggerAnnotationRenderForToolGroupIds:()=>D,triggerAnnotationRenderForViewportIds:()=>_.A,triggerEvent:()=>g.triggerEvent,viewport:()=>Ae,viewportFilters:()=>z,voi:()=>c});var i={};n.r(i),n.d(i,{getOrientationStringLPS:()=>Z,invertOrientationStringLPS:()=>j});var o={};n.r(o),n.d(o,{Events:()=>K,addToolState:()=>X,getToolState:()=>J,playClip:()=>ie,stopClip:()=>oe});var a={};n.r(a),n.d(a,{default:()=>de,smoothAnnotation:()=>le.A});var r={};n.r(r),n.d(r,{getBoundsIJKFromRectangleAnnotations:()=>ce.A,isAxisAlignedRectangle:()=>ge.l});var s={};n.r(s),n.d(s,{generateImageFromTimeData:()=>xe,getDataInTime:()=>Me});var l={};n.r(l),n.d(l,{getPoint:()=>Oe,getPolyDataPointIndexes:()=>Le,getPolyDataPoints:()=>Pe});var d={};n.r(d),n.d(d,{Colorbar:()=>Ge,Enums:()=>Ne,ViewportColorbar:()=>Ze});var c={};n.r(c),n.d(c,{colorbar:()=>d});var g=n(44656),h=n(38296),u=n(52610);function m(e,t,n=5){const i=(0,g.getEnabledElement)(e);if(!i)throw new Error("getAnnotationNearPoint: enabledElement not found");return v(i,t,n)}function v(e,t,n){const{renderingEngineId:i,viewportId:o}=e,a=u.getToolGroupForViewport(o,i);if(!a)return null;const{_toolInstances:r}=a;for(const i in r){const o=p(r[i],e,t,n);if(o)return o}return null}function p(e,t,n,i){const{viewport:o}=t,a=(0,h.getAnnotations)(e.constructor.toolName,o?.element),r=o?.getCurrentImageId?.();if(a?.length){const{element:o}=t.viewport;for(const t of a){const a=t.metadata?.referencedImageId;if(!(r&&a&&r!==a||!e.isPointNearTool)&&(e.isPointNearTool(o,t,n,i,"")||e.getHandleNearImagePoint(o,t,n,i)))return t}}return null}var f=n(64857),E=n(21090),I=n(11857),w=n(88484);const{calibratedPixelSpacingMetadataProvider:C}=g.utilities;function T(e,t,n){"number"==typeof n&&(n={type:g.Enums.CalibrationTypes.USER,scale:n}),C.add(e,n);t.getStackViewports().forEach((t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}var S=n(24592),_=n(23072),b=n(6805);const D=function(e){e.forEach((e=>{const t=(0,u.getToolGroup)(e);if(!t)return void console.warn(`ToolGroup not available for ${e}`);t.getViewportsInfo().forEach((e=>{const{renderingEngineId:t,viewportId:n}=e,i=(0,g.getRenderingEngine)(t);if(!i)return void console.warn(`RenderingEngine not available for ${t}`);const o=i.getViewport(n);(0,b.Ay)(o.element)}))}))};var A=n(11666),y=n(75403),R=n(96760),M=n(21783),x=n(60438),O=n(28117);class L{static{this.frameRangeExtractor=/(\/frames\/|[&?]frameNumber=)([^/&?]*)/i}static imageIdToFrames(e){const t=e.match(this.frameRangeExtractor);if(!t||!t[2])return null;const n=t[2].split("-").map((e=>Number(e)));return 1===n.length?n[0]:n}static framesToString(e){return Array.isArray(e)?`${e[0]}-${e[1]}`:String(e)}static framesToImageId(e,t){const n=e.match(this.frameRangeExtractor);if(!n||!n[2])return null;const i=this.framesToString(t);return e.replace(this.frameRangeExtractor,`${n[1]}${i}`)}static setFrameRange(e,t,n){const{referencedImageId:i}=e.metadata;e.metadata.referencedImageId=this.framesToImageId(i,t);const o={...n,annotation:e};(0,g.triggerEvent)(g.eventTarget,O.A.ANNOTATION_MODIFIED,o)}static getFrameRange(e){return this.imageIdToFrames(e.metadata.referencedImageId)}}var P=n(44753),N=n(19096),U=n(15306);const{transformWorldToIndex:k}=g.utilities;function V(e,t,n,i){const{boundsIJK:o,centerWorld:a,radiusWorld:r}=function(e,t,n){const[i,o]=e,a=P.eR.fromValues((i[0]+o[0])/2,(i[1]+o[1])/2,(i[2]+o[2])/2),r=P.eR.distance(i,o)/2;let s;if(!n){const e=k(t,a),n=t.getSpacing(),i=Math.min(...n),o=Math.ceil(r/i);return s=[[e[0]-o,e[0]+o],[e[1]-o,e[1]+o],[e[2]-o,e[2]+o]],{boundsIJK:s,centerWorld:a,radiusWorld:r}}return s=function(e,t,n,i,o){const[a,r]=n,s=e.getDimensions(),l=t.getCamera(),d=P.eR.fromValues(l.viewUp[0],l.viewUp[1],l.viewUp[2]),c=P.eR.fromValues(l.viewPlaneNormal[0],l.viewPlaneNormal[1],l.viewPlaneNormal[2]),g=P.eR.create();P.eR.cross(g,d,c);const h=P.eR.create(),u=P.eR.create();P.eR.scaleAndAdd(h,r,c,o),P.eR.scaleAndAdd(u,a,c,-o),P.eR.scaleAndAdd(h,h,g,-o),P.eR.scaleAndAdd(u,u,g,o);const m=[k(e,h),k(e,u)],v=(0,U.getBoundingBoxAroundShape)(m,s);return v}(t,n,e,0,r),{boundsIJK:s,centerWorld:a,radiusWorld:r}}(t,e,i),s={center:a,radius:r};(0,y.A)(e,(e=>(0,N.d)(s,e)),n,o)}var W,B=n(39490),H=n(75908),F=n(96638),G=n(10910),q=n(39956),$=n(84797),z=n(90252);function Z(e){let t="";const n=e[0]<0?"R":"L",i=e[1]<0?"A":"P",o=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=1e-4;for(let e=0;e<3;e++)if(a[0]>r&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>r&&a[1]>a[0]&&a[1]>a[2])t+=i,a[1]=0;else if(a[2]>r&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>r&&a[1]>r&&a[0]===a[1])t+=n+i,a[0]=0,a[1]=0;else if(a[0]>r&&a[2]>r&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else{if(!(a[1]>r&&a[2]>r&&a[1]===a[2]))break;t+=i+o,a[1]=0,a[2]=0}return t}function j(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}!function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(W||(W={}));const K=W,Y={};function X(e,t){const n=(0,g.getEnabledElement)(e),{viewportId:i}=n;Y[i]=t}function J(e){const t=(0,g.getEnabledElement)(e),{viewportId:n}=t;return Y[n]}const{ViewportStatus:Q}=g.Enums,{triggerEvent:ee}=g.utilities,te=!0,ne=new Map;function ie(e,t){let n,i;if(void 0===e)throw new Error("playClip: element must not be undefined");const o=(0,g.getEnabledElement)(e);if(!o)throw new Error("playClip: element must be a valid Cornerstone enabled element");t||(t={}),t.dynamicCineEnabled=t.dynamicCineEnabled??!0;const{viewport:a}=o,r=se(a),s=function(e,t){if(e instanceof g.StackViewport)return function(e,t){const n=e.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){this.waitForRenderedCount<=t&&e.viewportStatus!==Q.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,(0,M.A)(e,{delta:n,debounceLoading:te}))}}}(e,t.waitForRendered??30);if(e instanceof g.VolumeViewport){const n=se(e);return t.dynamicCineEnabled&&n?.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll(t){e.timePointIndex+=t}}}(n):function(e,t){const{volumeId:n}=t,i={viewPlaneNormal:P.eR.create(),scrollInfo:null},o=()=>{const t=e.getCamera();if(!i.scrollInfo||!P.eR.equals(t.viewPlaneNormal,i.viewPlaneNormal)){const o=g.utilities.getVolumeViewportScrollInfo(e,n);i.viewPlaneNormal=t.viewPlaneNormal,i.scrollInfo=o}return i.scrollInfo};return{get numScrollSteps(){return o().numScrollSteps},get currentStepIndex(){return o().currentStepIndex},get frameTimeVectorEnabled(){const n=e.getCamera(),i=t.direction.slice(6,9).map((e=>-e)),o=P.eR.dot(i,n.viewPlaneNormal);return P.Fd.equals(o,1)},scroll(t){o().currentStepIndex+=t,(0,M.A)(e,{delta:t})}}}(e,n)}throw new Error("Unknown viewport type")}(a,t);let l=J(e);const d=t.dynamicCineEnabled&&r?.isDynamicVolume();if(d&&re(e),l?ae(e,{stopDynamicCine:!d,viewportId:a.id}):(l={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0},X(e,l)),l.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(l.framesPerSecond=Number(t.framesPerSecond),l.reverse=l.framesPerSecond<0,l.ignoreFrameTimeVector=!0),!0!==l.ignoreFrameTimeVector&&l.frameTimeVector&&l.frameTimeVector.length===s.numScrollSteps&&s.frameTimeVectorEnabled){const{timeouts:e,isTimeVarying:t}=function(e,t){let n,i,o,a=0;const r=e.length,s=[];let l=!1;("number"!=typeof t||t<=0)&&(t=1);for(n=1;n<r;n++)o=Number(e[n])/t|0,s.push(o),1===n?i=o:o!==i&&(l=!0),a+=o;s.length>0&&(o=l?a/s.length|0:s[0],s.push(o));return{timeouts:s,isTimeVarying:l}}(l.frameTimeVector,l.speed);n=e,i=t}const c=()=>{const{numScrollSteps:t,currentStepIndex:n}=s;let i=n+(l.reverse?-1:1);const o=i<0||i>=t;if(!l.loop&&o){ae(e,{stopDynamicCine:!d,viewportId:a.id});const t={element:e};return void ee(e,K.CLIP_STOPPED,t)}i>=t?i=0:i<0&&(i=t-1);const r=i-n;r&&s.scroll(r)};d&&ne.set(r.volumeId,e),n&&n.length>0&&i?(l.usingFrameTimeVector=!0,l.intervalId=window.setTimeout((function e(){l.intervalId=window.setTimeout(e,n[s.currentStepIndex]),c()}),0)):(l.usingFrameTimeVector=!1,l.intervalId=window.setInterval(c,1e3/Math.abs(l.framesPerSecond)));const h={element:e};ee(e,K.CLIP_STARTED,h)}function oe(e,t={}){ae(e,{stopDynamicCine:!0,...t})}function ae(e,t={stopDynamicCine:!0,viewportId:void 0}){const{stopDynamicCine:n,viewportId:i}=t,o=(0,g.getEnabledElement)(e);let a;if(o){const{viewport:e}=o;a=J(e.element)}else{if(!i)return;a=function(e){return Y[e]}(i)}a&&function(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}(a),n&&o?.viewport instanceof g.BaseVolumeViewport&&re(e)}function re(e){const{viewport:t}=(0,g.getEnabledElement)(e),n=se(t);if(n?.isDynamicVolume()){const t=ne.get(n.volumeId);ne.delete(n.volumeId),t&&t!==e&&oe(t)}}function se(e){const t=function(e){return e.getActors().map((e=>g.cache.getVolume(e.uid))).filter((e=>!!e))}(e);return t.find((e=>e.isDynamicVolume()))??t[0]}var le=n(14659);const de={smoothAnnotation:le.A};var ce=n(89786),ge=n(81952),he=n(54957),ue=n(48506);let me,ve={maxImagesToPrefetch:1/0,preserveExistingPool:!0};const pe=10;function fe(e){const t=(0,he.k)(e);if(!t)return;const n=t||{},i=(0,ue.bV)(e);if(!i?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:o}=i;if(n.enabled&&=n.indicesToRequest?.length,!1===n.enabled)return;function a(e){const t=n.indicesToRequest.indexOf(e);t>-1&&n.indicesToRequest.splice(t,1)}t.indicesToRequest.sort(((e,t)=>e-t));if(n.indicesToRequest.slice().forEach((function(e){const t=i.imageIds[e];if(!t)return;(Math.abs(o-e)<6?g.cache.getImageLoadObject(t):g.cache.isLoaded(t))&&a(e)})),!n.indicesToRequest.length)return;ve.preserveExistingPool||g.imageLoadPoolManager.clearRequestStack(ue.y9);const r=(0,ue.zo)(n.indicesToRequest,i.currentImageIdIndex);let s,l;let d=r.low,c=r.high;const h=[];for(;d>=0||c<n.indicesToRequest.length;){const e=i.currentImageIdIndex,t=!(e-n.indicesToRequest[d]>ve.maxImagesToPrefetch)&&d>=0,o=!(n.indicesToRequest[c]-e>ve.maxImagesToPrefetch)&&c<n.indicesToRequest.length;if(!o&&!t)break;t&&(l=n.indicesToRequest[d--],s=i.imageIds[l],h.push(s)),o&&(l=n.indicesToRequest[c++],s=i.imageIds[l],h.push(s))}const u=(e,t)=>g.imageLoader.loadAndCacheImage(e,t),{useNorm16Texture:m}=(0,g.getConfiguration)().rendering;h.forEach((e=>{const t={targetBuffer:{type:m?void 0:"Float32Array"},preScale:{enabled:!0},requestType:ue.y9};g.imageLoadPoolManager.addRequest(u.bind(null,e,t),ue.y9,{imageId:e},ue.Lr)}))}function Ee(e){clearTimeout(me),me=setTimeout((function(){const t=e.target;try{fe(t)}catch(e){return}}),pe)}const Ie={enable:function(e){const t=(0,ue.bV)(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n={indicesToRequest:(0,ue.y1)(0,t.imageIds.length-1),enabled:!0,direction:1},i=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(i,1),(0,he.P)(e,n),fe(e),e.removeEventListener(g.Enums.Events.STACK_NEW_IMAGE,Ee),e.addEventListener(g.Enums.Events.STACK_NEW_IMAGE,Ee);const o=(0,ue.m0)(e);g.eventTarget.removeEventListener(g.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),g.eventTarget.addEventListener(g.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)},disable:function(e){clearTimeout(me),e.removeEventListener(g.Enums.Events.STACK_NEW_IMAGE,Ee);const t=(0,ue.m0)(e);g.eventTarget.removeEventListener(g.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=(0,he.k)(e);n&&n.indicesToRequest.length&&(n.enabled=!1,g.imageLoadPoolManager.clearRequestStack(ue.y9))},getConfiguration:function(){return ve},setConfiguration:function(e){ve=e}};let we,Ce={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1};const Te=5;function Se(e){const t=(0,ue.bV)(e);if(!t?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n=(0,he.k)(e);if(!n)return;const i=n||{};if(i.enabled&&=i.indicesToRequest?.length,!1===i.enabled)return;function o(e){const t=i.indicesToRequest.indexOf(e);t>-1&&i.indicesToRequest.splice(t,1)}const a=i.indicesToRequest.slice(),{currentImageIdIndex:r}=t;if(a.forEach((e=>{const n=t.imageIds[e];if(!n)return;(Math.abs(r-e)<6?g.cache.getImageLoadObject(n):g.cache.isLoaded(n))&&o(e)})),!i.indicesToRequest.length)return;Ce.preserveExistingPool||g.imageLoadPoolManager.filterRequests((0,ue.Pg)(t));const s=(n,a)=>g.imageLoader.loadAndCacheImage(n,a).then((()=>function(n){o(t.imageIds.indexOf(n));const a=g.cache.getCachedImageBasedOnImageURI(n),{stats:r}=i,s=a?.image?.decodeTimeInMS||0;if(s){r.imageIds.set(n,s),r.decodeTimeInMS+=s;const e=a?.image?.loadTimeInMS||0;r.loadTimeInMS+=e}if(!i.indicesToRequest.length&&a?.sizeInBytes){const{sizeInBytes:t}=a,n=g.cache.getMaxCacheSize()/4/t;if(i.cacheFill){if(r.imageIds.size){r.fillTime=Date.now()-r.start;const{size:e}=r.imageIds;r.fillSize=e,console.log("Done cache fill",r.fillTime,"ms",e,"items","average total time",Ke(r.fillTime/e),"ms","average load",Ke(r.loadTimeInMS/e),"ms","average decode",Ke(r.decodeTimeInMS/e),"ms")}}else r.initialTime=Date.now()-r.start,r.initialSize=r.imageIds.size,be(e,n),Se(e)}}(n))),{useNorm16Texture:l}=(0,g.getConfiguration)().rendering;a.forEach((e=>{const n=t.imageIds[e],i={targetBuffer:{type:l?void 0:"Float32Array"},preScale:{enabled:!0},requestType:ue.y9};g.imageLoadPoolManager.addRequest(s.bind(null,n,i),ue.y9,{imageId:n},ue.Lr)}))}function _e(e){clearTimeout(we),we=setTimeout((function(){const t=e.target;try{be(t),Se(t)}catch(e){return}}),Te)}const be=(e,t)=>{const n=(0,ue.bV)(e);if(!n||!n.imageIds||0===n.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:i}=n;let{maxAfter:o=2,minBefore:a=2}=Ce;const{directionExtraImages:r=10}=Ce,s=(0,he.k)(e)||{indicesToRequest:[],currentImageIdIndex:i,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},l=i-s.currentImageIdIndex;if(s.direction=l<0?-1:1,s.currentImageIdIndex=i,s.enabled=!0,s.stackCount<100&&(s.stackCount+=r),Math.abs(l)>o||!l)if(s.stackCount=0,t){const e=i/n.imageIds.length;a=Math.ceil(t*e),o=Math.ceil(t*(1-e)),s.cacheFill=!0}else s.cacheFill=!1;else l<0?(a+=s.stackCount,o=0):(o+=s.stackCount,a=0);const d=Math.max(0,i-a),c=Math.min(n.imageIds.length-1,i+o),g=[];for(let e=i+1;e<=c;e++)g.push(e);for(let e=i-1;e>=d;e--)g.push(e);s.indicesToRequest=g,(0,he.P)(e,s)};const De={enable:e=>{const t=(0,ue.bV)(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");be(e),Se(e),e.removeEventListener(g.Enums.Events.STACK_NEW_IMAGE,_e),e.addEventListener(g.Enums.Events.STACK_NEW_IMAGE,_e);const n=(0,ue.m0)(e);g.eventTarget.removeEventListener(g.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n),g.eventTarget.addEventListener(g.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n)},disable:function(e){clearTimeout(we),e.removeEventListener(g.Enums.Events.STACK_NEW_IMAGE,_e);const t=(0,ue.m0)(e);g.eventTarget.removeEventListener(g.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=(0,he.k)(e);n&&n.data.length&&(n.enabled=!1)},getConfiguration:function(){return Ce},setConfiguration:function(e){Ce=e}};var Ae=n(31555),ye=n(54868),Re=n(77071);const Me=function(e,t){const n=t.frameNumbers||[...Array(e.numTimePoints).keys()];if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){const i=g.cache.getVolume(t.maskVolumeId),[o,a]=function(e,t,n){const{imageData:i}=n,o=n.getScalarData(),a=o.length,r=[];r.length=a;const s=[],l=n.dimensions;let d=0;for(let e=0,t=o.length;e<t;e++)0!==o[e]&&(s.push([e%l[0],Math.floor(e/l[0]%l[1]),Math.floor(e/(l[0]*l[1]))]),r[d++]=e);r.length=d;const c=t.getScalarDataArrays(),g=[],h=c[0].length===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing);if(h){for(let t=0;t<r.length;t++){const n=[];e.forEach((e=>{const i=c[e];n.push(i[r[t]])})),g.push(n)}return[g,s]}const u=({pointLPS:n,value:i,pointIJK:o})=>{if(0===i)return;const a=(0,Re.Q5)(t.imageData,t.dimensions,t.spacing,n);let r=0;const l=new Map;e.forEach((e=>l.set(e,0)));const d=({index:t})=>{for(let n=0;n<e.length;n++){const i=c[n][t],o=e[n];l.set(o,l.get(o)+i)}r++};(0,y.A)(t.imageData,(()=>!0),d,a);const h=[];l.forEach((e=>{h.push(e/r)})),s.push(o),g.push(h)};return(0,y.A)(i,(()=>!0),u),[g,s]}(n,e,i);return[o,a]}if(t.imageCoordinate){const i=function(e,t,n){const{dimensions:i,imageData:o}=n,a=o.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!g.utilities.indexWithinDimensions(a,i))throw new Error("outside bounds");const r=i[0],s=i[0]*i[1],l=n.getScalarDataArrays(),d=[];return e.forEach((e=>{const t=l[e],n=a[2]*s+a[1]*r+a[0];d.push(t[n])})),d}(n,t.imageCoordinate,e);return i}};const xe=function(e,t,n){const i=n||[...Array(e.numTimePoints).keys()],o=i.length;if(i.length<=1)throw new Error("Please provide two or more time points");const a=e.getScalarDataArrays(),r=a[0].length,s=new Float32Array(r);if(t===g.Enums.DynamicOperatorType.SUM){for(let e=0;e<o;e++){const t=a[i[e]];for(let e=0;e<r;e++)s[e]+=t[e]}return s}if(t===g.Enums.DynamicOperatorType.SUBTRACT){if(i.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(let e=0;e<r;e++)s[e]+=a[i[0]][e]-a[i[1]][e];return s}if(t===g.Enums.DynamicOperatorType.AVERAGE){for(let e=0;e<o;e++){const t=a[i[e]];for(let e=0;e<r;e++)s[e]+=t[e]}for(let e=0;e<r;e++)s[e]=s[e]/o;return s}};function Oe(e,t){const n=3*t;if(n<e.length)return P.eR.fromValues(e[n],e[n+1],e[n+2])}function Le(e){const t=e.getLines().getData();let n=0;const i=new Map;for(;n<t.length;){const e=t[n++],o=[];for(let i=0;i<e;i++)o.push(t[n+i]);i.set(o[0],o),n+=e}const o=[],a=e=>{for(const[t,n]of e.entries())if(void 0!==n)return t;return-1};let r=a(i);for(;-1!==r;){const e=[r];for(;i.has(r);){const t=i.get(r)[1];i.has(t)&&e.push(t),i.delete(r),r=t}o.push(e),r=a(i)}return o.length?o:void 0}function Pe(e){const t=Le(e);if(!t)return;const n=e.getPoints().getData();return t.map((e=>e.map((e=>Oe(n,e)))))}var Ne=n(73231),Ue=n(24284),ke=n(50614),Ve=n(25605),We=n(4856),Be=n(57457),He=n(38461);const Fe={MULTIPLIER:1,RANGE_TEXT_POSITION:ke.U.Right,TICKS_BAR_SIZE:50};class Ge extends He.A{constructor(e){super(e),this._isMouseOver=!1,this._isInteracting=!1,this._mouseOverCallback=e=>{this._isMouseOver=!0,this.showTicks(),e.stopPropagation()},this._mouseOutCallback=e=>{this._isMouseOver=!1,this.hideTicks(),e.stopPropagation()},this._mouseDownCallback=e=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(e),e.stopPropagation()},this._mouseDragCallback=(e,t)=>{const n=this.getVOIMultipliers(),i=this._getPointsFromMouseEvent(e),{points:o,voiRange:a}=t,r=P.Zc.sub(P.Zc.create(),i.local,o.local),s=r[0]*n[0],l=r[1]*n[1];if(!s&&!l)return;const{lower:d,upper:c}=a;let{windowWidth:h,windowCenter:u}=g.utilities.windowLevel.toWindowLevel(d,c);h=Math.max(h+s,1),u+=l;const m=g.utilities.windowLevel.toLowHighRange(h,u);this.voiRange=m,e.stopPropagation(),e.preventDefault()},this._mouseUpCallback=e=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),e.stopPropagation()},this._eventListenersManager=new g.utilities.eventListener.MultiTargetEventListenerManager,this._colormaps=Ge.getColormapsMap(e),this._activeColormapName=Ge.getInitialColormapName(e),this._canvas=this._createCanvas(e),this._ticksBar=this._createTicksBar(e),this._rangeTextPosition=e.ticks?.position??Fe.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}get activeColormapName(){return this._activeColormapName}set activeColormapName(e){if(e===this._activeColormapName)return;const t=this._colormaps.get(e);t?(this._activeColormapName=e,this._canvas.colormap=t):console.warn(`Invalid colormap name (${e})`)}get imageRange(){return this._canvas.imageRange}set imageRange(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}get voiRange(){return this._canvas.voiRange}set voiRange(e){const{voiRange:t}=this._canvas;(0,Ue.kB)(e)&&!(0,Ue.bh)(e,t)&&(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){const e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[Fe.MULTIPLIER,Fe.MULTIPLIER]}onVoiChange(e){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(e){const{colormaps:t}=e;return t.reduce(((e,t)=>e.set(t.Name,t)),new Map)}static getInitialColormapName(e){const{activeColormapName:t,colormaps:n}=e;return!!t&&n.some((e=>e.Name===t))?t:n[0].Name}_createCanvas(e){const{imageRange:t,voiRange:n,showFullPixelValueRange:i}=e,o=this._colormaps.get(this._activeColormapName);return new Ve.n({colormap:o,imageRange:t,voiRange:n,showFullPixelValueRange:i})}_createTicksBar(e){const t=e.ticks;return new We.f({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}_getPointsFromMouseEvent(e){const{rootElement:t}=this,n=[e.clientX,e.clientY],i=[e.pageX,e.pageY],o=t.getBoundingClientRect();return{client:n,page:i,local:[i[0]-o.left-window.pageXOffset,i[1]-o.top-window.pageYOffset]}}updateTicksBar(){const{width:e,height:t}=this.containerSize;if(0===e&&0===t)return;const{_ticksBar:n,_rangeTextPosition:i}=this,o=e>=t,a=o?e:Fe.TICKS_BAR_SIZE,r=o?Fe.TICKS_BAR_SIZE:t;if(!(0,Be.A)(e,t,i))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");let s,l;n.size={width:a,height:r},o?(l=0,s=i===ke.U.Top?-r:t):(s=0,l=i===ke.U.Left?-a:e),n.top=s,n.left=l}_addRootElementEventListeners(){const{_eventListenersManager:e}=this,{rootElement:t}=this;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(e){const{_eventListenersManager:t}=this,n={points:this._getPointsFromMouseEvent(e),voiRange:{...this._canvas.voiRange}};this._removeVOIEventListeners(),t.addEventListener(document,"voi.mouseup",this._mouseUpCallback),t.addEventListener(document,"voi.mousemove",(e=>this._mouseDragCallback(e,n)))}_removeVOIEventListeners(){const{_eventListenersManager:e}=this;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}}var qe=n(51954);const{Events:$e}=g.Enums,ze={lower:-1e3,upper:1e3};class Ze extends Ge{constructor(e){const{element:t,volumeId:n}=e,i=Ze._getImageRange(t,n),o=Ze._getVOIRange(t,n);super({...e,imageRange:i,voiRange:o}),this.autoHideTicks=()=>{if(this._hideTicksTimeoutId)return;const e=this._hideTicksTime-Date.now();e<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout((()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()}),e)},this._stackNewImageCallback=()=>{this.imageRange=Ze._getImageRange(this._element)},this._imageVolumeModifiedCallback=e=>{const{volumeId:t}=e.detail.imageVolume;if(t!==this._volumeId)return;const{_element:n}=this;this.imageRange=Ze._getImageRange(n,t)},this._viewportVOIModifiedCallback=e=>{const{viewportId:t,volumeId:n,range:i}=e.detail,{viewport:o}=this.enabledElement;t===o.id&&n===this._volumeId&&(this.voiRange=i,this.showAndAutoHideTicks())},this._viewportColormapModifiedCallback=e=>{const{viewportId:t,colormap:n,volumeId:i}=e.detail,{viewport:o}=this.enabledElement;t===o.id&&i===this._volumeId&&(this.activeColormapName=n.name)},this._element=t,this._volumeId=n,this._addCornerstoneEventListener()}get element(){return this._element}get enabledElement(){return(0,g.getEnabledElement)(this._element)}getVOIMultipliers(){const{viewport:e}=this.enabledElement;return(0,qe.j)(e,this._volumeId)}onVoiChange(e){super.onVoiChange(e);const{viewport:t}=this.enabledElement;if(t instanceof g.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof g.VolumeViewport){const{_volumeId:n}=this,i=g.utilities.getViewportsWithVolumeId(n,t.renderingEngineId);t.setProperties({voiRange:e},n),i.forEach((e=>e.render()))}}static _getImageRange(e,t){const n=(0,g.getEnabledElement)(e),{viewport:i}=n,o=t?i.getActor(t):i.getDefaultActor();if(!o)return ze;const a=o.actor.getMapper().getInputData().getPointData().getScalars().getRange();return 0===a[0]&&0===a[1]?ze:{lower:a[0],upper:a[1]}}static _getVOIRange(e,t){const n=(0,g.getEnabledElement)(e),{viewport:i}=n,o=t?i.getActor(t):i.getDefaultActor();if(!o||!g.utilities.isImageActor(o))return ze;const a=o.actor.getProperty().getRGBTransferFunction(0).getRange();return 0===a[0]&&0===a[1]?ze:{lower:a[0],upper:a[1]}}showAndAutoHideTicks(e=1e3){this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){const{_element:e}=this;g.eventTarget.addEventListener($e.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener($e.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener($e.VOI_MODIFIED,this._viewportVOIModifiedCallback),e.addEventListener($e.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}}var je=n(15916);const Ke=g.utilities.roundNumber},11857:(e,t,n)=>{n.d(t,{A:()=>i});const i=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)}},83112:(e,t,n)=>{n.r(t),n.d(t,{BasicStatsCalculator:()=>o,Calculator:()=>i});const i=class{};class o extends i{static{this.max=[-1/0]}static{this.sum=[0]}static{this.sumSquares=[0]}static{this.squaredDiffSum=[0]}static{this.count=0}static{this.statsCallback=({value:e})=>{Array.isArray(e)&&e.length>1&&1===this.max.length&&(this.max.push(this.max[0],this.max[0]),this.sum.push(this.sum[0],this.sum[0]),this.sumSquares.push(this.sumSquares[0],this.sumSquares[0]),this.squaredDiffSum.push(this.squaredDiffSum[0],this.squaredDiffSum[0]));const t=Array.isArray(e)?e:[e];this.count+=1,this.max.forEach(((e,n)=>this.max[n]=Math.max(e,t[n]))),this.sum.map(((e,n)=>this.sum[n]+=t[n])),this.sumSquares.map(((e,n)=>this.sumSquares[n]+=t[n]**2)),this.squaredDiffSum.map(((e,n)=>this.squaredDiffSum[n]+=Math.pow(t[n]-this.sum[n]/this.count,2)))}}static{this.getStatistics=()=>{const e=this.sum.map((e=>e/this.count)),t=this.squaredDiffSum.map((e=>Math.sqrt(e/this.count))),n=this.sumSquares.map(((t,n)=>Math.sqrt(this.sumSquares[n]/this.count-e[n]**2))),i={max:{name:"max",label:"Max Pixel",value:a(this.max),unit:null},mean:{name:"mean",label:"Mean Pixel",value:a(e),unit:null},stdDev:{name:"stdDev",label:"Standard Deviation",value:a(t),unit:null},stdDevWithSumSquare:{name:"stdDevWithSumSquare",value:a(n),unit:null},count:{name:"count",label:"Pixel Count",value:this.count,unit:null},array:[]};return i.array.push(i.max,i.mean,i.stdDev,i.stdDevWithSumSquare,i.count),this.max=[-1/0],this.sum=[0],this.sumSquares=[0],this.squaredDiffSum=[0],this.count=0,i}}}function a(e){return 1===e.length?e[0]:e}},2264:(e,t,n)=>{function i(e,t,n={}){return n.precalculated||o(e,n),n.precalculated(t)}n.r(t),n.d(t,{getCanvasEllipseCorners:()=>a,pointInEllipse:()=>i,precalculatePointInEllipse:()=>o});const o=(e,t={})=>{const{xRadius:n,yRadius:i,zRadius:o}=e;void 0!==t.invXRadiusSq&&void 0!==t.invYRadiusSq&&void 0!==t.invZRadiusSq||(t.invXRadiusSq=0!==n?1/n**2:0,t.invYRadiusSq=0!==i?1/i**2:0,t.invZRadiusSq=0!==o?1/o**2:0);const{invXRadiusSq:a,invYRadiusSq:r,invZRadiusSq:s}=t,{center:l}=e,[d,c,g]=l;return t.precalculated=e=>{const t=e[0]-d;let n=t*t*a;if(n>1)return!1;const i=e[1]-c;if(n+=i*i*r,n>1)return!1;const o=e[2]-g;return n+=o*o*s,n<=1},t};function a(e){const[t,n,i,o]=e;return[[i[0],n[1]],[o[0],t[1]]]}},39956:(e,t,n)=>{n.r(t),n.d(t,{BasicStatsCalculator:()=>l,aabb:()=>i,ellipse:()=>d,lineSegment:()=>c,point:()=>g,polyline:()=>h,rectangle:()=>u,vec2:()=>o});var i={};n.r(i),n.d(i,{distanceToPoint:()=>s,distanceToPointSquared:()=>r,intersectAABB:()=>a});var o={};function a(e,t){return e.minX<=t.maxX&&e.maxX>=t.minX&&e.minY<=t.maxY&&e.maxY>=t.minY}function r(e,t){const n=e.maxX-e.minX,i=e.maxY-e.minY,o=[n,i],a=[e.minX+n/2,e.minY+i/2],r=[Math.abs(t[0]-a[0]),Math.abs(t[1]-a[1])],s=r[0]-.5*o[0],l=r[1]-.5*o[1];if(s>0&&l>0)return s*s+l*l;const d=Math.max(s,0)+Math.max(l,0);return d*d}function s(e,t){return Math.sqrt(r(e,t))}n.r(o),n.d(o,{findClosestPoint:()=>m.A,liangBarksyClip:()=>v.A});var l=n(83112),d=n(2264),c=n(21954),g=n(14846),h=n(56634),u=n(23345),m=n(87658),v=n(86981)},21954:(e,t,n)=>{n.r(t),n.d(t,{distanceToPoint:()=>r,distanceToPointSquared:()=>a,distanceToPointSquaredInfo:()=>o,intersectLine:()=>l,isPointOnLineSegment:()=>c});var i=n(39956);function o(e,t,n){let o;const a=i.point.distanceToPointSquared(e,t);if(e[0]===t[0]&&e[1]===t[1]&&(o=e),!o){const i=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/a;o=i<0?e:i>1?t:[e[0]+i*(t[0]-e[0]),e[1]+i*(t[1]-e[1])]}return{point:[...o],distanceSquared:i.point.distanceToPointSquared(n,o)}}function a(e,t,n){return o(e,t,n).distanceSquared}function r(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(a(e,t,n))}function s(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function l(e,t,n,i){const[o,a]=e,[r,l]=t,[d,c]=n,[g,h]=i,u=l-a,m=o-r,v=r*a-o*l,p=u*d+m*c+v,f=u*g+m*h+v;if(0!==p&&0!==f&&s(p)===s(f))return;const E=h-c,I=d-g,w=g*c-d*h,C=E*o+I*a+w,T=E*r+I*l+w;if(0!==C&&0!==T&&s(C)===s(T))return;const S=u*I-E*m;let _;_=m*w-I*v;const b=_/S;_=E*v-u*w;return[b,_/S]}const d=.01;function c(e,t,n){const i=e[0]<=t[0]?e[0]:t[0],o=e[0]>=t[0]?e[0]:t[0],a=e[1]<=t[1]?e[1]:t[1],r=e[1]>=t[1]?e[1]:t[1];if(!(n[0]>=i-d&&n[0]<=o+d&&n[1]>=a-d&&n[1]<=r+d))return!1;const s=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return(s>=0?s:-s)<=d}},38566:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(14257);function o(e,t){return Math.sqrt((0,i.A)(e,t))}},14257:(e,t,n)=>{function i(e,t){if(e.length!==t.length)throw Error("Both points should have the same dimensionality");const[n,i,o=0]=e,[a,r,s=0]=t,l=a-n,d=r-i,c=s-o;return l*l+d*d+c*c}n.d(t,{A:()=>i})},49131:(e,t,n)=>{function i(e,t){const[n,i]=e,[o,a]=t;return[2*o-n,2*a-i]}n.d(t,{A:()=>i})},56634:(e,t,n)=>{n.r(t),n.d(t,{addCanvasPointsToArray:()=>B,containsPoint:()=>r,containsPoints:()=>s,decimate:()=>L,getAABB:()=>l.A,getArea:()=>d,getClosestLineSegmentIntersection:()=>N,getFirstLineSegmentIntersectionIndexes:()=>M,getLineSegmentIntersectionsCoordinates:()=>P,getLineSegmentIntersectionsIndexes:()=>E,getNormal2:()=>u,getNormal3:()=>h,getSignedArea:()=>c,getSubPixelSpacingAndXYDirections:()=>V,getWindingDirection:()=>g,intersectPolyline:()=>x,isClosed:()=>a,isPointInsidePolyline3D:()=>q,mergePolylines:()=>y,pointCanProjectOnLine:()=>H,pointsAreWithinCloseContourProximity:()=>W,projectTo2D:()=>G,subtractPolylines:()=>R});var i=n(44753),o=n(39956);function a(e){if(e.length<3)return!1;const t=e.length,n=e[0],a=e[t-1],r=o.point.distanceToPointSquared(n,a);return i.Fd.equals(0,r)}function r(e,t,n={closed:void 0}){if(e.length<3)return!1;const i=e.length;let o=0;const{closed:s,holes:l}=n;if(l?.length)for(const e of l)if(r(e,t))return!1;const d=!(void 0===s?a(e):s),c=e.length-(d?1:2);for(let n=0;n<=c;n++){const a=e[n],r=e[n===i-1?0:n+1],s=a[0]>=r[0]?a[0]:r[0],l=a[1]>=r[1]?a[1]:r[1],d=a[1]<=r[1]?a[1]:r[1];if(t[0]<=s&&t[1]>=d&&t[1]<l){let e=a[0]===r[0];if(!e){const n=(t[1]-a[1])*(r[0]-a[0])/(r[1]-a[1])+a[0];e=t[0]<=n}o+=e?1:0}}return!!(o%2)}function s(e,t){for(let n=0,i=t.length;n<i;n++)if(!r(e,t[n]))return!1;return!0}var l=n(86970);function d(e){const t=e.length;let n=0,i=t-1;for(let o=0;o<t;o++)n+=(e[i][0]+e[o][0])*(e[i][1]-e[o][1]),i=o;return Math.abs(n/2)}function c(e){if(e.length<3)return 0;const t=e[0];let n=0;for(let i=0,o=e.length;i<o;i++){const a=e[i],r=e[i===o-1?0:i+1],s=a[0]-t[0],l=a[1]-t[1],d=r[0]-t[0];n+=s*(r[1]-t[1])-l*d}return n*=.5,n}function g(e){return c(e)>=0?1:-1}function h(e){const t=function(e){const t=i.eR.create(),n=e[0];for(let i=0,o=e.length;i<o;i++){const a=e[i],r=e[i===o-1?0:i+1],s=a[0]-n[0],l=a[1]-n[1],d=a[2]-n[2],c=r[0]-n[0],g=r[1]-n[1],h=r[2]-n[2];t[0]+=l*h-d*g,t[1]+=d*c-s*h,t[2]+=s*g-l*c}return i.eR.scale(t,t,.5),t}(e);return i.eR.normalize(t,t)}function u(e){const t=c(e);return[0,0,t/Math.abs(t)]}var m=n(14846);function v(e,t,n,i){let o=!1;const a=e[0]<t[0]?e[0]:t[0],r=e[1]<t[1]?e[1]:t[1],s=e[0]>t[0]?e[0]:t[0],l=e[1]>t[1]?e[1]:t[1],d=n[0]<i[0]?n[0]:i[0],c=n[1]<i[1]?n[1]:i[1],g=n[0]>i[0]?n[0]:i[0],h=n[1]>i[1]?n[1]:i[1];if(a>g||s<d||r>h||l<c)return!1;const u=[p(e,t,n),p(e,t,i),p(n,i,e),p(n,i,t)];return u[0]!==u[1]&&u[2]!==u[3]||((0===u[0]&&f(e,n,t)||0===u[1]&&f(e,i,t)||0===u[2]&&f(n,e,i)||0===u[3]&&f(n,t,i))&&(o=!0),o)}function p(e,t,n){const i=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===i?0:i>0?1:2}function f(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function E(e,t,n,i=!0){const o=[],a=e.length,r=a-(i?1:2);for(let i=0;i<=r;i++){const r=i===a-1?0:i+1;v(t,n,e[i],e[r])&&o.push([i,r])}return o}var I=n(21954);const w=.01;function C(e,t,n,i){const o=[t[0]-e[0],t[1]-e[1]],a=[i[0]-n[0],i[1]-n[1]],r=a[1]*o[0]-a[0]*o[1];if((r>=0?r:-r)<w){const o=[e[0]<t[0]?e[0]:t[0],e[0]>t[0]?e[0]:t[0],e[1]<t[1]?e[1]:t[1],e[1]>t[1]?e[1]:t[1]],a=[n[0]<i[0]?n[0]:i[0],n[0]>i[0]?n[0]:i[0],n[1]<i[1]?n[1]:i[1],n[1]>i[1]?n[1]:i[1]];if(!(o[0]<=a[1]&&o[1]>=a[0]&&o[2]<=a[3]&&o[3]>=a[2]))return;if(!(I.isPointOnLineSegment(e,t,n)||I.isPointOnLineSegment(e,t,i)||I.isPointOnLineSegment(n,i,e)))return;return[.5*((o[0]>a[0]?o[0]:a[0])+(o[1]<a[1]?o[1]:a[1])),.5*((o[2]>a[2]?o[2]:a[2])+(o[3]<a[3]?o[3]:a[3]))]}let s=e[1]-n[1],l=e[0]-n[0];const d=o[0]*s-o[1]*l;s=(a[0]*s-a[1]*l)/r,l=d/r;return[e[0]+s*o[0],e[1]+s*o[1]]}var T,S,_;function b(e){for(let t=0,n=e.length;t<n;t++){const i=e[t];i.next||(i.next=e[t===n-1?0:t+1])}}function D(e,t){const n=[],i=[],o=new Map;let a=r(t,e[0])?_.Exiting:_.Entering;for(let i=0,s=e.length;i<s;i++){const l=e[i],d=r(t,l),c={type:T.Vertex,coordinates:l,position:d?S.Inside:S.Outside,visited:!1,next:null};n.push(c);const g=e[i===s-1?0:i+1],h=E(t,l,g).map((e=>{const n=e[0],i=t[e[0]],o=t[e[1]],a=C(l,g,i,o);return{sourceLineSegmentId:n,coordinate:a,targetStartPointDistSquared:m.distanceToPointSquared(l,a)}}));h.sort(((e,t)=>e.targetStartPointDistSquared-t.targetStartPointDistSquared)),h.forEach((e=>{const{sourceLineSegmentId:t,coordinate:i}=e,r={type:T.Intersection,coordinates:i,position:S.Edge,direction:a,visited:!1,next:null},s={...r,direction:_.Unknown,cloned:!0};a===_.Entering?r.next=s:s.next=r;let l=o.get(t);l||(l=[],o.set(t,l)),n.push(r),l.push(s),a*=-1}))}for(let e=0,n=t.length;e<n;e++){const n=e,a=t[e],r={type:T.Vertex,coordinates:a,visited:!1,next:null};i.push(r);const s=o.get(n);s?.length&&s.map((e=>({intersectionPoint:e,lineSegStartDistSquared:m.distanceToPointSquared(a,e.coordinates)}))).sort(((e,t)=>e.lineSegStartDistSquared-t.lineSegStartDistSquared)).map((({intersectionPoint:e})=>e)).forEach((e=>i.push(e)))}return b(n),b(i),{targetPolylinePoints:n,sourcePolylinePoints:i}}function A(e){for(let t=0,n=e.length;t<n;t++){const n=e[t];if(!n.visited&&n.position===S.Outside)return n}}function y(e,t){const n=u(e),o=u(t),a=i.eR.dot(o,n);i.Fd.equals(1,a)||(t=t.slice().reverse());const{targetPolylinePoints:r}=D(e,t),s=A(r);if(!s)return e.slice();const l=[s.coordinates];let d=s.next;for(;d!==s;)d.type===T.Intersection&&d.cloned||l.push(d.coordinates),d=d.next;return l}function R(e,t){const n=u(e),o=u(t),a=i.eR.dot(o,n);i.Fd.equals(-1,a)||(t=t.slice().reverse());const{targetPolylinePoints:r}=D(e,t);let s=null;const l=[];for(;s=A(r);){const e=[s.coordinates];let t=s.next;for(s.visited=!0;t!==s;)t.visited=!0,t.type===T.Intersection&&t.cloned||e.push(t.coordinates),t=t.next;l.push(e)}return l}function M(e,t,n,i=!0){let o,a;i?(a=e.length-1,o=0):(a=0,o=1);for(let i=o;i<e.length;i++){if(v(t,n,e[a],e[i]))return[a,i];a=i}}function x(e,t){for(let n=0,i=e.length;n<i;n++){const o=M(t,e[n],e[n===i-1?0:n+1]);if(2===o?.length)return!0}return!1}!function(e){e[e.Vertex=0]="Vertex",e[e.Intersection=1]="Intersection"}(T||(T={})),function(e){e[e.Outside=-1]="Outside",e[e.Edge=0]="Edge",e[e.Inside=1]="Inside"}(S||(S={})),function(e){e[e.Exiting=-1]="Exiting",e[e.Unknown=0]="Unknown",e[e.Entering=1]="Entering"}(_||(_={}));const O=.1;function L(e,t=O){const n=e.length;if(n<3)return e;const i=t*t,o=[[0,n-1]],a=new Array(n).fill(!1);let r=2;for(a[0]=!0,a[n-1]=!0;o.length;){const[t,n]=o.pop();if(n-t==1)continue;const s=e[t],l=e[n];let d=-1/0,c=-1;for(let i=t+1;i<n;i++){const t=e[i],n=I.distanceToPointSquared(s,l,t);n>d&&(d=n,c=i)}d<i||(a[c]=!0,r++,o.push([c,n]),o.push([t,c]))}const s=new Array(r);for(let t=0,i=0;t<n;t++)a[t]&&(s[i++]=e[t]);return s}function P(e,t,n,i=!0){const o=[],a=E(e,t,n,i);for(let i=0;i<a.length;i++){const r=C(t,n,e[a[i][0]],e[a[i][1]]);o.push(r)}return o}function N(e,t,n,o=!0){let a,r;o?(r=e.length-1,a=0):(r=0,a=1);const s=[];for(let i=a;i<e.length;i++){const o=e[r],a=e[i];v(t,n,o,a)&&s.push([r,i]),r=i}if(0===s.length)return;const l=[];s.forEach((n=>{const o=[e[n[0]],e[n[1]]],a=[(o[0][0]+o[1][0])/2,(o[0][1]+o[1][1])/2];l.push(i.Zc.distance(a,t))}));const d=Math.min(...l);return{segment:s[l.indexOf(d)],distance:d}}var U=n(44656);const k=.001,V=(e,t)=>{let n,o,a;if(e instanceof U.StackViewport){const t=e.getImageData();o=t.direction.slice(0,3),a=t.direction.slice(3,6),n=t.spacing}else{const t=e.getImageData(),{direction:r,spacing:s}=t,{viewPlaneNormal:l,viewUp:d}=e.getCamera(),c=r.slice(0,3),g=r.slice(3,6),h=r.slice(6,9),u=i.eR.create();i.eR.cross(u,d,l);const m=Math.abs(i.eR.dot(u,c)),v=Math.abs(i.eR.dot(u,g)),p=Math.abs(i.eR.dot(u,h));let f;if(Math.abs(1-m)<k)f=s[0],o=c;else if(Math.abs(1-v)<k)f=s[1],o=g;else{if(!(Math.abs(1-p)<k))throw new Error("No support yet for oblique plane planar contours");f=s[2],o=h}const E=Math.abs(i.eR.dot(d,c)),I=Math.abs(i.eR.dot(d,g)),w=Math.abs(i.eR.dot(d,h));let C;if(Math.abs(1-E)<k)C=s[0],a=c;else if(Math.abs(1-I)<k)C=s[1],a=g;else{if(!(Math.abs(1-w)<k))throw new Error("No support yet for oblique plane planar contours");C=s[2],a=h}n=[f,C]}return{spacing:[n[0]/t,n[1]/t],xDir:o,yDir:a}},W=(e,t,n)=>i.Zc.dist(e,t)<n,B=(e,t,n,o)=>{const{xDir:a,yDir:r,spacing:s}=o,l=(0,U.getEnabledElement)(e),{viewport:d}=l;if(!t.length)return t.push(n),console.log(">>>>> !canvasPoints. :: RETURN"),1;const c=d.canvasToWorld(t[t.length-1]),g=d.canvasToWorld(n),h=i.eR.create();i.eR.subtract(h,g,c);const u=Math.abs(i.eR.dot(h,a)),m=Math.abs(i.eR.dot(h,r)),v=Math.max(Math.floor(u/s[0]),Math.floor(m/s[0]));if(v>1){const e=t[t.length-1],o=i.Zc.dist(e,n),a=i.Zc.create();i.Zc.subtract(a,n,e),i.Zc.set(a,a[0]/o,a[1]/o);const r=o/v;for(let n=1;n<=v;n++)t.push([e[0]+r*a[0]*n,e[1]+r*a[1]*n])}else t.push(n);return v},H=(e,t,n,o)=>{const a=[e[0]-t[0],e[1]-t[1]],r=[n[0]-t[0],n[1]-t[1]],s=a[0]*r[0]+a[1]*r[1];if(s<0)return!1;const l=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(0===l)return!1;const d=s/l,c=[r[0]/l,r[1]/l],g=[c[0]*d,c[1]*d],h=[t[0]+g[0],t[1]+g[1]];return!(i.Zc.distance(e,h)>o)&&!(i.Zc.distance(t,h)>i.Zc.distance(t,n))},F=1e-6;function G(e){let t;const n=U.utilities.getRandomSampleFromArray(e,50);for(let e=0;e<3;e++)if(n.every(((t,n,i)=>Math.abs(t[e]-i[0][e])<F))){t=e;break}if(void 0===t)throw new Error("Cannot find a shared dimension index for polyline, probably oblique plane");const i=[],o=(t+1)%3,a=(t+2)%3;for(let t=0;t<e.length;t++)i.push([e[t][o],e[t][a]]);return{sharedDimensionIndex:t,projectedPolyline:i}}function q(e,t,n={}){const{sharedDimensionIndex:i,projectedPolyline:o}=G(t),{holes:a}=n,s=[];if(a)for(let e=0;e<a.length;e++){const t=a[e],n=[];for(let e=0;e<t.length;e++)n.push([t[e][(i+1)%3],t[e][(i+2)%3]]);s.push(n)}return r(o,[e[(i+1)%3],e[(i+2)%3]],{holes:s})}},23345:(e,t,n)=>{n.r(t),n.d(t,{distanceToPoint:()=>o});var i=n(21954);function o(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,o,a,r]=e;let s=655535;const l=function(e,t,n,i){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+i]],bottom:[[e+n,t+i],[e,t+i]],left:[[e,t+i],[e,t]]}}(n,o,a,r);return Object.keys(l).forEach((e=>{const[n,o]=l[e],a=i.distanceToPoint(n,o,t);a<s&&(s=a)})),s}},19096:(e,t,n)=>{function i(e,t){const{center:n,radius:i}=e,o=e.radius2||i*i;return(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<=o}n.d(t,{d:()=>i})},87658:(e,t,n)=>{function i(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const o=function(e,t){const[n,i]=e,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))}(t,e);o<i&&(i=o,n=[...e])})),n}n.d(t,{A:()=>i})},86981:(e,t,n)=>{n.d(t,{A:()=>s});const i=1e-6,o=1,a=0;function r(e,t,n){const[o,a]=n;if(Math.abs(t)<i)return e<0;const r=e/t;if(t>0){if(r>a)return 0;r>o&&(n[0]=r)}else{if(r<o)return 0;r<a&&(n[1]=r)}return 1}function s(e,t,n,s,l){const[d,c]=e,[g,h]=t,u=g-d,m=h-c;if(void 0===s||void 0===l?(s=e,l=t):(s[0]=e[0],s[1]=e[1],l[0]=t[0],l[1]=t[1]),Math.abs(u)<i&&Math.abs(m)<i&&d>=n[0]&&d<=n[2]&&c>=n[1]&&c<=n[3])return o;const v=[0,1];if(r(n[0]-d,u,v)&&r(d-n[2],-u,v)&&r(n[1]-c,m,v)&&r(c-n[3],-m,v)){const[e,t]=v;return t<1&&(l[0]=d+t*u,l[1]=c+t*m),e>0&&(s[0]+=e*u,s[1]+=e*m),o}return a}},84797:(e,t,n)=>{n.r(t),n.d(t,{default:()=>l,filterAnnotationsForDisplay:()=>a.A,filterAnnotationsWithinSlice:()=>i.A,getPointInLineOfSightWithCriteria:()=>r.A,getWorldWidthAndHeightFromCorners:()=>o.A,isPlaneIntersectingAABB:()=>s.Y});var i=n(17926),o=n(78609),a=n(65826),r=n(3895),s=n(99706);const l={filterAnnotationsWithinSlice:i.A,getWorldWidthAndHeightFromCorners:o.A,filterAnnotationsForDisplay:a.A,getPointInLineOfSightWithCriteria:r.A,isPlaneIntersectingAABB:s.Y}},75403:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(44753);function o(e,t,n,o){let a,r,s,l,d,c,g;const{numComps:h}=e;g=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();const u=e.getDimensions();o?[[a,r],[s,l],[d,c]]=o:(a=0,r=u[0],s=0,l=u[1],d=0,c=u[2]);const m=i.eR.fromValues(a,s,d),v=e.getDirection(),p=v.slice(0,3),f=v.slice(3,6),E=v.slice(6,9),I=e.getSpacing(),[w,C,T]=I,S=e.indexToWorld(m),_=i.eR.fromValues(p[0]*w,p[1]*w,p[2]*w),b=i.eR.fromValues(f[0]*C,f[1]*C,f[2]*C),D=i.eR.fromValues(E[0]*T,E[1]*T,E[2]*T),A=h||g.length/u[2]/u[1]/u[0],y=u[0]*A,R=u[1]*y,M=[],x=i.eR.clone(S);for(let e=d;e<=c;e++){const o=i.eR.clone(x);for(let o=s;o<=l;o++){const s=i.eR.clone(x);for(let s=a;s<=r;s++){const a=[s,o,e];if(t(x,a)){const t=e*R+o*y+s*A;let i;i=A>2?[g[t],g[t+1],g[t+2]]:g[t],M.push({value:i,index:t,pointIJK:a,pointLPS:x.slice()}),n&&n({value:i,index:t,pointIJK:a,pointLPS:x})}i.eR.add(x,x,_)}i.eR.copy(x,s),i.eR.add(x,x,b)}i.eR.copy(x,o),i.eR.add(x,x,D)}return M}},60438:(e,t,n)=>{function i(e,t=5){return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}n.d(t,{l:()=>i})},89786:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(44656),o=n(14471),a=n(42290);const r=function(e,t,n={}){const r=[];return e.forEach((e=>{const{data:s}=e,{points:l}=s.handles,{imageData:d,dimensions:c}=t;let g=l;if(s.cachedStats?.projectionPoints){const{projectionPoints:e}=s.cachedStats;g=[].concat(...e)}const h=g.map((e=>i.utilities.transformWorldToIndex(d,e)));let u=(0,o.g)(h,c);n.numSlicesToProject&&!s.cachedStats?.projectionPoints&&(u=(0,a.A)(u,n.numSlicesToProject)),r.push(u)})),1===r.length?r[0]:r.reduce(((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)})),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})}},81952:(e,t,n)=>{n.d(t,{l:()=>s});var i=n(44753),o=n(44656);const{isEqual:a}=o.utilities,r=[i.eR.fromValues(1,0,0),i.eR.fromValues(0,1,0),i.eR.fromValues(0,0,1)];function s(e){const t=i.eR.subtract(i.eR.create(),e[0],e[1]),n=i.eR.subtract(i.eR.create(),e[0],e[2]);return[...l(t,r),...l(n,r)].every((e=>a(e,0)||a(e,90)||a(e,180)||a(e,270)))}function l(e,t){return t.map((t=>180*i.eR.angle(e,t)/Math.PI))}},21783:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(44656);function o(e,t){if(!(0,i.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof i.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{type:n}=e,{volumeId:o,delta:a,scrollSlabs:r}=t;if(e instanceof i.StackViewport)e.scroll(a,t.debounceLoading,t.loop);else if(e instanceof i.VolumeViewport)!function(e,t,n,o=!1){const a=o,{numScrollSteps:r,currentStepIndex:s,sliceRangeInfo:l}=i.utilities.getVolumeViewportScrollInfo(e,t,a);if(!l)return;const{sliceRange:d,spacingInNormalDirection:c,camera:g}=l,{focalPoint:h,viewPlaneNormal:u,position:m}=g,{newFocalPoint:v,newPosition:p}=i.utilities.snapFocalPointToSlice(h,m,d,u,c,n);e.setCamera({focalPoint:v,position:p}),e.render();const f=s+n,E={volumeId:t,viewport:e,delta:n,desiredStepIndex:f,currentStepIndex:s,numScrollSteps:r,currentImageId:e.getCurrentImageId()};(f>r||f<0)&&e.getCurrentImageId()?i.utilities.triggerEvent(i.eventTarget,i.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,E):i.utilities.triggerEvent(i.eventTarget,i.EVENTS.VOLUME_VIEWPORT_SCROLL,E)}(e,o,a,r);else{if(!(e instanceof i.VideoViewport))throw new Error(`Not implemented for Viewport Type: ${n}`);e.scroll(a)}}},33836:(e,t,n)=>{n.d(t,{A:()=>u});var i=n(44656),o=n(45200),a=n(23237),r=n(7727),s=n(20629),l=n(42111),d=n(39490),c=n(32415);const{uuidv4:g}=i.utilities,h=[l.A.HandlesUpdated,l.A.InterpolationUpdated];class u{static{this.toolNames=[]}static addTool(e){this.toolNames.includes(e)||this.toolNames.push(e)}static acceptAutoGenerated(e,t={}){const{toolNames:n,segmentationId:i,segmentIndex:a,sliceIndex:r}=t;for(const t of n||u.toolNames){const n=o.state.getAnnotations(t,e);if(n?.length)for(const e of n){const{interpolationUID:t,data:n,autoGenerated:o,metadata:s}=e;t&&(e.interpolationCompleted=!0),o&&(a&&a!==n.segmentation.segmentIndex||void 0!==r&&s&&r!==s.sliceIndex||i&&i!==n.segmentation.segmentationId||((0,c.V)(e),e.autoGenerated=!1))}}}static{this.handleAnnotationCompleted=e=>{const t=e.detail.annotation;if(!t?.metadata)return;const{toolName:n,originalToolName:i}=t.metadata;if(!this.toolNames.includes(n)&&!this.toolNames.includes(i))return;const o=(0,d.A)(t);if(!o)return void console.warn("Unable to find viewport for",t);const l={viewport:o,sliceData:m(o),annotation:t,interpolationUID:t.interpolationUID},c=!!t.interpolationUID;if(t.autoGenerated=!1,c)return(0,s.A)(l),void(0,r.A)(l);const h=[{key:"segmentIndex",value:t.data.segmentation.segmentIndex,parentKey:e=>e.data.segmentation},{key:"viewPlaneNormal",value:t.metadata.viewPlaneNormal,parentKey:e=>e.metadata},{key:"viewUp",value:t.metadata.viewUp,parentKey:e=>e.metadata}];let u=(0,a.A)(l,h);const{sliceIndex:v}=t.metadata,p=new Set;u.forEach((e=>{if(e.interpolationCompleted||e.metadata.sliceIndex===v){const{interpolationUID:t}=e;p.add(t)}})),u=u.filter((e=>!p.has(e.interpolationUID))),t.interpolationUID=u[0]?.interpolationUID||g(),l.interpolationUID=t.interpolationUID,(0,r.A)(l)}}static{this.handleAnnotationUpdate=e=>{const t=e.detail.annotation,{changeType:n=l.A.HandlesUpdated}=e.detail;if(!t?.metadata)return;const{toolName:i,originalToolName:o}=t.metadata;if(!this.toolNames.includes(i)&&!this.toolNames.includes(o)||!h.includes(n))return;const a=(0,d.A)(t);if(!a)return void console.warn("Unable to find matching viewport for annotation interpolation",t);t.autoGenerated&&((0,c.V)(t),t.autoGenerated=!1);const s={viewport:a,sliceData:m(a),annotation:t,interpolationUID:t.interpolationUID,isInterpolationUpdate:n===l.A.InterpolationUpdated};(0,r.A)(s)}}static{this.handleAnnotationDelete=e=>{const t=e.detail.annotation;if(!t?.metadata)return;const{toolName:n}=t.metadata;if(!this.toolNames.includes(n)||t.autoGenerated)return;const i=(0,d.A)(t);if(!i)return void console.warn("No viewport, can't delete interpolated results",t);const o={viewport:i,sliceData:m(i),annotation:t,interpolationUID:t.interpolationUID};t.autoGenerated=!1,(0,s.A)(o)}}}function m(e){return{numberOfSlices:e.getNumberOfSlices(),imageIndex:e.getCurrentImageIdIndex()}}},27650:(e,t,n)=>{function i(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}n.d(t,{A:()=>o});const o=function(e,t,n={}){const o=n.onFlood,a=n.onBoundary,r=n.equals,s=n.diagonals||!1,l=v(t),d=function(){const e=function(e){const t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))};for(let o=0;o<Math.pow(3,e);o+=1){const a=i(o.toString(3),"0",e);t.push(n(a))}return t}(t.length);return e.filter((function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||s)}))}(),c=[],g=[],h=new Set,u=new Map;for(c.push({currentArgs:t});c.length>0;)m(c.pop());return{flooded:g,boundaries:function(){const e=Array.from(u.values());return e.reverse(),e}()};function m(e){const t=e.currentArgs,n=e.previousArgs;(function(e){const[t,n,i=0]=e,o=t+32768+65536*(n+32768+65536*(i+32768));return h.has(o)})(t)||(function(e){const[t,n,i=0]=e,o=t+32768+65536*(n+32768+65536*(i+32768));h.add(o)}(t),function(e){const t=v(e);return r?r(t,l):t===l}(t)?(function(e){g.push(e),o&&o(...e)}(t),function(e){for(let t=0;t<d.length;t+=1){const n=d[t],i=e.slice(0);for(let t=0;t<e.length;t+=1)i[t]+=n[t];c.push({currentArgs:i,previousArgs:e})}}(t)):function(e){const[t,n,i=0]=e,o=t+32768+65536*(n+32768+65536*(i+32768));u.set(o,e),a&&a(...e)}(n))}function v(t){return e(...t)}}},94510:(e,t,n)=>{n.d(t,{HM:()=>l,OX:()=>d});var i=n(44656),o=n(30322),a=n(16124),r=n(84901);const s=new Map,l=e=>{const t=s.get(e);t&&(t.isDirty=!0)};function d(e){const t=function(e){const t=s.get(e);return t&&!t.isDirty?t.indices:null}(e);if(t)return t;const n=(0,o.getSegmentation)(e);if(!n)throw new Error(`No segmentation found for segmentationId ${e}`);let l;switch(n.type){case r.SegmentationRepresentations.Labelmap:l=function(e,t){const n=e.representationData[r.SegmentationRepresentations.Labelmap],o=new Set;(0,a.r)(n)?function(e,t){const n=i.cache.getVolume(t);n.getScalarData().forEach((t=>{0!==t&&e.add(t)}))}(o,t):function(e,t){t.forEach((t=>{i.cache.getImage(t).getPixelData().forEach((t=>{0!==t&&e.add(t)}))}))}(o,n.imageIdReferenceMap);return Array.from(o).map(Number).sort(((e,t)=>e-t))}(n,e);break;case r.SegmentationRepresentations.Contour:l=function(e){const{annotationUIDsMap:t,geometryIds:n}=e.representationData.CONTOUR||{};if(!n)throw new Error(`No geometryIds found for segmentationId ${e.segmentationId}`);const o=new Set([...t.keys()]);return n.forEach((e=>{const t=i.cache.getGeometry(e);o.add(t.data.getSegmentIndex())})),Array.from(o).sort(((e,t)=>e-t))}(n);break;case r.SegmentationRepresentations.Surface:l=function(e){const t=e.representationData.SURFACE?.geometryIds??[];return Array.from(t.keys()).map(Number).sort(((e,t)=>e-t))}(n);break;default:throw new Error(`Unsupported segmentation type: ${n.type}`)}return s.set(e,{indices:l,isDirty:!1}),l}},96638:(e,t,n)=>{n.r(t),n.d(t,{contourAndFindLargestBidirectional:()=>k,createBidirectionalToolData:()=>V,createImageIdReferenceMap:()=>R,createLabelmapVolumeForViewport:()=>I,createMergedLabelmapForIndex:()=>h,floodFill:()=>C.A,getBrushSizeForToolGroup:()=>b,getBrushThresholdForToolGroup:()=>A,getBrushToolInstances:()=>a.n7,getDefaultRepresentationConfig:()=>p,getHoveredContourSegmentationAnnotation:()=>ee,getSegmentAtLabelmapBorder:()=>J,getSegmentAtWorldPoint:()=>X,getUniqueSegmentIndices:()=>$.OX,invalidateBrushCursor:()=>q,isValidRepresentationConfig:()=>v,rectangleROIThresholdVolumeByRange:()=>c,segmentContourAction:()=>F,setBrushSizeForToolGroup:()=>_,setBrushThresholdForToolGroup:()=>D,thresholdSegmentationByRange:()=>y,thresholdVolumeByRange:()=>r,triggerSegmentationRender:()=>w.h6});var i=n(21013),o=n(87682),a=n(77071);const r=function(e,t,n){const{imageData:r}=e,s=e.getScalarData(),{overwrite:l,boundsIJK:d}=n,c=n?.overlapType||0;if(l)for(let e=0;e<s.length;e++)s[e]=0;const{baseVolumeIdx:g,volumeInfoList:h}=(0,a.zf)(e,t);let u,m,v;const p=(e,t,n)=>{const{imageData:o,dimensions:r,lower:s,upper:l}=e,d=(0,a.Q5)(o,r,t,n);m=0,u=0,v={lower:s,upper:l};let g=!1;return(0,i.pointInShapeCallback)(o,(()=>!0),(({value:e})=>{m+=1,e>=v.lower&&e<=v.upper&&(u+=1)}),d),0===c?g=u>0:1==c&&(g=u===m),g},f=(e,t)=>{const{imageData:n,referenceValues:i,lower:o,upper:a}=e,r=i[n.computeOffsetIndex(t)];return!(r<=o||r>=a)};return(0,i.pointInShapeCallback)(r,(()=>!0),(({index:e,pointIJK:t,pointLPS:i})=>{let o=h.length>0;for(let e=0;e<h.length&&(o=h[e].volumeSize===s.length?f(h[e],t):p(h[e],h[g].spacing,i),o);e++);o&&(s[e]=n.segmentIndex||1)}),d),(0,o.triggerSegmentationDataModified)(e.volumeId),e};var s=n(45200),l=n(94152),d=n(89786);const c=function(e,t,n,i){const o=e.map((e=>s.state.getAnnotation(e)));let a;!function(e){const t=[l.TR.toolName,l.mX.toolName];for(const n of e){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(o);for(let e=0;e<n.length;e++){n[e].volume.getScalarData().length!==t.getScalarData().length&&0!==e||(a=(0,d.A)(o,n[e].volume,i))}const c=r(t,n,{...i,boundsIJK:a});return c.modified(),c};var g=n(44656);const h=function(e,t=1,n="mergedLabelmap"){e.forEach((({direction:t,dimensions:n,origin:i,spacing:o})=>{if(!(g.utilities.isEqual(n,e[0].dimensions)&&g.utilities.isEqual(t,e[0].direction)&&g.utilities.isEqual(o,e[0].spacing)&&g.utilities.isEqual(i,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));const i=e[0],o=new(0,i.getScalarData().constructor)(i.getScalarData().length);e.forEach((e=>{const n=e.getScalarData();for(let e=0;e<n.length;e++)n[e]===t&&(o[e]=t)}));const a={scalarData:o,metadata:i.metadata,spacing:i.spacing,origin:i.origin,direction:i.direction,dimensions:i.dimensions};return g.volumeLoader.createLocalVolume(a,n,!0)};var u=n(44350),m=n(83946);function v(e,t){if(e===m.A.Labelmap)return(0,u.J)(t);throw new Error(`Unknown representation type: ${e}`)}function p(e){const{type:t}=e;if(t===m.A.Labelmap)return(0,u.A)();throw new Error(`Unknown representation type: ${t}`)}var f=n(48463),E=n.n(f);async function I(e){const{viewportId:t,renderingEngineId:n,options:i}=e;let{segmentationId:o}=e;const a=(0,g.getEnabledElementByIds)(t,n);if(!a)throw new Error("element disabled");const{viewport:r}=a;if(!(r instanceof g.VolumeViewport))throw new Error("Segmentation only supports VolumeViewport");const{uid:s}=r.getDefaultActor();if(void 0===o&&(o=`${s}-based-segmentation-${i?.volumeId??g.utilities.uuidv4().slice(0,8)}`),i){const e=E()(i);await g.volumeLoader.createLocalVolume(e,o)}else{const{uid:e}=r.getDefaultActor();await g.volumeLoader.createAndCacheDerivedSegmentationVolume(e,{volumeId:o})}return o}var w=n(49521),C=n(27650),T=n(52610),S=n(23072);function _(e,t,n){const i=(0,T.getToolGroup)(e);if(void 0===i)return;(0,a.n7)(e,n).forEach((e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()}));const o=i.getViewportsInfo(),r=Object.keys(o).map((e=>o[e]));if(!r.length)return;const{renderingEngineId:s}=r[0],l=i.getViewportIds(),d=(0,g.getRenderingEngine)(s);(0,S.A)(d,l)}function b(e,t){const n=(0,T.getToolGroup)(e);if(void 0===n)return;const i=n._toolInstances;if(!Object.keys(i).length)return;const o=(0,a.n7)(e,t)[0];return o?o.configuration.brushSize:void 0}function D(e,t,n={isDynamic:!1}){const i=(0,T.getToolGroup)(e);if(void 0===i)return;const o=(0,a.n7)(e),r={...n,...void 0!==t&&{threshold:t}};o.forEach((e=>{e.configuration.strategySpecificConfiguration.THRESHOLD={...e.configuration.strategySpecificConfiguration.THRESHOLD,...r}}));const s=i.getViewportsInfo();if(!s.length)return;const{renderingEngineId:l}=s[0],d=i.getViewportIds(),c=(0,g.getRenderingEngine)(l);(0,S.A)(c,d)}function A(e){const t=(0,T.getToolGroup)(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const i=(0,a.n7)(e)[0];return i?i.configuration.strategySpecificConfiguration.THRESHOLD.threshold:void 0}const y=function(e,t,n,r){const s=e.getScalarData(),{baseVolumeIdx:l,volumeInfoList:d}=(0,a.zf)(e,n);return d.forEach((e=>{const{volumeSize:n}=e;n===s.length?function(e,t,n){const{referenceValues:i,lower:o,upper:a}=n;for(let n=0;n<e.length;n++)if(e[n]===t){const r=i[n];e[n]=r>=o&&r<=a?t:0}}(s,t,e):function(e,t,n,o,r,s){const{imageData:l,lower:d,upper:c,dimensions:g}=n;let h,u,m;for(let n=0;n<e.length;n++)if(e[n]===t){const v=(0,a.Q5)(l,g,o[r].spacing,o[r].imageData.getPoint(n)),p=({value:e})=>{h+=1,e>=m.lower&&e<=m.upper&&(u+=1)};h=0,u=0,m={lower:d,upper:c};let f=!1;(0,i.pointInShapeCallback)(l,(()=>!0),p,v),f=0===s?u>0:u===h,e[n]=f?t:0}}(s,t,e,d,l,r)})),(0,o.triggerSegmentationDataModified)(e.volumeId),e};function R(e,t){return new Map(e.map(((e,n)=>[e,t[n]])))}var M=n(75908),x=n(44753);function O(e,t,n){const i=n.toIJK(e),o=n.toIJK(t),a=x.eR.create(),{testIJK:r}=n,s=x.eR.sub(x.eR.create(),i,o),l=Math.round(Math.max(...s.map(Math.abs)));if(l<2)return!0;const d=x.eR.scale(x.eR.create(),s,1/l);for(let e=1;e<l;e++)if(x.eR.scaleAndAdd(a,o,d,e),!r(a))return!1;return!0}const L=.01;function P(e,t,n){const{sliceContours:i}=e,{segmentIndex:o,containedSegmentIndices:a}=n;let r;const s=function(e,t,n){const i=g.cache.getVolume(e);if(!i)return void console.warn(`No volume found for ${e}`);const o=i.imageData.getPointData().getScalars().getData(),a=i.dimensions[0],r=a*i.dimensions[1];return{testCenter:(e,s)=>{const l=x.eR.add(x.eR.create(),e,s).map((e=>e/2)),d=i.imageData.worldToIndex(l).map(Math.round),[c,g,h]=d,u=o[c+g*a+h*r];return u===t||n?.has(u)},toIJK:e=>i.imageData.worldToIndex(e),testIJK:e=>{const[i,s,l]=e,d=Math.round(i)+Math.round(s)*a+Math.round(l)*r,c=o[d];return c===t||n?.has(c)}}}(t,o,a);for(const e of i){const t=N(e,s,r);t&&(r=t)}return r&&Object.assign(r,n),r}function N(e,t,n={maxMajor:0,maxMinor:0}){const{points:i}=e.polyData,{maxMinor:o,maxMajor:a}=n;let r,s=a*a,l=o*o;for(let e=0;e<i.length;e++)for(let n=e+1;n<i.length;n++){const o=i[e],a=i[n],d=x.eR.sqrDist(o,a);d<s||(d-L<s+L&&r||t.testCenter(o,a)&&O(o,a,t)&&(s=d-L,r=[e,n],l=0))}if(!r)return;s=Math.sqrt(s+L);const d=i[r[0]],c=i[r[1]],g=x.eR.sub(x.eR.create(),d,c);let h;x.eR.scale(g,g,1/s);for(let e=0;e<i.length;e++)for(let n=e+1;n<i.length;n++){const o=i[e],a=i[n],r=x.eR.sqrDist(o,a);if(r<=l)continue;const s=x.eR.sub(x.eR.create(),o,a);Math.abs(x.eR.dot(s,g))/Math.sqrt(r)>L||t.testCenter(o,a)&&O(o,a,t)&&(l=r,h=[e,n])}if(!h)return;l=Math.sqrt(l);return{majorAxis:[d,c],minorAxis:[i[h[0]],i[h[1]]],maxMajor:s,maxMinor:l,...e}}const{Labelmap:U}=m.A;function k(e){const t=(0,M.generateContourSetsFromLabelmap)({segmentations:e});if(!t?.length||!t[0].sliceContours.length)return;const{representationData:n,segments:i=[null,{label:"Unspecified",color:null,containedSegmentIndices:null}]}=e,{volumeId:o}=n[U],a=i.findIndex((e=>!!e));return-1!==a?(i[a].segmentIndex=a,P(t[0],o,i[a])):void 0}function V(e,t){const{majorAxis:n,minorAxis:i,label:o="",sliceIndex:a}=e,[r,s]=n,[l,d]=i,c=[r,s,l,d];return{highlighted:!0,invalidated:!0,metadata:{toolName:"Bidirectional",...t.getViewReference({sliceIndex:a})},data:{handles:{points:c,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:o,cachedStats:{}},isLocked:!1,isVisible:!0}}var W=n(63421),B=n(31555),H=n(50720);function F(e,t){const{data:n}=t,i=(0,g.getEnabledElement)(e),o=(n.getSegment||G)(i,n);if(!o)return;const a=i.viewport.getFrameOfReferenceUID(),r=W.state.getSegmentations(),{segmentIndex:l,segmentationId:d}=o,c=s.state.getAnnotations(this.toolName||H.A.toolName,a);let h=!1;const u=c.filter((e=>{const{segment:t}=e.data;if(t)return t.segmentationId===d&&t.segmentIndex===l&&(h=!0,e.data.segment=t),!!t}));let m;if(h||u.push({data:{segment:o}}),u.forEach((e=>{const t=[],{segment:n}=e.data,{segmentIndex:l,segmentationId:d}=n;t[l]=n,s.state.removeAnnotation(e.annotationUID);const c=k({...r.find((e=>e.segmentationId===d)),segments:t});if(!c)return;const g=V(c,i.viewport);g.annotationUID=e.annotationUID,g.data.segment=n;const h=s.state.addAnnotation(g,a);if(n.segmentIndex===o.segmentIndex&&n.segmentationId===o.segmentationId){m=c;const{style:e}=o;e&&s.config.style.setAnnotationStyles(h,e)}})),m){const{sliceIndex:t}=m,n=i.viewport.getImageIds();(0,B.jumpToSlice)(e,{imageIndex:n.length-1-t}),i.viewport.render()}else console.warn("No bidirectional found");return m}function G(e,t){const n=W.state.getSegmentations();if(!n.length)return;const i=t.segmentationId||n[0].segmentationId,o=t.segmentIndex??W.segmentIndex.getActiveSegmentIndex(i);if(!o)return;const a=t.segmentData?.get(o);return{label:`Segment ${o}`,segmentIndex:o,segmentationId:i,...a}}function q(e){const t=(0,T.getToolGroup)(e);if(void 0===t)return;(0,a.n7)(e).forEach((e=>{e.invalidateBrushCursor()}));const n=t.getViewportsInfo(),i=Object.keys(n).map((e=>n[e]));if(!i.length)return;const{renderingEngineId:o}=i[0],r=t.getViewportIds(),s=(0,g.getRenderingEngine)(o);(0,S.A)(s,r)}var $=n(94510),z=n(84901),Z=n(30322),j=n(16124),K=n(95778),Y=n(56634);function X(e,t,n={}){const i=(0,Z.getSegmentation)(e),o=i.representationData,a=n?.representationType??Object.keys(o)[0];if(!a)throw new Error(`Segmentation ${e} does not have any representations`);switch(a){case z.SegmentationRepresentations.Labelmap:return function(e,t,{viewport:n}){const i=e.representationData.LABELMAP;if((0,j.r)(i)){const{volumeId:e}=i,n=g.cache.getVolume(e);if(!n)return;return n.imageData.getScalarValueFromWorld(t)}const{imageIdReferenceMap:o}=i,a=n.getCurrentImageId(),r=o.get(a);if(!g.cache.getImage(r))return;const s=(0,Z.getSegmentationIdRepresentations)(e.segmentationId),{segmentationRepresentationUID:l}=s[0],d=n.getActor(l),c=d?.actor.getMapper().getInputData(),h=g.utilities.transformWorldToIndex(c,t),u=c.getDimensions(),m=c.voxelManager||g.utilities.VoxelManager.createVolumeVoxelManager(u,c.getPointData().getScalars().getData());return m.getAtIJKPoint(h)}(i,t,n);case z.SegmentationRepresentations.Contour:return function(e,t,{viewport:n}){const i=e.representationData.CONTOUR,o=Array.from(i.annotationUIDsMap.keys()),{viewPlaneNormal:a}=n.getCamera();for(const e of o){const n=i.annotationUIDsMap.get(e);if(n)for(const i of n){const n=(0,K.gw)(i);if(!n)continue;const{polyline:o}=n.data.contour;if(g.utilities.isEqual(a,n.metadata.viewPlaneNormal)&&(0,Y.isPointInsidePolyline3D)(t,o))return Number(e)}}}(i,t,n);default:return}}function J(e,t,{viewport:n,searchRadius:i}){const o=(0,Z.getSegmentation)(e),a=o.representationData.LABELMAP;if((0,j.r)(a)){const{volumeId:e}=a,o=g.cache.getVolume(e);if(!o)return;const r=o.imageData,s=r.getScalarValueFromWorld(t),l=function(e,t,n,i,o){const a=(t,o)=>{const a=[e[0]+t,e[1]+o],r=n.canvasToWorld(a);return i.getScalarValueFromWorld(r)};return Q(a,t,o)}(n.worldToCanvas(t),s,n,r,i);return l?s:void 0}const{imageIdReferenceMap:r}=a,s=n.getCurrentImageId(),l=r.get(s);if(!g.cache.getImage(l))return;const d=(0,Z.getSegmentationIdRepresentations)(o.segmentationId),{segmentationRepresentationUID:c}=d[0],h=n.getActor(c),u=h?.actor.getMapper().getInputData(),m=g.utilities.transformWorldToIndex(u,t),v=u.getDimensions(),p=u.voxelManager||g.utilities.VoxelManager.createVolumeVoxelManager(v,u.getPointData().getScalars().getData()),f=p.getAtIJKPoint(m),E=function(e,t,n,i,o){const a=(t,i,o)=>{const a=[e[0]+t,e[1]+i,e[2]+o];return n.getAtIJK(...a)};return Q(a,i,o)}(m,0,p,f);return E?f:void 0}function Q(e,t,n=1){const i=Array.from({length:2*n+1},((e,t)=>t-n));for(const n of i)for(const o of i)for(const a of i){if(0===n&&0===o&&0===a)continue;const i=e(n,o,a);if(void 0!==i&&t!==i)return!0}return!1}function ee(e){const t=(0,Z.getSegmentation)(e),{annotationUIDsMap:n}=t.representationData.CONTOUR;for(const[e,t]of n.entries()){if(Array.from(t).find((e=>(0,K.gw)(e).highlighted)))return e}}},49521:(e,t,n)=>{n.d(t,{Ay:()=>d,h6:()=>l,px:()=>s});var i=n(44656),o=n(84901),a=n(52610),r=n(94152);const s=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedToolGroups=()=>{this._throwIfDestroyed();const e=Array.from(this._needsRender.values());for(const t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size)return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,a.getToolGroup)(e);if(!t)return void console.warn(`No tool group found with toolGroupId: ${e}`);const{viewportsInfo:n}=t,s=n.map((({viewportId:e,renderingEngineId:t})=>{const n=(0,i.getRenderingEngine)(t);if(!n)return void console.warn("rendering Engine has been destroyed");const o=n.getViewport(e);return o||void 0})).filter(Boolean),l=t.getToolInstance(r.t0.toolName);function d(e){const{element:t,viewportId:n,renderingEngineId:r}=e.detail;t.removeEventListener(i.Enums.Events.IMAGE_RENDERED,d);const s=(0,a.getToolGroupForViewport)(n,r);if(!s)return void console.warn("toolGroup has been destroyed");const l={toolGroupId:s.id,viewportId:n};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_RENDERED,{...l})}l?(s.forEach((({element:e})=>{e.addEventListener(i.Enums.Events.IMAGE_RENDERED,d)})),l.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function l(e){s.renderToolGroupSegmentations(e)}const d=l},77071:(e,t,n)=>{n.d(t,{Q5:()=>d,n7:()=>s,zf:()=>c});var i=n(44656),o=n(52610),a=n(53712),r=n(14471);function s(e,t){const n=(0,o.getToolGroup)(e);if(void 0===n)return;const i=n._toolInstances;if(!Object.keys(i).length)return;if(t&&i[t])return[i[t]];return Object.values(i).filter((e=>e instanceof a.A))}const l=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function d(e,t,n,o){const a=[];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let i=0;i<2;i++){const r=[...o];r[0]=r[0]+(2*e-1)*n[0]/2,r[1]=r[1]+(2*t-1)*n[1]/2,r[2]=r[2]+(2*i-1)*n[2]/2,a.push(r)}const s=a.map((t=>i.utilities.transformWorldToIndex(e,t)));return(0,r.g)(s,t)}function c(e,t){const{spacing:n}=e,i=e.getScalarData(),o=[];let a=0;for(let e=0;e<t.length;e++){const{imageData:r,spacing:s,dimensions:d}=t[e].volume,c=t[e].volume.getScalarData().length;c===i.length&&l(s,n)&&(a=e);const g=r.getPointData().getScalars().getData(),h=t[e].lower,u=t[e].upper;o.push({imageData:r,referenceValues:g,lower:h,upper:u,spacing:s,dimensions:d,volumeSize:c})}return{volumeInfoList:o,baseVolumeIdx:a}}},21090:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(64857),o=n(11857);const a=function(e,t,n){let a=!0,r=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return(0,o.A)(n)&&(a="leading"in n?Boolean(n.leading):a,r="trailing"in n?Boolean(n.trailing):r),(0,i.A)(e,t,{leading:a,trailing:r,maxWait:t})}},54868:(e,t,n)=>{function i(e,t){const n=d(e),i=d(t);return{page:g(n.page,i.page),client:g(n.client,i.client),canvas:g(n.canvas,i.canvas),world:(o=n.world,a=i.world,[o[0]-a[0],o[1]-a[1],o[2]-a[2]])};var o,a}function o(e,t){const n=d(e),i=d(t);return{page:u(n.page,i.page),client:u(n.client,i.client),canvas:u(n.canvas,i.canvas),world:m(n.world,i.world)}}function a(e,t){}function r(e,t){const n=h(e),i=h(t);return{page:n.page-i.page,client:n.client-i.client,canvas:n.canvas-i.canvas,world:n.world-i.world}}function s(e){return JSON.parse(JSON.stringify(e))}function l(e){return JSON.parse(JSON.stringify(e))}function d(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function c(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function g(e,t){return[e[0]-t[0],e[1]-t[1]]}function h(e){const t=[];for(let n=0;n<e.length;n++)for(let i=0;i<e.length;i++)n<i&&t.push({page:u(e[n].page,e[i].page),client:u(e[n].client,e[i].client),canvas:u(e[n].canvas,e[i].canvas),world:m(e[n].world,e[i].world)});return t.reduce(((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length})),{page:0,client:0,canvas:0,world:0})}function u(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function m(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}n.r(t),n.d(t,{copyPoints:()=>l,copyPointsList:()=>s,getDeltaDistance:()=>o,getDeltaDistanceBetweenIPoints:()=>r,getDeltaPoints:()=>i,getDeltaRotation:()=>a,getMeanPoints:()=>d,getMeanTouchPoints:()=>c})},6805:(e,t,n)=>{n.d(t,{Ay:()=>g,ou:()=>c});var i=n(44656),o=n(84901),a=n(2746),r=n(42360);const{Active:s,Passive:l,Enabled:d}=o.ToolModes;const c=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))break}this._animationFrameSet=!1,this._animationFrameHandle=null,this._render()},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,i.getEnabledElement)(e);if(!t)return;if(!(0,i.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=(0,r.A)(e,[s,l,d]),{renderingEngineId:c,viewportId:g}=t,h={element:e,renderingEngineId:c,viewportId:g};(0,a.draw)(e,(a=>{let r=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,a);r=r||n}})),r&&(0,i.triggerEvent)(e,o.Events.ANNOTATION_RENDERED,{...h})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}};const g=function(e){c.renderViewport(e)}},23072:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(6805);const o=function(e,t){t.length&&e&&t.forEach((t=>{const n=e.getViewport(t);if(!n)return void console.warn(`Viewport not available for ${t}`);const{element:o}=n;(0,i.Ay)(o)}))}},31555:(e,t,n)=>{n.r(t),n.d(t,{isViewportPreScaled:()=>i.u,jumpToSlice:()=>o.A,jumpToWorld:()=>a.A});var i=n(97022),o=n(11666),a=n(88240)},97022:(e,t,n)=>{n.d(t,{u:()=>o});var i=n(44656);function o(e,t){if(e instanceof i.BaseVolumeViewport){const e=t.split("volumeId:"),n=e.length>1?e[1].split("?")[0]:e[0],o=i.cache.getVolume(n);return!!o?.scaling&&Object.keys(o.scaling).length>0}if(e instanceof i.StackViewport){const{preScale:t}=e.getImageData()||{};return!!t?.scaled}return!1}},11666:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(44656),o=n(88484),a=n(21783);const r=async function(e,t={}){const{imageIndex:n,debounceLoading:r,volumeId:s}=t,l=(0,i.getEnabledElement)(e);if(!l)throw new Error("Element has been disabled");const{viewport:d}=l,{imageIndex:c,numberOfSlices:g}=function(e,t){if(e instanceof i.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof i.VolumeViewport)return i.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}(d,r),h=function(e,t){const n=e-1;return(0,o.Ay)(t,0,n)}(g,n)-c;(0,a.A)(d,{delta:h,debounceLoading:r,volumeId:s})}},88240:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(44656),o=n(44753);function a(e,t){if(!(e instanceof i.VolumeViewport))return;const{focalPoint:n}=e.getCamera(),a=[0,0,0];return o.eR.sub(a,t,n),function(e,t){const n=e.getCamera(),i=n.viewPlaneNormal,a=o.eR.dot(t,i),r=o.eR.fromValues(i[0],i[1],i[2]);if(o.eR.scale(r,r,a),Math.abs(r[0])>.001||Math.abs(r[1])>.001||Math.abs(r[2])>.001){const t=[0,0,0],i=[0,0,0];o.eR.add(t,n.focalPoint,r),o.eR.add(i,n.position,r),e.setCamera({focalPoint:t,position:i}),e.render()}}(e,a),!0}},90252:(e,t,n)=>{function i(e,t){const n=e.length,i=[];for(let o=0;o<n;o++){const n=e[o];n.getFrameOfReferenceUID()===t&&i.push(n)}return i}n.r(t),n.d(t,{filterViewportsWithFrameOfReferenceUID:()=>i,filterViewportsWithParallelNormals:()=>u,filterViewportsWithToolEnabled:()=>d,getViewportIdsWithToolToRender:()=>m});var o=n(61738),a=n(84901);const{Active:r,Passive:s,Enabled:l}=a.ToolModes;function d(e,t){const n=e.length,i=[];for(let a=0;a<n;a++){const n=e[a],r=o.dU.getToolGroupForViewport(n.id,n.renderingEngineId);if(!r)continue;c(r,t)&&i.push(n)}return i}function c(e,t){const{toolOptions:n}=e,i=n[t];if(!i)return!1;const o=i.mode;return o===r||o===s||o===l}var g=n(44656),h=n(44753);const u=function(e,t,n=.999){return e.filter((e=>{const i=e.getCamera();return Math.abs(h.eR.dot(i.viewPlaneNormal,t.viewPlaneNormal))>n}))};function m(e,t,n=!0){const o=(0,g.getEnabledElement)(e),{renderingEngine:a,FrameOfReferenceUID:r}=o;let s=a.getViewports();s=i(s,r),s=d(s,t);const l=a.getViewport(o.viewportId);n&&(s=u(s,l.getCamera()));return s.map((e=>e.id))}},50614:(e,t,n)=>{var i;n.d(t,{U:()=>i}),function(e){e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right"}(i||(i={}))},73231:(e,t,n)=>{n.r(t),n.d(t,{ColorbarRangeTextPosition:()=>i.U});var i=n(50614)},52754:(e,t,n)=>{n.d(t,{Ay:()=>h});var i=n(50906),o=n(27398),a=n(23410),r=n(68749);const{vtkErrorMacro:s,vtkDebugMacro:l}=i.m;function d(e,t){t.classHierarchy.push("vtkImageMarchingSquares"),e.getContourValues=()=>t.contourValues,e.setContourValues=n=>{t.contourValues=n,e.modified()};const n=[],i=[],d=[],c=a.A.newInstance();e.getPixelScalars=(e,t,o,a,r,s)=>{const[l,d,c]=e;n[0]=c*t[1]*t[0]+d*t[0]+l,n[1]=n[0]+a[r],n[2]=n[0]+a[s],n[3]=n[2]+a[r];for(let e=0;e<4;++e)i[e]=o[n[e]]},e.getPixelPoints=(e,t,n,i,o)=>{const a=e[i],r=e[o];d[0]=t[i]+a*n[i],d[1]=t[o]+r*n[o],d[2]=d[0]+n[i],d[3]=d[1],d[4]=d[0],d[5]=d[1]+n[o],d[6]=d[2],d[7]=d[5]},e.produceLines=(o,a,s,l,g,h,u,m,v,p,f)=>{const E=a[t.slicingMode],I=[1,2,8,4],w=[];let C;e.getPixelScalars(a,s,h,v,p,f);let T=0;for(let e=0;e<4;e++)i[e]>=o&&(T|=I[e]);const S=r.A.getCase(T);if(S[0]<0)return;e.getPixelPoints(a,l,g,p,f);const _=l[t.slicingMode]+E*g[t.slicingMode];for(let e=0;S[e]>=0;e+=2){m.push(2);for(let a=0;a<2;a++){const s=r.A.getEdge(S[e+a]);if(C=void 0,t.mergePoints&&(C=c.isInsertedEdge(n[s[0]],n[s[1]])?.value),void 0===C){const e=(o-i[s[0]])/(i[s[1]]-i[s[0]]),a=d.slice(2*s[0],2*(s[0]+1)),r=d.slice(2*s[1],2*(s[1]+1));w[p]=a[0]+e*(r[0]-a[0]),w[f]=a[1]+e*(r[1]-a[1]),w[t.slicingMode]=_,C=u.length/3,u.push(w[0],w[1],w[2]),t.mergePoints&&c.insertEdge(n[s[0]],n[s[1]],C)}m.push(C)}}},e.requestData=(n,i)=>{const a=n[0];if(!a)return void s("Invalid or missing input");if(null==t.slicingMode||t.slicingMode<0||t.slicingMode>2)return void s("Invalid or missing slicing mode");console.time("msquares");const r=a.getOrigin(),d=a.getSpacing(),g=a.getDimensions(),h=a.getExtent(),u=a.computeIncrements(h),m=a.getPointData().getScalars().getData(),[v,p]=function(){let e=0,n=1;return 1===t.slicingMode?(e=0,n=2):0===t.slicingMode&&(e=1,n=2),[e,n]}(),f=[],E=[];let I=Math.round(t.slice);I>=g[t.slicingMode]&&(I=0);const w=[0,0,0];w[t.slicingMode]=I;for(let n=0;n<t.contourValues.length;++n){for(let i=0;i<g[p]-1;++i){w[p]=i;for(let i=0;i<g[v]-1;++i)w[v]=i,e.produceLines(t.contourValues[n],w,g,r,d,m,f,E,u,v,p)}c.initialize()}const C=o.Ay.newInstance();C.getPoints().setData(new Float32Array(f),3),C.getLines().setData(new Uint32Array(E)),i[0]=C,l("Produced output"),console.timeEnd("msquares")}}const c={contourValues:[],slicingMode:2,slice:0,mergePoints:!1};function g(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,c,n),i.m.obj(e,t),i.m.algo(e,t,1,1),i.m.setGet(e,t,["slicingMode","slice","mergePoints"]),i.m.algo(e,t,1,1),d(e,t)}var h={newInstance:i.m.newInstance(g,"vtkImageMarchingSquares"),extend:g}}}]);
//# sourceMappingURL=183.bundle.50590bf63a666d85b459.js.map